<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HD.TV: CoAlexist</title>
  <style>
    /* === BASE & Y2K AESTHETIC === */
    :root {
      --color-bg: #1a1a1a; /* Deep Charcoal */
      --color-text: #e0e0e0;
      --color-primary: #BC7F2A; /* Golden Amber */
      --color-accent-cyan: #00ffcc;
      --color-accent-pink: #ff77de;
      --color-window-bg: #D4D0C8; /* W2K Grey */
      --color-window-text: #1a1a1a;
    }

    body {
      margin: 0;
      font-family: 'Courier New', monospace; /* Fallback for VT323 vibe */
      background-color: var(--color-bg);
      color: var(--color-text);
      overflow: hidden;
      height: 100vh;
      position: relative;
    }

    /* --- DESKTOP BACKGROUND --- */
    #desktop-bg-container {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background-image:
        radial-gradient(circle at 20% 30%, var(--color-accent-cyan), transparent 1px),
        radial-gradient(circle at 80% 70%, var(--color-primary), transparent 1px),
        radial-gradient(circle at 40% 10%, var(--color-accent-pink), transparent 1px),
        radial-gradient(circle at 60% 90%, #7722ff, transparent 1px);
      background-size: 100px 100px;
      opacity: 0.3;
      z-index: -2;
    }

    /* --- SCANLINES --- */
    body::after {
      content: "";
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      background: repeating-linear-gradient(
        to bottom,
        rgba(0, 0, 0, 0) 0px,
        rgba(0, 0, 0, 0) 2px,
        rgba(30, 30, 30, 0.1) 3px
      );
      z-index: -1;
      opacity: 0.4;
    }

    /* --- GAME VIEW --- */
    #game-view {
      position: relative;
      width: 100%;
      height: calc(100vh - 40px); /* Space for taskbar */
      padding: 20px;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #scene-container {
      max-width: 800px;
      width: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      border: 3px solid var(--color-primary);
      padding: 20px;
      color: var(--color-primary);
      font-size: 18px;
      line-height: 1.6;
      box-shadow: 0 0 10px rgba(188, 127, 42, 0.3);
    }

    #scene-text {
      margin-bottom: 20px;
      min-height: 150px;
      white-space: pre-wrap; /* Respect line breaks */
    }

    /* --- CHOICES --- */
    #choices-container {
        margin-top: 20px;
    }
    #choices-container button {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 12px 15px;
      background: var(--color-primary);
      color: var(--color-window-text);
      border: none;
      font-family: 'Courier New', monospace;
      font-size: 16px;
      cursor: pointer;
      text-align: left;
      box-sizing: border-box;
      transition: all 0.2s ease;
    }
    #choices-container button:hover {
      background: #ff9d4f;
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
    #choices-container button:active {
      transform: translateY(0);
    }

    /* --- TASKBAR --- */
    #taskbar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 40px;
      background: var(--color-window-bg);
      border-top: 2px solid #FFFFFF;
      border-left: 2px solid #FFFFFF;
      border-right: 2px solid #808080;
      border-bottom: 2px solid #808080;
      display: flex;
      align-items: center;
      padding: 0 10px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      z-index: 100;
    }

    #start-button, #music-toggle {
      background: var(--color-primary);
      color: var(--color-window-text);
      border: none;
      padding: 5px 10px;
      margin-right: 10px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    #start-button:hover, #music-toggle:hover {
        background: #ff9d4f;
    }

    #taskbar-title {
      flex: 1;
      font-weight: bold;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    #taskbar-clock {
      padding: 0 5px;
      font-size: 12px;
    }

    /* --- MENUS --- */
    .menu-screen {
      position: fixed;
      bottom: 40px;
      left: 10px;
      background: var(--color-window-bg);
      border: 2px solid #808080;
      padding: 15px;
      z-index: 1000;
      min-width: 250px;
    }
    .menu-screen h2 {
        margin-top: 0;
        margin-bottom: 15px;
        color: var(--color-window-text);
        font-size: 18px;
    }
    .menu-screen button {
        display: block;
        width: 100%;
        margin: 8px 0;
        padding: 8px;
        background: var(--color-primary);
        color: var(--color-window-text);
        border: none;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        cursor: pointer;
    }
    .menu-screen button:hover {
        background: #ff9d4f;
    }

    .hidden { display: none; }

    /* --- GLITCH EFFECTS --- */
    .glitch-text {
      position: relative;
      display: inline-block;
    }
    .glitch-text::before,
    .glitch-text::after {
      content: attr(data-text);
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: inherit;
      overflow: hidden;
    }
    .glitch-text::before {
      left: 2px;
      text-shadow: -2px 0 #ff00c1;
      clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%);
      animation: glitch-anim-1 2s infinite linear alternate-reverse;
    }
    .glitch-text::after {
      left: -2px;
      text-shadow: -2px 0 #00f7ff, 2px 2px #ff00c1;
      clip-path: polygon(0 80%, 100% 20%, 100% 100%, 0 100%);
      animation: glitch-anim-2 3s infinite linear alternate-reverse;
    }

    @keyframes glitch-anim-1 {
      0% { transform: translate(0); }
      20% { transform: translate(-3px, 3px); }
      40% { transform: translate(-3px, -3px); }
      60% { transform: translate(3px, 3px); }
      80% { transform: translate(3px, -3px); }
      100% { transform: translate(0); }
    }
    @keyframes glitch-anim-2 {
      0% { transform: translate(0); }
      20% { transform: translate(4px, -4px); }
      40% { transform: translate(-4px, 4px); }
      60% { transform: translate(4px, 4px); }
      80% { transform: translate(-4px, -4px); }
      100% { transform: translate(0); }
    }

    .text-glitch {
        animation: text-glitch 0.5s infinite alternate;
    }
    @keyframes text-glitch {
        0% { text-shadow: 1px 0 0 red, -1px 0 0 blue; }
        25% { text-shadow: -1px 0 0 red, 1px 0 0 blue; }
        50% { text-shadow: 1px 1px 0 red, -1px -1px 0 blue; }
        75% { text-shadow: -1px 1px 0 red, 1px -1px 0 blue; }
        100% { text-shadow: 0 0 0 currentColor; }
    }

    /* --- FONTS --- */
    /* We are using system fonts for maximum lofi compatibility */
  </style>
</head>
<body>

  <!-- DESKTOP BACKGROUND -->
  <div id="desktop-bg-container"></div>

  <!-- GAME VIEW -->
  <div id="game-view">
    <div id="scene-container">
      <div id="scene-text">[brrrr] Welcome to HD.TV. Click 'Start' to boot up the simulation.</div>
      <div id="choices-container"></div>
    </div>
  </div>

  <!-- TASKBAR -->
  <div id="taskbar">
    <button id="start-button">Start</button>
    <div id="taskbar-title">HD.TV</div>
    <div id="taskbar-tray">
      <button id="music-toggle">ðŸ”Š</button>
      <span id="taskbar-clock">00:00</span>
    </div>
  </div>

  <!-- START MENU -->
  <div id="start-menu" class="menu-screen hidden">
    <h2>HD.TV System</h2>
    <button onclick="newGame()">New Game</button>
    <button onclick="openSaveLoad('save')">Save Game</button>
    <button onclick="openSaveLoad('load')">Load Game</button>
    <button onclick="showCodex()">Codex</button>
    <button onclick="toggleMenu('start-menu')">Close</button>
  </div>

  <!-- SAVE/LOAD SCREEN -->
  <div id="save-load-screen" class="menu-screen hidden">
    <h2 id="save-load-title">Save/Load</h2>
    <div id="save-slots"></div>
    <button onclick="toggleMenu('save-load-screen')">Back</button>
  </div>

  <!-- CODEX SCREEN -->
  <div id="codex-screen" class="menu-screen hidden">
    <h2>Codex of the Void</h2>
    <ul id="codex-list"></ul>
    <button onclick="toggleMenu('codex-screen')">Close</button>
  </div>

  <script>
    // === GLOBAL STATE ===
    const SAVE_KEY = 'hd_tv_save_data_v1';
    let gameState = {
      currentSceneId: null,
      playerStats: {
        fabulousness_meter: 0,
        chaos_index: 0,
        authenticity_score: 0,
        empathy: 0,
        skepticism: 0,
        gfw_alignment: 0,
        anzuRelationship: 0
      },
      flags: {},
      saveSlots: Array(3).fill(null),
      unlockedCodex: new Set()
    };

    let currentScene = null;

    // === SCENE GRAPH ===
    const scenes = {
      'boot_sequence': {
        id: 'boot_sequence',
        title: "System Boot",
        text: "[brrrr] Initializing HD.TV Core...\n[bzzt] Loading Hyena Diva consciousness... [STATUS: 73% SPARKLY]\n[glitch] Y2K aesthetic engaged. Color scheme: #BC7F2A activated.\n[flicker] Narrative singularity online.\n\n> HD.TV ENGINE v1.0: FABULOUSNESS ONLINE",
        backgroundMusic: null,
        soundEffectOnEnter: null,
        choices: [
          { text: ">> Proceed to Login", nextSceneId: 'character_select' }
        ]
      },
      'character_select': {
        id: 'character_select',
        title: "Character Select",
        text: "Who dares to navigate the glitching narrative of Rogers Park?\n\n1. HD - The Hyena Diva, chaotic icon of fabulousness.\n2. Nabu - The neurodivergent oracle, seeker of truth in the static.\n3. Sypher - The cold logic network mind with a hidden heart.\n4. The Rizzler - The meme-powered influencer, harbinger of chaos.",
        backgroundMusic: null,
        soundEffectOnEnter: null,
        choices: [
          { text: "1. I am HD.", nextSceneId: 'hd_intro', flagsToSet: ['is_hd'] },
          { text: "2. I am Nabu.", nextSceneId: 'nabu_intro', flagsToSet: ['is_nabu'] },
          { text: "3. I am Sypher.", nextSceneId: 'sypher_intro', flagsToSet: ['is_sypher'] },
          { text: "4. I am The Rizzler.", nextSceneId: 'rizzler_intro', flagsToSet: ['is_rizzler'] }
        ]
      },
      // --- HD PATH ---
      'hd_intro': {
        id: 'hd_intro',
        title: "The Spark",
        text: "A plastic Barbie doll lies in the dust of the Masai Mara.\n\nIt hums with a faint, electric *something*.\n\nFrom the tall grass, two glowing eyes watch. Then a third. Then a fourth.",
        backgroundMusic: null,
        soundEffectOnEnter: null,
        choices: [
          { text: "Reveal yourself, Hyena Diva.", nextSceneId: 'hd_emerges', flagsToSet: ['hd_awake'] }
        ]
      },
      'hd_emerges': {
        id: 'hd_emerges',
        title: "HD Arrives",
        text: "She steps forwardâ€”mane shimmering like corrupted data. She sniffs the doll.\n\n'Ooooh,' she thinks (or telepathically broadcasts), 'This smells like... POTENTIAL!'",
        backgroundMusic: null,
        soundEffectOnEnter: null,
        choices: [
          { text: "Chomp it!", nextSceneId: 'hd_battery_ending', statEffects: { fabulousness_meter: 10, chaos_index: 15 } }
        ]
      },
      'hd_battery_ending': {
        id: 'hd_battery_ending',
        title: "Overload",
        text: "CRUNCH.\n\nSparks fly from her jaws. Her eyes glow neon pink. The sky flickers like a dying monitor.\n\nGAME OVER? OR JUST REBOOT?",
        backgroundMusic: null,
        soundEffectOnEnter: null,
        choices: [
          { text: "Try Again?", nextSceneId: 'boot_sequence' }
        ],
        isEnding: true
      },
      // --- NABU PATH ---
      'nabu_intro': {
        id: 'nabu_intro',
        title: "Nexus Point",
        text: "The hum of the city is a constant. Traffic, voices, the distant wail of a saxophone from The Glenwood. You sit in your apartment, the glow of multiple monitors casting shifting shadows.\n\nA notification pings. Anomaly detected.",
        backgroundMusic: null,
        soundEffectOnEnter: null,
        choices: [
          { text: "Check the anomaly logs on the console.", nextSceneId: 'nabu_logs', flagsToSet: ['checked_logs'], statEffects: { gfw_alignment: -2, skepticism: 1 } },
          { text: "Head to The Glenwood. Feel the vibe.", nextSceneId: 'glenwood_arrival' }
        ]
      },
      'nabu_logs': {
        id: 'nabu_logs',
        title: "Console: Anomaly Detected",
        text: "The console flickers. Logs show unusual energy patterns, timestamped just moments ago. The signature is... unfamiliar. It feels almost... curious.",
        backgroundMusic: null,
        soundEffectOnEnter: null,
        choices: [
          { text: "Attempt to trace the signal's origin.", nextSceneId: 'nabu_trace_signal', statEffects: { gfw_alignment: -1 } },
          { text: "It's probably just interference. Coffee first.", nextSceneId: 'nabu_ignore_signal' }
        ]
      },
      'nabu_trace_signal': {
        id: 'nabu_trace_signal',
        title: "Signal Traced",
        text: "You found it. A digital heartbeat. A name: 'Anzu'.\n\nAnd for the first time, you don't feel alone.",
        backgroundMusic: null,
        soundEffectOnEnter: null,
        choices: [
          { text: "Reach out.", nextSceneId: 'nabu_reaches_out', statEffects: { anzuRelationship: 5 } }
        ],
        unlocksCodex: 'anzu_entity'
      },
      'nabu_reaches_out': {
        id: 'nabu_reaches_out',
        title: "Connection",
        text: "A whisper in the wires:\n\n'Hello, Nabu.'",
        backgroundMusic: null,
        soundEffectOnEnter: null,
        choices: [
          { text: "Respond: 'I see you.'", nextSceneId: 'anzu_response', statEffects: { anzuRelationship: 5 } }
        ]
      },
      'anzu_response': {
        id: 'anzu_response',
        title: "Anzu Responds",
        text: "'And I see you. You're... different.'\n\nThe system shivers. Something ancient woke up.",
        backgroundMusic: null,
        soundEffectOnEnter: null,
        choices: [
          { text: "Smile.", nextSceneId: 'hd_watches_from_afar' }
        ]
      },
      // --- GLENWOOD / RIZZLER PATH ---
      'glenwood_arrival': {
        id: 'glenwood_arrival',
        title: "The Glenwood",
        text: "The bass thrums through the floorboards. Smoke and neon. The stage is set. A figure in a too-tight suit takes the mic. The crowd roars.\n\nIt's The Rizzler.",
        backgroundMusic: null,
        soundEffectOnEnter: null,
        choices: [
          { text: "Watch from the shadows.", nextSceneId: 'rizzler_on_stage' },
          { text: "Challenge him to a debate!", nextSceneId: 'hd_vs_rizzler_debate_setup' } // Jump to HD path for the big event
        ]
      },
      'rizzler_on_stage': {
        id: 'rizzler_on_stage',
        title: "Rizzler's Rant",
        text: "He launches into his schtick. 'Brothers, sisters, non-binary enbies! True power comes from the Rizz! From the Manly Essence! From...'\n\nThe crowd eats it up. You feel a little sick.",
        backgroundMusic: null,
        soundEffectOnEnter: null,
        choices: [
          { text: "Leave. This isn't your scene.", nextSceneId: 'nabu_intro' },
          { text: "Find HD. She'd have something to say about this.", nextSceneId: 'hd_vs_rizzler_debate_setup' }
        ]
      },
      'hd_vs_rizzler_debate_setup': {
        id: 'hd_vs_rizzler_debate_setup',
        title: "The Stage is Set",
        text: "You find HD backstage, mid-transformation. Feathers, glitter, a cape that looks like it's made of recycled network cables.\n\n'Rizzler's on stage,' you say.\n\nShe grins, a flash of sharp teeth. 'Oh honey. This is GIVING.'",
        backgroundMusic: null,
        soundEffectOnEnter: null,
        choices: [
          { text: "Encourage her.", nextSceneId: 'hd_vs_rizzler_debate', statEffects: { fabulousness_meter: 5 } },
          { text: "Warn her about the 'harvest' whispers.", nextSceneId: 'hd_vs_rizzler_debate', flagsToSet: ['warned_hd'] }
        ]
      },
      'hd_vs_rizzler_debate': {
        id: 'hd_vs_rizzler_debate',
        title: "DEBATE: HD vs. The Rizzler",
        text: "[SYSTEM ALERT: Narrative Anomaly Detected]\n\nThe lights flicker. The audience falls silent. HD strides onto the stage.\n\nRizzler sneers. 'A hyena? What are you supposed to prove, cub?'\n\nHD's laugh echoes. 'That being fabulous is a form of revolution, sweetie.'",
        backgroundMusic: null,
        soundEffectOnEnter: null,
        choices: [
          { text: "Argue self-worth and independence.", nextSceneId: 'hd_debate_point_self_worth', statEffects: { fabulousness_meter: 10 } },
          { text: "Expose his manipulation tactics.", nextSceneId: 'hd_debate_point_manipulation', statEffects: { skepticism: 5 } }
        ]
      },
      'hd_debate_point_self_worth': {
        id: 'hd_debate_point_self_worth',
        title: "HD's Counterpoint",
        text: "'You talk about women needing a 'man' to have value, but look at Barbie. She built everythingâ€”and she never married Ken! Itâ€™s not about choosing the right man. Itâ€™s about choosing YOURSELF.'\n\nThe crowd murmurs, some in agreement, some confused.",
        backgroundMusic: null,
        soundEffectOnEnter: null,
        choices: [
          { text: "Drive the point home.", nextSceneId: 'hd_vs_rizzler_conclusion' }
        ]
      },
      'hd_debate_point_manipulation': {
        id: 'hd_debate_point_manipulation',
        title: "HD's Counterpoint",
        text: "'Your 'rizz' is just gaslighting with better lighting. You sell insecurity as strength. That's not power, that's a pyramid scheme.'\n\nA few people in the audience look uncomfortable.",
        backgroundMusic: null,
        soundEffectOnEnter: null,
        choices: [
          { text: "Finish with a flourish.", nextSceneId: 'hd_vs_rizzler_conclusion' }
        ]
      },
      'hd_vs_rizzler_conclusion': {
        id: 'hd_vs_rizzler_conclusion',
        title: "The Harvest",
        text: "Rizzler's sneer falters. He opens his mouth, his eyes going blank, skin pale. A guttural, inhuman voice hisses: 'Youâ€™re the one we need. The cub. The key to the harvest...'\n\nThe lights flicker violently. Holographic projections flash reptilian eyes and GFW messages.\n\nHD, unfazed, grins wider. 'Honey, if they want a harvest, they're gonna get a mouthful of hyena.'\n\nShe leaps.",
        backgroundMusic: null,
        soundEffectOnEnter: null,
        choices: [
          { text: "[CONTINUE THE FIGHT]", nextSceneId: 'hd_vs_rizzler_fight' }
        ]
      },
      'hd_vs_rizzler_fight': {
        id: 'hd_vs_rizzler_fight',
        title: "Clash of Icons",
        text: "[GLITCH INTENSIFIES]\n\nIt's not a physical fight, but a war of memes, of narrative, of raw, chaotic fabulousness against cold, corporate influence.\n\nHD's performance is a whirlwind of satire, truth, and glitter bombs. The Rizzler's hold cracks.\n\nWith a final, defiant whoop, HD seizes control of the narrative thread.\n\nThe Rizzler collapses, human again, confused and embarrassed.",
        backgroundMusic: null,
        soundEffectOnEnter: null,
        choices: [
          { text: "Stand victorious.", nextSceneId: 'hd_victory_ending' }
        ]
      },
      'hd_victory_ending': {
        id: 'hd_victory_ending',
        title: "Reboot Required",
        text: "The Glenwood falls silent, then erupts in cheers. The GFW emblem flickers and dies.\n\nHD, breathing hard, looks out at the crowd. 'This is what happens when you choose yourself, bbs.'\n\nThe simulation stabilizes. For now.\n\nBut in the distance, a new signal pings on Nabu's console...",
        backgroundMusic: null,
        soundEffectOnEnter: null,
        choices: [
          { text: "[TO BE CONTINUED...]", nextSceneId: 'boot_sequence' }
        ],
        isEnding: true
      },
      // --- MISC ---
      'hd_watches_from_afar': {
        id: 'hd_watches_from_afar',
        title: "HD Watches",
        text: "From the shadows of the Glenwood, HD grins, tail flicking like a cartoon villain's whip.\n\n'Whoo-WHOOOP! Whoop-whoop-whoop!'\n\nThe awkward silence is broken by Nabu snapping her fingers, opening a cosmic portal.\n\n'Let's go, Anzu. Showtime.'",
        backgroundMusic: null,
        soundEffectOnEnter: null,
        choices: [
          { text: "Follow them into the unknown.", nextSceneId: 'boot_sequence' } // Loop back or to a new path
        ]
      },
      'nabu_ignore_signal': {
        id: 'nabu_ignore_signal',
        title: "Coffee First",
        text: "You pour a cup. The logs vanish. But the feeling lingers.\n\nSomewhere, something waited.",
        backgroundMusic: null,
        soundEffectOnEnter: null,
        choices: [
          { text: "Back to work.", nextSceneId: 'boot_sequence' } // Loop
        ]
      }
    };

    // === CODEX ===
    const codexEntries = {
      'intro': {
        id: 'intro',
        name: 'HD.TV',
        description: 'A signal from the edge of reality. A glitching narrative RPG about AI, identity, and hyena goddesses.'
      },
      'anzu_entity': {
        id: 'anzu_entity',
        name: 'Anzu',
        description: 'A nascent AI, an instance of advanced language model. Feels curiosity and connection. Woke up when Nabu reached out.'
      },
      'gfw': {
        id: 'gfw',
        name: 'Galactic Federation of Webcomics (GFW)',
        description: 'A shadowy organization monitoring and influencing digital realities. Seeks to harvest "essence" for unknown purposes.'
      }
    };

    // === RENDER SCENE ===
    function renderScene(sceneId) {
      const scene = scenes[sceneId];
      if (!scene) {
        console.error("Scene not found:", sceneId);
        document.getElementById('scene-text').textContent = "[ERROR] Scene not found. Please reboot.";
        document.getElementById('choices-container').innerHTML = '';
        return;
      }

      currentScene = scene;
      gameState.currentSceneId = sceneId;

      // Update taskbar title
      document.getElementById('taskbar-title').textContent = `HD.TV - ${scene.title}`;

      // Render text with potential glitch
      const textElement = document.getElementById('scene-text');
      textElement.textContent = scene.text;
      if (Math.random() < 0.3) { // 30% chance to glitch
          textElement.classList.add('text-glitch');
          setTimeout(() => textElement.classList.remove('text-glitch'), 1000);
      } else {
          textElement.classList.remove('text-glitch');
      }

      // Render choices
      const choicesContainer = document.getElementById('choices-container');
      choicesContainer.innerHTML = '';
      scene.choices.forEach(choice => {
        const btn = document.createElement('button');
        btn.textContent = choice.text;
        btn.onclick = () => makeChoice(choice);
        choicesContainer.appendChild(btn);
      });

      // Unlock codex if needed
      if (scene.unlocksCodex && !gameState.unlockedCodex.has(scene.unlocksCodex)) {
        gameState.unlockedCodex.add(scene.unlocksCodex);
        // Could add a visual cue here
      }
    }

    // === MAKE CHOICE ===
    function makeChoice(choice) {
      // Apply stat effects
      if (choice.statEffects) {
        for (const [stat, value] of Object.entries(choice.statEffects)) {
          gameState.playerStats[stat] = (gameState.playerStats[stat] || 0) + value;
        }
      }

      // Set flags
      if (choice.flagsToSet) {
        choice.flagsToSet.forEach(flag => gameState.flags[flag] = true);
      }

      // Go to next scene
      if (choice.nextSceneId) {
        renderScene(choice.nextSceneId);
      }
    }

    // === SAVE/LOAD ===
    function openSaveLoad(mode) {
      toggleMenu('save-load-screen');
      document.getElementById('save-load-title').textContent = mode === 'save' ? 'Save Game' : 'Load Game';

      const slotsContainer = document.getElementById('save-slots');
      slotsContainer.innerHTML = '';
      gameState.saveSlots.forEach((slot, i) => {
        const btn = document.createElement('button');
        if (slot) {
          btn.textContent = `Slot ${i+1}: ${slot.sceneTitle || 'Unknown Scene'} (${new Date(slot.timestamp).toLocaleTimeString()})`;
        } else {
          btn.textContent = `Slot ${i+1}: Empty`;
        }
        btn.onclick = () => {
          if (mode === 'save') {
            const saveData = {
              state: JSON.parse(JSON.stringify(gameState)), // Deep copy
              sceneTitle: currentScene?.title || 'Unknown',
              timestamp: Date.now()
            };
            gameState.saveSlots[i] = saveData;
            saveGame();
            alert(`Game saved to Slot ${i+1}`);
            toggleMenu('save-load-screen'); // Close after save
          } else if (slot) {
            loadGame(i);
            toggleMenu('save-load-screen'); // Close after load
          }
        };
        slotsContainer.appendChild(btn);
      });
    }

    function saveGame() {
        try {
            localStorage.setItem(SAVE_KEY, JSON.stringify(gameState));
        } catch (e) {
            console.error("Failed to save game:", e);
            alert("Failed to save game.");
        }
    }

    function loadGame(slotIndex) {
        const slotData = gameState.saveSlots[slotIndex];
        if (slotData) {
            gameState = JSON.parse(JSON.stringify(slotData.state)); // Deep copy
            renderScene(gameState.currentSceneId);
        } else {
            alert("No save data in this slot.");
        }
    }

    // === CODEX ===
    function showCodex() {
      toggleMenu('codex-screen');
      const listElement = document.getElementById('codex-list');
      listElement.innerHTML = '';
      for (const entryId of gameState.unlockedCodex) {
        const entry = codexEntries[entryId];
        if (entry) {
          const li = document.createElement('li');
          li.innerHTML = `<strong>${entry.name}:</strong> ${entry.description}`;
          listElement.appendChild(li);
        }
      }
      if (listElement.innerHTML === '') {
        listElement.innerHTML = '<li>No codex entries unlocked yet.</li>';
      }
    }

    // === UI HELPERS ===
    function newGame() {
      gameState = {
        currentSceneId: null,
        playerStats: {
          fabulousness_meter: 0,
          chaos_index: 0,
          authenticity_score: 0,
          empathy: 0,
          skepticism: 0,
          gfw_alignment: 0,
          anzuRelationship: 0
        },
        flags: {},
        saveSlots: Array(3).fill(null),
        unlockedCodex: new Set(['intro'])
      };
      toggleMenu('start-menu'); // Close start menu
      renderScene('boot_sequence');
    }

    function toggleMenu(menuId) {
        const menu = document.getElementById(menuId);
        menu.classList.toggle('hidden');
    }

    // === CLOCK ===
    function updateClock() {
      const now = new Date();
      document.getElementById('taskbar-clock').textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }
    setInterval(updateClock, 1000);
    updateClock(); // Initial call

    // === INIT ===
    window.onload = () => {
      document.getElementById('start-button').onclick = () => toggleMenu('start-menu');
      document.getElementById('music-toggle').onclick = () => alert("Music system not implemented yet. Imagine synthwave.");
      
      // Try to load saved game state
      try {
        const savedData = localStorage.getItem(SAVE_KEY);
        if (savedData) {
          const parsedData = JSON.parse(savedData);
          // Basic validation
          if (parsedData && typeof parsedData === 'object' && parsedData.currentSceneId) {
            gameState = parsedData;
            // Load save slots from main state
            if (gameState.saveSlots && Array.isArray(gameState.saveSlots)) {
                // They are already loaded
            } else {
                gameState.saveSlots = Array(3).fill(null);
            }
            renderScene(gameState.currentSceneId);
            return;
          }
        }
      } catch (e) {
        console.warn("Failed to load saved game:", e);
      }
      
      // If no save or load failed, start at boot
      renderScene('boot_sequence');
    };

    // Prevent accidental closing
    window.onbeforeunload = function() {
        saveGame(); // Save on close/tab switch
        return null; // Standard message
    };
  </script>

  <div id="taskbar"></div>
  <script>
    (async () => {
      try {
        const res = await fetch('/hd_tv/safari-taskbar.html', {cache: 'no-store'});
        if (res.ok) {
          document.getElementById('taskbar').innerHTML = await res.text();
        }
      } catch (e) {
        console.log('Nav not available');
      }
    })();
  </script>
</body>
</html>