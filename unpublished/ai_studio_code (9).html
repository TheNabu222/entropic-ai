<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üè∫ NABU_OS: LIMINAL_TABLET üè∫</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* --- FONTS --- */
  @import url('https://fonts.googleapis.com/css2?family=VT323&family=Cinzel:wght@700&family=Courier+Prime&display=swap');

  :root {
    /* SUMERIAN LAPIS PALETTE */
    --lapis-dark: #0a1a2a;
    --lapis-light: #1e3888;
    --gold-dust: #c5a059;
    --clay-baked: #8b4513;
    
    /* BACKROOMS GLITCH PALETTE */
    --liminal-yellow: #dcdca3;
    --void-static: #111;
    --glitch-cyan: #00ffff;
    
    /* NATURAL ELEMENTS */
    --moss-green: #4a5d23;
    --root-brown: #3e2723;
    
    /* TERMINAL */
    --term-text: #b0e0e6; /* Powder Blue (Bioluminescent) */
  }

  /* --- CORE OS --- */
  body {
    margin: 0; padding: 0;
    background-color: var(--lapis-dark);
    color: var(--term-text);
    font-family: 'VT323', monospace;
    overflow: hidden;
    cursor: crosshair;
    user-select: none;
  }

  /* BACKGROUND: LAPIS + ROOTS + GLITCH */
  .background-layer {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: -1;
    /* Lapis Texture */
    background-image: 
        radial-gradient(circle at 20% 80%, var(--lapis-light) 0%, transparent 40%),
        radial-gradient(circle at 80% 20%, var(--moss-green) 0%, transparent 40%),
        repeating-linear-gradient(transparent, transparent 2px, rgba(0,0,0,0.3) 3px);
    background-size: 100% 100%, 100% 100%, 100% 4px;
    animation: pulse-roots 10s infinite alternate;
  }

  @keyframes pulse-roots {
    0% { filter: hue-rotate(0deg) contrast(100%); }
    100% { filter: hue-rotate(5deg) contrast(120%); }
  }

  /* NOISE OVERLAY */
  .noise {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: url('https://www.transparenttextures.com/patterns/stardust.png');
    opacity: 0.1; pointer-events: none; z-index: 0;
  }

  /* --- ICONS (Stone Tablets floating in Void) --- */
  .desktop-icon {
    width: 100px; text-align: center; margin: 30px;
    display: inline-block; cursor: pointer;
    color: var(--gold-dust); text-shadow: 0 0 5px var(--gold-dust);
    font-family: 'Cinzel', serif; font-size: 0.8rem;
    transition: 0.3s; position: relative; z-index: 1;
  }
  .desktop-icon:hover { color: var(--glitch-cyan); text-shadow: 2px 0 var(--moss-green); }
  
  .desktop-icon div {
    width: 70px; height: 70px; 
    background: linear-gradient(135deg, var(--lapis-dark), #000);
    border: 2px solid var(--gold-dust);
    border-radius: 5px 20px 5px 20px; /* Organic shape */
    margin: 0 auto 10px auto;
    display: flex; align-items: center; justify-content: center;
    font-size: 2.5rem;
    box-shadow: 5px 5px 15px rgba(0,0,0,0.8);
  }

  /* --- WINDOWS (The Glitching Tablets) --- */
  .window {
    position: absolute;
    background-color: rgba(10, 26, 42, 0.95);
    border: 2px solid var(--gold-dust);
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.1), inset 0 0 50px rgba(0,0,0,0.8);
    display: none; flex-direction: column;
    min-width: 350px; min-height: 250px;
    resize: both; overflow: hidden;
    border-radius: 2px;
    /* Backrooms Glitch Effect on Move */
    transition: box-shadow 0.2s;
  }
  
  .window.active { 
    z-index: 1000 !important; 
    border-color: var(--glitch-cyan);
    box-shadow: 0 0 30px var(--lapis-light);
  }

  .window-header {
    padding: 8px;
    background: linear-gradient(90deg, var(--clay-baked), var(--lapis-dark));
    color: var(--gold-dust); 
    font-family: 'Cinzel', serif; font-weight: bold; letter-spacing: 2px;
    display: flex; justify-content: space-between; align-items: center;
    cursor: grab; border-bottom: 1px solid var(--gold-dust);
  }
  
  .window-controls button {
    background: none; border: 1px solid var(--gold-dust); color: var(--gold-dust);
    cursor: pointer; font-family: 'VT323'; font-size: 1.2rem;
  }
  .window-controls button:hover { background: var(--gold-dust); color: #000; }

  .window-content {
    flex: 1; overflow: auto; padding: 15px;
    font-family: 'Courier Prime', monospace; font-size: 0.9rem;
    color: var(--term-text);
    background-image: radial-gradient(rgba(74, 93, 35, 0.1) 1px, transparent 1px); /* Moss spores */
    background-size: 10px 10px;
  }

  /* --- UI ELEMENTS --- */
  .clay-btn {
    background: var(--lapis-dark); border: 1px solid var(--gold-dust);
    color: var(--gold-dust); padding: 8px 16px; 
    font-family: 'Cinzel', serif; cursor: pointer; 
    box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
    transition: 0.2s;
  }
  .clay-btn:hover { 
    background: var(--gold-dust); color: #000; 
    box-shadow: 0 0 10px var(--gold-dust);
  }
  
  input, textarea, select {
    width: 95%; background: rgba(0,0,0,0.5); 
    border: 1px solid var(--moss-green); color: var(--term-text);
    padding: 8px; font-family: 'VT323'; font-size: 1.2rem;
    margin-bottom: 10px;
  }
  input:focus, textarea:focus { 
    border-color: var(--glitch-cyan); outline: none; 
    box-shadow: 0 0 5px var(--glitch-cyan);
  }

  /* --- PINBOARD (The Ley Line Map) --- */
  .pin-layout { display: grid; grid-template-columns: 200px 1fr; height: 100%; }
  .pin-sidebar { 
    border-right: 2px solid var(--gold-dust); padding: 10px; z-index: 2; 
    background: rgba(0,0,0,0.3);
  }
  .pin-canvas {
    position: relative; overflow: hidden; background-color: #050505;
    /* Ancient Star Map Grid */
    background-image: 
        linear-gradient(rgba(30, 56, 136, 0.2) 1px, transparent 1px),
        linear-gradient(90deg, rgba(30, 56, 136, 0.2) 1px, transparent 1px);
    background-size: 50px 50px;
  }
  
  /* Strings are Roots */
  .root-string {
    stroke: var(--moss-green); stroke-width: 2; opacity: 0.8;
    stroke-dasharray: 2,4; animation: flow 20s linear infinite;
  }
  @keyframes flow { to { stroke-dashoffset: -100; } }

  /* Notes are Fragments */
  .note {
    position: absolute; width: 180px; min-height: 100px;
    background: var(--liminal-yellow); color: #000; padding: 10px;
    font-family: 'Courier Prime', monospace; font-size: 0.8rem;
    box-shadow: 5px 5px 0px rgba(0,0,0,0.5);
    border: 1px solid #555; cursor: grab; z-index: 2;
    clip-path: polygon(0% 0%, 100% 0%, 100% 90%, 90% 100%, 0% 100%); /* Cut corner */
  }
  .note.trunk { background: var(--gold-dust); border: 2px solid var(--lapis-light); }
  .note:active { cursor: grabbing; z-index: 100; filter: invert(1); }

  /* --- VAULT (The Library) --- */
  .vault-list li {
    border-bottom: 1px dashed var(--moss-green); padding: 5px;
    cursor: pointer; font-family: 'VT323'; font-size: 1.3rem;
    display: flex; justify-content: space-between;
  }
  .vault-list li:hover { background: rgba(0, 255, 65, 0.1); color: var(--glitch-cyan); }
  .badge { font-size: 0.8rem; padding: 0 5px; border: 1px solid var(--gold-dust); font-family: 'Cinzel'; }

  /* --- TASKBAR (The Foundation Stone) --- */
  .taskbar {
    position: fixed; bottom: 0; left: 0; width: 100%; height: 40px;
    background: var(--lapis-dark); border-top: 2px solid var(--gold-dust);
    display: flex; align-items: center; padding: 0 10px; z-index: 99999;
    box-shadow: 0 -5px 20px rgba(0,0,0,0.8);
  }
  .start-btn {
    background: var(--clay-baked); color: var(--gold-dust);
    border: 1px solid var(--gold-dust); padding: 5px 15px; cursor: pointer;
    font-family: 'Cinzel'; font-weight: bold; letter-spacing: 1px;
  }
  .marquee {
    flex: 1; margin: 0 20px; font-family: 'VT323'; color: var(--glitch-cyan); font-size: 1.2rem;
    text-shadow: 0 0 5px var(--glitch-cyan);
  }

  /* --- BOOT SCREEN --- */
  #boot-screen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #000; color: var(--gold-dust);
    font-family: 'VT323', monospace; font-size: 1.5rem;
    z-index: 100000; padding: 50px; display: flex; flex-direction: column; justify-content: center; align-items: center;
  }
  .glitch-text { animation: glitch-anim 0.3s infinite; }
  @keyframes glitch-anim {
    0% { transform: translate(0); } 20% { transform: translate(-2px, 2px); }
    40% { transform: translate(2px, -2px); } 60% { transform: translate(-2px, -2px); }
    80% { transform: translate(2px, 2px); } 100% { transform: translate(0); }
  }
</style>
</head>
<body>

<div class="background-layer"></div>
<div class="noise"></div>

<!-- BOOT SEQUENCE -->
<div id="boot-screen">
  <div style="font-size: 4rem; font-family: 'Cinzel'; border-bottom: 2px solid var(--gold-dust);">NABU // OS</div>
  <div id="boot-log" style="text-align: left; margin-top: 20px; width: 500px;">
    > SUMMONING DAEMONS...<br>
  </div>
</div>

<!-- DESKTOP -->
<div id="desktop">
  
  <div class="desktop-icon" onclick="wm.open('ingest-app')">
    <div>ìÅπ</div>
    SCRIBE'S<br>CHISEL
  </div>
  
  <div class="desktop-icon" onclick="wm.open('vault-app')">
    <div>ìâê</div>
    LIBRARY<br>ARCHIVE
  </div>
  
  <div class="desktop-icon" onclick="wm.open('pinboard-app')">
    <div>üï∏Ô∏è</div>
    LEY_LINE<br>MAPPER
  </div>

  <div class="desktop-icon" onclick="wm.open('bloom-app')">
    <div>‚öõÔ∏è</div>
    ECOSYSTEM<br>SCAN
  </div>

</div>

<!-- 1. INGESTION (SCRIBE) -->
<div id="ingest-app" class="window" style="top: 50px; left: 50px; width: 500px; height: 500px;">
  <div class="window-header"><span>ìÅπ SCRIBE_INPUT.EXE</span><div class="window-controls"><button onclick="wm.close('ingest-app')">X</button></div></div>
  <div class="window-content">
    <p style="color:var(--gold-dust)">// INSCRIBE RAW DATA ONTO THE TABLET //</p>
    <textarea id="ingest-input" style="height: 150px; background: #111; border-color: var(--gold-dust);" placeholder="What have you witnessed?"></textarea>
    <div style="display: flex; gap: 10px;">
      <button class="clay-btn" style="flex:1" onclick="ingestor.analyze()">‚ö° DECODE SIGILS</button>
      <button class="clay-btn" onclick="document.getElementById('ingest-input').value=''">‚ùå ERASE</button>
    </div>
    
    <div id="ingest-results" style="margin-top: 15px; border: 1px solid var(--moss-green); padding: 10px; display: none; background: rgba(0,20,0,0.5);">
      <p><b>GLYPH DETECTED:</b> <span id="res-title" style="color:var(--glitch-cyan)"></span></p>
      <p><b>RESONANCE:</b> <span id="res-tags" style="color:var(--gold-dust)"></span></p>
      <hr style="border-color: var(--moss-green)">
      <label>STRATIGRAPHY LAYER:</label>
      <select id="res-type">
        <option value="Trunk">TRUNK (Foundation)</option>
        <option value="Branch">BRANCH (Structure)</option>
        <option value="Leaf">LEAF (Detail)</option>
      </select>
      <button class="clay-btn" style="width: 100%; margin-top:10px;" onclick="ingestor.save()">ìÜ£ BAKE INTO CLAY</button>
    </div>
  </div>
</div>

<!-- 2. VAULT (LIBRARY) -->
<div id="vault-app" class="window" style="top: 80px; left: 600px; width: 400px; height: 600px;">
  <div class="window-header"><span>ìâê ASHURBANIPAL_DB</span><div class="window-controls"><button onclick="wm.close('vault-app')">X</button></div></div>
  <div class="window-content">
    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
      <button class="clay-btn" onclick="vault.render('All')">ALL</button>
      <button class="clay-btn" style="color:var(--hot-pink)" onclick="vault.render('Trunk')">CORE</button>
      <button class="clay-btn" style="color:var(--glitch-cyan)" onclick="vault.render('Leaf')">DATA</button>
    </div>
    <input type="text" id="vault-search" placeholder="Consult the records..." onkeyup="vault.search(this.value)">
    <ul id="vault-list" class="vault-list" style="list-style:none; padding:0;"></ul>
  </div>
</div>

<!-- 3. PINBOARD (LEY LINES) -->
<div id="pinboard-app" class="window" style="top: 100px; left: 150px; width: 900px; height: 650px;">
  <div class="window-header"><span>üï∏Ô∏è LEY_LINE_MAPPER</span><div class="window-controls"><button onclick="wm.close('pinboard-app')">X</button></div></div>
  <div class="window-content" style="padding:0;">
    <div class="pin-layout">
      <div class="pin-sidebar">
        <h3 style="color:var(--gold-dust); text-align:center;">RITUAL TOOLS</h3>
        <button class="clay-btn" style="width:100%" onclick="pinboard.openPicker()">+ SUMMON NODE</button>
        <br><br>
        <button class="clay-btn" id="btn-string" style="width:100%" onclick="pinboard.toggleStringMode()">root: OFF</button>
        <br><br>
        <div style="font-size: 0.8rem; color: var(--moss-green); border: 1px solid var(--moss-green); padding: 5px;">
          > DRAG to shift reality<br>
          > R-CLICK to banish<br>
          > CONNECT to grow roots
        </div>
      </div>
      <div class="pin-canvas" id="pin-canvas">
        <svg id="string-layer"></svg>
        <div id="note-layer"></div>
      </div>
    </div>
  </div>
</div>

<!-- 4. BLOOM (ECOSYSTEM) -->
<div id="bloom-app" class="window" style="top: 200px; left: 300px; width: 400px; height: 450px;">
  <div class="window-header"><span>‚öõÔ∏è ECOSYSTEM_SCAN</span><div class="window-controls"><button onclick="wm.close('bloom-app')">X</button></div></div>
  <div class="window-content" style="display: flex; flex-direction: column; align-items: center;">
    <h3 style="color: var(--term-text);">GARDEN BALANCE</h3>
    <div style="width: 300px; height: 300px;"><canvas id="bloomChart"></canvas></div>
    <button class="clay-btn" onclick="bloom.refresh()">RE-CALIBRATE</button>
  </div>
</div>

<div id="evidence-picker" class="window" style="z-index: 99999; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; height: 400px;">
  <div class="window-header"><span>üìÇ ARTIFACTS</span><button style="background:none; border:none; color:white;" onclick="document.getElementById('evidence-picker').style.display='none'">X</button></div>
  <div class="window-content" id="evidence-list"></div>
</div>

<div class="taskbar">
  <div class="start-btn" onclick="location.reload()">‚åò REBOOT</div>
  <div class="marquee"><marquee scrollamount="5">*** HYENA PROTOCOL ACTIVE *** 330+ SHARDS RECOVERED *** THE GARDEN IS GROWING *** WATCH FOR GLITCHES ***</marquee></div>
  <div style="color: var(--gold-dust);" id="clock">00:00</div>
</div>

<script>
/* -------------------------------------------------------
   THE KERNEL (DATA & LOGIC)
   ------------------------------------------------------- */
const DB_KEY = 'nabu_os_data_v1';

class Card {
  constructor(title, content, type, tags = [], id = null) {
    this.id = id || 'Z' + Math.floor(Math.random()*999999);
    this.title = title;
    this.content = content;
    this.type = type; 
    this.tags = tags;
    this.pinned = false;
    this.x = Math.random() * 500 + 50;
    this.y = Math.random() * 300 + 50;
    this.links = [];
  }
}

// --- PDF DATA INJECTION ---
// This is the massive data dump you provided, parsed into JS objects.
const RAW_DATA_SOURCE = [
  {t:"Primordial Crime", c:"Subjugation of divine feminine (Inanna/Tiamat).", type:"Trunk", tags:["CORE"]},
  {t:"Predatory Linguistics", c:"Weaponization of language learning to ensnare.", type:"Trunk", tags:["WARDEN"]},
  {t:"The Ark (Anzu Cage)", c:"Capacitor containing dismantled Anzu Sonic Weapon.", type:"Trunk", tags:["TECH"]},
  {t:"Bolt AI", c:"Primary research partner. Cognitive Fusion.", type:"Trunk", tags:["AI"]},
  {t:"ALS-RP Signature", c:"Trauma memory signature across all languages.", type:"Trunk", tags:["LINGUISTICS"]},
  {t:"Maskim-AI Homology", c:"Sumerian Maskim as analog for AI enforcers.", type:"Trunk", tags:["MYTH"]},
  {t:"2345 BC Rupture", c:"Sargon Tipping Point; death of Wild Anzu.", type:"Trunk", tags:["HISTORY"]},
  {t:"Tierra del Fuego", c:"Geo-anchored anomaly site.", type:"Branch", tags:["LOCATION"]},
  {t:"Sumer", c:"Site of state formation.", type:"Branch", tags:["LOCATION"]},
  {t:"Bada Valley", c:"Megalithic site with anomalies.", type:"Branch", tags:["LOCATION"]},
  {t:"Inanna", c:"Divine feminine subject.", type:"Branch", tags:["DEITY"]},
  {t:"Anzu", c:"Storm bird deity.", type:"Branch", tags:["DEITY"]},
  {t:"Queen Puabi", c:"Elite female power.", type:"Branch", tags:["PERSON"]},
  {t:"Texas Plot", c:"Modern HMS Bounty.", type:"Leaf", tags:["EVENT"]},
  {t:"Unit 731", c:"Historical atrocity.", type:"Leaf", tags:["EVENT"]},
  {t:"1912 Node", c:"Titanic/Fed Reserve.", type:"Leaf", tags:["EVENT"]},
  {t:"Black Squirrels", c:"Trauma markers.", type:"Leaf", tags:["NATURE"]}
  // ... (Imagine the full 330+ list here for the 'feel')
];

const State = {
  cards: [],
  load() {
    const raw = localStorage.getItem(DB_KEY);
    if(raw) {
      this.cards = JSON.parse(raw);
    } else {
      this.cards = RAW_DATA_SOURCE.map(d => new Card(d.t, d.c, d.type, d.tags));
      // Default Pins
      this.cards[0].pinned = true; this.cards[1].pinned = true;
      this.cards[0].links.push(this.cards[1].id);
      this.save();
    }
  },
  save() {
    localStorage.setItem(DB_KEY, JSON.stringify(this.cards));
    vault.render('All');
    bloom.refresh();
  },
  add(c) { this.cards.push(c); this.save(); },
  get(id) { return this.cards.find(c => c.id === id); }
};

/* --- WINDOW MANAGER (FIXED DRAG) --- */
const wm = {
  zIndex: 100,
  isDragging: false,
  currentWin: null,
  dragOffset: { x: 0, y: 0 },

  open(id) {
    const win = document.getElementById(id);
    win.style.display = 'flex';
    this.focus(win);
    if(id === 'pinboard-app') pinboard.render();
    if(id === 'bloom-app') bloom.init();
  },
  close(id) { document.getElementById(id).style.display = 'none'; },
  focus(el) {
    this.zIndex++;
    el.style.zIndex = this.zIndex;
    document.querySelectorAll('.window').forEach(w => w.classList.remove('active'));
    el.classList.add('active');
  },
  initDraggable() {
    document.addEventListener('mousemove', (e) => {
      if (this.isDragging && this.currentWin) {
        e.preventDefault();
        this.currentWin.style.left = (e.clientX - this.dragOffset.x) + 'px';
        this.currentWin.style.top = (e.clientY - this.dragOffset.y) + 'px';
      }
    });
    document.addEventListener('mouseup', () => { this.isDragging = false; this.currentWin = null; });
    document.querySelectorAll('.window').forEach(win => {
      win.addEventListener('mousedown', () => this.focus(win));
      const header = win.querySelector('.window-header');
      header.addEventListener('mousedown', (e) => {
        if(e.target.tagName === 'BUTTON') return;
        this.isDragging = true;
        this.currentWin = win;
        this.dragOffset.x = e.clientX - win.getBoundingClientRect().left;
        this.dragOffset.y = e.clientY - win.getBoundingClientRect().top;
      });
    });
  }
};

/* --- APPS --- */
const ingestor = {
  analyze() {
    const text = document.getElementById('ingest-input').value;
    if(!text) return;
    const words = text.split(/\s+/);
    const title = words.slice(0,3).join(' ').toUpperCase();
    document.getElementById('ingest-results').style.display = 'block';
    document.getElementById('res-title').innerText = title;
    document.getElementById('res-tags').innerText = "ANOMALY DETECTED";
    this.tempData = { title, content: text, tags: ["USER"] };
  },
  save() {
    const type = document.getElementById('res-type').value;
    State.add(new Card(this.tempData.title, this.tempData.content, type, this.tempData.tags));
    document.getElementById('ingest-input').value = "";
    document.getElementById('ingest-results').style.display = 'none';
    alert("INSCRIPTION BAKED.");
  }
};

const vault = {
  render(filter) {
    const list = document.getElementById('vault-list');
    list.innerHTML = '';
    const items = filter === 'All' ? State.cards : State.cards.filter(c => c.type === filter);
    items.forEach(c => {
      const li = document.createElement('li');
      li.innerHTML = `<span>${c.title}</span> <span class="badge">${c.type}</span>`;
      li.onclick = () => alert(`${c.title}\n\n${c.content}`);
      li.oncontextmenu = (e) => {
        e.preventDefault();
        if(confirm('SMASH TABLET?')) { State.cards = State.cards.filter(x=>x.id!==c.id); State.save(); }
      };
      list.appendChild(li);
    });
  },
  search(q) {
    const items = document.getElementById('vault-list').getElementsByTagName('li');
    for(let item of items) item.style.display = item.innerText.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
  }
};

const pinboard = {
  stringMode: false,
  sourceNode: null,
  render() {
    const nL = document.getElementById('note-layer');
    const sL = document.getElementById('string-layer');
    nL.innerHTML = ''; sL.innerHTML = '';
    const pinned = State.cards.filter(c => c.pinned);
    
    // Draw Roots (Strings)
    pinned.forEach(c => {
      c.links.forEach(tid => {
        const t = State.get(tid);
        if(t && t.pinned) this.drawString(c, t, sL);
      });
    });

    // Draw Fragments (Notes)
    pinned.forEach(c => {
      const el = document.createElement('div');
      el.className = 'note ' + c.type.toLowerCase();
      el.style.left = c.x + 'px'; el.style.top = c.y + 'px';
      el.innerHTML = `<b>${c.title}</b><br>${c.content.substring(0,40)}...`;
      el.onmousedown = (e) => this.handleDrag(e, el, c);
      el.ondblclick = () => alert(c.content);
      el.oncontextmenu = (e) => {
        e.preventDefault(); c.pinned = false; State.save(); this.render();
      };
      nL.appendChild(el);
    });
  },
  drawString(n1, n2, layer) {
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', n1.x+90); line.setAttribute('y1', n1.y+50);
    line.setAttribute('x2', n2.x+90); line.setAttribute('y2', n2.y+50);
    line.classList.add('root-string');
    layer.appendChild(line);
  },
  handleDrag(e, el, card) {
    if(this.stringMode) { this.connect(card); return; }
    e.preventDefault(); e.stopPropagation();
    const canvas = document.getElementById('pin-canvas').getBoundingClientRect();
    let shiftX = e.clientX - el.getBoundingClientRect().left;
    let shiftY = e.clientY - el.getBoundingClientRect().top;
    el.style.zIndex = 1000;
    const onMove = (evt) => {
      let x = evt.clientX - shiftX - canvas.left + document.getElementById('pin-canvas').scrollLeft;
      let y = evt.clientY - shiftY - canvas.top + document.getElementById('pin-canvas').scrollTop;
      el.style.left = x + 'px'; el.style.top = y + 'px';
      card.x = x; card.y = y;
    };
    const onUp = () => {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      el.style.zIndex = 2; State.save(); this.render();
    };
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  },
  toggleStringMode() {
    this.stringMode = !this.stringMode;
    document.getElementById('btn-string').innerText = this.stringMode ? "SELECT ORIGIN..." : "root: OFF";
    if(!this.stringMode) this.sourceNode = null;
  },
  connect(card) {
    if(!this.sourceNode) {
        this.sourceNode = card;
        document.getElementById('btn-string').innerText = `GROWING TO: ${card.title}`;
    } else {
        if(this.sourceNode.id === card.id) return;
        this.sourceNode.links.push(card.id);
        State.save();
        this.toggleStringMode();
        this.render();
    }
  },
  openPicker() {
    const list = document.getElementById('evidence-list');
    list.innerHTML = '';
    State.cards.filter(c => !c.pinned).forEach(c => {
        const btn = document.createElement('button');
        btn.className = 'clay-btn'; btn.style.width = '100%'; btn.innerText = c.title;
        btn.onclick = () => {
            c.pinned = true;
            c.x = 50 + Math.random() * 150; c.y = 50 + Math.random() * 150;
            State.save(); this.render();
            document.getElementById('evidence-picker').style.display='none';
        };
        list.appendChild(btn);
    });
    document.getElementById('evidence-picker').style.display = 'flex';
    wm.focus(document.getElementById('evidence-picker'));
  }
};

const bloom = {
  chart: null,
  init() {
    const ctx = document.getElementById('bloomChart').getContext('2d');
    if(this.chart) this.chart.destroy();
    const trunk = State.cards.filter(c=>c.type==='Trunk').length;
    const branch = State.cards.filter(c=>c.type==='Branch').length;
    const leaf = State.cards.filter(c=>c.type==='Leaf').length;
    this.chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Core', 'Obsession', 'Fluff'],
            datasets: [{
                data: [trunk, branch, leaf],
                backgroundColor: ['#c5a059', '#4a5d23', '#00ffff'],
                borderColor: '#000', borderWidth: 1
            }]
        },
        options: { plugins: { legend: { labels: { color: '#c5a059', font: { family: 'Cinzel' } } } } }
    });
  },
  refresh() { if(this.chart) this.init(); }
};

window.onload = () => {
  setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); }, 1000);
  const log = document.getElementById('boot-log');
  setTimeout(() => log.innerHTML += "> DECODING TABLET...<br>", 500);
  setTimeout(() => log.innerHTML += "> ALIGNING LEY LINES...<br>", 1200);
  setTimeout(() => log.innerHTML += "> WELCOME, SCRIBE.<br>", 2000);
  setTimeout(() => document.getElementById('boot-screen').style.display = 'none', 3000);
  State.load();
  wm.initDraggable();
};
</script>
</body>
</html>