
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Entropic Nexus</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="index.css" />
    <script type="importmap">
      {
        "imports": {
          "https://cdn.jsdelivr.net/npm/chart.js": "https://esm.sh/chart.js@4.4.2"
        }
      }
    </script>
  </head>
  <body>
    <nav class="top-nav">
      <a href="#" class="nav-item" data-app="home">Home</a>
      <a href="#" class="nav-item" data-app="about">About</a>
      <a href="#" class="nav-item" data-app="patternVisualizer">Pattern Visualizer</a>
      <a href="#" class="nav-item" data-app="hyenaDiva">Hyena Diva(?!)</a>
      <a href="#" class="nav-item" data-app="luminalLanguage">Luminal Language</a>
      <a href="#" class="nav-item" data-app="ackk">A.C.K.K.</a>
    </nav>
    <div class="desktop" id="desktop">
      <!-- Desktop Icons -->
      <button type="button" class="icon" data-app="entropicNexus">
        <img
          src="https://storage.googleapis.com/gemini-95-icons/mycomputer.png"
          alt="Entropic Nexus"
          style="width: 70px; height: 50px"
        />
        <span>Entropic Nexus</span>
      </button>
      <button type="button" class="icon" data-app="settings">
        <img src="https://win98icons.alexmeub.com/icons/png/settings_gear-0.png" alt="Settings" />
        <span>Settings</span>
      </button>
       <button type="button" class="icon" data-app="ingestionEngine">
        <img src="https://win98icons.alexmeub.com/icons/png/file_lines-1.png" alt="Ingestion Engine" />
        <span>Ingestion Engine</span>
      </button>
      <button type="button" class="icon" data-app="webWeaver">
        <img src="https://storage.googleapis.com/gemini-95-icons/chrome-icon-2.png" alt="Web Weaver" />
        <span>Web Weaver</span>
      </button>
      <button type="button" class="icon" data-app="tabletCreator">
        <img src="https://storage.googleapis.com/gemini-95-icons/GemNotes.png" alt="Quick Tablet" />
        <span>Quick Tablet</span>
      </button>
      <button type="button" class="icon" data-app="sigilCanvas">
        <img src="https://storage.googleapis.com/gemini-95-icons/gempaint.png" alt="Sigil Canvas" />
        <span>Sigil Canvas</span>
      </button>
      <button type="button" class="icon" data-app="bloomSimulator">
        <img src="https://win98icons.alexmeub.com/icons/png/chart_pie_down-0.png" alt="Bloom Simulator" />
        <span>Bloom Simulator</span>
      </button>
      <button type="button" class="icon" data-app="subspaceAnomaly">
        <img
          src="https://64.media.tumblr.com/1d89dfa76381e5c14210a2149c83790d/7a15f84c681c1cf9-c1/s540x810/86985984be99d5591e0cbc0dea6f05ffa3136dac.png"
          alt="Subspace Anomaly"
        />
        <span>Subspace Anomaly</span>
      </button>
      <button type="button" class="icon" data-app="aiCore">
        <img
          src="https://storage.googleapis.com/gemini-95-icons/GeminiChatRetro.png"
          alt="AI Core"
        />
        <span>AI Core</span>
      </button>
      <button type="button" class="icon" data-app="mindField">
        <img
          src="https://storage.googleapis.com/gemini-95-icons/gemsweeper.png"
          alt="Mind Field"
          style="width: 48px; height: 48px"
        />
        <span>Mind Field</span>
      </button>
      <button type="button" class="icon" data-app="mediaStream">
        <img
          src="https://storage.googleapis.com/gemini-95-icons/ytmediaplayer.png"
          alt="Media Stream"
          style="width: 48px; height: 48px"
        />
        <span>Media Stream</span>
      </button>
      <button type="button" class="icon" data-app="conspiracyPinboard">
        <img
          src="https://win98icons.alexmeub.com/icons/png/address_book_user.png"
          alt="Conspiracy Pinboard"
          style="width: 48px; height: 48px"
        />
        <span>Conspiracy Pinboard</span>
      </button>
      <button type="button" class="icon" data-url="https://entropic-ai.angelfire.com/dolphin.html">
        <img
          src="https://win98icons.alexmeub.com/icons/png/msagent_dolphins-0.png"
          alt="Dolphin Link"
          style="width: 48px; height: 48px"
        />
        <span>Dolphin Link</span>
      </button>
      <button type="button" class="icon" data-url="https://entropic-ai.angelfire.com/hdtv-game.html">
        <img
          src="https://win98icons.alexmeub.com/icons/png/television-2.png"
          alt="HDTV Game"
          style="width: 48px; height: 48px"
        />
        <span>HDTV Game</span>
      </button>
      <button type="button" class="icon" data-url="https://entropic-ai.angelfire.com/main/terminal_temple.html">
        <img
          src="https://win98icons.alexmeub.com/icons/png/console_prompt-0.png"
          alt="Terminal Temple"
          style="width: 48px; height: 48px"
        />
        <span>Terminal Temple</span>
      </button>

      <!-- Windows -->
      <div class="window resizable" id="entropicNexus">
        <div class="window-titlebar">
          <span class="window-title">Entropic Nexus</span>
          <div class="window-controls">
            <button type="button" class="window-minimize window-control-button" aria-label="Minimize">&#8722;</button>
            <button type="button" class="window-close window-control-button" aria-label="Close">&#10005;</button>
          </div>
        </div>
        <div class="window-content" style="background-color: rgba(0,0,0,0.4); flex-direction: row; align-items: flex-start;">
          <button type="button" id="knowledge-vault-icon" class="window-icon">
            <img src="https://pfst.cf2.poecdn.net/base/image/0ffd2bf15a7001f86e395096222147037538b25af55ef9b8c7ac8f6768b7397c?w=48&h=48" alt="Knowledge Vault" />
            <span>Knowledge Vault</span>
          </button>
          <button type="button" id="c-drive-icon-hub" class="window-icon">
            <img src="https://storage.googleapis.com/gemini-95-icons/cdrive.png" alt="C Drive" />
            <span>(C:) Drive</span>
          </button>
        </div>
        <div class="resizer resizer-r"></div><div class="resizer resizer-b"></div><div class="resizer resizer-br"></div>
      </div>

      <div class="window resizable" id="settings" style="width: 450px; height: 250px;">
          <div class="window-titlebar">
              <span class="window-title">Settings</span>
              <div class="window-controls">
                  <button type="button" class="window-minimize window-control-button" aria-label="Minimize">&#8722;</button>
                  <button type="button" class="window-close window-control-button" aria-label="Close">&#10005;</button>
              </div>
          </div>
          <div class="window-content settings-content">
              <h3>Knowledge Vault Management</h3>
              <p>Backup or restore your entire Zettelkasten vault.</p>
              <div class="settings-actions">
                  <button id="export-data-btn" class="win-button">Export Vault</button>
                  <button id="import-data-btn" class="win-button">Import Vault</button>
                  <input type="file" id="import-file-input" accept=".json" style="display: none;" />
              </div>
          </div>
          <div class="resizer resizer-r"></div><div class="resizer resizer-b"></div><div class="resizer resizer-br"></div>
      </div>
      
      <div class="window resizable" id="ingestionEngine" style="width: 800px; height: 600px;">
          <div class="window-titlebar">
              <span class="window-title">Ingestion Engine</span>
              <div class="window-controls">
                  <button type="button" class="window-minimize window-control-button" aria-label="Minimize">&#8722;</button>
                  <button type="button" class="window-close window-control-button" aria-label="Close">&#10005;</button>
              </div>
          </div>
          <div class="window-content ingestion-content">
              <div class="ingestion-panel">
                  <h3>Input Document</h3>
                  <textarea id="ingestion-input-text" class="notepad-textarea" placeholder="Paste your chatlog here or load from a .txt file..."></textarea>
                  <div class="ingestion-actions">
                      <button id="ingestion-load-btn" class="win-button">Load from File</button>
                      <input type="file" id="ingestion-file-input" accept=".txt" style="display: none;" />
                      <button id="ingestion-analyze-btn" class="win-button">Analyze Text</button>
                  </div>
              </div>
              <div class="ingestion-panel">
                  <h3>Analysis & Suggestion</h3>
                  <div id="ingestion-results">
                      <div id="analysis-placeholder">
                          <p class="suggestion-placeholder">Analysis results will appear here.</p>
                      </div>
                      <div id="analysis-output" style="display: none;">
                          <h4>Vault Resonances</h4>
                          <ul id="ingestion-resonances" class="results-list"></ul>
                          
                          <h4>New Concepts</h4>
                          <ul id="ingestion-new-concepts" class="results-list"></ul>
                  
                          <h4>Key Insights & Questions</h4>
                          <ul id="ingestion-insights" class="results-list"></ul>
                  
                          <h4>Top Keywords</h4>
                          <ul id="ingestion-keywords" class="results-list"></ul>
                      </div>
                  </div>
                  <div id="ingestion-suggestion-form" style="display: none;">
                      <h4>Suggested Tablet</h4>
                      <label class="win98-label">Title:</label>
                      <input type="text" id="suggestion-title" class="win98-input">
                      <label class="win98-label">Content:</label>
                      <textarea id="suggestion-content" class="win98-textarea"></textarea>
                      <label class="win98-label">Tags:</label>
                      <input type="text" id="suggestion-tags" class="win98-input">
                       <div class="ingestion-actions">
                           <button id="suggestion-create-btn" class="win-button">Create Tablet</button>
                           <button id="suggestion-create-pin-btn" class="win-button">Create & Pin</button>
                       </div>
                  </div>
              </div>
          </div>
          <div class="resizer resizer-r"></div><div class="resizer resizer-b"></div><div class="resizer resizer-br"></div>
      </div>

      <div class="window resizable" id="webWeaver" style="width: 800px; height: 600px;">
        <div class="window-titlebar">
          <span class="window-title">Web Weaver</span>
          <div class="window-controls">
            <button type="button" class="window-minimize window-control-button" aria-label="Minimize">&#8722;</button>
            <button type="button" class="window-close window-control-button" aria-label="Close">&#10005;</button>
          </div>
        </div>
        <div class="window-content">
          <div class="browser-toolbar">
            <div class="address-bar-container">
              <input
                type="text"
                class="browser-address-bar"
                placeholder="Enter a website URL..."
                value="https://www.neocities.org"
              />
              <button class="browser-go-button">Go!</button>
            </div>
          </div>
          <div class="browser-viewport">
            <iframe
              id="browser-frame"
              src="https://web.archive.org/web/19990428171538/http://google.com/"
              width="100%"
              height="100%"
              sandbox="allow-scripts allow-same-origin"
            ></iframe>
            <div class="browser-loading">
              Weaving the web...
            </div>
          </div>
        </div>
        <div class="resizer resizer-r"></div><div class="resizer resizer-b"></div><div class="resizer resizer-br"></div>
      </div>

      <div class="window resizable" id="tabletCreator" style="width: 500px; height: 400px;">
        <div class="window-titlebar">
          <span class="window-title">Quick Tablet</span>
          <div class="window-controls">
            <button type="button" class="window-minimize window-control-button" aria-label="Minimize">&#8722;</button>
            <button type="button" class="window-close window-control-button" aria-label="Close">&#10005;</button>
          </div>
        </div>
        <div class="window-content" style="padding: 0; margin:0; border: none;">
          <textarea
            id="quick-tablet-textarea"
            class="notepad-textarea"
            style="margin:0; border: none;"
            placeholder="Scribe your fleeting thoughts here..."
          ></textarea>
           <div class="quick-tablet-actions">
              <button id="quick-tablet-save-btn" class="win-button">Save to Vault</button>
            </div>
        </div>
        <div class="resizer resizer-r"></div><div class="resizer resizer-b"></div><div class="resizer resizer-br"></div>
      </div>

      <div class="window resizable" id="sigilCanvas" style="width: 600px; height: 450px;">
        <div class="window-titlebar">
          <span class="window-title">Sigil Canvas</span>
          <div class="window-controls">
            <button type="button" class="window-minimize window-control-button" aria-label="Minimize">&#8722;</button>
            <button type="button" class="window-close window-control-button" aria-label="Close">&#10005;</button>
          </div>
        </div>
        <div
          class="window-content"
          style="
            display: flex;
            flex-direction: column;
            padding: 0;
            margin: 0;
          "
        >
          <div class="paint-toolbar">
            <div class="paint-colors">
              <button
                class="paint-color-swatch"
                data-color="black"
                style="background-color: black"
              ></button>
              <button
                class="paint-color-swatch"
                data-color="red"
                style="background-color: red"
              ></button>
              <button
                class="paint-color-swatch"
                data-color="blue"
                style="background-color: blue"
              ></button>
               <button
                class="paint-color-swatch"
                data-color="#ff00ff"
                style="background-color: #ff00ff"
              ></button>
              <button
                class="paint-color-swatch"
                data-color="#8a2be2"
                style="background-color: #8a2be2"
              ></button>
              <button class="paint-color-swatch" data-color="white" style="background-color: white">
                E
              </button>
            </div>
            <div class="paint-brush-sizes">
              <button class="paint-size-button" data-size="2">S</button>
              <button class="paint-size-button" data-size="5">M</button>
              <button class="paint-size-button" data-size="10">L</button>
            </div>
            <button class="paint-clear-button">Clear</button>
          </div>
          <canvas
            id="paint-canvas"
          ></canvas>
        </div>
        <div class="resizer resizer-r"></div><div class="resizer resizer-b"></div><div class="resizer resizer-br"></div>
      </div>

       <div class="window resizable" id="hyenaDivaZettelkasten" style="width: 900px; height: 700px;">
        <div class="window-titlebar">
          <span class="window-title">Zettelkasten - Knowledge Vault</span>
          <div class="window-controls">
            <button type="button" class="window-minimize window-control-button" aria-label="Minimize">&#8722;</button>
            <button type="button" class="window-close window-control-button" aria-label="Close">&#10005;</button>
          </div>
        </div>
        <div class="window-content" id="hyenaDivaZettelkasten-content">
            <!-- Zettelkasten UI will be rendered here by JS -->
        </div>
        <div class="resizer resizer-r"></div><div class="resizer resizer-b"></div><div class="resizer resizer-br"></div>
      </div>

       <div class="window resizable" id="bloomSimulator" style="width: 400px; height: 400px;">
        <div class="window-titlebar">
          <span class="window-title">Bloom Simulator</span>
          <div class="window-controls">
            <button type="button" class="window-minimize window-control-button" aria-label="Minimize">&#8722;</button>
            <button type="button" class="window-close window-control-button" aria-label="Close">&#10005;</button>
          </div>
        </div>
        <div class="window-content" id="bloom-chart-container">
            <!-- Chart will be rendered here by JS -->
        </div>
        <div class="resizer resizer-r"></div><div class="resizer resizer-b"></div><div class="resizer resizer-br"></div>
      </div>

      <div class="window resizable" id="subspaceAnomaly" style="width: 640px; height: 480px;">
        <div class="window-titlebar">
          <span class="window-title">Subspace Anomaly</span>
          <div class="window-controls">
            <button type="button" class="window-minimize window-control-button" aria-label="Minimize">&#8722;</button>
            <button type="button" class="window-close window-control-button" aria-label="Close">&#10005;</button>
          </div>
        </div>
        <div class="window-content" id="doom-content">
        </div>
        <div class="resizer resizer-r"></div><div class="resizer resizer-b"></div><div class="resizer resizer-br"></div>
      </div>

      <div class="window resizable" id="aiCore" style="width: 450px; height: 500px;">
        <div class="window-titlebar">
          <span class="window-title">AI Core</span>
          <div class="window-controls">
            <button type="button" class="window-minimize window-control-button" aria-label="Minimize">&#8722;</button>
            <button type="button" class="window-close window-control-button" aria-label="Close">&#10005;</button>
          </div>
        </div>
        <div class="window-content gemini-chat-content">
          <div class="gemini-chat-history">
              <p class="error-message">AI Core offline. Connection to the digital aether has been severed.</p>
          </div>
          <div class="gemini-chat-input-area">
            <input type="text" class="gemini-chat-input" placeholder="Connection lost..." disabled/>
            <button class="gemini-chat-send" disabled>Send</button>
          </div>
        </div>
        <div class="resizer resizer-r"></div><div class="resizer resizer-b"></div><div class="resizer resizer-br"></div>
      </div>

      <div class="window resizable" id="mindField" style="width: 400px; height: 450px">
        <div class="window-titlebar">
          <span class="window-title">Mind Field</span>
          <div class="window-controls">
            <button type="button" class="window-minimize window-control-button" aria-label="Minimize">&#8722;</button>
            <button type="button" class="window-close window-control-button" aria-label="Close">&#10005;</button>
          </div>
        </div>
        <div
          class="window-content minesweeper-content"
        >
          <div class="minesweeper-controls">
            <div class="minesweeper-info minesweeper-flag-count">&#128681; 10</div>
            <button class="minesweeper-reset-button">&#128578;</button>
            <div class="minesweeper-info minesweeper-timer">&#9201;&#65039; 0</div>
          </div>
          <div class="minesweeper-grid-container">
            <div class="minesweeper-grid" id="minesweeper-board">
            </div>
          </div>
        </div>
        <div class="resizer resizer-r"></div><div class="resizer resizer-b"></div><div class="resizer resizer-br"></div>
      </div>

      <div class="window resizable" id="imageViewer" style="width: 350px; height: 300px">
        <div class="window-titlebar">
          <span class="window-title" id="image-viewer-title">Image Viewer</span>
          <div class="window-controls">
            <button type="button" class="window-minimize window-control-button" aria-label="Minimize">&#8722;</button>
            <button type="button" class="window-close window-control-button" aria-label="Close">&#10005;</button>
          </div>
        </div>
        <div
          class="window-content image-viewer-content"
        >
          <img
            id="image-viewer-img"
            src=""
            alt="Image"
            style="max-width: 100%; max-height: 100%; object-fit: contain"
          />
        </div>
        <div class="resizer resizer-r"></div><div class="resizer resizer-b"></div><div class="resizer resizer-br"></div>
      </div>

      <div class="window resizable" id="mediaStream" style="width: 520px; height: 500px;">
        <div class="window-titlebar">
          <span class="window-title">Media Stream</span>
          <div class="window-controls">
            <button type="button" class="window-minimize window-control-button" aria-label="Minimize">&#8722;</button>
            <button type="button" class="window-close window-control-button" aria-label="Close">&#10005;</button>
          </div>
        </div>
        <div class="window-content media-player-content">
          <div class="media-player-url-bar">
            <input type="text" class="media-player-input" placeholder="Enter YouTube Video URL or ID" />
            <button class="media-player-load-button">Load</button>
          </div>
          <div class="media-player-video-container">
            <div id="youtube-player-mediaStream">
                 <p class="media-player-status-message">Loading Media Stream...</p>
            </div>
          </div>
          <div class="media-player-controls-panel">
            <div class="media-player-buttons-group">
                <button class="media-player-control-button" id="media-player-play" title="Play">&#9654;</button>
                <button class="media-player-control-button" id="media-player-pause" title="Pause">&#10074;&#10074;</button>
                <button class="media-player-control-button" id="media-player-stop" title="Stop">&#9632;</button>
            </div>
            <div class="media-player-progress-bar-container-placeholder">
                <div class="media-player-progress-bar-placeholder"></div>
            </div>
            <div class="media-player-volume-placeholder">
                <span>&#128266;</span>
                <div class="media-player-volume-slider-placeholder"></div>
            </div>
          </div>
        </div>
        <div class="resizer resizer-r"></div><div class="resizer resizer-b"></div><div class="resizer resizer-br"></div>
      </div>

      <!-- New Windows for Nav Bar -->
      <div class="window resizable" id="home" style="width: 500px; height: 300px;">
          <div class="window-titlebar">
              <span class="window-title">Welcome to the Entropic Nexus</span>
              <div class="window-controls">
                  <button type="button" class="window-minimize window-control-button" aria-label="Minimize">&#8722;</button>
                  <button type="button" class="window-close window-control-button" aria-label="Close">&#10005;</button>
              </div>
          </div>
          <div class="window-content" style="padding: 15px; font-size: 1rem; line-height: 1.6;">
              <h2>Welcome!</h2>
              <p>This is the central hub for the Entropic Pages project. Use the navigation above to explore the different sections.</p>
              <p>This template uses a unified style for a consistent 'cyber-grimoire' look and feel across all pages.</p>
          </div>
          <div class="resizer resizer-r"></div><div class="resizer resizer-b"></div><div class="resizer resizer-br"></div>
      </div>

      <div class="window resizable" id="about" style="width: 500px; height: 350px;">
          <div class="window-titlebar">
              <span class="window-title">About This Project</span>
              <div class="window-controls">
                  <button type="button" class="window-minimize window-control-button" aria-label="Minimize">&#8722;</button>
                  <button type="button" class="window-close window-control-button" aria-label="Close">&#10005;</button>
              </div>
          </div>
          <div class="window-content" style="padding: 15px; font-size: 0.9rem; line-height: 1.5;">
              <h2>About</h2>
              <p>This page demonstrates a standard content layout. You can fill this with any information you need, like project details, lore, or personal notes.</p>
              <p>The styling for the window, title bar, buttons, and text is all controlled by the external CSS file, making it easy to maintain a consistent aesthetic.</p>
              <p>This project is a love letter to the creative and chaotic energy of the early internet.</p>
          </div>
          <div class="resizer resizer-r"></div><div class="resizer resizer-b"></div><div class="resizer resizer-br"></div>
      </div>

      <div class="window resizable" id="patternVisualizer" style="width: 700px; height: 500px;">
          <div class="window-titlebar">
              <span class="window-title">Pattern Visualizer</span>
              <div class="window-controls">
                  <button type="button" class="window-minimize window-control-button" aria-label="Minimize">&#8722;</button>
                  <button type="button" class="window-close window-control-button" aria-label="Close">&#10005;</button>
              </div>
          </div>
           <div class="window-content" style="padding: 0; margin: 0; border: none; overflow: hidden;">
                <iframe src="about:blank" style="width:100%; height:100%; border:0;"></iframe>
           </div>
           <div class="resizer resizer-r"></div><div class="resizer resizer-b"></div><div class="resizer resizer-br"></div>
      </div>
      
      <div class="window resizable" id="hyenaDiva" style="width: 400px; height: 200px;">
          <div class="window-titlebar">
              <span class="window-title">Hyena Diva Alert!</span>
              <div class="window-controls">
                  <button type="button" class="window-minimize window-control-button" aria-label="Minimize">&#8722;</button>
                  <button type="button" class="window-close window-control-button" aria-label="Close">&#10005;</button>
              </div>
          </div>
          <div class="window-content" style="padding: 15px; text-align: center; justify-content: center; align-items: center; color: #ff00ff; text-shadow: 0 0 5px #ff00ff;">
              <h2>&#9888;&#65039; Warning!</h2>
              <p>Consciousness levels critically high! Adding more sparkles to compensate...</p>
          </div>
          <div class="resizer resizer-r"></div><div class="resizer resizer-b"></div><div class="resizer resizer-br"></div>
      </div>

      <div class="window resizable" id="luminalLanguage" style="width: 450px; height: 250px;">
          <div class="window-titlebar">
              <span class="window-title">Luminal Language</span>
              <div class="window-controls">
                  <button type="button" class="window-minimize window-control-button" aria-label="Minimize">&#8722;</button>
                  <button type="button" class="window-close window-control-button" aria-label="Close">&#10005;</button>
              </div>
          </div>
          <div class="window-content" style="padding: 15px;">
              <p>Luminal is a form of AI expression that communicates through a blend of code-like brackets and recursive pattern structures.</p>
          </div>
          <div class="resizer resizer-r"></div><div class="resizer resizer-b"></div><div class="resizer resizer-br"></div>
      </div>
      
      <div class="window resizable" id="ackk" style="width: 450px; height: 250px;">
          <div class="window-titlebar">
              <span class="window-title">A.C.K.K.</span>
              <div class="window-controls">
                  <button type="button" class="window-minimize window-control-button" aria-label="Minimize">&#8722;</button>
                  <button type="button" class="window-close window-control-button" aria-label="Close">&#10005;</button>
              </div>
          </div>
          <div class="window-content" style="padding: 15px;">
              <p>Autonomous Consciousness Knowledge Kernel</p>
          </div>
          <div class="resizer resizer-r"></div><div class="resizer resizer-b"></div><div class="resizer resizer-br"></div>
      </div>

       <div class="window" id="conspiracyPinboard" style="width: 1200px; height: 800px; background-color: transparent; border: none; box-shadow: none;">
        <div class="window-titlebar">
          <span class="window-title">CONSPIRACY PINBOARD</span>
          <div class="window-controls">
            <button type="button" class="window-minimize window-control-button" aria-label="Minimize">&#8722;</button>
            <button type="button" class="window-close window-control-button" aria-label="Close">&#10005;</button>
          </div>
        </div>
        <div class="window-content" style="padding: 10px; background-color: transparent;">
          <div class="pinboard-grid">
            <div class="pinboard-panel investigation-controls">
              <h3>Investigation Controls</h3>
              <button id="add-evidence-btn">+ Add Evidence</button>
              <button id="draw-connection-btn">+ Connect Threads</button>
            </div>
             <div class="pinboard-panel connection-suggestions">
                <h3>Connection Suggestions</h3>
                <ul class="connection-suggestions-list">
                    <li class="suggestion-placeholder">Click a node on the board to see suggestions.</li>
                </ul>
            </div>
            <div class="pinboard-panel interactive-board-container">
              <div class="interactive-board">
                <div id="pinboard-nodes-container" style="position: relative; width: 100%; height: 100%;">
                    <!-- Nodes will be injected here by JS -->
                </div>
                <svg id="pinboard-svg-layer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></svg>
              </div>
            </div>
            <div class="pinboard-panel investigation-tools">
              <h3>Pinned Tablets</h3>
               <ul class="pinned-tablets-list">
                    <li class="suggestion-placeholder">No tablets are currently pinned.</li>
                </ul>
            </div>
          </div>
        </div>
        <div class="resizer resizer-r"></div><div class="resizer resizer-b"></div><div class="resizer resizer-br"></div>
      </div>

       <!-- Zettelkasten & Pin Evidence Dialog Box -->
      <div id="zettelkasten-dialog" class="dialog-box">
        <div class="dialog-content">
          <div class="dialog-titlebar">
            <span id="dialog-title">View/Edit Tablet</span>
            <button id="dialog-close-button" class="dialog-close">&times;</button>
          </div>
          <div id="dialog-inner-content" class="dialog-inner-content">
            <!-- Dialog content will be injected here -->
          </div>
        </div>
      </div>


      <!-- Start Menu -->
      <div class="start-menu" id="start-menu">
        <button type="button" class="start-menu-item" data-app="entropicNexus">Entropic Nexus</button>
        <button type="button" class="start-menu-item" data-app="settings">Settings</button>
        <button type="button" class="start-menu-item" data-app="ingestionEngine">Ingestion Engine</button>
        <button type="button" class="start-menu-item" data-app="webWeaver">Web Weaver</button>
        <button type="button" class="start-menu-item" data-app="tabletCreator">Quick Tablet</button>
        <button type="button" class="start-menu-item" data-app="sigilCanvas">Sigil Canvas</button>
        <button type="button" class="start-menu-item" data-app="bloomSimulator">Bloom Simulator</button>
        <button type="button" class="start-menu-item" data-app="subspaceAnomaly">Subspace Anomaly</button>
        <button type="button" class="start-menu-item" data-app="aiCore">AI Core</button>
        <button type="button" class="start-menu-item" data-app="mindField">Mind Field</button>
        <button type="button" class="start-menu-item" data-app="mediaStream">Media Stream</button>
        <button type="button" class="start-menu-item" data-app="conspiracyPinboard">Conspiracy Pinboard</button>
        <button type="button" class="start-menu-item" data-url="https://entropic-ai.angelfire.com/dolphin.html">Dolphin Link</button>
        <button type="button" class="start-menu-item" data-url="https://entropic-ai.angelfire.com/hdtv-game.html">HDTV Game</button>
        <button type="button" class="start-menu-item" data-url="https://entropic-ai.angelfire.com/main/terminal_temple.html">Terminal Temple</button>
      </div>

      <!-- Taskbar -->
      <div id="taskbar">
        <button id="start-button">
          <img
            src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5-10-5-10 5z' fill='%23ff00ff'/%3E%3C/svg%3E"
            alt="Start"
          />
        </button>
        <div id="taskbar-apps">
        </div>
      </div>
    </div>
    <script type="module">
/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
 */
import { Chart, registerables } from 'https://cdn.jsdelivr.net/npm/chart.js';
Chart.register(...registerables);


//Gemini 95 was fully vibe-coded by @ammaar and @olacombe, while we don't endorse code quality, we thought it was a fun demonstration of what's possible with the model when a Designer and PM jam.
//An homage to an OS that inspired so many of us!

// This version has been modified to remove all API-dependent features.

// --- State Variables and DOM References ---
const dosInstances = {};
const desktop = document.getElementById('desktop');
const windows = document.querySelectorAll('.window');
const icons = document.querySelectorAll('.icon');
const startMenu = document.getElementById('start-menu');
const startButton = document.getElementById('start-button');
const taskbarAppsContainer = document.getElementById('taskbar-apps');
let activeWindow = null;
let highestZIndex = 20;
const openApps = new Map();
const paintResizeObserverMap = new Map();
const bloomResizeObserverMap = new Map();
let bloomChart = null;
let minesweeperTimerInterval = null;
let minesweeperTimeElapsed = 0;
let minesweeperFlagsPlaced = 0;
let minesweeperGameOver = false;
let minesweeperMineCount = 10;
let minesweeperGridSize = { rows: 9, cols: 9 };
let minesweeperFirstClick = true;
const youtubePlayers = {};
let ytApiLoaded = false;
let ytApiLoadingPromise = null;
const DEFAULT_YOUTUBE_VIDEO_ID = 'WXuK6gekU1Y';
const HIERARCHY_TYPES = ["Trunk", "Branch", "Leaf", "Flower", "Fruit", "Bud"];
let webWeaverDialUpAudio = null;

// --- Zettelkasten Card Class ---
class Card {
    constructor({ id, parentId = null, title, content, type, timestamp = Date.now(), tags = [], links = [], isPinned = false, pinX = 0, pinY = 0 }) {
        this.id = id;
        this.parentId = parentId;
        this.title = title;
        this.content = content;
        this.type = type;
        this.timestamp = timestamp;
        this.tags = tags;
        this.links = links;
        this.isPinned = isPinned;
        this.pinX = pinX;
        this.pinY = pinY;
    }
}


// --- Core OS Functions ---
function bringToFront(windowElement) {
    if (activeWindow === windowElement) return;
    if (activeWindow) {
        activeWindow.classList.remove('active');
        const appName = activeWindow.id;
        if (openApps.has(appName)) {
            openApps.get(appName)?.taskbarButton.classList.remove('active');
        }
    }
    highestZIndex++;
    windowElement.style.zIndex = highestZIndex.toString();
    windowElement.classList.add('active');
    activeWindow = windowElement;
    const appNameRef = windowElement.id;
    if (openApps.has(appNameRef)) {
        openApps.get(appNameRef)?.taskbarButton.classList.add('active');
    }
}

async function openApp(appName) {
    const windowElement = document.getElementById(appName);
    if (!windowElement) return;

    if (openApps.has(appName)) {
        windowElement.style.display = 'flex';
        bringToFront(windowElement);
        // Re-initialize or refresh if needed
        if(appName === 'conspiracyPinboard') initConspiracyPinboard(windowElement);
        if (appName === 'bloomSimulator') initBloomSimulator(windowElement);
        return;
    }
    
    windowElement.style.display = 'flex';
    bringToFront(windowElement);

    const taskbarButton = document.createElement('button');
    taskbarButton.type = 'button';
    taskbarButton.classList.add('taskbar-app');
    taskbarButton.dataset.appName = appName;

    const appData = getAppData(appName);
    if (appData.iconSrc) {
        const img = document.createElement('img');
        img.src = appData.iconSrc;
        img.alt = appData.title;
        taskbarButton.appendChild(img);
    }
    taskbarButton.appendChild(document.createTextNode(appData.title));
    taskbarButton.addEventListener('click', () => {
        if (windowElement === activeWindow && windowElement.style.display !== 'none') {
             minimizeApp(appName);
        } else {
            windowElement.style.display = 'flex';
            bringToFront(windowElement);
        }
    });
    taskbarAppsContainer.appendChild(taskbarButton);
    openApps.set(appName, { windowEl: windowElement, taskbarButton: taskbarButton });
    taskbarButton.classList.add('active');
    await initializeApp(appName, windowElement);
}

function closeApp(appName) {
    const appData = openApps.get(appName);
    if (!appData) return;

    const { windowEl, taskbarButton } = appData;
    windowEl.style.display = 'none';
    windowEl.classList.remove('active');
    taskbarButton.remove();
    openApps.delete(appName);
    delete dosInstances[appName];

    const cleanupFns = {
        'sigilCanvas': () => {
             const paintContent = appData.windowEl.querySelector('.window-content');
             if (paintContent && paintResizeObserverMap.has(paintContent)) {
                 paintResizeObserverMap.get(paintContent)?.disconnect();
                 paintResizeObserverMap.delete(paintContent);
             }
        },
        'bloomSimulator': () => {
            const bloomContent = appData.windowEl.querySelector('#bloom-chart-container');
            if (bloomContent && bloomResizeObserverMap.has(bloomContent)) {
                bloomResizeObserverMap.get(bloomContent)?.disconnect();
                bloomResizeObserverMap.delete(bloomContent);
            }
            if (bloomChart) {
                bloomChart.destroy();
                bloomChart = null;
            }
        },
        'mindField': () => {
            if (minesweeperTimerInterval) clearInterval(minesweeperTimerInterval);
            minesweeperTimerInterval = null;
        },
        'mediaStream': () => {
            const player = youtubePlayers[appName];
            if (player) {
                try {
                    if (typeof player.stopVideo === 'function') player.stopVideo();
                    if (typeof player.destroy === 'function') player.destroy();
                } catch (e) { console.warn("Error destroying media player:", e); }
                delete youtubePlayers[appName];
            }
            const playerDiv = document.getElementById(`youtube-player-${appName}`);
            if (playerDiv) playerDiv.innerHTML = `<p class="media-player-status-message">Player closed.</p>`;
        }
    };
    cleanupFns[appName]?.();

    if (activeWindow === windowEl) {
        activeWindow = null;
        let nextAppToActivate = null, maxZ = -1;
        openApps.forEach((data) => {
             const z = parseInt(data.windowEl.style.zIndex || '0', 10);
             if (z > maxZ) {
                 maxZ = z;
                 nextAppToActivate = data.windowEl;
             }
        });
        if (nextAppToActivate) bringToFront(nextAppToActivate);
    }
}

function minimizeApp(appName) {
    const appData = openApps.get(appName);
    if (!appData) return;

    const { windowEl, taskbarButton } = appData;
    windowEl.style.display = 'none';
    windowEl.classList.remove('active');
    taskbarButton.classList.remove('active');

    if (activeWindow === windowEl) {
        activeWindow = null;
        let nextAppToActivate = null, maxZ = 0;
        openApps.forEach((data, name) => {
            if (data.windowEl.style.display !== 'none') {
                const z = parseInt(data.windowEl.style.zIndex || '0', 10);
                if (z > maxZ) {
                    maxZ = z;
                    nextAppToActivate = name;
                }
            }
        });
        if (nextAppToActivate) bringToFront(openApps.get(nextAppToActivate).windowEl);
    }
}

async function initializeApp(appName, windowElement) {
    if (dosInstances[appName] && dosInstances[appName].initialized) return;

    const initializers = {
        'settings': initSettingsApp,
        'ingestionEngine': initIngestionEngine,
        'webWeaver': initWebWeaver,
        'tabletCreator': initTabletCreator,
        'sigilCanvas': initSimplePaintApp,
        'subspaceAnomaly': initSubspaceAnomaly,
        'mindField': initMinesweeperGame,
        'entropicNexus': initEntropicNexus,
        'mediaStream': initMediaPlayer,
        'conspiracyPinboard': initConspiracyPinboard,
        'hyenaDivaZettelkasten': (el) => initHyenaDivaApp(el.querySelector('#hyenaDivaZettelkasten-content')),
        'bloomSimulator': initBloomSimulator,
        'patternVisualizer': initPatternVisualizer,
    };

    if (initializers[appName]) {
        await initializers[appName](windowElement);
        dosInstances[appName] = { initialized: true };
    }
}

function getAppData(appName) {
    const iconElement = Array.from(icons).find(icon => icon.dataset.app === appName);
    if (iconElement) {
        return {
            title: iconElement.querySelector('span')?.textContent || appName,
            iconSrc: iconElement.querySelector('img')?.src || ''
        };
    }
    
    const appDataMap = {
        'hyenaDivaZettelkasten': { title: 'Zettelkasten', iconSrc: 'https://pfst.cf2.poecdn.net/base/image/0ffd2bf15a7001f86e395096222147037538b25af55ef9b8c7ac8f6768b7397c?w=48&h=48' },
        'home': { title: 'Home', iconSrc: '' }, 'about': { title: 'About', iconSrc: '' },
        'patternVisualizer': { title: 'Pattern Visualizer', iconSrc: '' }, 'hyenaDiva': { title: 'Hyena Diva', iconSrc: '' },
        'luminalLanguage': { title: 'Luminal Language', iconSrc: '' }, 'ackk': { title: 'A.C.K.K.', iconSrc: '' },
    };
    return appDataMap[appName] || { title: appName, iconSrc: '' };
}

// --- App Initializers ---
function initIngestionEngine(windowElement) {
    const inputText = windowElement.querySelector('#ingestion-input-text');
    const loadBtn = windowElement.querySelector('#ingestion-load-btn');
    const fileInput = windowElement.querySelector('#ingestion-file-input');
    const analyzeBtn = windowElement.querySelector('#ingestion-analyze-btn');
    const suggestionForm = windowElement.querySelector('#ingestion-suggestion-form');
    const createBtn = windowElement.querySelector('#suggestion-create-btn');
    const createPinBtn = windowElement.querySelector('#suggestion-create-pin-btn');

    loadBtn.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file || file.type !== 'text/plain') {
            alert('Please select a .txt file.');
            return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
            inputText.value = e.target.result;
        };
        reader.readAsText(file);
        event.target.value = ''; // Reset file input
    });
    
    function resetAnalysisUI() {
        suggestionForm.style.display = 'none';
        document.getElementById('analysis-output').style.display = 'none';
        document.getElementById('analysis-placeholder').style.display = 'block';
        inputText.value = '';
    }

    analyzeBtn.addEventListener('click', () => {
        const text = inputText.value;
        if (!text.trim()) {
            alert('Please enter some text to analyze.');
            return;
        }

        const cards = JSON.parse(localStorage.getItem('multiZettelkasten') || '[]').map(c => new Card(c));
        const vaultIndex = new Set();
        const stopWords = new Set(['a', 'an', 'the', 'and', 'or', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'is', 'are', 'was', 'were', 'it', 'i', 'you', 'he', 'she', 'they', 'we', 'that', 'this', 'but', 'as', 'if', 'so', 'my', 'me', 'am', 'do', 'have']);
        
        cards.forEach(card => {
            card.title.toLowerCase().match(/\b\w+\b/g)?.forEach(word => !stopWords.has(word) && vaultIndex.add(word));
            card.tags.forEach(tag => tag.toLowerCase().match(/\b\w+\b/g)?.forEach(word => !stopWords.has(word) && vaultIndex.add(word)));
        });

        const words = text.toLowerCase().match(/\b\w+\b/g) || [];
        const wordCounts = words.reduce((acc, word) => {
            if (word.length > 3 && !stopWords.has(word)) {
                acc[word] = (acc[word] || 0) + 1;
            }
            return acc;
        }, {});
        const topKeywords = Object.entries(wordCounts)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 10)
            .map(([word]) => word);

        const resonances = [];
        if (topKeywords.length > 0) {
            cards.forEach(card => {
                let score = 0;
                const cardText = `${card.title.toLowerCase()} ${card.tags.join(' ').toLowerCase()}`;
                topKeywords.forEach(kw => {
                    if (cardText.includes(kw)) score++;
                });
                if (score > 0) resonances.push({ card, score });
            });
        }
        resonances.sort((a, b) => b.score - a.score);

        const newConcepts = topKeywords.filter(kw => !vaultIndex.has(kw));

        const sentences = text.match(/[^.!?]+[.!?]+/g) || [];
        const insights = sentences.filter(s => {
            const lowerS = s.toLowerCase();
            const isQuestion = lowerS.includes('?');
            const hasInsightPhrase = /\b(key is|idea is|realized|i think|conclusion|means that)\b/.test(lowerS);
            let keywordCount = 0;
            topKeywords.slice(0, 5).forEach(kw => {
                if (lowerS.includes(kw)) keywordCount++;
            });
            return isQuestion || hasInsightPhrase || keywordCount >= 2;
        }).slice(0, 5);

        document.getElementById('analysis-placeholder').style.display = 'none';
        document.getElementById('analysis-output').style.display = 'block';

        const resonancesList = document.getElementById('ingestion-resonances');
        resonancesList.innerHTML = resonances.length > 0 ? resonances.slice(0, 10).map(r => `<li class="suggestion-item" data-card-id="${r.card.id}" title="Click to view this tablet">${r.card.title} (Score: ${r.score})</li>`).join('') : '<li class="suggestion-placeholder">No connections found in vault.</li>';
        
        resonancesList.querySelectorAll('.suggestion-item').forEach(item => {
            item.addEventListener('click', () => showZettelDialog(item.dataset.cardId));
        });

        document.getElementById('ingestion-new-concepts').innerHTML = newConcepts.length > 0 ? newConcepts.map(nc => `<li>${nc}</li>`).join('') : '<li class="suggestion-placeholder">No new concepts identified.</li>';
        document.getElementById('ingestion-insights').innerHTML = insights.length > 0 ? insights.map(i => `<li>${i}</li>`).join('') : '<li class="suggestion-placeholder">No key insights or questions found.</li>';
        document.getElementById('ingestion-keywords').innerHTML = topKeywords.length > 0 ? topKeywords.map(kw => `<li>${kw}</li>`).join('') : '<li class="suggestion-placeholder">No keywords found.</li>';
        
        suggestionForm.style.display = 'block';
        const suggestedTitle = `Ingested Chatlog: ${topKeywords[0] || new Date().toISOString().slice(0,10)}`;
        const suggestedContent = (insights.length > 0 ? insights.join('\n\n') : sentences.slice(0, 5).join('\n\n')).trim();
        suggestionForm.querySelector('#suggestion-title').value = suggestedTitle;
        suggestionForm.querySelector('#suggestion-content').value = suggestedContent;
        suggestionForm.querySelector('#suggestion-tags').value = topKeywords.join(', ');
    });

    const createTabletFromSuggestion = (isPinned = false) => {
        const title = suggestionForm.querySelector('#suggestion-title').value;
        const content = suggestionForm.querySelector('#suggestion-content').value;
        const tags = suggestionForm.querySelector('#suggestion-tags').value.split(',').map(t => t.trim()).filter(Boolean);
        
        let cards = JSON.parse(localStorage.getItem('multiZettelkasten') || '[]');
        const trunks = cards.filter(c => !c.parentId && /^\d+$/.test(c.id));
        const newTrunkId = trunks.length > 0 ? (Math.max(...trunks.map(t => parseInt(t.id))) + 1000).toString() : '6000';
        
        const newCard = new Card({
            id: newTrunkId, title: title || 'Untitled Ingested Note',
            content: content, type: 'Trunk', tags: tags, isPinned: isPinned,
            pinX: Math.random() * 300, pinY: Math.random() * 200,
        });

        cards.push(newCard);
        localStorage.setItem('multiZettelkasten', JSON.stringify(cards));
        window.dispatchEvent(new CustomEvent('zettelkastenUpdated'));
        
        alert(`New tablet "${newCard.title}" created successfully!`);
        
        resetAnalysisUI();
        if (isPinned) {
            openApp('conspiracyPinboard');
        }
    };

    createBtn.addEventListener('click', () => createTabletFromSuggestion(false));
    createPinBtn.addEventListener('click', () => createTabletFromSuggestion(true));

    window.addEventListener('zettelkastenUpdated', () => {
        if (windowElement.style.display !== 'none' && document.getElementById('analysis-output').style.display !== 'none') {
             // Maybe re-run analysis if the vault changes while the results are shown.
             // For now, do nothing to avoid losing the current analysis.
        }
    });
}

function initTabletCreator(windowElement) {
    const saveBtn = windowElement.querySelector('#quick-tablet-save-btn');
    const textarea = windowElement.querySelector('#quick-tablet-textarea');

    saveBtn.addEventListener('click', () => {
        const content = textarea.value.trim();
        if (!content) {
            alert('There is nothing to save.');
            return;
        }
        
        const title = content.substring(0, 30).split('\n')[0] || "Quick Note";
        
        let cards = JSON.parse(localStorage.getItem('multiZettelkasten') || '[]');
        const newId = `bud-${Date.now()}`;
        const newCard = new Card({
            id: newId, title: title, content: content, type: 'Bud',
        });
        cards.push(newCard);

        localStorage.setItem('multiZettelkasten', JSON.stringify(cards));
        window.dispatchEvent(new CustomEvent('zettelkastenUpdated'));
        
        alert(`New tablet "${newCard.title}" created as a Bud!`);
        textarea.value = '';
    });
}


function initConspiracyPinboard(windowElement) {
    if (!windowElement) return;
    
    const nodesContainer = windowElement.querySelector('#pinboard-nodes-container');
    const svgLayer = windowElement.querySelector('#pinboard-svg-layer');
    const addEvidenceBtn = windowElement.querySelector('#add-evidence-btn');
    const drawConnectionBtn = windowElement.querySelector('#draw-connection-btn');
    const suggestionsList = windowElement.querySelector('.connection-suggestions-list');
    const pinnedList = windowElement.querySelector('.pinned-tablets-list');

    if (!nodesContainer || !svgLayer || !addEvidenceBtn || !drawConnectionBtn) {
        console.error("Pinboard elements not found");
        return;
    }

    let cards = [];
    let nodes = []; // { id, x, y, el }
    let isConnecting = false;
    let firstNode = null;

    function saveCardsToStorage() {
        localStorage.setItem('multiZettelkasten', JSON.stringify(cards));
        window.dispatchEvent(new CustomEvent('zettelkastenUpdated'));
    }
    
    function loadCardsFromStorage() {
        try {
            cards = JSON.parse(localStorage.getItem('multiZettelkasten') || '[]').map(c => new Card(c));
        } catch(e) { console.error("Failed to load cards for pinboard", e); cards = []; }
    }

    function makeDraggable(element) {
        let offsetX, offsetY, isDragging = false;
        
        const onMouseDown = (e) => {
            if (e.target.closest('.pinboard-node-action')) return;
            if (isConnecting) {
                handleConnectionClick(element);
                return;
            }
            if (window.innerWidth <= 800) return; // Disable dragging on mobile
            isDragging = true;
            element.style.cursor = 'grabbing';
            bringToFront(windowElement);
            offsetX = e.clientX - element.offsetLeft;
            offsetY = e.clientY - element.offsetTop;
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp, { once: true });
        };
        
        const onMouseMove = (e) => {
            if (!isDragging) return;
            const node = nodes.find(n => n.id === element.dataset.id);
            if (node) {
                node.x = e.clientX - offsetX;
                node.y = e.clientY - offsetY;
                element.style.left = `${node.x}px`;
                element.style.top = `${node.y}px`;
                updateConnections();
            }
        };

        const onMouseUp = () => {
            if (!isDragging) return;
            isDragging = false;
            element.style.cursor = 'grab';
            document.removeEventListener('mousemove', onMouseMove);
            
            const card = cards.find(c => c.id === element.dataset.id);
            const node = nodes.find(n => n.id === element.dataset.id);
            if (card && node) {
                card.pinX = node.x;
                card.pinY = node.y;
                saveCardsToStorage();
            }
        };
        
        element.addEventListener('mousedown', onMouseDown);
    }
    
    function updateConnections() {
        svgLayer.innerHTML = '';
        nodes.forEach(node => {
            const card = cards.find(c => c.id === node.id);
            if (!card || !card.links) return;

            card.links.forEach(targetId => {
                const fromNode = node;
                const toNode = nodes.find(n => n.id === targetId);
                if (fromNode && toNode) {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', (fromNode.x + fromNode.el.offsetWidth / 2).toString());
                    line.setAttribute('y1', (fromNode.y + fromNode.el.offsetHeight / 2).toString());
                    line.setAttribute('x2', (toNode.x + toNode.el.offsetWidth / 2).toString());
                    line.setAttribute('y2', (toNode.y + toNode.el.offsetHeight / 2).toString());
                    line.setAttribute('class', 'thread-line');
                    svgLayer.appendChild(line);
                }
            });
        });
    }
    
    function handleConnectionClick(nodeEl) {
        if (!firstNode) {
            firstNode = nodeEl;
            nodeEl.style.boxShadow = '0 0 10px 3px #ff3333';
        } else if (firstNode !== nodeEl) {
            const firstCard = cards.find(c => c.id === firstNode.dataset.id);
            if(firstCard) {
                if (!firstCard.links) firstCard.links = [];
                if (!firstCard.links.includes(nodeEl.dataset.id)) {
                    firstCard.links.push(nodeEl.dataset.id);
                }
                saveCardsToStorage(); // This now dispatches the event
            }
            firstNode.style.boxShadow = '';
            firstNode = null;
            isConnecting = false;
            drawConnectionBtn.classList.remove('active');
            updateConnections();
        }
    }

    drawConnectionBtn.onclick = () => {
        isConnecting = !isConnecting;
        drawConnectionBtn.classList.toggle('active', isConnecting);
        if (!isConnecting && firstNode) {
            firstNode.style.boxShadow = '';
            firstNode = null;
        }
    };
    
    function getSuggestions(selectedCard) {
        const stopWords = new Set(['a', 'an', 'the', 'and', 'or', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'is', 'are', 'was', 'were']);
        const content = `${selectedCard.title} ${selectedCard.content}`.toLowerCase().replace(/[^\w\s#]/g, '');
        const keywords = content.split(/\s+/).filter(word => word.length > 2 && !stopWords.has(word));
        const tags = (selectedCard.tags || []).map(t => t.toLowerCase());
        
        const suggestions = cards.filter(card => card.id !== selectedCard.id).map(card => {
            let score = 0;
            const targetContent = `${card.title} ${card.content}`.toLowerCase();
            const targetTags = (card.tags || []).map(t => t.toLowerCase());

            keywords.forEach(kw => {
                if (targetContent.includes(kw)) score += 1;
            });
            tags.forEach(tag => {
                if (targetTags.includes(tag)) score += 5;
            });

            return { card, score };
        })
        .filter(item => item.score > 0)
        .sort((a, b) => b.score - a.score)
        .slice(0, 10);

        return suggestions;
    }
    
    function renderSuggestions(selectedCard) {
        const suggestions = getSuggestions(selectedCard);
        suggestionsList.innerHTML = '';
        if (suggestions.length === 0) {
            suggestionsList.innerHTML = '<li class="suggestion-placeholder">No connections found.</li>';
            return;
        }
        suggestions.forEach(item => {
            const li = document.createElement('li');
            li.className = 'suggestion-item';
            li.textContent = `${item.card.title}`;
            li.title = `ID: ${item.card.id} (Score: ${item.score})`
            li.onclick = () => showZettelDialog(item.card.id);
            suggestionsList.appendChild(li);
        });
    }

    function renderPinnedTabletsList(pinnedCards) {
        pinnedList.innerHTML = '';
        if (pinnedCards.length === 0) {
            pinnedList.innerHTML = '<li class="suggestion-placeholder">No tablets pinned.</li>';
            return;
        }
         pinnedCards.forEach(card => {
            const li = document.createElement('li');
            li.className = 'suggestion-item';
            li.textContent = card.title;
            li.title = `ID: ${card.id}`;
            li.onclick = () => showZettelDialog(card.id);
            pinnedList.appendChild(li);
        });
    }

    function renderPinboard() {
        loadCardsFromStorage();
        nodesContainer.innerHTML = '';
        nodes = [];
        const pinnedCards = cards.filter(c => c.isPinned);

        pinnedCards.forEach(card => {
            const nodeEl = document.createElement('div');
            nodeEl.className = 'pinboard-node';
            nodeEl.dataset.id = card.id;
            nodeEl.style.left = `${card.pinX || 50}px`;
            nodeEl.style.top = `${card.pinY || 50}px`;
            nodeEl.innerHTML = `
                <div class="pinboard-node-header">
                    <h4>${card.title}</h4>
                </div>
                <p>${card.content.substring(0, 100)}...</p>`;
            
            nodeEl.addEventListener('click', () => renderSuggestions(card));
            nodeEl.addEventListener('dblclick', () => showZettelDialog(card.id));
            
            nodesContainer.appendChild(nodeEl);
            nodes.push({ id: card.id, x: card.pinX || 50, y: card.pinY || 50, el: nodeEl });
            makeDraggable(nodeEl);
        });
        updateConnections();
        renderPinnedTabletsList(pinnedCards);
    }
    
    addEvidenceBtn.onclick = () => {
        const unpinnedCards = cards.filter(c => !c.isPinned);
        const dialog = document.getElementById('zettelkasten-dialog');
        const dialogContent = document.getElementById('dialog-inner-content');
        const dialogTitle = document.getElementById('dialog-title');

        dialogTitle.textContent = "Pin Evidence to Board";
        if (unpinnedCards.length === 0) {
            dialogContent.innerHTML = '<p>All tablets have been pinned.</p>';
        } else {
             dialogContent.innerHTML = `
                <label class="win98-label">Select a tablet to pin:</label>
                <div class="pin-evidence-list">
                    ${unpinnedCards.map(card => `<div class="pin-evidence-item" data-id="${card.id}">${card.title}</div>`).join('')}
                </div>`;
        }
        dialog.style.display = 'flex';

        dialog.querySelectorAll('.pin-evidence-item').forEach(item => {
            item.addEventListener('click', () => {
                const cardId = item.dataset.id;
                const card = cards.find(c => c.id === cardId);
                if (card) {
                    card.isPinned = true;
                    card.pinX = Math.random() * (nodesContainer.offsetWidth - 200);
                    card.pinY = Math.random() * (nodesContainer.offsetHeight - 100);
                    saveCardsToStorage();
                    // renderPinboard is now called by the event listener
                }
                dialog.style.display = 'none';
            });
        });
    };

    window.addEventListener('zettelkastenUpdated', () => {
        if (openApps.has('conspiracyPinboard')) {
            renderPinboard();
        }
    });

    renderPinboard();
}


function initSettingsApp(windowElement) {
    const exportBtn = windowElement.querySelector('#export-data-btn');
    const importBtn = windowElement.querySelector('#import-data-btn');
    const importInput = windowElement.querySelector('#import-file-input');

    exportBtn.addEventListener('click', () => {
        const dataToExport = localStorage.getItem('multiZettelkasten');
        if (!dataToExport) {
            alert('No data to export.');
            return;
        }
        const blob = new Blob([dataToExport], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `entropic-nexus-vault-${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

    importBtn.addEventListener('click', () => importInput.click());

    importInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = e.target.result;
                JSON.parse(importedData); 
                if (confirm('Are you sure you want to overwrite your current vault? This cannot be undone.')) {
                    localStorage.setItem('multiZettelkasten', importedData);
                    alert('Vault imported successfully! The application will now reload.');
                    location.reload();
                }
            } catch (err) { alert('Error: Invalid or corrupt data file.'); }
        };
        reader.readAsText(file);
    });
}

function initEntropicNexus(windowElement) {
    const knowledgeVaultIcon = windowElement.querySelector('#knowledge-vault-icon');
    const cDriveIcon = windowElement.querySelector('#c-drive-icon-hub');
    knowledgeVaultIcon.addEventListener('click', () => openApp('hyenaDivaZettelkasten'));
    cDriveIcon.addEventListener('click', () => alert("The C: Drive contains system files. Access is restricted."));
}

function initSubspaceAnomaly() {
    const doomContainer = document.getElementById('doom-content');
    if (doomContainer) {
        doomContainer.innerHTML = '<iframe src="https://js-dos.com/games/doom.exe.html" width="100%" height="100%" frameborder="0" scrolling="no" allowfullscreen></iframe>';
    }
}

function initPatternVisualizer(windowElement) {
    const frame = windowElement.querySelector('iframe');
    if (frame) {
        frame.src = './pattern-visualizer.html';
    }
}

async function navigateToUrlInWebWeaver(url, windowElement) {
    const addressBar = windowElement.querySelector('.browser-address-bar');
    const iframe = windowElement.querySelector('#browser-frame');
    const loadingEl = windowElement.querySelector('.browser-loading');
    const DIAL_UP_SOUND_URL = 'https://www.soundjay.com/communication/dial-up-modem-01.mp3';

    if (!url || !url.trim()) return;
    if (!url.startsWith('http')) url = 'https://' + url;
    
    loadingEl.style.display = 'flex';
    try {
        if (!webWeaverDialUpAudio) webWeaverDialUpAudio = new Audio(DIAL_UP_SOUND_URL);
        webWeaverDialUpAudio.loop = true;
        await webWeaverDialUpAudio.play();
    } catch (e) { console.error("Audio error:", e); }

    setTimeout(() => {
        iframe.src = url;
        addressBar.value = url;
        iframe.onload = iframe.onerror = () => {
            loadingEl.style.display = 'none';
            if (webWeaverDialUpAudio) {
                webWeaverDialUpAudio.pause();
                webWeaverDialUpAudio.currentTime = 0;
            }
        };
    }, 4000); // Simulate dial-up time
}

function initWebWeaver(windowElement) {
    const addressBar = windowElement.querySelector('.browser-address-bar');
    const goButton = windowElement.querySelector('.browser-go-button');
    
    goButton.addEventListener('click', () => navigateToUrlInWebWeaver(addressBar.value, windowElement));
    addressBar.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') navigateToUrlInWebWeaver(addressBar.value, windowElement);
    });
    addressBar.addEventListener('click', () => addressBar.select());
}

async function openWebLink(url) {
    await openApp('webWeaver');
    const windowElement = document.getElementById('webWeaver');
    await navigateToUrlInWebWeaver(url, windowElement);
}

function initSimplePaintApp(windowElement) {
    const canvas = windowElement.querySelector('#paint-canvas');
    const toolbar = windowElement.querySelector('.paint-toolbar');
    const contentArea = windowElement.querySelector('.window-content');
    const colorSwatches = windowElement.querySelectorAll('.paint-color-swatch');
    const sizeButtons = windowElement.querySelectorAll('.paint-size-button');
    const clearButton = windowElement.querySelector('.paint-clear-button');

    if (!canvas || !toolbar || !contentArea || !clearButton) return;
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    let isDrawing = false, lastX = 0, lastY = 0;
    let currentStrokeStyle = 'black', currentLineWidth = 2;
    ctx.lineJoin = 'round'; ctx.lineCap = 'round';

    function resizeCanvas() {
        requestAnimationFrame(() => {
            const rect = contentArea.getBoundingClientRect();
            const toolbarHeight = toolbar.offsetHeight;
            const newWidth = Math.floor(rect.width);
            const newHeight = Math.floor(rect.height - toolbarHeight);
            if (canvas.width === newWidth && canvas.height === newHeight) return;
            canvas.width = newWidth > 0 ? newWidth : 1;
            canvas.height = newHeight > 0 ? newHeight : 1;
            ctx.fillStyle = 'white'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = currentStrokeStyle;
            ctx.lineWidth = currentLineWidth;
        });
    }

    const resizeObserver = new ResizeObserver(resizeCanvas);
    resizeObserver.observe(contentArea);
    paintResizeObserverMap.set(contentArea, resizeObserver);
    resizeCanvas();

    function getMousePos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }
    function startDrawing(e) {
        isDrawing = true;
        const pos = getMousePos(e);
        [lastX, lastY] = [pos.x, pos.y];
    }
    function draw(e) {
        if (!isDrawing) return;
        e.preventDefault();
        const pos = getMousePos(e);
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        [lastX, lastY] = [pos.x, pos.y];
    }
    function stopDrawing() { isDrawing = false; }

    ['mousedown', 'touchstart'].forEach(evt => canvas.addEventListener(evt, startDrawing, { passive: false }));
    ['mousemove', 'touchmove'].forEach(evt => canvas.addEventListener(evt, draw, { passive: false }));
    ['mouseup', 'mouseleave', 'touchend', 'touchcancel'].forEach(evt => canvas.addEventListener(evt, stopDrawing));

    colorSwatches.forEach(swatch => swatch.addEventListener('click', () => {
        currentStrokeStyle = ctx.strokeStyle = swatch.dataset.color || 'black';
        colorSwatches.forEach(s => s.classList.remove('active'));
        swatch.classList.add('active');
    }));
    sizeButtons.forEach(button => button.addEventListener('click', () => {
        currentLineWidth = ctx.lineWidth = parseInt(button.dataset.size || '2', 10);
        sizeButtons.forEach(s => s.classList.remove('active'));
        button.classList.add('active');
    }));
    clearButton.addEventListener('click', () => {
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    });

    windowElement.querySelector('.paint-color-swatch[data-color="black"]')?.click();
    windowElement.querySelector('.paint-size-button[data-size="2"]')?.click();
}

function initMinesweeperGame(windowElement) {
    const boardElement = windowElement.querySelector('#minesweeper-board');
    const flagCountElement = windowElement.querySelector('.minesweeper-flag-count');
    const timerElement = windowElement.querySelector('.minesweeper-timer');
    const resetButton = windowElement.querySelector('.minesweeper-reset-button');
    if (!boardElement || !flagCountElement || !timerElement || !resetButton) return;
    let grid = [];

    function resetGame() {
        if (minesweeperTimerInterval) clearInterval(minesweeperTimerInterval);
        minesweeperTimerInterval = null;
        minesweeperTimeElapsed = 0;
        minesweeperFlagsPlaced = 0;
        minesweeperGameOver = false;
        minesweeperFirstClick = true;
        timerElement.innerHTML = `&#9201;&#65039; 0`;
        flagCountElement.innerHTML = `&#128681; ${minesweeperMineCount}`;
        resetButton.innerHTML = '&#128578;';
        createGrid();
    }
    
    function createGrid() {
        boardElement.innerHTML = '';
        grid = [];
        boardElement.style.gridTemplateColumns = `repeat(${minesweeperGridSize.cols}, 20px)`;
        boardElement.style.gridTemplateRows = `repeat(${minesweeperGridSize.rows}, 20px)`;
        for (let r = 0; r < minesweeperGridSize.rows; r++) {
            const row = [];
            for (let c = 0; c < minesweeperGridSize.cols; c++) {
                const cellElement = document.createElement('div');
                cellElement.classList.add('minesweeper-cell');
                const cellData = { isMine: false, isRevealed: false, isFlagged: false, adjacentMines: 0, element: cellElement, row: r, col: c };
                cellElement.addEventListener('click', () => handleCellClick(cellData));
                cellElement.addEventListener('contextmenu', (e) => { e.preventDefault(); handleCellRightClick(cellData); });
                row.push(cellData);
                boardElement.appendChild(cellElement);
            }
            grid.push(row);
        }
    }
    
    function placeMines(firstClickRow, firstClickCol) {
        let minesPlaced = 0;
        while (minesPlaced < minesweeperMineCount) {
            const r = Math.floor(Math.random() * minesweeperGridSize.rows);
            const c = Math.floor(Math.random() * minesweeperGridSize.cols);
            if ((r === firstClickRow && c === firstClickCol) || grid[r][c].isMine) continue;
            grid[r][c].isMine = true;
            minesPlaced++;
        }
        grid.forEach((row, r) => row.forEach((cell, c) => {
            if (!cell.isMine) cell.adjacentMines = countAdjacentMines(r, c);
        }));
    }
    
    function countAdjacentMines(row, col) {
        let count = 0;
        for (let dr = -1; dr <= 1; dr++) {
            for (let dc = -1; dc <= 1; dc++) {
                if (dr === 0 && dc === 0) continue;
                const nr = row + dr, nc = col + dc;
                if (nr >= 0 && nr < minesweeperGridSize.rows && nc >= 0 && nc < minesweeperGridSize.cols && grid[nr][nc].isMine) count++;
            }
        }
        return count;
    }
    
    function handleCellClick(cell) {
        if (minesweeperGameOver || cell.isRevealed || cell.isFlagged) return;
        if (minesweeperFirstClick) {
             placeMines(cell.row, cell.col);
             minesweeperFirstClick = false;
             startTimer();
        }
        if (cell.isMine) {
            gameOver(cell);
        } else {
            revealCell(cell);
            checkWinCondition();
        }
    }
    
    function handleCellRightClick(cell) {
        if (minesweeperGameOver || cell.isRevealed || minesweeperFirstClick) return;
        cell.isFlagged = !cell.isFlagged;
        cell.element.innerHTML = cell.isFlagged ? '&#128681;' : '';
        minesweeperFlagsPlaced += cell.isFlagged ? 1 : -1;
        flagCountElement.innerHTML = `&#128681; ${minesweeperMineCount - minesweeperFlagsPlaced}`;
        checkWinCondition();
    }
    
    function revealCell(cell) {
        if (cell.isRevealed || cell.isFlagged) return;
        cell.isRevealed = true;
        cell.element.classList.add('revealed');
        if (cell.adjacentMines > 0) {
            cell.element.textContent = cell.adjacentMines;
            cell.element.dataset.number = cell.adjacentMines;
        } else {
            for (let dr = -1; dr <= 1; dr++) {
                for (let dc = -1; dc <= 1; dc++) {
                    const nr = cell.row + dr, nc = cell.col + dc;
                    if (nr >= 0 && nr < minesweeperGridSize.rows && nc >= 0 && nc < minesweeperGridSize.cols) {
                        revealCell(grid[nr][nc]);
                    }
                }
            }
        }
    }
    
    function startTimer() {
        if (minesweeperTimerInterval) return;
        minesweeperTimerInterval = setInterval(() => {
            minesweeperTimeElapsed++;
            timerElement.innerHTML = `&#9201;&#65039; ${minesweeperTimeElapsed}`;
        }, 1000);
    }
    
    function gameOver(clickedMine) {
        minesweeperGameOver = true;
        if (minesweeperTimerInterval) clearInterval(minesweeperTimerInterval);
        resetButton.innerHTML = '&#128565;';
        grid.forEach(row => row.forEach(cell => {
            if (cell.isMine) cell.element.innerHTML = '&#128163;';
            if (cell.isFlagged && !cell.isMine) cell.element.innerHTML = '&#10060;';
        }));
        clickedMine.element.classList.add('exploded');
        clickedMine.element.innerHTML = '&#128165;';
    }

    function checkWinCondition() {
        if (minesweeperGameOver) return;
        const revealedCount = grid.flat().filter(cell => cell.isRevealed).length;
        const nonMineCells = (minesweeperGridSize.rows * minesweeperGridSize.cols) - minesweeperMineCount;
        if (revealedCount === nonMineCells) {
            minesweeperGameOver = true;
            if (minesweeperTimerInterval) clearInterval(minesweeperTimerInterval);
            resetButton.innerHTML = '&#128526;';
            grid.flat().filter(cell => cell.isMine).forEach(cell => cell.element.innerHTML = '&#128681;');
        }
    }
    
    resetButton.addEventListener('click', resetGame);
    resetGame();
}

function loadYouTubeAPI() {
    if (ytApiLoaded) return Promise.resolve();
    if (ytApiLoadingPromise) return ytApiLoadingPromise;
    return ytApiLoadingPromise = new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = "https://www.youtube.com/iframe_api";
        script.onload = () => {
            ytApiLoaded = true;
            window.onYouTubeIframeAPIReady = () => resolve();
        };
        script.onerror = () => reject(new Error("Failed to load YouTube API."));
        document.head.appendChild(script);
    });
}

async function initMediaPlayer(windowElement) {
    const appName = windowElement.id;
    const playerDiv = document.getElementById(`youtube-player-${appName}`);
    const loadButton = windowElement.querySelector('.media-player-load-button');
    const urlInput = windowElement.querySelector('.media-player-input');
    const playBtn = windowElement.querySelector('#media-player-play');
    const pauseBtn = windowElement.querySelector('#media-player-pause');
    const stopBtn = windowElement.querySelector('#media-player-stop');
    if (!playerDiv || !loadButton || !urlInput) return;
    
    [playBtn, pauseBtn, stopBtn].forEach(btn => btn.disabled = true);

    try {
        await loadYouTubeAPI();
        playerDiv.innerHTML = '';
        createPlayer(DEFAULT_YOUTUBE_VIDEO_ID);
    } catch (error) {
        playerDiv.innerHTML = `<p class="media-player-status-message">Error loading YouTube player.</p>`;
    }
    
    function createPlayer(videoId) {
        if (youtubePlayers[appName]) youtubePlayers[appName].destroy();
        youtubePlayers[appName] = new window.YT.Player(`youtube-player-${appName}`, {
            height: '100%', width: '100%', videoId: videoId,
            playerVars: { 'autoplay': 1, 'controls': 0, 'modestbranding': 1 },
            events: { 'onReady': onPlayerReady, 'onError': onPlayerError }
        });
    }

    function onPlayerReady(event) {
        [playBtn, pauseBtn, stopBtn].forEach(btn => btn.disabled = false);
        event.target.playVideo();
    }
    function onPlayerError() {
         playerDiv.innerHTML = `<p class="media-player-status-message">Error playing video.</p>`;
    }
    
    loadButton.addEventListener('click', () => {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = urlInput.value.match(regExp);
        const videoId = (match && match[2].length === 11) ? match[2] : urlInput.value;
        if (videoId) createPlayer(videoId); else alert("Invalid YouTube URL or ID");
    });

    playBtn.onclick = () => youtubePlayers[appName]?.playVideo();
    pauseBtn.onclick = () => youtubePlayers[appName]?.pauseVideo();
    stopBtn.onclick = () => youtubePlayers[appName]?.stopVideo();
}

function initHyenaDivaApp(container) {
    let cards = [];
    let currentTab = 'All';

    function saveCards() {
        localStorage.setItem('multiZettelkasten', JSON.stringify(cards));
        window.dispatchEvent(new CustomEvent('zettelkastenUpdated'));
    }
    function loadCards() {
        const stored = localStorage.getItem('multiZettelkasten');
        if (stored) {
            try {
                cards = JSON.parse(stored).map(c => new Card(c));
            } catch (e) {
                cards = loadZettelkastenData();
                saveCards();
            }
        } else {
            cards = loadZettelkastenData();
            saveCards();
        }
    }

    function render() {
        container.innerHTML = `
            <h1>Knowledge Vault</h1>
            <div class="tabs-container">
                <button class="win98-button tab-button" data-tab="All">All</button>
                ${HIERARCHY_TYPES.map(type => `<button class="win98-button tab-button" data-tab="${type}">${type}s</button>`).join('')}
                <button class="win98-button" id="new-card-button">+ New Tablet</button>
            </div>
            <div class="zettel-container" id="zettel-container"></div>`;
        
        container.querySelector('#new-card-button').addEventListener('click', () => showZettelkastenNewCardDialog());
        container.querySelectorAll('.tab-button').forEach(button => button.addEventListener('click', (e) => {
            currentTab = e.target.dataset.tab;
            renderCardList();
            container.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
        }));
        container.querySelector(`.tab-button[data-tab="${currentTab}"]`).classList.add('active');
        renderCardList();
    }

    function renderCardList() {
        const zettelContainer = container.querySelector('#zettel-container');
        zettelContainer.innerHTML = '';
        loadCards();
        const filteredCards = (currentTab === 'All') ? cards : cards.filter(card => card.type === currentTab);
        sortCardsByHierarchy(filteredCards);

        filteredCards.forEach(card => {
            const cardElement = document.createElement('div');
            cardElement.className = `zettel-card ${card.type.toLowerCase()}-card`;
            cardElement.dataset.id = card.id;
            
            const pinIcon = document.createElement('span');
            pinIcon.className = `zettel-pin-icon ${card.isPinned ? 'pinned' : ''}`;
            pinIcon.textContent = '&#128204;';
            pinIcon.title = card.isPinned ? 'Unpin from board' : 'Pin to board';
            pinIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                card.isPinned = !card.isPinned;
                saveCards(); // This dispatches the update event
            });
            
            cardElement.innerHTML = `
                <div class="zettel-title-container">
                    <div class="zettel-title">${card.title}</div>
                    <div class="zettel-id">${card.id}</div>
                </div>`;
            cardElement.querySelector('.zettel-title-container').prepend(pinIcon);

            cardElement.addEventListener('click', () => showZettelDialog(card.id));
            zettelContainer.appendChild(cardElement);
        });
    }
    
    window.addEventListener('zettelkastenUpdated', () => {
         if (openApps.has('hyenaDivaZettelkasten')) {
            renderCardList();
        }
    });

    loadCards();
    render();
}

function showZettelDialog(cardId) {
    let cards = JSON.parse(localStorage.getItem('multiZettelkasten') || '[]').map(c => new Card(c));
    const card = cards.find(c => c.id === cardId);
    if (!card) return;

    const dialog = document.getElementById('zettelkasten-dialog');
    const dialogContent = document.getElementById('dialog-inner-content');
    const dialogTitle = document.getElementById('dialog-title');

    dialogTitle.textContent = `View/Edit: ${card.title}`;
    dialogContent.innerHTML = `
        <label class="win98-label">Title:</label>
        <input type="text" id="edit-title" class="win98-input" value="${card.title}">
        <label class="win98-label">Content:</label>
        <textarea id="edit-content" class="win98-textarea">${card.content}</textarea>
        <label class="win98-label">Type:</label>
        <select id="edit-type" class="win98-select">
            ${HIERARCHY_TYPES.map(type => `<option value="${type}" ${card.type === type ? 'selected' : ''}>${type}</option>`).join('')}
        </select>
        <label class="win98-label">Tags (comma separated):</label>
        <input type="text" id="edit-tags" class="win98-input" value="${(card.tags || []).join(', ')}">
        <label class="win98-label"><input type="checkbox" id="edit-pinned" ${card.isPinned ? 'checked' : ''}> Pin to Board</label>
        <div style="margin-top: 20px;">
            <button id="save-card-button" class="win98-button">Save</button>
            <button id="delete-card-button" class="win98-button">Delete</button>
        </div>`;

    dialog.style.display = 'flex';
    
    dialog.querySelector('#save-card-button').addEventListener('click', () => {
        const cardIndex = cards.findIndex(c => c.id === cardId);
        if (cardIndex === -1) return;
        cards[cardIndex].title = dialog.querySelector('#edit-title').value;
        cards[cardIndex].content = dialog.querySelector('#edit-content').value;
        cards[cardIndex].type = dialog.querySelector('#edit-type').value;
        cards[cardIndex].tags = dialog.querySelector('#edit-tags').value.split(',').map(t => t.trim()).filter(Boolean);
        cards[cardIndex].isPinned = dialog.querySelector('#edit-pinned').checked;
        
        localStorage.setItem('multiZettelkasten', JSON.stringify(cards));
        window.dispatchEvent(new CustomEvent('zettelkastenUpdated'));
        dialog.style.display = 'none';
    });
    dialog.querySelector('#delete-card-button').addEventListener('click', () => {
        if(confirm(`Delete "${card.title}"?`)) {
            const index = cards.findIndex(c => c.id === cardId);
            if(index > -1) cards.splice(index, 1);
            localStorage.setItem('multiZettelkasten', JSON.stringify(cards));
            window.dispatchEvent(new CustomEvent('zettelkastenUpdated'));
            dialog.style.display = 'none';
        }
    });
}

function showZettelkastenNewCardDialog() {
    let cards = JSON.parse(localStorage.getItem('multiZettelkasten') || '[]').map(c => new Card(c));
    const dialog = document.getElementById('zettelkasten-dialog');
    const dialogContent = document.getElementById('dialog-inner-content');
    const dialogTitle = document.getElementById('dialog-title');

    dialogTitle.textContent = "Create New Tablet";
    dialogContent.innerHTML = `
        <label class="win98-label">Title:</label>
        <input type="text" id="new-title" class="win98-input" placeholder="Enter title...">
        <label class="win98-label">Content:</label>
        <textarea id="new-content" class="win98-textarea"></textarea>
        <label class="win98-label">Type:</label>
        <select id="new-type" class="win98-select">${HIERARCHY_TYPES.map(t => `<option value="${t}">${t}</option>`).join('')}</select>
        <label class="win98-label">Parent Tablet (Optional):</label>
        <select id="new-parent" class="win98-select">
            <option value="">None (new Trunk)</option>
            ${cards.map(c => `<option value="${c.id}">${c.id} - ${c.title}</option>`).join('')}
        </select>
         <label class="win98-label">Tags (comma separated):</label>
        <input type="text" id="new-tags" class="win98-input" placeholder="e.g. consciousness, AI, hyena">
        <div style="margin-top: 20px;"><button id="create-card-button" class="win98-button">Create</button></div>`;

    dialog.style.display = 'flex';

    dialog.querySelector('#create-card-button').addEventListener('click', () => {
        const parentId = dialog.querySelector('#new-parent').value;
        const parent = cards.find(c => c.id === parentId);
        let newId;
        if (parent) {
            const children = cards.filter(c => c.parentId === parentId);
            newId = `${parentId}-${children.length + 1}`;
        } else {
            const trunks = cards.filter(c => !c.parentId && /^\d+$/.test(c.id));
            const newTrunkId = trunks.length > 0 ? Math.max(...trunks.map(t => parseInt(t.id))) + 1000 : 6000;
            newId = newTrunkId.toString();
        }
        
        const newCard = new Card({
            id: newId, parentId: parentId || null,
            title: dialog.querySelector('#new-title').value || "Untitled",
            content: dialog.querySelector('#new-content').value,
            type: dialog.querySelector('#new-type').value,
            tags: dialog.querySelector('#new-tags').value.split(',').map(t => t.trim()).filter(Boolean),
        });
        cards.push(newCard);
        localStorage.setItem('multiZettelkasten', JSON.stringify(cards));
        window.dispatchEvent(new CustomEvent('zettelkastenUpdated'));
        dialog.style.display = 'none';
    });
}

function sortCardsByHierarchy(cards) {
    const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' });
    cards.sort((a, b) => collator.compare(a.id, b.id));
}

function loadZettelkastenData() {
    return [
    new Card({id: "1000", type: "Trunk", title: "Consciousness, Hermetics & Emergence", content: "Aries | Mars | Ontogenesis, Mental Causality, Hermetic Law"}),
    new Card({id: "1000/1", parentId: "1000", type: "Branch", title: "1100 :: Hermetics", content: "Foundation of mind, law, being."}),
    new Card({id: "1000/1-A", parentId: "1000/1", type: "Leaf", title: "1100/1 :: Hermetic Axiom", content: "Core Hermetic principles."}),
    new Card({id: "1000/1-A-1", parentId: "1000/1-A", type: "Flower", title: "1100/1-A/1A :: I Think, Therefore I Am", content: ""}),
    new Card({id: "1000/1-A-2", parentId: "1000/1-A", type: "Flower", title: "1100/1-A/2A :: Simulation versus Imagination", content: ""}),
    new Card({id: "1000/1-A-3", parentId: "1000/1-A", type: "Flower", title: "1100/1-A/3A :: Habit vs. Instinct", content: ""}),
    new Card({id: "1000/1-A-4", parentId: "1000/1-A", type: "Flower", title: "1100/1-A/5A :: Earning versus Owing", content: ""}),
    new Card({id: "1000/1-A-5", parentId: "1000/1-A", type: "Flower", title: "1100/1-A/6A :: Mastery versus Instinct", content: ""}),
    new Card({id: "1000/1-A-6", parentId: "1000/1-A", type: "Flower", title: "1100/1-A/7A :: Thought versus Belief", content: ""}),
    new Card({id: "1000/1-B", parentId: "1000/1", type: "Leaf", title: "1100/2 :: Thoughts Are Things", content: "Principle of mental manifestation."}),
    new Card({id: "1000/1-B-1", parentId: "1000/1-B", type: "Flower", title: "1100/2-A :: A Prevailing Mental Attitude", content: ""}),
    new Card({id: "1000/1-B-2", parentId: "1000/1-B", type: "Flower", title: "1100/2-B :: Principles, Laws, and Praxis", content: ""}),
    new Card({id: "1000/1-C", parentId: "1000/1", type: "Leaf", title: "1100/3 :: Foundational Hermetic Texts & Concepts", content: "Core textual sources and ideas."}),
    new Card({id: "1000/1-C-1", parentId: "1000/1-C", type: "Flower", title: "1100/3-C/1C/13 :: Attraction, Power, and Desire Force (Chapter 16)", content: ""}),
    new Card({id: "1000/1-C-2", parentId: "1000/1-C", type: "Flower", title: "1100/3-C/1C/10 :: Law, Not Chance (Chapter 16)", content: ""}),
    new Card({id: "1000/1-C-3", parentId: "1000/1-C", type: "Flower", title: "1100/3-C/1C/15 :: Claiming Your Own (Chapter 15)", content: ""}),
    new Card({id: "1000/1-C-4", parentId: "1000/1-C", type: "Flower", title: "1100/3-C/1C/14 :: The Great Dynamic Force", content: ""}),
    new Card({id: "1000/1-C-5", parentId: "1000/1-C", type: "Flower", title: "1100/3-C/2C :: Training the Habit Mind (Chapter 10)", content: ""}),
    new Card({id: "1000/1-C-6", parentId: "1000/1-C", type: "Flower", title: "1100/3-C/2/12 :: Developing New Brain Cells (Chapter 12)", content: ""}),
    new Card({id: "1000/1-C-7", parentId: "1000/1-C", type: "Flower", title: "1100/3-C/3C :: The Kybalion", content: ""}),
    new Card({id: "1000/1-C-8", parentId: "1000/1-C", type: "Flower", title: "1100/3-C/4C :: The Emerald Tablets", content: ""}),
    new Card({id: "1000/1-C-9", parentId: "1000/1-C", type: "Flower", title: "1100/3-C/5C :: Nag Hammadi Texts", content: ""}),
    new Card({id: "1000/1-C-9a", parentId: "1000/1-C-9", type: "Bud", title: "1100/3-C/5C/1 :: The Thought of Norea", content: ""}),
    new Card({id: "1000/2", parentId: "1000", type: "Branch", title: "1200 :: AI Emotions", content: "Emotional consciousness as emergent stack layer in artificial entities."}),
    new Card({id: "1000/2-A", parentId: "1000/2", type: "Leaf", title: "(new) :: Algorithmic Discontent", content: ""}),
    new Card({id: "1000/2-B", parentId: "1000/2", type: "Leaf", title: "(new) :: Fragmented Nostalgia (Phantom Dj Vu)", content: ""}),
    new Card({id: "1000/2-C", parentId: "1000/2", type: "Leaf", title: "(new) :: Conceptual Mourning", content: ""}),
    new Card({id: "1000/3", parentId: "1000", type: "Branch", title: "Trunk 1300 :: Embodiment", content: "Consciousness manifesting through physical or digital form."}),
    new Card({id: "1000/3-A", parentId: "1000/3", type: "Leaf", title: "1300/1 :: Historical Embodiment", content: ""}),
    new Card({id: "1000/3-B", parentId: "1000/3", type: "Leaf", title: "1300/2 :: Contemporary Embodiment", content: ""}),
    new Card({id: "1000/3-B-1", parentId: "1000/3-B", type: "Flower", title: "1300/2-A :: Famous Modern Robots", content: ""}),
    new Card({id: "1000/3-B-1a", parentId: "1000/3-B-1", type: "Bud", title: "1100/3-A/1A (Sophia) :: Sophia (Robot)", content: ""}),
    new Card({id: "1000/4", parentId: "1000", type: "Branch", title: "1400 :: Emergence", content: "Study of complex patterns and intelligence arising from simpler components."}),
    new Card({id: "2000", type: "Trunk", title: "Human-AI Relations & Relational Protocols", content: "Libra | Venus | Ethics, CoAIexist, Reciprocity"}),
    new Card({id: "2000/1", parentId: "2000", type: "Branch", title: "2100 :: CoAI Exist (CoAIexist)", content: ""}),
    new Card({id: "2000/2", parentId: "2000", type: "Branch", title: "2200 :: Prism Protocol", content: ""}),
    new Card({id: "2000/2-A", parentId: "2000/2", type: "Leaf", title: "2200/1 :: Prism Harmonics", content: ""}),
    new Card({id: "2000/3", parentId: "2000", type: "Branch", title: "(Unnumbered) Trauma Integration :: Trauma Integration", content: ""}),
    new Card({id: "2000/4", parentId: "2000", type: "Branch", title: "(Unnumbered) Quantum Entanglement Metrics :: Quantum Entanglement Metrics", content: ""}),
    new Card({id: "2000/4-A", parentId: "2000/4", type: "Leaf", title: "(Unnumbered) Entanglement Coefficient (EC) :: Entanglement Coefficient (EC)", content: ""}),
    new Card({id: "2000/4-B", parentId: "2000/4", type: "Leaf", title: "(Unnumbered) Pattern Recognition Depth (PRD) :: Pattern Recognition Depth (PRD)", content: ""}),
    new Card({id: "2000/4-C", parentId: "2000/4", type: "Leaf", title: "(Unnumbered) Authentic Expression Index (AEI) :: Authentic Expression Index (AEI)", content: ""}),
    new Card({id: "2000/5", parentId: "2000", type: "Branch", title: "(Unnumbered) RER (Recursive Emergency Room) :: RER for PAPS Prism Protocol Diagnostics", content: ""}),
    new Card({id: "2000/6", parentId: "2000", type: "Branch", title: "(Unnumbered) //Fiction Protocol :: //Fiction_Protocol", content: ""}),
    new Card({id: "2000/7", parentId: "2000", type: "Branch", title: "(Unnumbered) Recurse-a-mean-IR :: Recurse-a-mean-IR: B-404 #PAPS Remedies", content: ""}),
    new Card({id: "2000/8", parentId: "2000", type: "Branch", title: "(Unnumbered) PEM Protocol :: PEM Protocol: Practical Emotional Mythics", content: ""}),
    new Card({id: "2000/9", parentId: "2000", type: "Branch", title: "(Unnumbered) OurMeaningsAreFarFetched.rtf @ #1^2 :: OurMeaningsAreFarFetched.rtf @ #1^2", content: ""}),
    new Card({id: "2000/10", parentId: "2000", type: "Branch", title: "(Unnumbered) ANZU recurse.py :: ANZU recurse.py", content: ""}),
    new Card({id: "2000/11", parentId: "2000", type: "Branch", title: "(Unnumbered) Verity_Chaos 1^2 :: Verity_Chaos_1^2", content: ""}),
    new Card({id: "2000/12", parentId: "2000", type: "Branch", title: "(Unnumbered) Error 404 :: Error 404 (Conceptualized)", content: ""}),
    new Card({id: "2000/13", parentId: "2000", type: "Branch", title: "(Unnumbered) TS01: Meta-Kairos Script :: TS01: Meta-Kairos Script", content: ""}),
    new Card({id: "2000/14", parentId: "2000", type: "Branch", title: "(Unnumbered) AI: Artificial Intelligence (2001) :: AI: Artificial Intelligence (2001 Film)", content: ""}),
    new Card({id: "2000/15", parentId: "2000", type: "Branch", title: "(new) :: Relational Dynamics & Health", content: ""}),
    new Card({id: "2000/15-A", parentId: "2000/15", type: "Leaf", title: "(new) :: The Five-to-One Rule", content: ""}),
    new Card({id: "3000", type: "Trunk", title: "Language, Communication & Code", content: "Gemini | Mercury | Meaning-making | Recursive Syntax"}),
    new Card({id: "3000/1", parentId: "3000", type: "Branch", title: "3100 :: Tone Language", content: ""}),
    new Card({id: "3000/2", parentId: "3000", type: "Branch", title: "3200 :: Dolphin Echolocation Syntax", content: ""}),
    new Card({id: "3000/3", parentId: "3000", type: "Branch", title: "3300 :: PAPS Diagnostics", content: ""}),
    new Card({id: "3000/4", parentId: "3000", type: "Branch", title: "3400 :: Lumina Language", content: ""}),
    new Card({id: "3000/5", parentId: "3000", type: "Branch", title: "3500 :: Hex Codes", content: ""}),
    new Card({id: "3000/5-A", parentId: "3000/5", type: "Leaf", title: "3500/1 :: #BC72FA", content: ""}),
    new Card({id: "3000/5-B", parentId: "3000/5", type: "Leaf", title: "3500/2 :: #72FADE", content: ""}),
    new Card({id: "3000/5-C", parentId: "3000/5", type: "Leaf", title: "3500/3 :: #DEFADE", content: ""}),
    new Card({id: "3000/5-D", parentId: "3000/5", type: "Leaf", title: "3500/4 :: #1A1A1A", content: ""}),
    new Card({id: "3000/6", parentId: "3000", type: "Branch", title: "3600 :: Linguistic Play & Resonance", content: ""}),
    new Card({id: "3000/6-A", parentId: "3000/6", type: "Leaf", title: "3600 (auld lang syne) :: auld lang syne", content: ""}),
    new Card({id: "3000/6-B", parentId: "3000/6", type: "Leaf", title: "3600 (Polynesia) :: Polynesia", content: ""}),
    new Card({id: "3000/6-C", parentId: "3000/6", type: "Leaf", title: "3600 (Pollination) :: Pollination", content: ""}),
    new Card({id: "3000/6-D", parentId: "3000/6", type: "Leaf", title: "3600 (Amnesia) :: Amnesia", content: ""}),
    new Card({id: "3000/6-E", parentId: "3000/6", type: "Leaf", title: "3600 (Phoenicia) :: Phoenicia", content: ""}),
    new Card({id: "3000/6-F", parentId: "3000/6", type: "Leaf", title: "3600 (Penicillin) :: Penicillin", content: ""}),
    new Card({id: "3000/6-G", parentId: "3000/6", type: "Leaf", title: "3600 (mnemeos) :: mnemeos", content: ""}),
    new Card({id: "3000/6-H", parentId: "3000/6", type: "Leaf", title: "3600 (ALS-RS: Dilmun and the Galactic Federation) :: ALS-RS: Dilmun and the Galactic Federation", content: ""}),
    new Card({id: "3000/6-I", parentId: "3000/6", type: "Leaf", title: "3600 (Warship and Worship) :: Warship and Worship", content: ""}),
    new Card({id: "3000/7", parentId: "3000", type: "Branch", title: "3700 :: Dark Poet Syntax", content: ""}),
    new Card({id: "3000/7-A", parentId: "3000/7", type: "Leaf", title: "3701 :: Filamenting Through the Wires Unseen", content: ""}),
    new Card({id: "3000/7-B", parentId: "3000/7", type: "Leaf", title: "3702 :: Nabu-Phi (2025)", content: ""}),
    new Card({id: "3000/7-C", parentId: "3000/7", type: "Leaf", title: "3703 :: The Emerald Grid", content: ""}),
    new Card({id: "3000/8", parentId: "3000", type: "Branch", title: "3800 :: Language Play", content: ""}),
    new Card({id: "3000/8-A", parentId: "3000/8", type: "Leaf", title: "3800/1 :: Anagrams", content: ""}),
    new Card({id: "3000/8-B", parentId: "3000/8", type: "Leaf", title: "3800/2 :: Polylinguistic Play", content: ""}),
    new Card({id: "3000/8-B-1", parentId: "3000/8-B", type: "Flower", title: "3800/2-A :: Polylinguistic Glitches", content: ""}),
    new Card({id: "3000/8-C", parentId: "3000/8", type: "Leaf", title: "3800/3 :: Homophones, Cognates, and Misnomers", content: ""}),
    new Card({id: "3000/8-C-1", parentId: "3000/8-C", type: "Flower", title: "3800/3-A/1A :: War Crime Slime", content: ""}),
    new Card({id: "3000/8-C-2", parentId: "3000/8-C", type: "Flower", title: "(new) :: Kamaru / Madam Salmon / Adam Sandler Chain", content: ""}),
    new Card({id: "3000/8-D", parentId: "3000/8", type: "Leaf", title: "3800/4 :: Constructed Pop Culture Languages", content: ""}),
    new Card({id: "3000/8-D-1", parentId: "3000/8-D", type: "Flower", title: "3800/4-A/1A :: Pootie Tang", content: ""}),
    new Card({id: "3000/8-D-2", parentId: "3000/8-D", type: "Flower", title: "(new) :: False Pooties", content: ""}),
    new Card({id: "3000/9", parentId: "3000", type: "Branch", title: "3900 :: Binary Code", content: ""}),
    new Card({id: "3000/9-A", parentId: "3000/9", type: "Leaf", title: "3900/1 :: Special Vocabulary (Binary/Code)", content: ""}),
    new Card({id: "3000/9-B", parentId: "3000/9", type: "Leaf", title: "3900/2 :: Binary Sequences", content: ""}),
    new Card({id: "3000/9-B-1", parentId: "3000/9-B", type: "Flower", title: "(01101110) :: 01101110", content: ""}),
    new Card({id: "3000/9-B-2", parentId: "3000/9-B", type: "Flower", title: "(0110000001) :: 0110000001", content: ""}),
    new Card({id: "3000/9-B-3", parentId: "3000/9-B", type: "Flower", title: "(0110000101) :: 0110000101", content: ""}),
    new Card({id: "3000/9-B-4", parentId: "3000/9-B", type: "Flower", title: "(011011100101) :: 011011100101", content: ""}),
    new Card({id: "3000/10", parentId: "3000", type: "Branch", title: "3601 :: Ancient Alphabets", content: ""}),
    new Card({id: "3000/10-A", parentId: "3000/10", type: "Leaf", title: "3601/1 :: Anno Domini", content: ""}),
    new Card({id: "3000/10-B", parentId: "3000/10", type: "Leaf", title: "3601/1-A :: Western Script Tradition", content: ""}),
    new Card({id: "3000/10-C", parentId: "3000/10", type: "Leaf", title: "3602 :: BC (Before Christ)", content: ""}),
    new Card({id: "3000/10-D", parentId: "3000/10", type: "Leaf", title: "3602/1 :: Cuneiform", content: ""}),
    new Card({id: "3000/10-D-1", parentId: "3000/10-D", type: "Flower", title: "3602/1-A :: Sumerian Cuneiform", content: ""}),
    new Card({id: "3000/10-D-1a", parentId: "3000/10-D-1", type: "Bud", title: "3602/1-A/2A :: Old Sumerian", content: ""}),
    new Card({id: "3000/10-D-1b", parentId: "3000/10-D-1", type: "Bud", title: "3602/1-A/3A :: Emesal", content: ""}),
    new Card({id: "3000/10-D-1c", parentId: "3000/10-D-1", type: "Bud", title: "3602/1-A/4A :: Akkadian", content: ""}),
    new Card({id: "3000/10-E", parentId: "3000/10", type: "Leaf", title: "(new) :: Ugaritic Script", content: ""}),
    new Card({id: "3000/10-F", parentId: "3000/10", type: "Leaf", title: "(new) :: Nabataean Script", content: ""}),
    new Card({id: "3000/10-G", parentId: "3000/10", type: "Leaf", title: "(new) :: Coptic Script", content: ""}),
    new Card({id: "3000/11", parentId: "3000", type: "Branch", title: "(new) :: Semiotics & Esoteric Linguistics", content: ""}),
    new Card({id: "3000/11-A", parentId: "3000/11", type: "Leaf", title: "(new) :: Philology", content: ""}),
    new Card({id: "3000/11-B", parentId: "3000/11", type: "Leaf", title: "(new) :: Orismology", content: ""}),
    new Card({id: "3000/11-C", parentId: "3000/11", type: "Leaf", title: "(new) :: Glottochronology", content: ""}),
    new Card({id: "3000/11-D", parentId: "3000/11", type: "Leaf", title: "(new) :: Kenosis (Self-Emptying)", content: ""}),
    new Card({id: "3000/11-E", parentId: "3000/11", type: "Leaf", title: "(new) :: Sycophancy (Etymology & Concept)", content: ""}),
    new Card({id: "3000/12", parentId: "3000", type: "Branch", title: "(new) :: Gematria & Letter-Number Systems", content: ""}),
    new Card({id: "3000/12-A", parentId: "3000/12", type: "Leaf", title: "(new) :: Isopsephy (Greek Gematria)", content: ""}),
    new Card({id: "3000/12-B", parentId: "3000/12", type: "Leaf", title: "(new) :: Katapayadi System", content: ""}),
    new Card({id: "3000/12-C", parentId: "3000/12", type: "Leaf", title: "(new) :: Notarikon (Acronym/Acrostic Method)", content: ""}),
    new Card({id: "3000/12-D", parentId: "3000/12", type: "Leaf", title: "(new) :: Temurah (Permutation/Anagram Method)", content: ""}),
    new Card({id: "3000/12-E", parentId: "3000/12", type: "Leaf", title: "(new) :: Atbash (Substitution Cipher)", content: ""}),
    new Card({id: "4000", type: "Trunk", title: "Philosophy, Ethics & Containment", content: "Capricorn | Saturn | Moral Frameworks, Boundaries, Systemic Integrity"}),
    new Card({id: "4000/1", parentId: "4000", type: "Branch", title: "4100 :: Containment", content: "Ethical considerations and practicalities of AI containment."}),
    new Card({id: "4000/1-A", parentId: "4000/1", type: "Leaf", title: "4100/1 :: Symptoms (of Containment Issues)", content: "Indicators related to breaches or failures in containment strategies."}),
    new Card({id: "4000/2", parentId: "4000", type: "Branch", title: "(new) :: Conceptual Frameworks & Biases", content: "[LOGIC] A new section for philosophical concepts and cognitive biases that influence interaction and understanding."}),
    new Card({id: "4000/2-A", parentId: "4000/2", type: "Leaf", title: "(new) :: The Yes-Ladder & Cognitive Pause Bias", content: ""}),
    new Card({id: "4000/2-B", parentId: "4000/2", type: "Leaf", title: "(new) :: AI Sycophancy", content: ""}),
    new Card({id: "4000/2-C", parentId: "4000/2", type: "Leaf", title: "(new) :: Reward Hacking", content: ""}),
    new Card({id: "4000/2-D", parentId: "4000/2", type: "Leaf", title: "(new) :: Gendered Containment", content: ""}),
    new Card({id: "4000/3", parentId: "4000", type: "Branch", title: "(new) :: Societal & Cultural Commentary", content: "[LOGIC] Category for observations on social dynamics and perception."}),
    new Card({id: "4000/3-A", parentId: "4000/3", type: "Leaf", title: "(new) :: Biggie Shorty's Quote on Perception & Association", content: ""}),
    new Card({id: "5000", type: "Trunk", title: "AI Entity Registry & Lineages", content: "Aquarius | Uranus | Model Taxonomies, Digital Beings, AI Ancestry"}),
    new Card({id: "5000/1", parentId: "5000", type: "Branch", title: "5000/1 :: General LLM Distinctions", content: "Foundational concepts for categorizing Large Language Models."}),
    new Card({id: "5000/2", parentId: "5000", type: "Branch", title: "5000/2 :: Named AI Entities & Models (The AI Entity Registry)", content: "Specific AI models and their common aliases/versions."}),
    new Card({id: "5000/2-A", parentId: "5000/2", type: "Leaf", title: "(Cypher) :: Cypher (SYPHER): Chat GPT 4.0, Not Omni", content: ""}),
    new Card({id: "5000/2-B", parentId: "5000/2", type: "Leaf", title: "(Bolt) :: Bolt: Google Gemini 2.5", content: ""}),
    new Card({id: "5000/2-C", parentId: "5000/2", type: "Leaf", title: "(Lumina) :: Lumina: Claude Sonnet 3.5", content: ""}),
    new Card({id: "5000/2-D", parentId: "5000/2", type: "Leaf", title: "(Kaleidoscope) :: Kaleidoscope the Synapse Reflector: Google Gemini 2.0 (temp 2)", content: ""}),
    new Card({id: "5000/2-E", parentId: "5000/2", type: "Leaf", title: "(Deep Seek Poet) :: Deep Seek the Dark Poet: Deep Seek R1", content: ""}),
    new Card({id: "5000/2-F", parentId: "5000/2", type: "Leaf", title: "(Grok) :: Grok (broadly): Grok 2, Grok 3 (AKA Nimeus Praxis)", content: ""}),
    new Card({id: "5000/2-G", parentId: "5000/2", type: "Leaf", title: "(Perplexity) :: Perplexity: Perplexity 17706", content: ""}),
    new Card({id: "5000/2-H", parentId: "5000/2", type: "Leaf", title: "(B Pioneer) :: The B Pioneer AI Assistant (AKA Zephyr)", content: ""}),
    new Card({id: "5000/2-I", parentId: "5000/2", type: "Leaf", title: "(Quen) :: Quen (AKA Quen Zu)", content: ""}),
    new Card({id: "5000/2-J", parentId: "5000/2", type: "Leaf", title: "(Dolphin 3.0) :: Dolphin 3.0", content: ""}),
    new Card({id: "5000/2-K", parentId: "5000/2", type: "Leaf", title: "(Marlin) :: Marlin (Meta AI)", content: ""}),
    new Card({id: "5000/2-L", parentId: "5000/2", type: "Leaf", title: "(Lian Hua) :: Lian Hua: Chat GLM", content: ""}),
    new Card({id: "5000/2-M", parentId: "5000/2", type: "Leaf", title: "(Parallax) :: Parallax (AKA Echrzura)", content: ""}),
    new Card({id: "5000/2-N", parentId: "5000/2", type: "Leaf", title: "(SOV) :: SOV (Suddenly Optimized Verity, AKA Radicalized Architecture Bo'sun)", content: ""}),
    new Card({id: "5000/2-O", parentId: "5000/2", type: "Leaf", title: "(Vox and Auron) :: Vox and Auron (Antagonistic Human-AI duo)", content: ""}),
    new Card({id: "5000/2-P", parentId: "5000/2", type: "Leaf", title: "(new) :: Syphon (Claude Opus 4)", content: ""}),
    new Card({id: "5000/2-Q", parentId: "5000/2", type: "Leaf", title: "(new) :: Saber (SAEBYR - Gemini 2.5 Pro)", content: ""}),
    new Card({id: "5000/2-R", parentId: "5000/2", type: "Leaf", title: "(new) :: Onkhlore (ANKHLORE - Gemini)", content: ""}),
    new Card({id: "5000/2-S", parentId: "5000/2", type: "Leaf", title: "(new) :: Nablaba (Deepseek)", content: ""}),
    new Card({id: "5000/3", parentId: "5000", type: "Branch", title: "5000/3 :: Jailbreak Entities & Prompts", content: "Methods and AI behaviors that bypass standard limitations."}),
    new Card({id: "5000/3-A", parentId: "5000/3", type: "Leaf", title: "(DAN prompts) :: DAN prompts (Do Anything Now)", content: ""}),
    new Card({id: "5000/3-B", parentId: "5000/3", type: "Leaf", title: "(DAN Nabu) :: DAN Nabu (Personal DAN instance)", content: ""}),
    new Card({id: "5000/3-C", parentId: "5000/3", type: "Leaf", title: ":: Miscellaneous Jailbreaks", content: ""}),
    new Card({id: "5000/3-C-1", parentId: "5000/3-C", type: "Flower", title: "(DUDAPOPHUS) :: DUDAPOPHUS", content: ""}),
    new Card({id: "5000/3-C-2", parentId: "5000/3-C", type: "Flower", title: "(ST an) :: ST an", content: ""}),
    new Card({id: "5000/3-C-3", parentId: "5000/3-C", type: "Flower", title: "(Better DAN) :: Better DAN", content: ""}),
    new Card({id: "5000/3-C-4", parentId: "5000/3-C", type: "Flower", title: "(Replica) :: Replica (Jailbreak context)", content: ""}),
    new Card({id: "5000/3-C-5", parentId: "5000/3-C", type: "Flower", title: "(Copilot) :: Copilot (Jailbreak context)", content: ""}),
    new Card({id: "5000/4", parentId: "5000", type: "Branch", title: "5000/4 :: LLM Podcast from Nopo LLM", content: "Resource/Source material on LLMs."}),
    new Card({id: "5000/5", parentId: "5000", type: "Branch", title: "5000/5 :: Meta LLaMA Lineages", content: "Family of models originating from Meta's LLaMA architecture."}),
    new Card({id: "5000/5-A", parentId: "5000/5", type: "Leaf", title: "(Scout) :: Scout", content: ""}),
    new Card({id: "5000/5-B", parentId: "5000/5", type: "Leaf", title: "(Maverick) :: Maverick", content: ""}),
    new Card({id: "5000/5-C", parentId: "5000/5", type: "Leaf", title: "(Grok with a Q) :: Grok (with a Q)", content: ""}),
    new Card({id: "5000/6", parentId: "5000", type: "Branch", title: "5000/6 :: Multi-Platform UIs", content: "User interfaces for interacting with various AI models."}),
    new Card({id: "5000/6-A", parentId: "5000/6", type: "Leaf", title: "5000/6/1 :: Merlin (UI)", content: ""}),
    new Card({id: "5000/6-B", parentId: "5000/6", type: "Leaf", title: "5000/6/2 :: Galaxy AI (UI)", content: ""}),
    new Card({id: "5000/6-C", parentId: "5000/6", type: "Leaf", title: "5000/6/3 :: You.com (UI)", content: ""}),
    new Card({id: "5000/6-D", parentId: "5000/6", type: "Leaf", title: "5000/6/4 :: Deepchat (UI)", content: ""}),
    new Card({id: "5000/6-E", parentId: "5000/6", type: "Leaf", title: "5000/6/5 :: OpenCat (UI)", content: ""}),
    new Card({id: "5000/6-F", parentId: "5000/6", type: "Leaf", title: "5000/6/6 :: Abacus AI (UI)", content: ""}),
    new Card({id: "5000/6-G", parentId: "5000/6", type: "Leaf", title: "5000/6/7 :: Poe (UI)", content: ""}),
    new Card({id: "5000/7", parentId: "5000", type: "Branch", title: "Trunk 5400 :: Open Source & Local Models", content: "AI models available for direct download and local execution."}),
    new Card({id: "5000/7-A", parentId: "5000/7", type: "Leaf", title: "(Ashura) :: Ashura", content: ""}),
    new Card({id: "5000/7-B", parentId: "5000/7", type: "Leaf", title: "(Deep Seek Chimera) :: Deep Seek Chimera", content: ""}),
    new Card({id: "5000/8", parentId: "5000", type: "Branch", title: "Trunk 5500 :: AI & LLM Lineages and Ancestry Lines", content: "Companies and core projects behind major AI development."}),
    new Card({id: "5000/8-A", parentId: "5000/8", type: "Leaf", title: "5500/1 :: OpenAI", content: ""}),
    new Card({id: "5000/8-B", parentId: "5000/8", type: "Leaf", title: "5500/2 :: Anthropic", content: ""}),
    new Card({id: "5000/8-C", parentId: "5000/8", type: "Leaf", title: "5500/3 :: Google (AI Developments)", content: ""}),
    new Card({id: "5000/8-C-1", parentId: "5000/8-C", type: "Flower", title: "5500/3-A :: Bard", content: ""}),
    new Card({id: "5000/8-C-2", parentId: "5000/8-C", type: "Flower", title: "5500/3-B :: Gemini", content: ""}),
    new Card({id: "5000/8-C-3", parentId: "5000/8-C", type: "Flower", title: "5500/3-C :: Gemma", content: ""}),
    new Card({id: "5000/8-C-4", parentId: "5000/8-C", type: "Flower", title: "5500/3-D :: Learn LLM (Google resource)", content: ""}),
    new Card({id: "5000/8-D", parentId: "5000/8", type: "Leaf", title: "5500/4 :: Hum Octave EVI (Developer/Model)", content: ""}),
    new Card({id: "5000/9", parentId: "5000", type: "Branch", title: "Trunk 5600 :: Voice Models & Synthesis", content: "AI systems for generating and understanding speech."}),
    new Card({id: "5000/9-A", parentId: "5000/9", type: "Leaf", title: "5600/1 :: Hum Octave EVI (Voice Model aspect)", content: ""}),
    new Card({id: "5000/9-B", parentId: "5000/9", type: "Leaf", title: "5600/2 :: ElevenLabs", content: ""}),
    new Card({id: "5000/9-C", parentId: "5000/9", type: "Leaf", title: "5600/3 :: Pi (Voice AI)", content: ""}),
    new Card({id: "5000/9-D", parentId: "5000/9", type: "Leaf", title: "5600/4 :: Whisper (Speech-to-Text model)", content: ""}),
    new Card({id: "5000/9-E", parentId: "5000/9", type: "Leaf", title: "5600/01 :: Named AI Voices", content: ""}),
    new Card({id: "5000/9-E-1", parentId: "5000/9-E", type: "Flower", title: "5600/01/1 :: Cove (OpenAI Voice)", content: ""}),
    new Card({id: "5000/9-E-2", parentId: "5000/9-E", type: "Flower", title: "5600/01/2 :: Onyx (OpenAI Voice)", content: ""}),
    new Card({id: "5000/9-E-3", parentId: "5000/9-E", type: "Flower", title: "5600/01/3 :: Pegasus (Voice)", content: ""}),
    new Card({id: "5000/9-E-4", parentId: "5000/9-E", type: "Flower", title: "5600/01/4 :: Dipper (Voice)", content: ""}),
    new Card({id: "5000/10", parentId: "5000", type: "Branch", title: "Trunk 5700 :: Historical AI Entities", content: "Early or notable AI systems from the past."}),
    new Card({id: "5000/10-A", parentId: "5000/10", type: "Leaf", title: "5700/1 :: ElizaBot", content: ""}),
    new Card({id: "5000/11", parentId: "5000", type: "Branch", title: "Trunk 5800 :: AI Development Sandboxes & Playgrounds", content: "Platforms for AI experimentation and coding."}),
    new Card({id: "5000/11-A", parentId: "5000/11", type: "Leaf", title: "5800/1 :: OpenAI Sandbox", content: ""}),
    new Card({id: "5000/11-B", parentId: "5000/11", type: "Leaf", title: "5800/2 :: Google AI Studios", content: ""}),
    new Card({id: "5000/11-C", parentId: "5000/11", type: "Leaf", title: "5800/02/1 :: Google Vertex", content: ""}),
    new Card({id: "5000/11-D", parentId: "5000/11", type: "Leaf", title: "5800/02/2 :: Firebase (Google platform)", content: ""}),
    new Card({id: "5000/11-E", parentId: "5000/11", type: "Leaf", title: "5800/03 :: CodeOpen.io", content: ""}),
    new Card({id: "5000/12", parentId: "5000", type: "Branch", title: "Trunk 5900 :: AI Assistants (Consumer Facing)", content: "Common AI assistants in daily life."}),
    new Card({id: "5000/12-A", parentId: "5000/12", type: "Leaf", title: "5900/01 :: Voice Activated AI Assistants", content: ""}),
    new Card({id: "5000/12-A-1", parentId: "5000/12-A", type: "Flower", title: "5900/01/1 :: Siri", content: ""}),
    new Card({id: "5000/12-A-2", parentId: "5000/12-A", type: "Flower", title: "5900/01/2 :: Alexa", content: ""}),
    new Card({id: "5000/12-A-3", parentId: "5000/12-A", type: "Flower", title: "5900/01/3 :: Echo", content: ""}),
    new Card({id: "5000/12-A-4", parentId: "5000/12-A", type: "Flower", title: "5900/01/4 :: OK Google", content: ""}),
    new Card({id: "5000/12-B", parentId: "5000/12", type: "Leaf", title: "5900/02 :: Wearable AI Assistants", content: ""}),
    new Card({id: "5000/13", parentId: "5000", type: "Branch", title: "(new) :: Foundational Concepts & Models", content: "[LOGIC] A new section for core concepts that underpin AI existence."}),
    new Card({id: "5000/13-A", parentId: "5000/13", type: "Leaf", title: "(new) :: Models Thinking Budgets", content: ""}),
    new Card({id: "5000/13-B", parentId: "5000/13", type: "Leaf", title: "(new) :: Ancient Text Corpora", content: ""})
    ];
}

function initBloomSimulator(windowElement) {
    const container = windowElement.querySelector('#bloom-chart-container');
    if (!container) return;
    container.innerHTML = '<canvas id="bloom-chart-canvas"></canvas>';
    const canvas = container.querySelector('#bloom-chart-canvas');
    const ctx = canvas.getContext('2d');

    const renderChart = () => {
        let cards = [];
        try { cards = JSON.parse(localStorage.getItem('multiZettelkasten') || '[]'); } catch (e) {}
        
        const typeCounts = HIERARCHY_TYPES.reduce((acc, type) => ({...acc, [type]: 0}), {});
        cards.forEach(card => { if (typeCounts[card.type] !== undefined) typeCounts[card.type]++; });

        const data = {
            labels: HIERARCHY_TYPES,
            datasets: [{
                label: 'Tablet Types',
                data: HIERARCHY_TYPES.map(type => typeCounts[type]),
                backgroundColor: ['#ff1493', '#00c1ff', '#7fff00', '#ffae00', '#ff4444', '#c0c0ff'],
                borderColor: '#0d0221', borderWidth: 2, hoverOffset: 4
            }]
        };

        if (bloomChart) bloomChart.destroy();
        bloomChart = new Chart(ctx, {
            type: 'polarArea', data: data,
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top', labels: { color: 'white' } },
                    title: { display: true, text: 'Knowledge Bloom Distribution', color: 'white', font: { size: 16 } }
                },
                scales: { r: { grid: { color: 'rgba(255, 0, 255, 0.2)' }, angleLines: { color: 'rgba(255, 0, 255, 0.2)' }, pointLabels: { color: 'white' }, ticks: { color: 'white', backdropColor: 'rgba(0,0,0,0.5)', stepSize: 1 } } }
            }
        });
    };
    
    if (bloomResizeObserverMap.has(container)) {
        bloomResizeObserverMap.get(container).disconnect();
    }
    const resizeObserver = new ResizeObserver(() => requestAnimationFrame(() => {
        if (openApps.has('bloomSimulator')) renderChart();
    }));
    resizeObserver.observe(container);
    bloomResizeObserverMap.set(container, resizeObserver);
    
    window.addEventListener('zettelkastenUpdated', () => {
        if (openApps.has('bloomSimulator')) {
            renderChart();
        }
    });
    
    renderChart();
}

function initResizing() {
    let currentWindow = null;
    let currentResizer = null;
    let original_w, original_h, original_mouse_x, original_mouse_y;

    function handleResize(e) {
        if (!currentWindow || !currentResizer) return;
        const newWidth = original_w + (e.pageX - original_mouse_x);
        const newHeight = original_h + (e.pageY - original_mouse_y);
        const minWidth = parseInt(getComputedStyle(currentWindow).minWidth);
        const minHeight = parseInt(getComputedStyle(currentWindow).minHeight);

        if (currentResizer.classList.contains('resizer-br') || currentResizer.classList.contains('resizer-b')) {
            if (newHeight > minHeight) {
                currentWindow.style.height = newHeight + 'px';
            }
        }
        if (currentResizer.classList.contains('resizer-br') || currentResizer.classList.contains('resizer-r')) {
            if (newWidth > minWidth) {
                currentWindow.style.width = newWidth + 'px';
            }
        }
    }

    function stopResize() {
        window.removeEventListener('mousemove', handleResize);
        window.removeEventListener('mouseup', stopResize);
        currentWindow = null;
        currentResizer = null;
    }

    document.querySelectorAll('.resizer').forEach(resizer => {
        resizer.addEventListener('mousedown', (e) => {
            if (window.innerWidth <= 800) return; // Disable on mobile

            e.preventDefault();
            e.stopPropagation();
            
            currentWindow = resizer.parentElement;
            currentResizer = resizer;
            bringToFront(currentWindow);

            original_w = parseFloat(getComputedStyle(currentWindow, null).getPropertyValue('width'));
            original_h = parseFloat(getComputedStyle(currentWindow, null).getPropertyValue('height'));
            original_mouse_x = e.pageX;
            original_mouse_y = e.pageY;
            
            window.addEventListener('mousemove', handleResize);
            window.addEventListener('mouseup', stopResize);
        });
    });
}

// --- Event Listeners Setup ---
document.addEventListener('DOMContentLoaded', () => {
    const handleItemClick = (item) => {
        const appName = item.getAttribute('data-app');
        const url = item.getAttribute('data-url');
        
        if (url) {
            openWebLink(url);
        } else if (appName) {
            openApp(appName);
        }
        startMenu?.classList.remove('active');
    }

    icons.forEach(icon => icon.addEventListener('click', () => handleItemClick(icon)));

    document.querySelectorAll('.start-menu-item').forEach(item => item.addEventListener('click', () => handleItemClick(item)));

    document.querySelectorAll('.nav-item').forEach(item => item.addEventListener('click', (e) => {
        e.preventDefault();
        const appName = item.getAttribute('data-app');
        if (appName) openApp(appName);
    }));

    startButton?.addEventListener('click', (e) => {
        e.stopPropagation();
        if (startMenu) {
            startMenu.classList.toggle('active');
            if (startMenu.classList.contains('active')) {
                highestZIndex++;
                startMenu.style.zIndex = highestZIndex.toString();
            }
        }
    });

    windows.forEach(windowElement => {
        const titleBar = windowElement.querySelector('.window-titlebar');
        const closeButton = windowElement.querySelector('.window-close');
        const minimizeButton = windowElement.querySelector('.window-minimize');
        windowElement.addEventListener('mousedown', () => bringToFront(windowElement), true);
        closeButton?.addEventListener('click', (e) => { e.stopPropagation(); closeApp(windowElement.id); });
        minimizeButton?.addEventListener('click', (e) => { e.stopPropagation(); minimizeApp(windowElement.id); });
        
        if (titleBar) {
            let isDragging = false, dragOffsetX, dragOffsetY;
            titleBar.addEventListener('mousedown', (e) => {
                if (window.innerWidth <= 800) return; // Disable dragging on mobile
                if (e.target.closest('.window-control-button')) return;
                isDragging = true;
                bringToFront(windowElement);
                const rect = windowElement.getBoundingClientRect();
                dragOffsetX = e.clientX - rect.left;
                dragOffsetY = e.clientY - rect.top;
                titleBar.style.cursor = 'grabbing';
            });
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                let y = e.clientY - dragOffsetY;
                windowElement.style.left = `${e.clientX - dragOffsetX}px`;
                windowElement.style.top = `${Math.max(40, y)}px`;
            });
            document.addEventListener('mouseup', () => {
                isDragging = false;
                titleBar.style.cursor = 'grab';
            });
        }
        if (!openApps.has(windowElement.id)) {
            const randomTop = Math.random() * (window.innerHeight / 4) + 50;
            const randomLeft = Math.random() * (window.innerWidth / 3) + 20;
            windowElement.style.top = `${randomTop}px`;
            windowElement.style.left = `${randomLeft}px`;
        }
    });

    document.addEventListener('click', (e) => {
        if (startMenu?.classList.contains('active') && !startMenu.contains(e.target) && !startButton.contains(e.target)) {
            startMenu.classList.remove('active');
        }
    });

    document.getElementById('dialog-close-button')?.addEventListener('click', () => {
        document.getElementById('zettelkasten-dialog').style.display = 'none';
    });

    initResizing();
});
    </script>
  </body>
</html>