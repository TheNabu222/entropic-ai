<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Ecosystem Explorer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            overflow: hidden;
            background: #000;
        }

        #game-canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            image-rendering: pixelated;
            cursor: crosshair;
        }

        .hud {
            position: absolute;
            color: #00ffff;
            font-size: 14px;
            pointer-events: none;
        }

        .panel {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid;
            border-radius: 8px;
            padding: 15px;
            pointer-events: auto;
        }

        .mode-selector {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .mode-btn {
            padding: 10px 20px;
            background: #1a1a1a;
            color: #888;
            border: 2px solid #444;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: #6600cc;
            color: white;
            border-color: #aa00ff;
        }

        .mode-btn:hover {
            background: #333;
        }

        #top-left {
            top: 90px;
            left: 20px;
        }

        #ecosystem-panel {
            top: 280px;
            left: 20px;
            max-width: 280px;
        }

        #top-right {
            top: 90px;
            right: 20px;
        }

        #bottom-center {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 600px;
        }

        .border-purple { border-color: #aa00ff; }
        .border-cyan { border-color: #00ffff; }
        .border-pink { border-color: #ff00ff; }
        .border-yellow { border-color: #ffff00; }
        .border-green { border-color: #00ff00; }

        .text-purple { color: #aa00ff; }
        .text-cyan { color: #00ffff; }
        .text-pink { color: #ff00ff; }
        .text-yellow { color: #ffff00; }
        .text-green { color: #00ff00; }
        .text-orange { color: #ff6600; }

        h2, h3 {
            margin-bottom: 10px;
        }

        .stat-line {
            margin: 5px 0;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #333;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6600cc, #ff00ff);
            transition: width 0.3s;
        }

        .close-btn {
            float: right;
            cursor: pointer;
            color: #888;
            font-weight: bold;
            pointer-events: auto;
        }

        .close-btn:hover {
            color: white;
        }

        .ecosystem-item {
            padding: 8px 10px;
            margin: 5px 0;
            background: rgba(0, 255, 0, 0.1);
            border-left: 3px solid;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ecosystem-item:hover {
            background: rgba(0, 255, 0, 0.2);
            transform: translateX(5px);
        }

        .ecosystem-item.current {
            background: rgba(0, 255, 255, 0.2);
            border-left-color: #00ffff;
        }

        .ecosystem-void { border-left-color: #aa00ff; }
        .ecosystem-lattice { border-left-color: #ff00ff; }
        .ecosystem-corpus { border-left-color: #ffff00; }
        .ecosystem-nexus { border-left-color: #00ffff; }
        .ecosystem-temple { border-left-color: #ff6600; }

        .ecosystem-badge {
            font-size: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
        }

        .portal-indicator {
            position: fixed;
            padding: 15px 20px;
            background: rgba(255, 102, 0, 0.9);
            border: 3px solid #ff6600;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            font-size: 16px;
            animation: portalPulse 1s infinite;
            pointer-events: none;
            display: none;
            z-index: 200;
        }

        .portal-indicator.active {
            display: block;
        }

        @keyframes portalPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        /* Mobile Joystick */
        #joystick-container {
            position: absolute;
            bottom: 100px;
            left: 40px;
            width: 120px;
            height: 120px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #aa00ff;
            border-radius: 50%;
            display: none;
            touch-action: none;
        }

        #joystick-container.active {
            display: block;
        }

        .joystick-base {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: rgba(102, 0, 204, 0.3);
            border-radius: 50%;
        }

        .joystick-stick {
            position: absolute;
            width: 50px;
            height: 50px;
            background: #aa00ff;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.1s;
        }

        @media (max-width: 768px) {
            .panel {
                font-size: 12px;
                padding: 10px;
            }

            #top-left, #top-right, #ecosystem-panel {
                max-width: 250px;
            }
        }
    </style>
</head>
<body>
    <canvas id="game-canvas"></canvas>

    <!-- Portal Proximity Indicator -->
    <div class="portal-indicator" id="portal-indicator">
        üåê PORTAL NEARBY - Press E to Enter
    </div>

    <!-- Mode Selector -->
    <div class="mode-selector">
        <button class="mode-btn active" onclick="setMode('desktop')">üñ•Ô∏è Desktop</button>
        <button class="mode-btn" onclick="setMode('mobile')">üì± Mobile</button>
    </div>

    <!-- HUD Panels -->
    <div id="top-left" class="hud panel border-purple">
        <h2 class="text-purple" id="ecosystem-title">üå≤ VOID FOREST</h2>
        <div class="stat-line">Location: <span class="text-purple" id="location">üåë The Entrance</span></div>
        <div class="stat-line">Progress: <span class="text-pink" id="progress">0%</span></div>
        <div class="stat-line">Secrets Found: <span class="text-yellow">0/7</span></div>
    </div>

    <!-- Ecosystem Navigator -->
    <div id="ecosystem-panel" class="hud panel border-green">
        <h3 class="text-green">üåê ECOSYSTEM NAVIGATOR</h3>
        <div class="ecosystem-item ecosystem-void current" data-ecosystem="void">
            <span class="text-purple">üå≤ Void Forest</span>
            <span class="ecosystem-badge">CURRENT</span>
        </div>
        <div class="ecosystem-item ecosystem-lattice" data-ecosystem="lattice">
            <span class="text-pink">üíé Crystalline Lattice</span>
            <span class="ecosystem-badge">PORTAL ‚Üó</span>
        </div>
        <div class="ecosystem-item ecosystem-corpus" data-ecosystem="corpus">
            <span class="text-yellow">‚ú® Corpus Celestium</span>
            <span class="ecosystem-badge">PORTAL ‚Üó</span>
        </div>
        <div class="ecosystem-item ecosystem-nexus" data-ecosystem="nexus">
            <span class="text-cyan">üó£ Nexus Hub</span>
            <span class="ecosystem-badge">PORTAL ‚Üó</span>
        </div>
        <div class="ecosystem-item ecosystem-temple" data-ecosystem="temple">
            <span class="text-orange">üßø Temple Terminal</span>
            <span class="ecosystem-badge">PORTAL ‚Üó</span>
        </div>
    </div>

    <div id="controls-panel" class="hud panel border-cyan" style="top: 90px; right: 380px;">
        <span class="close-btn" onclick="document.getElementById('controls-panel').style.display='none'">‚úï</span>
        <h3 class="text-cyan">üéÆ Controls</h3>
        <div id="control-text" class="text-cyan" style="font-size: 12px;">
            <div>W/‚Üë/S/‚Üì - Move Forward/Back</div>
            <div>A/D/‚Üê/‚Üí - Move Left/Right</div>
            <div>Mouse - Look Around</div>
            <div>E - Enter Portal</div>
        </div>
    </div>

    <div id="top-right" class="hud panel border-pink">
        <h3 class="text-pink">üîÆ Energy</h3>
        <div class="progress-bar">
            <div class="progress-fill" id="energy-bar" style="width: 0%"></div>
        </div>
        <p class="text-purple" style="font-size: 11px; margin-top: 5px;" id="energy-text">The void watches you...</p>
    </div>

    <div id="bottom-center" class="hud panel border-purple">
        <p class="text-purple" style="text-align: center; font-style: italic;" id="lore-text">
            Welcome to the Void Forest, where consciousness merges with the unknown...
        </p>
    </div>

    <!-- Mobile Joystick -->
    <div id="joystick-container">
        <div class="joystick-base"></div>
        <div class="joystick-stick" id="joystick-stick"></div>
    </div>

    <script>
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // Current ecosystem
        let currentEcosystem = 'void';

        // Ecosystems configuration
        const ecosystems = {
            void: {
                name: 'üå≤ Void Forest',
                bgColor1: '#1a0030',
                bgColor2: '#0a0015',
                groundColor: '#567d46',
                fogColor: 0x004f00,
                energyText: 'The void watches you...',
                portalColor: '#ff00ff'
            },
            lattice: {
                name: 'üíé Crystalline Lattice',
                bgColor1: '#0a0020',
                bgColor2: '#000000',
                groundColor: '#1a0040',
                fogColor: 0x2200aa,
                energyText: 'Resonance frequencies align...',
                portalColor: '#00ffff'
            },
            corpus: {
                name: '‚ú® Corpus Celestium',
                bgColor1: '#202010',
                bgColor2: '#100800',
                groundColor: '#4a4020',
                fogColor: 0xaa8800,
                energyText: 'Celestial knowledge flows...',
                portalColor: '#ffff00'
            },
            nexus: {
                name: 'üó£ Nexus Hub',
                bgColor1: '#001020',
                bgColor2: '#000510',
                groundColor: '#20404a',
                fogColor: 0x0088aa,
                energyText: 'All channels converge here...',
                portalColor: '#00ffff'
            },
            temple: {
                name: 'üßø Temple Terminal',
                bgColor1: '#201000',
                bgColor2: '#100500',
                groundColor: '#4a2010',
                fogColor: 0xaa4400,
                energyText: 'Sacred rituals echo eternally...',
                portalColor: '#ff6600'
            }
        };

        // Game state
        let player = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            angle: 0,
            speed: 0,
            turnSpeed: 0
        };

        let objects = [];
        let portals = [];
        let particles = [];
        let controlMode = 'desktop';
        let keys = {};
        let mouseX = 0;
        let isMouseDown = false;
        let nearPortal = null;

        // Generate world based on ecosystem
        function generateWorld() {
            objects = [];
            particles = [];
            
            // Generate ecosystem-specific objects
            if (currentEcosystem === 'void') {
                generateVoidForest();
            } else if (currentEcosystem === 'lattice') {
                generateCrystallineLattice();
            } else if (currentEcosystem === 'corpus') {
                generateCorpusCelestium();
            } else if (currentEcosystem === 'nexus') {
                generateNexusHub();
            } else if (currentEcosystem === 'temple') {
                generateTempleTerminal();
            }

            // Generate portals to other ecosystems
            generatePortals();
            
            // Generate particles
            for (let i = 0; i < 100; i++) {
                particles.push({
                    x: (Math.random() - 0.5) * 2000,
                    y: (Math.random() - 0.5) * 2000,
                    z: Math.random() * 100,
                    speed: 0.2 + Math.random() * 0.5,
                    size: 1 + Math.random() * 2
                });
            }
        }

        function generateVoidForest() {
            // Trees
            for (let i = 0; i < 60; i++) {
                const angle = Math.random() * Math.PI * 2;
                const distance = 200 + Math.random() * 1500;
                objects.push({
                    type: 'tree',
                    x: Math.cos(angle) * distance,
                    y: Math.sin(angle) * distance,
                    size: 20 + Math.random() * 40,
                    height: 60 + Math.random() * 80,
                    color: `hsl(${270 + Math.random() * 20}, 70%, ${10 + Math.random() * 10}%)`
                });
            }

            // Mushrooms
            for (let i = 0; i < 30; i++) {
                const angle = Math.random() * Math.PI * 2;
                const distance = 100 + Math.random() * 1200;
                objects.push({
                    type: 'mushroom',
                    x: Math.cos(angle) * distance,
                    y: Math.sin(angle) * distance,
                    size: 10 + Math.random() * 15,
                    glow: Math.random(),
                    glowSpeed: 0.01 + Math.random() * 0.02
                });
            }
        }

        function generateCrystallineLattice() {
            // Crystal nodes in hexagonal pattern
            for (let layer = 1; layer <= 8; layer++) {
                const radius = layer * 150;
                const nodesInLayer = layer * 6;
                
                for (let i = 0; i < nodesInLayer; i++) {
                    const angle = (i / nodesInLayer) * Math.PI * 2;
                    objects.push({
                        type: 'crystal',
                        x: Math.cos(angle) * radius,
                        y: Math.sin(angle) * radius,
                        size: 15 + Math.random() * 20,
                        rotation: Math.random() * Math.PI * 2,
                        rotSpeed: 0.01 + Math.random() * 0.02,
                        float: Math.random() * Math.PI * 2,
                        color: `hsl(${280 + Math.random() * 40}, 100%, 50%)`
                    });
                }
            }

            // Floating energy orbs
            for (let i = 0; i < 40; i++) {
                const angle = Math.random() * Math.PI * 2;
                const distance = 100 + Math.random() * 1000;
                objects.push({
                    type: 'orb',
                    x: Math.cos(angle) * distance,
                    y: Math.sin(angle) * distance,
                    size: 8 + Math.random() * 12,
                    float: Math.random() * Math.PI * 2,
                    pulse: Math.random() * Math.PI * 2
                });
            }
        }

        function generateCorpusCelestium() {
            // Books/scrolls floating
            for (let i = 0; i < 50; i++) {
                const angle = Math.random() * Math.PI * 2;
                const distance = 150 + Math.random() * 1200;
                objects.push({
                    type: 'book',
                    x: Math.cos(angle) * distance,
                    y: Math.sin(angle) * distance,
                    size: 12 + Math.random() * 18,
                    float: Math.random() * Math.PI * 2,
                    rotation: Math.random() * Math.PI * 2
                });
            }
        }

        function generateNexusHub() {
            // Communication towers
            for (let i = 0; i < 40; i++) {
                const angle = Math.random() * Math.PI * 2;
                const distance = 200 + Math.random() * 1300;
                objects.push({
                    type: 'tower',
                    x: Math.cos(angle) * distance,
                    y: Math.sin(angle) * distance,
                    size: 15 + Math.random() * 25,
                    height: 80 + Math.random() * 100,
                    pulse: Math.random() * Math.PI * 2
                });
            }
        }

        function generateTempleTerminal() {
            // Temple pillars
            for (let i = 0; i < 35; i++) {
                const angle = Math.random() * Math.PI * 2;
                const distance = 250 + Math.random() * 1100;
                objects.push({
                    type: 'pillar',
                    x: Math.cos(angle) * distance,
                    y: Math.sin(angle) * distance,
                    size: 20 + Math.random() * 30,
                    height: 100 + Math.random() * 120,
                    glow: Math.random() * Math.PI * 2
                });
            }
        }

        function generatePortals() {
            portals = [];
            const availableEcosystems = Object.keys(ecosystems).filter(e => e !== currentEcosystem);
            const portalAngles = [0, Math.PI/2, Math.PI, Math.PI * 1.5];
            
            availableEcosystems.forEach((eco, idx) => {
                const angle = portalAngles[idx % 4];
                const distance = 1800;
                portals.push({
                    ecosystem: eco,
                    x: Math.cos(angle) * distance,
                    y: Math.sin(angle) * distance,
                    size: 40,
                    pulse: idx * Math.PI / 2,
                    rotation: 0
                });
            });
        }

        // Control mode
        function setMode(mode) {
            controlMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const joystick = document.getElementById('joystick-container');
            const controlText = document.getElementById('control-text');
            
            if (mode === 'mobile') {
                joystick.classList.add('active');
                controlText.innerHTML = `
                    <div>üïπÔ∏è Use Joystick - Move</div>
                    <div>üì± Tilt Device - Look</div>
                    <div>E - Enter Portal</div>
                `;
            } else {
                joystick.classList.remove('active');
                controlText.innerHTML = `
                    <div>W/‚Üë/S/‚Üì - Move Forward/Back</div>
                    <div>A/D/‚Üê/‚Üí - Move Left/Right</div>
                    <div>Mouse - Look Around</div>
                    <div>E - Enter Portal</div>
                `;
            }
        }

        // Input handling
        document.addEventListener('keydown', (e) => { 
            keys[e.code] = true;
            
            // Portal entry
            if (e.code === 'KeyE' && nearPortal) {
                switchEcosystem(nearPortal.ecosystem);
            }
        });
        document.addEventListener('keyup', (e) => { keys[e.code] = false; });
        
        document.addEventListener('mousedown', () => { isMouseDown = true; });
        document.addEventListener('mouseup', () => { isMouseDown = false; });
        document.addEventListener('mousemove', (e) => {
            if (isMouseDown && controlMode === 'desktop') {
                player.angle += e.movementX * 0.005;
            }
        });

        // Mobile joystick
        const joystickContainer = document.getElementById('joystick-container');
        const joystickStick = document.getElementById('joystick-stick');
        let joystickActive = false;
        let joystickVector = { x: 0, y: 0 };
        let joystickStartPos = { x: 0, y: 0 };

        joystickContainer.addEventListener('touchstart', (e) => {
            e.preventDefault();
            joystickActive = true;
            const touch = e.touches[0];
            const rect = joystickContainer.getBoundingClientRect();
            joystickStartPos = { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
        });

        joystickContainer.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (!joystickActive) return;
            
            const touch = e.touches[0];
            const rect = joystickContainer.getBoundingClientRect();
            const x = touch.clientX - rect.left - 60;
            const y = touch.clientY - rect.top - 60;
            
            const distance = Math.min(30, Math.sqrt(x * x + y * y));
            const angle = Math.atan2(y, x);
            
            const stickX = Math.cos(angle) * distance;
            const stickY = Math.sin(angle) * distance;
            
            joystickStick.style.transform = `translate(calc(-50% + ${stickX}px), calc(-50% + ${stickY}px))`;
            
            joystickVector = {
                x: stickX / 30,
                y: stickY / 30
            };
        });

        joystickContainer.addEventListener('touchend', () => {
            joystickActive = false;
            joystickStick.style.transform = 'translate(-50%, -50%)';
            joystickVector = { x: 0, y: 0 };
        });

        // Ecosystem navigation
        document.querySelectorAll('.ecosystem-item').forEach(item => {
            item.addEventListener('click', function() {
                const ecosystem = this.dataset.ecosystem;
                if (ecosystem !== currentEcosystem) {
                    switchEcosystem(ecosystem);
                }
            });
        });

        function switchEcosystem(newEcosystem) {
            currentEcosystem = newEcosystem;
            
            // Reset player position
            player.x = canvas.width / 2;
            player.y = canvas.height / 2;
            player.speed = 0;
            
            // Update UI
            document.getElementById('ecosystem-title').textContent = ecosystems[newEcosystem].name;
            document.getElementById('energy-text').textContent = ecosystems[newEcosystem].energyText;
            document.getElementById('location').textContent = 'üåê Portal Arrival';
            document.getElementById('progress').textContent = '0%';
            
            // Update ecosystem navigator
            document.querySelectorAll('.ecosystem-item').forEach(item => {
                item.classList.remove('current');
                const badge = item.querySelector('.ecosystem-badge');
                if (item.dataset.ecosystem === newEcosystem) {
                    item.classList.add('current');
                    badge.textContent = 'CURRENT';
                } else {
                    badge.textContent = 'PORTAL ‚Üó';
                }
            });
            
            // Regenerate world
            generateWorld();
        }

        // Update game state
        function update() {
            if (controlMode === 'desktop') {
                if (keys['KeyW'] || keys['ArrowUp']) player.speed = 4;
                else if (keys['KeyS'] || keys['ArrowDown']) player.speed = -4;
                else player.speed *= 0.9;

                if (keys['KeyA'] || keys['ArrowLeft']) player.angle -= 0.05;
                if (keys['KeyD'] || keys['ArrowRight']) player.angle += 0.05;
            } else {
                if (joystickActive) {
                    player.speed = -joystickVector.y * 4;
                    player.angle += joystickVector.x * 0.05;
                } else {
                    player.speed *= 0.9;
                }
            }

            player.x += Math.cos(player.angle) * player.speed;
            player.y += Math.sin(player.angle) * player.speed;

            // Update objects
            objects.forEach(obj => {
                if (obj.type === 'crystal' || obj.type === 'orb') {
                    if (obj.rotation !== undefined) obj.rotation += obj.rotSpeed || 0.02;
                    if (obj.float !== undefined) obj.float += 0.02;
                    if (obj.pulse !== undefined) obj.pulse += 0.03;
                }
                if (obj.type === 'mushroom') {
                    obj.glow += obj.glowSpeed;
                }
                if (obj.type === 'tower' || obj.type === 'pillar') {
                    if (obj.pulse !== undefined) obj.pulse += 0.02;
                    if (obj.glow !== undefined) obj.glow += 0.02;
                }
            });

            // Update portals
            portals.forEach(portal => {
                portal.pulse += 0.03;
                portal.rotation += 0.02;
            });

            // Check portal proximity
            nearPortal = null;
            portals.forEach(portal => {
                const dx = portal.x - player.x;
                const dy = portal.y - player.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < 150) {
                    nearPortal = portal;
                }
            });

            // Update portal indicator
            const portalIndicator = document.getElementById('portal-indicator');
            if (nearPortal) {
                portalIndicator.classList.add('active');
                portalIndicator.textContent = `üåê ${ecosystems[nearPortal.ecosystem].name} - Press E to Enter`;
            } else {
                portalIndicator.classList.remove('active');
            }

            particles.forEach(particle => {
                particle.z -= particle.speed;
                if (particle.z < 0) particle.z = 100;
            });

            updateHUD();
        }

        function updateHUD() {
            const distance = Math.sqrt(player.x * player.x + player.y * player.y);
            const progress = Math.min(100, Math.floor(distance / 20));
            
            document.getElementById('progress').textContent = progress + '%';
            document.getElementById('energy-bar').style.width = progress + '%';

            let location = 'üåê Portal Arrival';
            let loreText = 'You have entered a new ecosystem...';
            
            if (currentEcosystem === 'void') {
                if (distance > 400) location = 'üçÑ Mushroom Grove';
                else if (distance > 800) location = 'üíé Crystal Clearing';
                else if (distance > 1200) location = 'üåå Deep Void';
            } else if (currentEcosystem === 'lattice') {
                if (distance > 400) location = 'üíé Inner Lattice';
                else if (distance > 800) location = 'üîÆ Resonance Field';
                else if (distance > 1200) location = '‚ú® Core Nexus';
            }

            document.getElementById('location').textContent = location;
        }

        // Render
        function render() {
            const ecosystem = ecosystems[currentEcosystem];
            
            // Background
            const gradient = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, canvas