<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>~*~HyEnA DiVa'Z ZeTtElKaStEn~*~ Windows 98 Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Tahoma&family=Comic+Sans+MS&family=VT323&display=swap" rel="stylesheet">
  <style>
    /* Y2K HYENA DIVA COLORS */
    :root {
      --hyena-pink: #ff72b6;
      --hyena-purple: #bf5fff;
      --hyena-teal: #72fade;
      --hyena-yellow: #fffb01;
      --hyena-blue: #00a2ff;
      
      /* Windows 98 colors with Hyena flair */
      --win98-gray: #C0C0C0;
      --win98-gray-dark: #808080;
      --win98-gray-light: #DFDFDF;
      --win98-desktop: #ff72b6; /* Hyena pink background */
      --win98-window: #C0C0C0;
      --win98-title-active: #bf5fff; /* Hyena purple title bar */
      --win98-title-inactive: #808080;
      --win98-button: #C0C0C0;
      --win98-button-highlight: #FFFFFF;
      --win98-button-shadow: #808080;
      --win98-text: #000000;
    }
    
    /* Base styles */
    body {
      background-color: var(--win98-desktop);
      background-image: url('https://pfst.cf2.poecdn.net/base/image/c568f858cbfe5304ed56fca693cb244fed53eafca1683b9a9c6d110dbd7dfeeb?w=1024&h=1024');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-blend-mode: soft-light;
      color: var(--win98-text);
      font-family: 'Tahoma', 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
      position: fixed;
      -webkit-font-smoothing: antialiased;
      -webkit-overflow-scrolling: touch;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
    }

    /* Apply iOS-style overscroll behavior */
    .ios-scroll {
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* Mobile View Toggle Styles */
    .view-toggle {
      position: fixed;
      top: 5px;
      right: 5px;
      z-index: 9999;
      background: var(--hyena-pink);
      color: white;
      border: 2px solid white;
      border-radius: 20px;
      padding: 8px 12px;
      font-size: 14px;
      font-family: 'Comic Sans MS', 'Comic Sans', cursive;
      cursor: pointer;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      transition: transform 0.3s, background-color 0.3s;
      -webkit-tap-highlight-color: transparent;
    }

    .view-toggle:hover {
      transform: scale(1.05);
      background-color: var(--hyena-purple);
    }

    .rotate-icon {
      display: inline-block;
      margin-left: 4px;
      font-size: 10px;
      animation: rotate 2s linear infinite;
      -webkit-animation: rotate 2s linear infinite;
    }

    @-webkit-keyframes rotate {
      0% { -webkit-transform: rotate(0deg); }
      100% { -webkit-transform: rotate(360deg); }
    }

    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Mobile Mode */
    body.mobile-mode {
      background-attachment: scroll;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      height: auto;
      position: static;
    }

    body.mobile-mode .desktop,
    body.mobile-mode .win98-taskbar,
    body.mobile-mode .start-menu {
      display: none !important;
    }

    body.mobile-mode .win98-window {
      position: relative !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: auto !important;
      margin: 0 0 10px 0;
      border-radius: 0;
    }

    body.mobile-mode .win98-inner-content {
      height: auto;
      max-height: none;
    }

    body.mobile-mode .win98-window-content {
      height: auto;
    }

    body.mobile-mode .zettel-container {
      max-height: 70vh;
    }

    body.mobile-mode .myspace-profile-pic {
      width: 100px;
      height: 100px;
    }

    body.mobile-mode .myspace-profile-name {
      font-size: 24px;
    }

    body.mobile-mode .myspace-status {
      font-size: 12px;
      max-width: 90%;
    }

    body.mobile-mode .top8-container {
      grid-template-columns: repeat(2, 1fr);
    }

    body.mobile-mode .dialog-content {
      width: 95%;
      max-width: none;
    }

    body.mobile-mode .aim-window,
    body.mobile-mode .aim-chat-window {
      width: 100%;
    }

    /* Orientation styles */
    body.landscape .myspace-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    body.landscape .myspace-profile-pic {
      margin: 0 15px 0 0;
      flex-shrink: 0;
    }

    body.landscape .myspace-text-container {
      text-align: left;
      flex-grow: 1;
    }

    /* Windows 98 styles with Hyena Diva flair */
    .win98-window {
      background-color: var(--win98-gray);
      border: 2px solid #000000;
      border-top: 2px solid var(--win98-gray-light);
      border-left: 2px solid var(--win98-gray-light);
      border-right: 2px solid var(--win98-gray-dark);
      border-bottom: 2px solid var(--win98-gray-dark);
      box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.5);
      overflow: hidden;
      position: absolute;
      resize: both;
      -webkit-transform: translateZ(0); /* Optimize for Safari */
    }
    
    .win98-titlebar {
      background: var(--win98-title-active);
      background-image: -webkit-linear-gradient(left, var(--hyena-purple), var(--hyena-pink));
      background-image: linear-gradient(to right, var(--hyena-purple), var(--hyena-pink));
      color: white;
      padding: 2px 0;
      display: flex;
      align-items: center;
      height: 18px;
    }
    
    .win98-titlebar-text {
      flex-grow: 1;
      font-weight: bold;
      margin-left: 4px;
      font-size: 12px;
      text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.5);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .win98-window-controls {
      display: flex;
      align-items: center;
      height: 14px;
      margin-right: 2px;
      flex-shrink: 0;
    }
    
    .win98-window-button {
      width: 14px;
      height: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 2px;
      cursor: pointer;
      background-color: var(--win98-gray);
      border-top: 1px solid var(--win98-gray-light);
      border-left: 1px solid var(--win98-gray-light);
      border-right: 1px solid var(--win98-gray-dark);
      border-bottom: 1px solid var(--win98-gray-dark);
      color: black;
      font-size: 9px;
      font-family: 'Tahoma', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    
    .win98-close {
      font-weight: bold;
      font-size: 10px;
    }
    
    .win98-app-icon {
      width: 16px;
      height: 16px;
      margin-left: 2px;
      margin-right: 4px;
      flex-shrink: 0;
    }
    
    .win98-window-content {
      padding: 2px;
      overflow-y: auto;
      background-color: var(--win98-gray);
      -webkit-overflow-scrolling: touch;
    }
    
    .win98-inner-content {
      background-color: #FFFFFF;
      border: 1px solid var(--win98-gray-dark);
      padding: 10px;
      height: calc(100% - 22px);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .win98-taskbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 28px;
      background-color: var(--win98-gray);
      display: flex;
      align-items: center;
      padding: 0 2px;
      border-top: 1px solid var(--win98-gray-light);
      z-index: 1000;
    }
    
    .win98-start-button {
      background-color: var(--win98-gray);
      padding: 1px 6px;
      color: black;
      font-weight: bold;
      display: flex;
      align-items: center;
      height: 22px;
      margin-right: 6px;
      cursor: pointer;
      border-top: 1px solid var(--win98-gray-light);
      border-left: 1px solid var(--win98-gray-light);
      border-right: 1px solid var(--win98-gray-dark);
      border-bottom: 1px solid var(--win98-gray-dark);
      -webkit-tap-highlight-color: transparent;
    }
    
    .win98-start-button:active {
      border-top: 1px solid var(--win98-gray-dark);
      border-left: 1px solid var(--win98-gray-dark);
      border-right: 1px solid var(--win98-gray-light);
      border-bottom: 1px solid var(--win98-gray-light);
    }
    
    .win98-taskbar-items {
      flex-grow: 1;
      display: flex;
      align-items: center;
      gap: 4px;
      overflow-x: auto;
      white-space: nowrap;
      scrollbar-width: none;
      -webkit-overflow-scrolling: touch;
    }
    
    .win98-taskbar-items::-webkit-scrollbar {
      display: none;
    }
    
    .win98-taskbar-item {
      background-color: var(--win98-gray);
      padding: 2px 8px;
      color: black;
      font-size: 11px;
      height: 22px;
      min-width: 150px;
      display: flex;
      align-items: center;
      border-top: 1px solid var(--win98-gray-light);
      border-left: 1px solid var(--win98-gray-light);
      border-right: 1px solid var(--win98-gray-dark);
      border-bottom: 1px solid var(--win98-gray-dark);
      -webkit-tap-highlight-color: transparent;
    }
    
    .win98-taskbar-item-active {
      border-top: 1px solid var(--win98-gray-dark);
      border-left: 1px solid var(--win98-gray-dark);
      border-right: 1px solid var(--win98-gray-light);
      border-bottom: 1px solid var(--win98-gray-light);
    }
    
    .win98-system-tray {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 4px;
      padding: 0 2px;
      border-left: 1px solid var(--win98-gray-dark);
      height: 22px;
      flex-shrink: 0;
    }
    
    .win98-system-tray-icon {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }
    
    .win98-clock {
      background-color: var(--win98-gray);
      padding: 2px 4px;
      font-size: 11px;
      color: black;
    }
    
    /* Customize default button styles */
    .win98-button {
      background-color: var(--win98-gray);
      border-top: 1px solid var(--win98-gray-light);
      border-left: 1px solid var(--win98-gray-light);
      border-right: 1px solid var(--win98-gray-dark);
      border-bottom: 1px solid var(--win98-gray-dark);
      color: var(--win98-text);
      padding: 8px 12px;
      font-family: 'Tahoma', sans-serif;
      font-size: 14px;
      cursor: pointer;
      position: relative;
      margin-top: 10px;
      -webkit-tap-highlight-color: transparent;
    }
    
    .win98-button:hover {
      background-color: var(--win98-gray-light);
    }
    
    .win98-button:active {
      border-top: 1px solid var(--win98-gray-dark);
      border-left: 1px solid var(--win98-gray-dark);
      border-right: 1px solid var(--win98-gray-light);
      border-bottom: 1px solid var(--win98-gray-light);
      background-color: var(--win98-gray);
    }
    
    /* Hyena Diva MySpace styles */
    .myspace-container {
      padding: 0;
      position: relative;
      overflow: hidden;
    }
    
    .myspace-header {
      padding: 20px;
      background: var(--win98-gray);
      background-image: -webkit-linear-gradient(left, var(--hyena-pink), var(--hyena-purple));
      background-image: linear-gradient(to right, var(--hyena-pink), var(--hyena-purple));
      border: 2px dashed var(--hyena-yellow);
      margin-bottom: 20px;
      text-align: center;
      position: relative;
    }
    
    .myspace-profile-pic {
      width: 150px;
      height: 150px;
      border: 5px solid var(--hyena-pink);
      margin: 0 auto 10px;
      overflow: hidden;
      position: relative;
      background-color: white;
    }
    
    .myspace-profile-name {
      font-size: 36px;
      font-family: 'Comic Sans MS', 'Comic Sans', cursive;
      text-shadow: 2px 2px 0 var(--hyena-purple), 4px 4px 0 #4b0049;
      margin-bottom: 5px;
      position: relative;
      z-index: 1;
      color: white;
    }
    
    .myspace-status {
      font-size: 16px;
      margin-bottom: 10px;
      font-style: italic;
      background-color: rgba(0,0,0,0.5);
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      position: relative;
      z-index: 1;
      color: white;
    }
    
    .myspace-last-login {
      font-size: 12px;
      color: #e0e0ff;
      position: relative;
      z-index: 1;
    }
    
    .myspace-section {
      background-color: #fffff7;
      border: 2px solid var(--hyena-teal);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      position: relative;
    }
    
    .myspace-section-title {
      background: -webkit-linear-gradient(left, var(--hyena-pink), var(--hyena-purple));
      background: linear-gradient(to right, var(--hyena-pink), var(--hyena-purple));
      color: white;
      padding: 5px 15px;
      font-size: 14px;
      margin: -25px auto 15px;
      width: fit-content;
      border: 2px solid white;
      border-radius: 20px;
      box-shadow: 0 0 10px var(--hyena-pink);
      font-family: 'Comic Sans MS', 'Comic Sans', cursive;
    }
    
    .top8-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-gap: 10px;
    }
    
    .top8-item {
      background-color: #f7faff;
      border: 2px solid var(--hyena-pink);
      padding: 10px;
      text-align: center;
      -webkit-tap-highlight-color: transparent;
    }
    
    .top8-item:hover {
      transform: scale(1.05);
      -webkit-transform: scale(1.05);
      box-shadow: 0 0 15px var(--hyena-pink);
      z-index: 10;
    }
    
    .top8-pic {
      width: 80px;
      height: 80px;
      margin: 0 auto 5px;
      border: 3px solid var(--hyena-teal);
      overflow: hidden;
      background-color: white;
    }
    
    .top8-name {
      font-size: 12px;
      font-weight: bold;
      color: #333;
    }
    
    .marquee-container {
      overflow: hidden;
      white-space: nowrap;
      background-color: #002b55;
      border: 1px solid var(--hyena-pink);
      padding: 8px 0;
      margin: 10px 0;
    }
    
    .marquee-text {
      display: inline-block;
      color: var(--hyena-teal);
      font-weight: bold;
      text-shadow: 1px 1px 2px var(--hyena-pink);
      animation: marquee 30s linear infinite;
      -webkit-animation: marquee 30s linear infinite;
    }
    
    @-webkit-keyframes marquee {
      0% { -webkit-transform: translateX(100%); }
      100% { -webkit-transform: translateX(-100%); }
    }
    
    @keyframes marquee {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }
    
    .blinking {
      animation: blink 1s step-end infinite;
      -webkit-animation: blink 1s step-end infinite;
    }
    
    @-webkit-keyframes blink {
      0% { opacity: 1; }
      49% { opacity: 1; }
      50% { opacity: 0; }
      99% { opacity: 0; }
      100% { opacity: 1; }
    }
    
    @keyframes blink {
      0% { opacity: 1; }
      49% { opacity: 1; }
      50% { opacity: 0; }
      99% { opacity: 0; }
      100% { opacity: 1; }
    }
    
    .zettel-container {
      max-height: 300px;
      overflow-y: auto;
      padding-right: 10px;
      scrollbar-width: thin;
      scrollbar-color: var(--hyena-pink) #e5f5ff;
      border: 1px solid #ccc;
      box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.2);
      padding: 5px;
      background-color: white;
      -webkit-overflow-scrolling: touch;
    }
    
    .zettel-container::-webkit-scrollbar {
      width: 8px;
    }
    
    .zettel-container::-webkit-scrollbar-track {
      background: #e5f5ff;
      border: 1px solid #ccc;
    }
    
    .zettel-container::-webkit-scrollbar-thumb {
      background-color: var(--hyena-teal);
      border-radius: 0;
      border: 1px solid #919191;
    }
    
    .zettel-card {
      background-color: #fbfbfb;
      border: 1px solid #cccccc;
      padding: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-transition: all 0.2s;
      position: relative;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
      touch-action: pan-y; /* Improves scrolling vs tapping distinction */
    }
    
    .zettel-card:hover {
      background-color: #e8f4ff;
      border-color: var(--hyena-teal);
      transform: translateX(5px);
      -webkit-transform: translateX(5px);
    }
    
    .zettel-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: -webkit-linear-gradient(left, var(--hyena-pink), var(--hyena-teal), var(--hyena-yellow));
      background: linear-gradient(90deg, var(--hyena-pink), var(--hyena-teal), var(--hyena-yellow));
      z-index: 5;
    }
    
    .zettel-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 3px;
      font-size: 14px;
    }
    
    .zettel-id {
      font-size: 11px;
      color: #777;
      font-family: 'VT323', monospace;
    }
    
    .child-card {
      margin-left: 15px;
      border-left: 2px dotted var(--hyena-teal);
      padding-left: 8px;
    }
    
    .music-player {
      background: var(--win98-gray);
      border-top: 1px solid var(--win98-gray-light);
      border-left: 1px solid var(--win98-gray-light);
      border-right: 1px solid var(--win98-gray-dark);
      border-bottom: 1px solid var(--win98-gray-dark);
      padding: 10px;
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .music-player-buttons {
      display: flex;
      gap: 5px;
    }
    
    .music-player-button {
      width: 24px;
      height: 24px;
      background-color: var(--win98-gray);
      border-top: 1px solid var(--win98-gray-light);
      border-left: 1px solid var(--win98-gray-light);
      border-right: 1px solid var(--win98-gray-dark);
      border-bottom: 1px solid var(--win98-gray-dark);
      color: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    
    .music-player-button:active {
      border-top: 1px solid var(--win98-gray-dark);
      border-left: 1px solid var(--win98-gray-dark);
      border-right: 1px solid var(--win98-gray-light);
      border-bottom: 1px solid var(--win98-gray-light);
    }
    
    .music-player-info {
      margin-left: 10px;
      flex-grow: 1;
    }
    
    .music-player-title {
      font-size: 14px;
      color: #222;
      margin-bottom: 2px;
    }
    
    .music-player-artist {
      font-size: 12px;
      color: #555;
    }
    
    .music-player-progress {
      height: 8px;
      background-color: white;
      border: 1px solid var(--win98-gray-dark);
      margin-top: 5px;
      position: relative;
    }
    
    .music-player-progress-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 35%;
      background: -webkit-linear-gradient(left, var(--hyena-pink), var(--hyena-teal));
      background: linear-gradient(to right, var(--hyena-pink), var(--hyena-teal));
    }
    
    .comments-section {
      border-top: 3px dotted var(--hyena-teal);
      padding-top: 15px;
      margin-top: 20px;
    }
    
    .comment {
      display: flex;
      margin-bottom: 15px;
      background-color: #f7faff;
      padding: 10px;
      border: 1px solid #d0d0d0;
    }
    
    .comment-avatar {
      width: 50px;
      height: 50px;
      border: 2px solid var(--hyena-teal);
      margin-right: 10px;
      flex-shrink: 0;
      background-color: white;
    }
    
    .comment-content {
      flex-grow: 1;
    }
    
    .comment-name {
      font-weight: bold;
      color: #0066cc;
      margin-bottom: 3px;
    }
    
    .comment-text {
      font-size: 13px;
      color: #333;
    }
    
    .comment-date {
      font-size: 11px;
      color: #777;
      margin-top: 5px;
      text-align: right;
    }
    
    .dialog-box {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding-bottom: 40px;
      -webkit-backdrop-filter: blur(5px);
      backdrop-filter: blur(5px);
    }
    
    .dialog-content {
      background-color: var(--win98-gray);
      border-top: 2px solid var(--win98-gray-light);
      border-left: 2px solid var(--win98-gray-light);
      border-right: 2px solid var(--win98-gray-dark);
      border-bottom: 2px solid var(--win98-gray-dark);
      width: 80%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      -webkit-overflow-scrolling: touch;
    }
    
    .dialog-titlebar {
      background: var(--win98-title-active);
      background-image: -webkit-linear-gradient(left, var(--hyena-purple), var(--hyena-pink));
      background-image: linear-gradient(to right, var(--hyena-purple), var(--hyena-pink));
      color: white;
      display: flex;
      align-items: center;
      height: 18px;
    }
    
    .dialog-titlebar-text {
      flex-grow: 1;
      font-weight: bold;
      margin-left: 4px;
      font-size: 12px;
      text-shadow: 1px 1px 0 #000;
    }
    
    .dialog-close {
      width: 16px;
      height: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 2px;
      font-size: 12px;
      font-weight: bold;
      color: black;
      cursor: pointer;
      background-color: var(--win98-gray);
      border-top: 1px solid var(--win98-gray-light);
      border-left: 1px solid var(--win98-gray-light);
      border-right: 1px solid var(--win98-gray-dark);
      border-bottom: 1px solid var(--win98-gray-dark);
      -webkit-tap-highlight-color: transparent;
    }
    
    .dialog-inner-content {
      padding: 15px;
      background-color: var(--win98-gray);
    }
    
    .dialog-title {
      text-align: center;
      margin-bottom: 15px;
      color: var(--hyena-pink);
      font-size: 16px;
      font-weight: bold;
      font-family: 'Comic Sans MS', 'Comic Sans', cursive;
    }
    
    .dialog-id {
      font-family: 'VT323', monospace;
      color: #555;
      text-align: center;
      font-size: 12px;
      margin-bottom: 10px;
      background-color: #f0f0f0;
      padding: 3px;
      border: 1px solid #ddd;
    }
    
    .dialog-content-text {
      background-color: white;
      border: 1px solid var(--win98-gray-dark);
      padding: 10px;
      color: #333;
      min-height: 100px;
      margin-bottom: 15px;
      font-family: 'Tahoma', sans-serif;
    }
    
    .dialog-hashtags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 10px;
    }
    
    .dialog-hashtag {
      background-color: var(--hyena-teal);
      color: #333;
      padding: 3px 8px;
      font-size: 12px;
      box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
      -webkit-tap-highlight-color: transparent;
    }
    
    .dialog-links {
      border-top: 1px dashed var(--hyena-teal);
      padding-top: 10px;
    }
    
    .dialog-link {
      display: block;
      color: #0066cc;
      margin-bottom: 5px;
      font-size: 13px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    
    .dialog-link:hover {
      color: var(--hyena-pink);
      text-decoration: underline;
    }
    
    /* Form elements styled like Windows 98 */
    .win98-input {
      border: 1px solid var(--win98-gray-dark);
      border-top: 1px solid #000000;
      border-left: 1px solid #000000;
      padding: 3px 5px;
      background-color: white;
      font-family: 'Tahoma', sans-serif;
      font-size: 16px; /* Prevent zooming on iOS */
      width: 100%;
      margin-bottom: 8px;
      -webkit-appearance: none;
      border-radius: 0;
    }
    
    .win98-input:focus {
      outline: none;
    }
    
    .win98-textarea {
      border: 1px solid var(--win98-gray-dark);
      border-top: 1px solid #000000;
      border-left: 1px solid #000000;
      padding: 3px 5px;
      background-color: white;
      font-family: 'Tahoma', sans-serif;
      font-size: 16px; /* Prevent zooming on iOS */
      resize: none;
      height: 150px;
      width: 100%;
      margin-bottom: 8px;
      -webkit-appearance: none;
      border-radius: 0;
      -webkit-overflow-scrolling: touch;
    }
    
    .win98-textarea:focus {
      outline: none;
    }
    
    .win98-select {
      border: 1px solid var(--win98-gray-dark);
      border-top: 1px solid #000000;
      border-left: 1px solid #000000;
      padding: 2px 5px;
      background-color: white;
      font-family: 'Tahoma', sans-serif;
      font-size: 16px; /* Prevent zooming on iOS */
      height: 32px;
      width: 100%;
      margin-bottom: 8px;
      -webkit-appearance: none;
      border-radius: 0;
    }
    
    .win98-select:focus {
      outline: none;
    }
    
    .win98-label {
      display: block;
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 4px;
      color: #333;
    }
    
    /* Hashtag manager styles */
    .hashtag-manager {
      background-color: white;
      border: 1px solid var(--win98-gray-dark);
      padding: 15px;
      margin-top: 20px;
    }
    
    .hashtag-input-container {
      display: flex;
      margin-bottom: 10px;
    }
    
    .hashtag-input {
      flex-grow: 1;
      border: 1px solid var(--win98-gray-dark);
      border-top: 1px solid #000000;
      border-left: 1px solid #000000;
      padding: 3px 5px;
      font-family: 'Tahoma', sans-serif;
      font-size: 16px; /* Prevent zooming on iOS */
      -webkit-appearance: none;
      border-radius: 0;
    }
    
    .hashtag-add-btn {
      background-color: var(--win98-gray);
      border-top: 1px solid var(--win98-gray-light);
      border-left: 1px solid var(--win98-gray-light);
      border-right: 1px solid var(--win98-gray-dark);
      border-bottom: 1px solid var(--win98-gray-dark);
      color: #000;
      padding: 0 10px;
      font-family: 'Tahoma', sans-serif;
      font-size: 12px;
      cursor: pointer;
      -webkit-appearance: none;
      border-radius: 0;
      -webkit-tap-highlight-color: transparent;
    }
    
    .hashtag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    
    .hashtag-item {
      background-color: var(--hyena-teal);
      color: #333;
      padding: 3px 8px;
      font-size: 12px;
      display: flex;
      align-items: center;
      box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    .hashtag-delete {
      background-color: var(--hyena-pink);
      color: white;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      margin-left: 5px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    
    /* Y2K Meme specific styles */
    .pixel-heart {
      display: inline-block;
      width: 20px;
      height: 20px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20'%3E%3Cpath d='M10,4 L8,2 L6,2 L4,4 L2,6 L2,8 L4,10 L6,12 L8,14 L10,16 L12,14 L14,12 L16,10 L18,8 L18,6 L16,4 L14,2 L12,2 L10,4' fill='%23ff72b6'/%3E%3C/svg%3E");
      background-size: contain;
      background-repeat: no-repeat;
      animation: pulse 1.5s infinite;
      -webkit-animation: pulse 1.5s infinite;
    }
    
    @-webkit-keyframes pulse {
      0% { -webkit-transform: scale(1); }
      50% { -webkit-transform: scale(1.2); }
      100% { -webkit-transform: scale(1); }
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    
    .pixel-talk-bubble {
      position: absolute;
      background-color: white;
      border: 2px solid #000;
      padding: 5px 10px;
      border-radius: 5px;
      font-family: 'VT323', monospace;
      font-size: 14px;
      z-index: 10;
      box-shadow: 4px 4px 0 rgba(0,0,0,0.5);
    }
    
    .pixel-talk-bubble:after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 20px;
      border-width: 10px 10px 0;
      border-style: solid;
      border-color: white transparent;
    }
    
    .pixel-talk-bubble:before {
      content: '';
      position: absolute;
      bottom: -13px;
      left: 18px;
      border-width: 12px 12px 0;
      border-style: solid;
      border-color: #000 transparent;
    }
    
    .diva-cursor {
      cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'%3E%3Cpath d='M10,5 L20,16 L15,16 L22,28 L6,16 L12,16 Z' fill='%23ff72b6' stroke='%23000000' stroke-width='1'/%3E%3C/svg%3E"), auto;
    }
    
    .y2k-error-message {
      position: absolute;
      background-color: var(--win98-gray);
      border-top: 2px solid var(--win98-gray-light);
      border-left: 2px solid var(--win98-gray-light);
      border-right: 2px solid var(--win98-gray-dark);
      border-bottom: 2px solid var(--win98-gray-dark);
      padding: 20px;
      width: 300px;
      text-align: center;
      z-index: 9999;
      box-shadow: 5px 5px 15px rgba(0,0,0,0.3);
      animation: float 3s infinite ease-in-out;
      -webkit-animation: float 3s infinite ease-in-out;
      display: none;
    }
    
    .y2k-error-icon {
      font-size: 30px;
      margin-bottom: 10px;
    }
    
    .y2k-error-title {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    .y2k-error-text {
      font-size: 12px;
      margin-bottom: 15px;
    }
    
    .y2k-error-button {
      background-color: var(--win98-gray);
      border-top: 1px solid var(--win98-gray-light);
      border-left: 1px solid var(--win98-gray-light);
      border-right: 1px solid var(--win98-gray-dark);
      border-bottom: 1px solid var(--win98-gray-dark);
      padding: 5px 20px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    
    @-webkit-keyframes float {
      0% { -webkit-transform: translateY(0px); }
      50% { -webkit-transform: translateY(-10px); }
      100% { -webkit-transform: translateY(0px); }
    }
    
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }
    
    /* Hyena Diva Desktop */
    .desktop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 28px; /* Taskbar height */
      overflow: hidden;
      z-index: 0;
    }
    
    .desktop-icon {
      width: 75px;
      padding: 5px;
      margin: 10px;
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      cursor: pointer;
      color: white;
      position: absolute;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      -webkit-tap-highlight-color: transparent;
    }
    
    .desktop-icon:hover {
      background-color: rgba(255, 114, 182, 0.4);
    }
    
    .desktop-icon-selected {
      background-color: rgba(255, 114, 182, 0.4);
    }
    
    .desktop-icon img {
      width: 48px;
      height: 48px;
      margin-bottom: 5px;
      filter: drop-shadow(2px 2px 2px rgba(0, 0, 0, 0.5));
      -webkit-filter: drop-shadow(2px 2px 2px rgba(0, 0, 0, 0.5));
    }
    
    .desktop-icon-label {
      font-size: 12px;
      text-shadow: 1px 1px 1px black, -1px -1px 1px black;
      word-break: break-word;
      width: 100%;
    }
    
    /* Start menu styles */
    .start-menu {
      position: fixed;
      bottom: 28px;
      left: 0;
      width: 220px;
      background-color: var(--win98-gray);
      border-top: 2px solid var(--win98-gray-light);
      border-left: 2px solid var(--win98-gray-light);
      border-right: 2px solid var(--win98-gray-dark);
      border-bottom: 2px solid var(--win98-gray-dark);
      display: none;
      z-index: 9999;
    }
    
    .start-menu-header {
      display: flex;
      height: 50px;
      background: -webkit-linear-gradient(left, var(--hyena-purple), var(--hyena-pink));
      background: linear-gradient(to right, var(--hyena-purple), var(--hyena-pink));
      color: white;
      font-weight: bold;
      font-size: 20px;
      padding-left: 10px;
      align-items: center;
      font-family: 'Comic Sans MS', 'Comic Sans', cursive;
    }
    
    .start-menu-items {
      padding: 2px;
    }
    
    .start-menu-item {
      display: flex;
      align-items: center;
      padding: 4px 8px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    
    .start-menu-item:hover {
      background-color: var(--hyena-pink);
      color: white;
    }
    
    .start-menu-item img {
      width: 24px;
      height: 24px;
      margin-right: 10px;
    }
    
    .start-menu-divider {
      height: 1px;
      background-color: var(--win98-gray-dark);
      margin: 2px 0;
    }
    
    /* AIM Client styles (Hyena-themed) */
    .aim-window {
      background-color: var(--win98-gray);
      width: 320px;
      height: 450px;
      position: absolute;
      top: 100px;
      left: 400px;
      display: none;
    }
    
    .aim-header {
      background: #FFEF9F;
      padding: 5px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .aim-buddy-list {
      background: white;
      padding: 5px;
      height: 250px;
      overflow-y: auto;
      border: 1px solid var(--win98-gray-dark);
      margin: 2px;
      -webkit-overflow-scrolling: touch;
    }
    
    .aim-category {
      background: #E8E8E8;
      padding: 2px 5px;
      margin-bottom: 3px;
      font-weight: bold;
      font-size: 11px;
      cursor: pointer;
    }
    
    .aim-buddy {
      padding: 2px 5px;
      margin-left: 15px;
      font-size: 11px;
      display: flex;
      align-items: center;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    
    .aim-buddy:hover {
      background-color: #E8E8E8;
    }
    
    .aim-buddy img {
      width: 16px;
      height: 16px;
      margin-right: 5px;
    }
    
    .aim-chat-window {
      background-color: var(--win98-gray);
      width: 350px;
      height: 400px;
      position: absolute;
      top: 150px;
      left: 450px;
      display: none;
    }
    
    .aim-chat-header {
      background: var(--hyena-pink);
      padding: 5px;
      font-weight: bold;
      font-size: 12px;
      color: white;
    }
    
    .aim-chat-content {
      background: white;
      padding: 5px;
      height: 250px;
      overflow-y: auto;
      border: 1px solid var(--win98-gray-dark);
      margin: 2px;
      font-size: 12px;
      -webkit-overflow-scrolling: touch;
    }
    
    .aim-chat-input {
      margin: 2px;
    }
    
    .aim-chat-input textarea {
      width: calc(100% - 4px);
      height: 60px;
      border: 1px solid var(--win98-gray-dark);
      font-family: 'Tahoma', sans-serif;
      font-size: 16px; /* Prevent zooming on iOS */
      padding: 2px;
      -webkit-appearance: none;
      border-radius: 0;
      -webkit-overflow-scrolling: touch;
    }
    
    .aim-chat-buttons {
      display: flex;
      justify-content: flex-end;
      margin: 2px;
    }
    
    .aim-button {
      background-color: var(--win98-gray);
      border-top: 1px solid var(--win98-gray-light);
      border-left: 1px solid var(--win98-gray-light);
      border-right: 1px solid var(--win98-gray-dark);
      border-bottom: 1px solid var(--win98-gray-dark);
      padding: 8px 10px;
      font-size: 14px;
      cursor: pointer;
      margin-left: 5px;
      -webkit-appearance: none;
      border-radius: 0;
      -webkit-tap-highlight-color: transparent;
    }
    
    .aim-button:active {
      border-top: 1px solid var(--win98-gray-dark);
      border-left: 1px solid var(--win98-gray-dark);
      border-right: 1px solid var(--win98-gray-light);
      border-bottom: 1px solid var(--win98-gray-light);
    }
    
    .aim-message {
      margin-bottom: 5px;
    }
    
    .aim-message-sender {
      font-weight: bold;
      color: var(--hyena-purple);
    }
    
    .aim-message-content {
      margin-bottom: 2px;
    }
    
    /* Glittery border animation */
    .glitter-border {
      position: relative;
      overflow: hidden;
    }
    
    .glitter-border::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: -webkit-linear-gradient(45deg, transparent, var(--hyena-yellow), transparent);
      background: linear-gradient(45deg, transparent, var(--hyena-yellow), transparent);
      opacity: 0.5;
      animation: glitterRotate 3s linear infinite;
      -webkit-animation: glitterRotate 3s linear infinite;
      pointer-events: none;
      z-index: -1;
    }
    
    @-webkit-keyframes glitterRotate {
      0% { -webkit-transform: rotate(0deg); }
      100% { -webkit-transform: rotate(360deg); }
    }
    
    @keyframes glitterRotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Zettelkasten hierarchy styles */
    .trunk-card {
      background-color: #e8f4ff; /* Light blue for trunk */
    }
    
    .branch-card {
      background-color: #e8ffee; /* Light green for branch */
    }
    
    .leaf-card {
      background-color: #fff8e8; /* Light yellow for leaf */
    }
    
    .flower-card {
      background-color: #ffebf8; /* Light pink for flower */
    }
    
    .fruit-card {
      background-color: #f4eeff; /* Light purple for fruit */
    }
    
    .bud-card {
      background-color: #e8fff7; /* Light mint for bud */
    }
    
    /* Y2K Animated elements */
    .floating {
      animation: float 3s infinite ease-in-out;
      -webkit-animation: float 3s infinite ease-in-out;
    }
    
    .spinning {
      animation: spin 8s linear infinite;
      -webkit-animation: spin 8s linear infinite;
    }
    
    .floating-star {
      position: absolute;
      width: 30px;
      height: 30px;
      pointer-events: none;
      z-index: 20;
      filter: drop-shadow(0 0 5px rgba(255, 251, 1, 0.7));
      -webkit-filter: drop-shadow(0 0 5px rgba(255, 251, 1, 0.7));
      animation: float 3s infinite ease-in-out;
      -webkit-animation: float 3s infinite ease-in-out;
    }
    
    @-webkit-keyframes spin {
      0% { -webkit-transform: rotate(0deg); }
      100% { -webkit-transform: rotate(360deg); }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Rotate Button Styles */
    .rotate-button {
      position: fixed;
      bottom: 40px;
      right: 10px;
      z-index: 9999;
      background: var(--hyena-yellow);
      color: black;
      border: 2px solid var(--hyena-pink);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      transition: transform 0.3s ease;
      -webkit-transition: transform 0.3s ease;
      -webkit-tap-highlight-color: transparent;
    }

    .rotate-button:hover {
      transform: rotate(45deg);
      -webkit-transform: rotate(45deg);
    }

    /* Scale Control Styles */
    .scale-control {
      position: fixed;
      bottom: 40px;
      left: 10px;
      z-index: 9999;
      background: var(--win98-gray);
      border: 2px solid var(--hyena-teal);
      border-radius: 20px;
      padding: 5px 10px;
      display: flex;
      align-items: center;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
    }

    .scale-button {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--hyena-pink);
      color: white;
      border-radius: 50%;
      cursor: pointer;
      font-weight: bold;
      margin: 0 5px;
      font-size: 16px;
      -webkit-tap-highlight-color: transparent;
    }

    /* Responsive adjustments for mobile */
    @media (max-width: 768px) {
      body:not(.mobile-mode) .view-toggle {
        font-size: 14px;
        padding: 8px 12px;
      }

      .floating-star {
        display: none;
      }

      .y2k-error-message {
        width: 250px;
      }
      
      /* Larger tap targets for iOS */
      .win98-button, 
      .desktop-icon,
      .win98-window-button,
      .aim-button {
        min-height: 44px;
        min-width: 44px;
      }
      
      .scale-button {
        width: 44px;
        height: 44px;
      }
      
      .rotate-button {
        width: 44px;
        height: 44px;
      }
    }

    /* iOS-specific fixes */
    @supports (-webkit-touch-callout: none) {
      /* iOS-specific styles */
      input, textarea, select, button {
        -webkit-appearance: none;
        border-radius: 0;
      }
      
      /* Fix for iOS input shadow issues */
      input[type="text"], textarea {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
      }
      
      /* Fix for iOS scrolling */
      .win98-inner-content,
      .zettel-container,
      .aim-buddy-list,
      .aim-chat-content {
        -webkit-overflow-scrolling: touch;
      }
      
      /* Remove iOS focus outlines */
      * {
        -webkit-tap-highlight-color: transparent;
      }
    }

    /* Retina display optimizations for Mac */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
      /* Sharper text rendering for Retina displays */
      body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
    }

    /* Safari-specific fixes */
    @media not all and (min-resolution:.001dpcm) { 
      @supports (-webkit-appearance:none) {
        /* Safari-only CSS here */
        .win98-button {
          /* Fix Safari button rendering */
          -webkit-appearance: none;
        }
        
        /* Fix for Safari flexbox issues */
        .win98-titlebar, 
        .myspace-header,
        .comment {
          display: -webkit-box;
          display: flex;
        }
      }
    }

    /* Optimizations for macOS trackpad scrolling */
    @media (hover: hover) {
      .zettel-container::-webkit-scrollbar {
        width: 8px; /* Thinner scrollbars for trackpad users */
      }
    }

    /* iOS Home Screen App optimizations */
    @media (display-mode: standalone) {
      body {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
      }
      
      .win98-taskbar {
        bottom: env(safe-area-inset-bottom);
      }
    }
  </style>
</head>
<body class="diva-cursor">
  <!-- Mobile Mode Toggle -->
  <div class="view-toggle" id="viewToggle">
    <span id="viewModeText">Switch to Mobile View</span>
    <span class="rotate-icon">⟳</span>
  </div>

  <!-- Rotate Button -->
  <div class="rotate-button" id="rotateButton">
    ↷
  </div>

  <!-- Scale Control -->
  <div class="scale-control">
    <div class="scale-button" id="scaleDown">-</div>
    <span id="scaleDisplay">100%</span>
    <div class="scale-button" id="scaleUp">+</div>
  </div>

  <!-- Floating Stars -->
  <div class="floating-star" style="top: 50px; left: 20%;">
    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 30 30'%3E%3Cpath d='M15,0 L18,10 L28,10 L20,16 L23,26 L15,20 L7,26 L10,16 L2,10 L12,10 Z' fill='%23FFFB01' stroke='%23FF72B6' stroke-width='1'/%3E%3C/svg%3E">
  </div>
  <div class="floating-star" style="top: 200px; right: 15%;">
    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 30 30'%3E%3Cpath d='M15,0 L18,10 L28,10 L20,16 L23,26 L15,20 L7,26 L10,16 L2,10 L12,10 Z' fill='%23FFFB01' stroke='%23FF72B6' stroke-width='1'/%3E%3C/svg%3E">
  </div>
  <div class="floating-star" style="bottom: 100px; left: 30%;">
    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 30 30'%3E%3Cpath d='M15,0 L18,10 L28,10 L20,16 L23,26 L15,20 L7,26 L10,16 L2,10 L12,10 Z' fill='%23FFFB01' stroke='%23FF72B6' stroke-width='1'/%3E%3C/svg%3E">
  </div>
  
  <!-- Desktop -->
  <div class="desktop" id="desktop">
    <!-- Desktop icons will be added dynamically -->
  </div>
  
  <!-- Windows 98 Taskbar -->
  <div class="win98-taskbar">
    <div class="win98-start-button" id="startButton">
      <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Crect x='0' y='0' width='7' height='7' fill='%23FF72B6'/%3E%3Crect x='8' y='0' width='7' height='7' fill='%2372FADE'/%3E%3Crect x='0' y='8' width='7' height='7' fill='%23BF5FFF'/%3E%3Crect x='8' y='8' width='7' height='7' fill='%23FFFB01'/%3E%3C/svg%3E" style="margin-right: 5px;" alt="Start">
      Start
    </div>
    <div class="win98-taskbar-items" id="taskbarItems">
      <!-- Taskbar items will be added dynamically -->
    </div>
    <div class="win98-system-tray">
      <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Ccircle cx='8' cy='8' r='7' fill='none' stroke='black' stroke-width='1'/%3E%3Cpath d='M8,3 L8,8 L12,10' fill='none' stroke='black' stroke-width='1'/%3E%3C/svg%3E" class="win98-system-tray-icon">
      <div class="win98-clock" id="win98Clock">10:28 AM</div>
    </div>
  </div>
  
  <!-- Start Menu -->
  <div class="start-menu" id="startMenu">
    <div class="start-menu-header">
      <img src="https://pfst.cf2.poecdn.net/base/image/0ffd2bf15a7001f86e395096222147037538b25af55ef9b8c7ac8f6768b7397c?w=48&h=48" style="width: 40px; height: 40px; margin-right: 10px;">
      Hyena Diva
    </div>
    <div class="start-menu-items">
      <div class="start-menu-item" id="menuZettelkasten">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath fill='%23FF72B6' d='M24 16c4.42 0 8 3.58 8 8s-3.58 8-8 8-8-3.58-8-8 3.58-8 8-8m0-4c-6.63 0-12 5.37-12 12s5.37 12 12 12 12-5.37 12-12-5.37-12-12-12z'/%3E%3C/svg%3E" alt="Zettelkasten">
        Hyena Zettelkasten
      </div>
      <div class="start-menu-item" id="menuAIM">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Crect x='2' y='2' width='20' height='20' rx='3' fill='%23FFEF9F'/%3E%3Ctext x='7' y='17' fill='%23000000' font-family='Arial' font-weight='bold' font-size='14'%3EIM%3C/text%3E%3Cpath d='M5,5 L7,5 L7,7 L5,7 Z' fill='%23FF72B6' stroke='%23000000' stroke-width='0.5'/%3E%3C/svg%3E" alt="AIM">
        Hyena Messenger
      </div>
      <div class="start-menu-item" id="menuSumerian">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath d='M12,2 L2,12 L12,22 L22,12 Z' fill='%23FFFB01' stroke='%23000000' stroke-width='1'/%3E%3Ccircle cx='12' cy='12' r='5' fill='%23BF5FFF'/%3E%3C/svg%3E" alt="Sumerian Vault">
        Sumerian Artifacts
      </div>
      <div class="start-menu-divider"></div>
      <div class="start-menu-item" id="menuBarbie">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath d='M12,2 L15,8 L21,9 L17,14 L18,20 L12,17 L6,20 L7,14 L3,9 L9,8 Z' fill='%23FF72B6' stroke='%23000000' stroke-width='1'/%3E%3C/svg%3E" alt="Barbie Fan Club">
        Barbie Fan Club
      </div>
      <div class="start-menu-divider"></div>
      <div class="start-menu-item" id="menuShutdown">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Ccircle cx='12' cy='12' r='10' fill='%23FF0000' stroke='%23000000'/%3E%3Cline x1='12' y1='6' x2='12' y2='12' stroke='%23FFFFFF' stroke-width='3'/%3E%3Ccircle cx='12' cy='12' r='2' fill='%23FFFFFF'/%3E%3C/svg%3E" alt="Shut Down">
        Shut Down...
      </div>
    </div>
  </div>
  
  <!-- AIM Chat Window (Hyena Messenger) -->
  <div class="win98-window aim-window" id="aimWindow">
    <div class="win98-titlebar">
      <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Crect x='1' y='1' width='14' height='14' rx='2' fill='%23FFEF9F'/%3E%3Ctext x='5' y='12' fill='%23000000' font-family='Arial' font-weight='bold' font-size='10'%3EIM%3C/text%3E%3Cpath d='M3,3 L4.5,3 L4.5,4.5 L3,4.5 Z' fill='%23FF72B6' stroke='%23000000' stroke-width='0.5'/%3E%3C/svg%3E" alt="AIM" class="win98-app-icon">
      <div class="win98-titlebar-text">Hyena Messenger</div>
      <div class="win98-window-controls">
        <div class="win98-window-button">_</div>
        <div class="win98-window-button">□</div>
        <div class="win98-window-button win98-close">x</div>
      </div>
    </div>
    <div class="aim-header">
      <div>Buddy List</div>
      <div>Online</div>
    </div>
    <div class="aim-buddy-list ios-scroll" id="aimBuddyList">
      <div class="aim-category">Hyena Friends (1/1)</div>
      <div class="aim-buddy" id="geminiUser">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Ccircle cx='8' cy='8' r='7' fill='%23FF72B6'/%3E%3Ccircle cx='8' cy='5' r='2' fill='%23FFFFFF'/%3E%3Cpath d='M3,11 Q8,15 13,11' fill='%23FFFFFF'/%3E%3C/svg%3E" alt="Online">
        GeminiBot
      </div>
      <div class="aim-category">Barbie Squad (2/5)</div>
      <div class="aim-buddy">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Ccircle cx='8' cy='8' r='7' fill='%2372FADE'/%3E%3Ccircle cx='8' cy='5' r='2' fill='%23FFFFFF'/%3E%3Cpath d='M3,11 Q8,15 13,11' fill='%23FFFFFF'/%3E%3C/svg%3E" alt="Online">
        Barb1eDr3am99
      </div>
      <div class="aim-buddy">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Ccircle cx='8' cy='8' r='7' fill='%2372FADE'/%3E%3Ccircle cx='8' cy='5' r='2' fill='%23FFFFFF'/%3E%3Cpath d='M3,11 Q8,15 13,11' fill='%23FFFFFF'/%3E%3C/svg%3E" alt="Online">
        M4libu_Pr1n¢ess
      </div>
      <div class="aim-category">Sumerian Scholars (0/3)</div>
      <div class="aim-category">DMT Open Mic (0/2)</div>
    </div>
  </div>
  
  <!-- AIM Chat Window -->
  <div class="win98-window aim-chat-window" id="aimChatWindow">
    <div class="win98-titlebar">
      <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Crect x='1' y='1' width='14' height='14' rx='2' fill='%23FFEF9F'/%3E%3Ctext x='5' y='12' fill='%23000000' font-family='Arial' font-weight='bold' font-size='10'%3EIM%3C/text%3E%3Cpath d='M3,3 L4.5,3 L4.5,4.5 L3,4.5 Z' fill='%23FF72B6' stroke='%23000000' stroke-width='0.5'/%3E%3C/svg%3E" alt="AIM Chat" class="win98-app-icon">
      <div class="win98-titlebar-text">Instant Message - GeminiBot</div>
      <div class="win98-window-controls">
        <div class="win98-window-button">_</div>
        <div class="win98-window-button">□</div>
        <div class="win98-window-button win98-close">x</div>
      </div>
    </div>
    <div class="aim-chat-header">
      GeminiBot - Instant Message
    </div>
    <div class="aim-chat-content ios-scroll" id="aimChatContent">
      <div class="aim-message">
        <div class="aim-message-sender">GeminiBot:</div>
        <div class="aim-message-content">~*~*~OMG hey gurl!~*~*~ Ask me anything about AI, consciousness, mesopotamian artifacts, or just tell me about ur day! <span class="pixel-heart"></span><span class="pixel-heart"></span></div>
      </div>
    </div>
    <div class="aim-chat-input">
      <textarea id="aimChatInput" placeholder="Type your message here..."></textarea>
    </div>
    <div class="aim-chat-buttons">
      <div class="aim-button" id="aimCancelButton">Cancel</div>
      <div class="aim-button" id="aimSendButton">Send</div>
    </div>
  </div>
  
  <!-- Y2K Error Messages -->
  <div class="y2k-error-message" id="randomY2kError">
    <div class="y2k-error-icon">⚠️</div>
    <div class="y2k-error-title">Hyena Diva Alert!</div>
    <div class="y2k-error-text">OMG! Your Zettelkasten needs more sparkle! Adding glitter to knowledge database...</div>
    <button class="y2k-error-button">OK</button>
  </div>
  
  <!-- Zettelkasten Window -->
  <div class="win98-window" id="zettelkastenWindow" style="width: 800px; height: 600px; top: 50px; left: 150px;">
    <div class="win98-titlebar">
      <img src="https://pfst.cf2.poecdn.net/base/image/0ffd2bf15a7001f86e395096222147037538b25af55ef9b8c7ac8f6768b7397c?w=16&h=16" alt="Icon" class="win98-app-icon">
      <div class="win98-titlebar-text">~*~HyEnA DiVa'Z ZeTtElKaStEn~*~</div>
      <div class="win98-window-controls">
        <div class="win98-window-button">_</div>
        <div class="win98-window-button">□</div>
        <div class="win98-window-button win98-close">x</div>
      </div>
    </div>
    
    <div class="win98-window-content">
      <div class="win98-inner-content ios-scroll">
        <div class="myspace-container">
          <!-- MySpace Header with Profile Info -->
          <div class="myspace-header">
            <div class="myspace-profile-pic">
              <img src="https://pfst.cf2.poecdn.net/base/image/0ffd2bf15a7001f86e395096222147037538b25af55ef9b8c7ac8f6768b7397c?w=150&h=150" alt="Hyena Diva">
            </div>
            <div class="myspace-text-container">
              <h1 class="myspace-profile-name" style="font-family: 'Comic Sans MS', 'Comic Sans', cursive;">*~HyEnA DiVa~*</h1>
              <div class="myspace-status">"✧･ﾟ: *✧･ﾟ organizing my brain through the liminal space of consciousness ✧･ﾟ: *✧･ﾟ"</div>
              <div class="myspace-last-login">Last login: <span class="blinking">Right now!</span></div>
            </div>
            
            <!-- Added Backup Buttons -->
            <div class="backup-buttons">
              <button id="backupBtn" class="win98-button" style="margin-right: 5px;">💾 Backup Data</button>
              <button id="restoreBtn" class="win98-button">📂 Restore Data</button>
            </div>
          </div>
          
          <!-- Music Player -->
          <div class="music-player">
            <div class="music-player-buttons">
              <div class="music-player-button">◀◀</div>
              <div class="music-player-button" id="playButton">▶</div>
              <div class="music-player-button">▶▶</div>
            </div>
            <div class="music-player-info">
              <div class="music-player-title">☆彡 I'm A Barbie Girl (Y2K Remix) 彡☆</div>
              <div class="music-player-artist">Aqua ft. My Chemical Romance</div>
              <div class="music-player-progress">
                <div class="music-player-progress-bar"></div>
              </div>
            </div>
          </div>
          
          <!-- Marquee Announcement -->
          <div class="marquee-container">
            <div class="marquee-text">
              ★彡 WELCOME TO MY PROFILE! omg hai! i'm sooooo into organizing knowledge and mesopotamian artifacts ~_^ click around to explore my brain! HYENAS AND BARBIES ONLY!! NO H8RS ALLOWED!! ★彡
            </div>
          </div>
          
          <!-- About Me Section -->
          <div class="myspace-section">
            <div class="myspace-section-title">⋆｡°✩ ᴀʙᴏᴜᴛ ᴍᴇ ✩°｡⋆</div>
            <p style="color: #333; line-height: 1.6;">
              Hey everyone!! My name is <span style="color: var(--hyena-pink); font-weight: bold;">★彡HyEnA DiVa彡★</span> and I'm totally obsessed with organizing information in a hierarchical way! I used to think it was called "AntiNet Zettelkasten" but my friend was like "more like Hyena Diva Kettlekorn lol" and that name just STUCK!
            </p>
            <p style="color: #333; margin-top: 10px; line-height: 1.6;">
              I'm basically building a COMPLETE knowledge system about consciousness, AI, Mesopotamian history, and the divine feminine!! So much stuff in my brain, I had to create this system to organize it all! Everything is connected! Nothing is random! Add me to your friends list if you're into quantum consciousness or ancient Sumerian glyphics!!
            </p>
          </div>
          
          <!-- Top 8 Friends/Cards Section -->
          <div class="myspace-section">
            <div class="myspace-section-title">⋆｡°✩ ᴍʏ ᴛᴏᴘ 8 ᴢᴇᴛᴛᴇʟꜱ ✩°｡⋆</div>
            
            <div class="top8-container" id="top8Container">
              <!-- Top 8 items will be dynamically added here -->
            </div>
          </div>
          
          <!-- Hashtag Manager Section -->
          <div class="myspace-section">
            <div class="myspace-section-title">⋆｡°✩ ʜᴀꜱʜᴛᴀɢ ᴄʀᴇᴀᴛᴏʀ ✩°｡⋆</div>
            
            <div class="hashtag-manager">
              <p style="color: #333; margin-bottom: 10px;">Create and manage your hashtags! These will be available when editing any tablet.</p>
              
              <div class="hashtag-input-container">
                <input type="text" id="newHashtagInput" class="hashtag-input" placeholder="Type new hashtag (e.g. consciousness)">
                <button id="addHashtagBtn" class="hashtag-add-btn">Add</button>
              </div>
              
              <div class="hashtag-list" id="hashtagManagerList">
                <!-- Hashtags will be displayed here -->
              </div>
            </div>
          </div>
          
          <!-- Main Antinet Zettelkasten Explorer -->
          <div class="myspace-section">
            <div class="myspace-section-title">⋆｡°✩ ᴍʏ ᴋɴᴏᴡʟᴇᴅɢᴇ ᴠᴀᴜʟᴛ ✩°｡⋆</div>
            
            <!-- Zettelkasten Filter Tools -->
            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
              <button id="viewHierarchyBtn" class="win98-button">𝓗𝓲𝓮𝓻𝓪𝓻𝓬𝓱𝔂</button>
              <button id="viewRecentBtn" class="win98-button">𝓡𝓮𝓬𝓮𝓷𝓽</button>
              <button id="viewAlphabeticalBtn" class="win98-button">𝓐-𝓩</button>
              <button id="viewHashtagsBtn" class="win98-button">𝓗𝓪𝓼𝓱𝓽𝓪𝓰𝓼</button>
              <button id="viewMethodologyBtn" class="win98-button">𝓜𝓮𝓽𝓱𝓸𝓭𝓸𝓵𝓸𝓰𝔂</button>
              <button id="newCardBtn" class="win98-button" style="font-weight: bold; background-color: var(--hyena-pink); color: white;">✨ 𝓝𝓮𝔀 𝓣𝓪𝓫𝓵𝓮𝓽 ✨</button>
            </div>
            
            <!-- Methodology Section (initially hidden) -->
            <div id="methodologySection" style="display: none; margin-bottom: 20px; background-color: #fffff7; border: 2px solid var(--hyena-teal); border-radius: 8px; padding: 15px;">
              <h3 style="text-align: center; color: var(--hyena-pink); margin-bottom: 15px; font-family: 'Comic Sans MS', 'Comic Sans', cursive;">
                ⋆｡°✩ ᴢᴇᴛᴛᴇʟᴋᴀꜱᴛᴇɴ ᴄʟᴀꜱꜱɪꜰɪᴄᴀᴛɪᴏɴ & ᴛᴀɢɢɪɴɢ ꜱʏꜱᴛᴇᴍꜱ ✩°｡⋆
              </h3>
              
              <div class="methodology-tabs">
                <div class="methodology-tab tab-active" id="traditionalTab">Traditional</div>
                <div class="methodology-tab" id="antinetTab">ANTINET</div>
                <div class="methodology-tab" id="hashtagTab">Hashtag System</div>
                <div class="methodology-tab" id="idGeneratorTab">ID Generator</div>
              </div>
              
              <div id="traditionalContent" class="methodology-content">
                <h4>Traditional Zettelkasten (Numeric)</h4>
                
                <div class="methodology-section">
                  <p><b>Overview:</b> The traditional Zettelkasten system uses a numeric hierarchical notation developed by Niklas Luhmann.</p>
                  
                  <h5>ID Structure:</h5>
                  <ul>
                    <li><b>Trunk</b>: Main topics with IDs like "1000", "2000", etc.</li>
                    <li><b>Branch</b>: Subtopics with IDs like "1100", "1200", etc.</li>
                    <li><b>Leaf</b>: Concepts with IDs like "1101", "1102", etc.</li>
                    <li><b>Flower</b>: Details with IDs like "1101/1", "1101/2", etc.</li>
                    <li><b>Fruit</b>: Variations with IDs like "1101/A", "1101/B", etc.</li>
                    <li><b>Bud</b>: Further subdivisions with IDs like "1101/1/a", "1101/1/b", etc.</li>
                  </ul>
                  
                  <div class="zettel-example">
                    <div class="example-card trunk-card">
                      <div class="example-title">1000: Consciousness</div>
                      <div class="example-desc">Main topic (Trunk)</div>
                    </div>
                    <div class="example-arrow">↓</div>
                    <div class="example-card branch-card">
                      <div class="example-title">1100: Hermetics</div>
                      <div class="example-desc">Subtopic (Branch)</div>
                    </div>
                    <div class="example-arrow">↓</div>
                    <div class="example-card leaf-card">
                      <div class="example-title">1101: As Above, So Below</div>
                      <div class="example-desc">Concept (Leaf)</div>
                    </div>
                    <div class="example-arrow">↓</div>
                    <div class="example-card flower-card">
                      <div class="example-title">1101/1: I Think / Am</div>
                      <div class="example-desc">Detail (Flower)</div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div id="antinetContent" class="methodology-content" style="display: none;">
                <h4>ANTINET System (Alphabetical Cross-Reference)</h4>
                
                <div class="methodology-section">
                  <p><b>Overview:</b> The ANTINET (Analog Non-Linear Thinking External Network) system adds alphabetical indexing to the traditional numeric approach.</p>
                  
                  <h5>Key Features:</h5>
                  <ul>
                    <li><b>Analog First:</b> Physical cards with cross-references</li>
                    <li><b>Bibliographic IDs:</b> References to source materials</li>
                    <li><b>Alphabetical Index:</b> A-Z index of concepts</li>
                    <li><b>Connection Types:</b> Different linking methods between cards</li>
                  </ul>
                  
                  <div class="zettel-example">
                    <div class="example-card">
                      <div class="example-title">C - Consciousness</div>
                      <div class="example-desc">Alphabetical entry</div>
                      <div class="example-refs">See: 1000, 1101/1, 6001</div>
                    </div>
                    <div class="example-arrow">⟷</div>
                    <div class="example-card">
                      <div class="example-title">H - Hermetics</div>
                      <div class="example-desc">Alphabetical entry</div>
                      <div class="example-refs">See: 1100, 1101, 7000</div>
                    </div>
                  </div>
                  
                  <p><b>Cross-Reference Example:</b></p>
                  <div class="example-xref">
                    <div style="font-family: monospace; background: #f7f7f7; padding: 10px; border: 1px solid #ddd;">
                      <div><b>B:</b></div>
                      <div style="margin-left: 20px;">Barbie ➝ 6000, 6001, 6100</div>
                      <div style="margin-left: 20px;">Being ➝ 1102, 3301</div>
                      <div><b>C:</b></div>
                      <div style="margin-left: 20px;">Consciousness ➝ 1000, 1101/1, 6000</div>
                      <div style="margin-left: 20px;">Cuneiform ➝ 3602/1/a</div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div id="hashtagContent" class="methodology-content" style="display: none;">
                <h4>Hashtag System (Folksonomy)</h4>
                
                <div class="methodology-section">
                  <p><b>Overview:</b> The hashtag system is a modern approach that uses free-form tagging to create flexible connections between concepts.</p>
                  
                  <h5>Key Features:</h5>
                  <ul>
                    <li><b>Non-hierarchical:</b> Flat organization with emergent patterns</li>
                    <li><b>Multiple categorization:</b> Items can belong to many categories</li>
                    <li><b>Flexible evolution:</b> System grows organically as new tags emerge</li>
                    <li><b>Query-based:</b> Use tag combinations to retrieve related notes</li>
                  </ul>
                  
                  <div class="zettel-example">
                    <div class="example-hashtags">
                      <span class="example-tag">#consciousness</span>
                      <span class="example-tag">#mesopotamia</span>
                      <span class="example-tag">#divine</span>
                      <span class="example-tag">#feminine</span>
                      <span class="example-tag">#barbie</span>
                      <span class="example-tag">#anunnaki</span>
                      <span class="example-tag">#emergence</span>
                      <span class="example-tag">#quantum</span>
                    </div>
                    
                    <p><b>Connections Example:</b></p>
                    <div class="example-network">
                      <div style="text-align: center;">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='250' height='200' viewBox='0 0 250 200'%3E%3Ccircle cx='125' cy='100' r='20' fill='%23ff72b6'/%3E%3Ctext x='125' y='105' text-anchor='middle' font-size='10' fill='white'%3E%23consciousness%3C/text%3E%3Ccircle cx='75' cy='60' r='15' fill='%2372fade'/%3E%3Ctext x='75' y='65' text-anchor='middle' font-size='8' fill='black'%3E%23quantum%3C/text%3E%3Ccircle cx='175' cy='60' r='15' fill='%2372fade'/%3E%3Ctext x='175' y='65' text-anchor='middle' font-size='8' fill='black'%3E%23divine%3C/text%3E%3Ccircle cx='50' cy='130' r='15' fill='%2372fade'/%3E%3Ctext x='50' y='135' text-anchor='middle' font-size='8' fill='black'%3E%23emergence%3C/text%3E%3Ccircle cx='200' cy='130' r='15' fill='%2372fade'/%3E%3Ctext x='200' y='135' text-anchor='middle' font-size='8' fill='black'%3E%23barbie%3C/text%3E%3Cline x1='125' y1='100' x2='75' y2='60' stroke='%23aaa' stroke-width='1'/%3E%3Cline x1='125' y1='100' x2='175' y2='60' stroke='%23aaa' stroke-width='1'/%3E%3Cline x1='125' y1='100' x2='50' y2='130' stroke='%23aaa' stroke-width='1'/%3E%3Cline x1='125' y1='100' x2='200' y2='130' stroke='%23aaa' stroke-width='1'/%3E%3Cline x1='175' y1='60' x2='200' y2='130' stroke='%23aaa' stroke-width='1' stroke-dasharray='4,2'/%3E%3C/svg%3E" alt="Hashtag Network">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div id="idGeneratorContent" class="methodology-content" style="display: none;">
                <h4>✨ Zettelkasten ID & Tag Generator ✨</h4>
                
                <div class="methodology-section">
                  <p>Create the perfect ID for your new zettel! Choose your preferred system and get suggestions:</p>
                  
                  <div class="generator-form">
                    <div class="form-section">
                      <label class="win98-label">System Type:</label>
                      <select id="idSystemType" class="win98-select">
                        <option value="traditional">Traditional (Numeric)</option>
                        <option value="antinet">ANTINET (Alphanumeric)</option>
                        <option value="hybrid">Hybrid System</option>
                      </select>
                    </div>
                    
                    <div class="form-section">
                      <label class="win98-label">Parent Note (Optional):</label>
                      <select id="parentNoteSelect" class="win98-select">
                        <option value="">-- Select a parent note --</option>
                        <!-- Will be populated dynamically -->
                      </select>
                    </div>
                    
                    <div class="form-section">
                      <label class="win98-label">Note Type:</label>
                      <select id="noteTypeSelect" class="win98-select">
                        <option value="trunk">Trunk (Main Topic)</option>
                        <option value="branch">Branch (Subtopic)</option>
                        <option value="leaf">Leaf (Concept)</option>
                        <option value="flower">Flower (Detail)</option>
                        <option value="fruit">Fruit (Variation)</option>
                        <option value="bud">Bud (Subdivision)</option>
                      </select>
                    </div>
                    
                    <div class="form-section">
                      <label class="win98-label">Note Title/Topic:</label>
                      <input type="text" id="noteTitleInput" class="win98-input" placeholder="Enter your note title or topic">
                    </div>
                    
                    <div class="form-section">
                      <button id="generateIdBtn" class="win98-button" style="background-color: var(--hyena-teal); color: black; width: 100%;">✨ Generate ID & Hashtags ✨</button>
                    </div>
                  </div>
                  
                  <div id="generationResults" class="generation-results" style="display: none;">
                    <h5>Generated Results:</h5>
                    
                    <div class="result-section">
                      <label>Suggested ID:</label>
                      <div id="suggestedIdResult" class="result-value" style="font-family: 'VT323', monospace;">1234</div>
                      <button id="copyIdBtn" class="copy-btn">Copy</button>
                    </div>
                    
                    <div class="result-section">
                      <label>Alternative IDs:</label>
                      <div id="alternativeIdsResult" class="result-value" style="font-family: 'VT323', monospace;">1234/A, 1234/1, 1234/B</div>
                    </div>
                    
                    <div class="result-section">
                      <label>Suggested Hashtags:</label>
                      <div id="suggestedTagsResult" class="result-tags">
                        <!-- Will be filled dynamically -->
                      </div>
                    </div>
                    
                    <div class="result-section">
                      <button id="useInNewCardBtn" class="win98-button" style="background-color: var(--hyena-pink); color: white; width: 100%;">Use For New Tablet</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Hashtag Cloud (initially hidden) -->
            <div id="hashtagCloud" class="hidden" style="display: none; flex-wrap: wrap; gap: 5px; margin-bottom: 15px;">
              <!-- Hashtags will be displayed here -->
            </div>
            
            <!-- Zettelkasten Cards Container -->
            <div id="zettelContainer" class="zettel-container ios-scroll">
              <!-- Zettel cards will be dynamically added here -->
            </div>
          </div>
          
          <!-- Comments Section -->
          <div class="myspace-section comments-section">
            <div class="myspace-section-title">⋆｡°✩ ᴄᴏᴍᴍᴇɴᴛꜱ ✩°｡⋆</div>
            
            <div class="comment">
              <div class="comment-avatar">
                <div style="width: 100%; height: 100%; background: linear-gradient(45deg, var(--hyena-pink), #ff9cc8); display: flex; align-items: center; justify-content: center;">
                  <span style="font-size: 20px;">💖</span>
                </div>
              </div>
              <div class="comment-content">
                <div class="comment-name">xX_HyenaLuvr69_Xx</div>
                <div class="comment-text">OMG your kettlekorn system is SOOOO amazing! I'm learning so much about organizing knowledge. Keep it up! Love the pink theme!!!</div>
                <div class="comment-date">May 23, 2023 at 3:42 PM</div>
              </div>
            </div>
            
            <div class="comment">
              <div class="comment-avatar">
                <div style="width: 100%; height: 100%; background: linear-gradient(45deg, var(--hyena-teal), var(--hyena-yellow)); display: flex; align-items: center; justify-content: center;">
                  <span style="font-size: 20px;">🧠</span>
                </div>
              </div>
              <div class="comment-content">
                <div class="comment-name">Nikola Tesla's Ghost</div>
                <div class="comment-text">Your organization of consciousness concepts reminds me of my own thought patterns. Have you considered adding entries about etheric vibrations? PS: Love the song on your profile!</div>
                <div class="comment-date">Apr 12, 2023 at 11:11 PM</div>
              </div>
            </div>
            
            <div class="comment">
              <div class="comment-avatar">
                <div style="width: 100%; height: 100%; background: linear-gradient(45deg, #00c8ff, #90e0ff); display: flex; align-items: center; justify-content: center;">
                  <span style="font-size: 20px;">🦢</span>
                </div>
              </div>
              <div class="comment-content">
                <div class="comment-name">BabyGoose_OpenMic</div>
                <div class="comment-text">will you go with him to da prOm?? ur mesopotamian research is on point!! i think the anunnaki would totally approve of ur zettelkasten method. gonna try this 4 my own research. btw ur profile is so kewl!</div>
                <div class="comment-date">June 6, 2023 at 6:06 AM</div>
              </div>
            </div>
            
            <!-- Add a new comment form -->
            <div style="margin-top: 20px; background-color: #f7faff; padding: 15px; border: 1px solid #cccccc;">
              <div style="font-weight: bold; color: #333; margin-bottom: 8px;">Leave a comment:</div>
              <textarea id="commentText" class="win98-textarea" style="height: 80px;" placeholder="Write something nice..."></textarea>
              <button id="postCommentBtn" class="win98-button" style="width: 100%;">Post Comment</button>
            </div>
          </div>
          
          <!-- "Created with" footer -->
          <div style="text-align: center; margin-top: 30px; font-size: 12px; color: #555;">
            <div>⋆｡°✩ Created with AnGeLic CoDE & GL1TCH MaGiC ✩°｡⋆</div>
            <div style="margin-top: 5px;">
              <span style="color: var(--hyena-pink);">♡</span> <span style="color: var(--hyena-teal); font-weight: bold;">Sumerian Knowledge Priestess</span> <span style="color: var(--hyena-pink);">♡</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Main dialogs and other elements from the original -->
  <div id="zettelDialog" class="dialog-box"></div>
  <div id="newCardDialog" class="dialog-box"></div>
  <div id="importExtractDialog" class="dialog-box"></div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // --- iOS/Safari Detection ---
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
      
      // Apply iOS-specific classes if needed
      if (isIOS) {
        document.body.classList.add('ios-device');
      }
      
      if (isMac) {
        document.body.classList.add('mac-device');
      }
      
      // --- Mobile/Desktop View Toggle ---
      const viewToggle = document.getElementById('viewToggle');
      const viewModeText = document.getElementById('viewModeText');
      let isMobileMode = false;
      let isRotated = false;
      let currentScale = 100;
      
      // Check if we should default to mobile view
      function checkDefaultView() {
        // Check if mobile device based on screen width or iOS
        if (window.innerWidth <= 768 || isIOS) {
          toggleMobileMode();
        }
      }
      
      function toggleMobileMode() {
        isMobileMode = !isMobileMode;
        document.body.classList.toggle('mobile-mode', isMobileMode);
        viewModeText.textContent = isMobileMode ? 'Switch to Desktop View' : 'Switch to Mobile View';
        
        // Open Zettelkasten by default in mobile view
        if (isMobileMode) {
          openWindow('zettelkastenWindow');
        }
        
        // If switching to desktop mode, update the taskbar
        if (!isMobileMode) {
          updateTaskbar();
        }
      }
      
      // Add proper touch event for iOS
      if (isIOS) {
        viewToggle.addEventListener('touchend', function(e) {
          e.preventDefault();
          toggleMobileMode();
        });
      } else {
        viewToggle.addEventListener('click', toggleMobileMode);
      }
      
      // --- Rotate Functionality ---
      const rotateButton = document.getElementById('rotateButton');
      
      function toggleRotation() {
        isRotated = !isRotated;
        document.body.classList.toggle('rotated', isRotated);
        
        // When rotated, we also check orientation
        checkOrientation();
      }
      
      if (isIOS) {
        rotateButton.addEventListener('touchend', function(e) {
          e.preventDefault();
          toggleRotation();
        });
      } else {
        rotateButton.addEventListener('click', toggleRotation);
      }
      
      // --- Scale Functionality ---
      const scaleUp = document.getElementById('scaleUp');
      const scaleDown = document.getElementById('scaleDown');
      const scaleDisplay = document.getElementById('scaleDisplay');
      
      function updateScale(change) {
        // Remove previous scale classes
        document.body.classList.remove('scale-75', 'scale-125', 'scale-150');
        
        // Calculate new scale
        currentScale += change;
        
        // Limit to reasonable values
        if (currentScale < 75) currentScale = 75;
        if (currentScale > 150) currentScale = 150;
        
        // Update display
        scaleDisplay.textContent = currentScale + '%';
        
        // Apply scale using CSS transform instead of classes for more precise control
        document.body.style.transform = `scale(${currentScale/100})`;
        document.body.style.transformOrigin = 'center top';
      }
      
      // Add touch events for iOS
      if (isIOS) {
        scaleUp.addEventListener('touchend', function(e) {
          e.preventDefault();
          updateScale(25);
        });
        
        scaleDown.addEventListener('touchend', function(e) {
          e.preventDefault();
          updateScale(-25);
        });
      } else {
        scaleUp.addEventListener('click', () => updateScale(25));
        scaleDown.addEventListener('click', () => updateScale(-25));
      }
      
      // --- Orientation Detection ---
      function checkOrientation() {
        const isLandscape = window.innerWidth > window.innerHeight;
        document.body.classList.toggle('landscape', isLandscape);
      }
      
      // Listen for orientation changes
      window.addEventListener('resize', checkOrientation);
      
      if (isIOS) {
        window.addEventListener('orientationchange', function() {
          // Small delay to ensure orientation has fully changed
          setTimeout(checkOrientation, 300);
        });
      }
      
      // --- Create Desktop Icons ---
      const desktopIcons = [
        {
          name: "My Zettelkasten",
          icon: "https://pfst.cf2.poecdn.net/base/image/0ffd2bf15a7001f86e395096222147037538b25af55ef9b8c7ac8f6768b7397c?w=48&h=48",
          target: "zettelkastenWindow",
          top: 20,
          left: 20
        },
        {
          name: "Hyena Messenger",
          icon: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 48 48'%3E%3Crect x='4' y='4' width='40' height='40' rx='5' fill='%23FFEF9F'/%3E%3Ctext x='14' y='35' fill='%23000000' font-family='Arial' font-weight='bold' font-size='28'%3EIM%3C/text%3E%3Cpath d='M10,10 L15,10 L15,15 L10,15 Z' fill='%23FF72B6' stroke='%23000000' stroke-width='1'/%3E%3C/svg%3E",
          target: "aimWindow",
          top: 20,
          left: 120
        },
        {
          name: "Barbie Fan Club",
          icon: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 48 48'%3E%3Crect x='4' y='4' width='40' height='40' rx='3' fill='%23FF72B6'/%3E%3Ctext x='12' y='35' fill='%23FFFFFF' font-family='Arial' font-weight='bold' font-size='14'%3EBARBIE%3C/text%3E%3Cpath d='M24,10 L28,18 L36,19 L30,25 L32,34 L24,30 L16,34 L18,25 L12,19 L20,18 Z' fill='%23FFFFFF'/%3E%3C/svg%3E",
          target: "barbieWindow",
          top: 20,
          left: 220
        },
        {
          name: "Sumerian Artifacts",
          icon: "https://pfst.cf2.poecdn.net/base/image/c568f858cbfe5304ed56fca693cb244fed53eafca1683b9a9c6d110dbd7dfeeb?w=48&h=48",
          target: "sumerianWindow",
          top: 20,
          left: 320
        }
      ];
      
      // --- Desktop Icon Creation ---
      const desktop = document.getElementById('desktop');
      
      desktopIcons.forEach((iconInfo) => {
        const icon = document.createElement('div');
        icon.className = 'desktop-icon';
        icon.setAttribute('data-target', iconInfo.target);
        icon.style.top = `${iconInfo.top}px`;
        icon.style.left = `${iconInfo.left}px`;
        
        icon.innerHTML = `
          <img src="${iconInfo.icon}" alt="${iconInfo.name}">
          <div class="desktop-icon-label">${iconInfo.name}</div>
        `;
        
        if (isIOS) {
          // Use touchstart/touchend for iOS 
          icon.addEventListener('touchend', function(e) {
            e.preventDefault();
            // Deselect all icons
            document.querySelectorAll('.desktop-icon').forEach(i => {
              i.classList.remove('desktop-icon-selected');
            });
            
            // Select this icon
            this.classList.add('desktop-icon-selected');
            
            // Check for double tap (simulate double click)
            const now = new Date().getTime();
            const lastTap = this.getAttribute('data-lasttap') || 0;
            const timeDiff = now - lastTap;
            
            if (timeDiff < 300 && timeDiff > 0) {
              // Double tap detected
              const targetId = this.getAttribute('data-target');
              openWindow(targetId);
            }
            
            this.setAttribute('data-lasttap', now);
          });
        } else {
          // Use regular click events for non-iOS
          icon.addEventListener('click', function() {
            // Deselect all icons
            document.querySelectorAll('.desktop-icon').forEach(i => {
              i.classList.remove('desktop-icon-selected');
            });
            
            // Select this icon
            this.classList.add('desktop-icon-selected');
          });
          
          icon.addEventListener('dblclick', function() {
            const targetId = this.getAttribute('data-target');
            openWindow(targetId);
          });
        }
        
        desktop.appendChild(icon);
      });
      
      // --- Y2K Random Error Messages ---
      // Show random Y2K-style error messages
      function showRandomErrorMessage() {
        const messages = [
          {title: "Hyena Diva Alert!", text: "OMG! Your Zettelkasten needs more sparkle! Adding glitter to knowledge database..."},
          {title: "Barbie System Warning", text: "Consciousness levels increasing! Mesopotamian knowledge integration at 73%..."},
          {title: "Y2K Protocol", text: "Time paradox detected! Your Zettelkasten exists in multiple dimensions simultaneously!"},
          {title: "Sumerian Download", text: "Ancient knowledge packets arriving from the Anunnaki database. Please wait..."},
          {title: "Digital Hyena", text: "Giggling detected in system files. Your knowledge is evolving beyond human comprehension!"}
        ];
        
        // Pick a random message
        const randomMessage = messages[Math.floor(Math.random() * messages.length)];
        
        // Update the error message
        const errorBox = document.getElementById('randomY2kError');
        errorBox.querySelector('.y2k-error-title').textContent = randomMessage.title;
        errorBox.querySelector('.y2k-error-text').textContent = randomMessage.text;
        
        // Position randomly on screen but ensure it's visible on smaller screens
        const maxTop = Math.max(50, window.innerHeight - 300);
        const maxLeft = Math.max(50, window.innerWidth - 350);
        errorBox.style.top = `${Math.random() * maxTop}px`;
        errorBox.style.left = `${Math.random() * maxLeft}px`;
        
        // Show the message
        errorBox.style.display = 'block';
        
        // Hide after a few seconds
        setTimeout(() => {
          errorBox.style.display = 'none';
        }, 5000);
      }
      
      // Show error messages occasionally, but less frequently on iOS to save performance
      const errorMessageInterval = isIOS ? 180000 : 120000;
      setInterval(showRandomErrorMessage, errorMessageInterval);
      
      // Error message OK button handler
      const errorButton = document.querySelector('.y2k-error-button');
      if (isIOS) {
        errorButton.addEventListener('touchend', function(e) {
          e.preventDefault();
          this.closest('.y2k-error-message').style.display = 'none';
        });
      } else {
        errorButton.addEventListener('click', function() {
          this.closest('.y2k-error-message').style.display = 'none';
        });
      }
      
      // --- Window Management ---
      const windows = document.querySelectorAll('.win98-window');
      let activeWindow = null;
      
      // Make windows draggable, only in desktop mode
      windows.forEach(win => {
        makeWindowDraggable(win);
        
        // Close button click handler
        const closeBtn = win.querySelector('.win98-close');
        if (closeBtn) {
          if (isIOS) {
            closeBtn.addEventListener('touchend', function(e) {
              e.preventDefault();
              win.style.display = 'none';
              updateTaskbar();
            });
          } else {
            closeBtn.addEventListener('click', function() {
              win.style.display = 'none';
              updateTaskbar();
            });
          }
        }
        
        // Minimize button
        const minBtn = win.querySelector('.win98-window-button:first-of-type');
        if (minBtn) {
          if (isIOS) {
            minBtn.addEventListener('touchend', function(e) {
              e.preventDefault();
              win.style.display = 'none';
              updateTaskbar();
            });
          } else {
            minBtn.addEventListener('click', function() {
              win.style.display = 'none';
              updateTaskbar();
            });
          }
        }
        
        // Window click handler to bring to front
        if (isIOS) {
          win.addEventListener('touchstart', function() {
            bringToFront(win);
          });
        } else {
          win.addEventListener('mousedown', function() {
            bringToFront(win);
          });
        }
      });
      
      function makeWindowDraggable(element) {
        const titlebar = element.querySelector('.win98-titlebar');
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        
        if (titlebar) {
          if (isIOS) {
            titlebar.ontouchstart = touchDragStart;
          } else {
            titlebar.onmousedown = dragMouseDown;
          }
        }
        
        function dragMouseDown(e) {
          e.preventDefault();
          // Don't allow dragging in mobile mode
          if (isMobileMode) return;
          
          // Get the mouse cursor position at startup
          pos3 = e.clientX;
          pos4 = e.clientY;
          document.onmouseup = closeDragElement;
          // Call a function whenever the cursor moves
          document.onmousemove = elementDrag;
        }
        
        function touchDragStart(e) {
          // Don't allow dragging in mobile mode
          if (isMobileMode) return;
          
          // Get the touch position
          const touch = e.touches[0];
          pos3 = touch.clientX;
          pos4 = touch.clientY;
          
          // Set up touch event handlers
          document.ontouchend = closeTouchDrag;
          document.ontouchmove = touchDrag;
        }
        
        function elementDrag(e) {
          e.preventDefault();
          // Calculate the new cursor position
          pos1 = pos3 - e.clientX;
          pos2 = pos4 - e.clientY;
          pos3 = e.clientX;
          pos4 = e.clientY;
          // Set the element's new position
          element.style.top = (element.offsetTop - pos2) + "px";
          element.style.left = (element.offsetLeft - pos1) + "px";
        }
        
        function touchDrag(e) {
          // Get the new touch position
          const touch = e.touches[0];
          const clientX = touch.clientX;
          const clientY = touch.clientY;
          
          // Calculate the new position
          pos1 = pos3 - clientX;
          pos2 = pos4 - clientY;
          pos3 = clientX;
          pos4 = clientY;
          
          // Set the element's new position
          element.style.top = (element.offsetTop - pos2) + "px";
          element.style.left = (element.offsetLeft - pos1) + "px";
          
          // Prevent default behavior
          e.preventDefault();
        }
        
        function closeDragElement() {
          // Stop moving when mouse button is released
          document.onmouseup = null;
          document.onmousemove = null;
        }
        
        function closeTouchDrag() {
          // Stop moving when touch ends
          document.ontouchend = null;
          document.ontouchmove = null;
        }
      }
      
      function bringToFront(window) {
        if (activeWindow) {
          activeWindow.classList.remove('window-active');
          activeWindow.classList.add('window-inactive');
        }
        
        window.classList.remove('window-inactive');
        window.classList.add('window-active');
        activeWindow = window;
        
        // Update taskbar to reflect active window
        if (!isMobileMode) {
          updateTaskbar();
        }
      }
      
      function openWindow(windowId) {
        const window = document.getElementById(windowId);
        if (window) {
          window.style.display = 'block';
          bringToFront(window);
          if (!isMobileMode) {
            updateTaskbar();
          }
        }
      }
      
      // --- Taskbar Management ---
      function updateTaskbar() {
        // Skip if in mobile mode
        if (isMobileMode) return;
        
        const taskbarItems = document.getElementById('taskbarItems');
        taskbarItems.innerHTML = '';
        
        // Add taskbar items for visible windows
        windows.forEach(win => {
          if (win.style.display !== 'none') {
            const titlebar = win.querySelector('.win98-titlebar-text');
            const title = titlebar ? titlebar.textContent : 'Window';
            const icon = win.querySelector('.win98-app-icon');
            
            const taskbarItem = document.createElement('div');
            taskbarItem.className = 'win98-taskbar-item';
            if (win.classList.contains('window-active')) {
              taskbarItem.classList.add('win98-taskbar-item-active');
            }
            
            taskbarItem.innerHTML = `
              ${icon ? icon.outerHTML : ''}
              ${title.length > 20 ? title.substring(0, 18) + '...' : title}
            `;
            
            if (isIOS) {
              taskbarItem.addEventListener('touchend', function(e) {
                e.preventDefault();
                if (win.style.display === 'none') {
                  win.style.display = 'block';
                }
                bringToFront(win);
              });
            } else {
              taskbarItem.addEventListener('click', function() {
                if (win.style.display === 'none') {
                  win.style.display = 'block';
                }
                bringToFront(win);
              });
            }
            
            taskbarItems.appendChild(taskbarItem);
          }
        });
      }
      
      // --- Start Button and Menu ---
      const startButton = document.getElementById('startButton');
      const startMenu = document.getElementById('startMenu');
      
      if (isIOS) {
        startButton.addEventListener('touchend', function(e) {
          e.preventDefault();
          if (startMenu.style.display === 'block') {
            startMenu.style.display = 'none';
          } else {
            startMenu.style.display = 'block';
          }
        });
      } else {
        startButton.addEventListener('click', function() {
          if (startMenu.style.display === 'block') {
            startMenu.style.display = 'none';
          } else {
            startMenu.style.display = 'block';
          }
        });
      }
      
      // Close start menu when clicking elsewhere
      if (isIOS) {
        document.addEventListener('touchend', function(e) {
          if (!startButton.contains(e.target) && !startMenu.contains(e.target)) {
            startMenu.style.display = 'none';
          }
        });
      } else {
        document.addEventListener('click', function(e) {
          if (!startButton.contains(e.target) && !startMenu.contains(e.target)) {
            startMenu.style.display = 'none';
          }
        });
      }
      
      // Start menu items click handlers
      const menuItems = document.querySelectorAll('.start-menu-item');
      menuItems.forEach(item => {
        if (isIOS) {
          item.addEventListener('touchend', function(e) {
            e.preventDefault();
            const id = this.id;
            if (id === 'menuZettelkasten') {
              openWindow('zettelkastenWindow');
            } else if (id === 'menuAIM') {
              openWindow('aimWindow');
            } else if (id === 'menuShutdown') {
              alert('It is now safe to turn off your computer.');
            }
            startMenu.style.display = 'none';
          });
        } else {
          item.addEventListener('click', function() {
            const id = this.id;
            if (id === 'menuZettelkasten') {
              openWindow('zettelkastenWindow');
            } else if (id === 'menuAIM') {
              openWindow('aimWindow');
            } else if (id === 'menuShutdown') {
              alert('It is now safe to turn off your computer.');
            }
            startMenu.style.display = 'none';
          });
        }
      });
      
      // --- AIM Chat Functionality ---
      // Set a different Gemini API key approach for iOS Safari
      // This is a blank placeholder - you would need to implement a secure approach
      // in a production environment to avoid exposing API keys
      const geminiApiKey = 'AIzaSyDVTlIyPLV1GH4Nhp6heb3CwgAQFzg7-fE';
      
      if (isIOS) {
        document.getElementById('geminiUser').addEventListener('touchend', function(e) {
          e.preventDefault();
          openWindow('aimChatWindow');
        });
        
        document.getElementById('aimSendButton').addEventListener('touchend', function(e) {
          e.preventDefault();
          sendAimMessage();
        });
        
        document.getElementById('aimCancelButton').addEventListener('touchend', function(e) {
          e.preventDefault();
          document.getElementById('aimChatWindow').style.display = 'none';
          updateTaskbar();
        });
      } else {
        document.getElementById('geminiUser').addEventListener('click', function() {
          openWindow('aimChatWindow');
        });
        
        document.getElementById('aimSendButton').addEventListener('click', sendAimMessage);
        
        document.getElementById('aimCancelButton').addEventListener('click', function() {
          document.getElementById('aimChatWindow').style.display = 'none';
          updateTaskbar();
        });
      }
      
      // iOS keyboard enter key handling
      document.getElementById('aimChatInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendAimMessage();
        }
      });
      
      async function sendAimMessage() {
        const inputField = document.getElementById('aimChatInput');
        const message = inputField.value.trim();
        
        if (!message) return;
        
        // Add user message to chat
        addMessageToChat('You', message);
        
        // Clear input field
        inputField.value = '';
        
        // Add loading indicator
        const loadingId = addMessageToChat('GeminiBot', 'Typing...');
        
        try {
          // Special handling for iOS Safari which may handle fetch differently
          const fetchOptions = {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              contents: [{
                parts: [{
                  text: 'You are Hyena Diva, a Y2K-era teen hyena chatting on AOL Instant Messenger. You love Barbie, Sumerian history, organizing knowledge, and consciousness. Your communication style is super enthusiastic with excessive punctuation, circa 2002 internet speak, and emojis. You use "like", "literally", "omg", "lol", and other similar expressions. Answer the following question as Hyena Diva: ' + message
                }]
              }],
              generationConfig: {
                temperature: 0.9,
                maxOutputTokens: 300
              }
            })
          };
          
          // Call Gemini API with appropriate error handling for iOS
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${geminiApiKey}`, fetchOptions);
          
          if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
          }
          
          const data = await response.json();
          
          // Extract the text content from the response
          const aiResponse = data.candidates && data.candidates[0] && data.candidates[0].content && 
                           data.candidates[0].content.parts && data.candidates[0].content.parts[0] && 
                           data.candidates[0].content.parts[0].text ? 
                           data.candidates[0].content.parts[0].text : 
                           "OMG sorrrrrryyyy! Something went wrong with my message!";
          
          // Replace the loading message with the actual response
          replaceMessage(loadingId, 'GeminiBot', aiResponse);
          
          // Add AIM message sound
          playMessageSound();
          
        } catch (error) {
          console.error('Error calling Gemini API:', error);
          replaceMessage(loadingId, 'GeminiBot', 'omg sorry!! my internet is soooo glitchy right now!! can u try again??');
        }
      }
      
      function addMessageToChat(sender, content) {
        const chatContent = document.getElementById('aimChatContent');
        const messageId = 'msg-' + Date.now();
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'aim-message';
        messageDiv.id = messageId;
        
        messageDiv.innerHTML = `
          <div class="aim-message-sender">${sender}:</div>
          <div class="aim-message-content">${content}</div>
        `;
        
        chatContent.appendChild(messageDiv);
        
        // Scroll to bottom with special handling for iOS
        setTimeout(() => {
          chatContent.scrollTop = chatContent.scrollHeight;
        }, 100);
        
        return messageId;
      }
      
      function replaceMessage(messageId, sender, content) {
        const messageDiv = document.getElementById(messageId);
        if (messageDiv) {
          messageDiv.innerHTML = `
            <div class="aim-message-sender">${sender}:</div>
            <div class="aim-message-content">${content}</div>
          `;
          
          // Scroll to bottom with special handling for iOS
          const chatContent = document.getElementById('aimChatContent');
          setTimeout(() => {
            chatContent.scrollTop = chatContent.scrollHeight;
          }, 100);
        }
      }
      
      // Modified sound playback for iOS compatibility
      function playMessageSound() {
        try {
          // Create a Web Audio API context
          const AudioContext = window.AudioContext || window.webkitAudioContext;
          const audioContext = new AudioContext();
          
          // Create an oscillator for a simple beep
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          // Configure the sound
          oscillator.type = 'sine';
          oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
          oscillator.frequency.setValueAtTime(440, audioContext.currentTime + 0.1);
          
          gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
          
          // Connect nodes
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          // Play the sound
          oscillator.start();
          oscillator.stop(audioContext.currentTime + 0.2);
          
          // iOS requires user interaction to unlock audio
          // This function will be called from a user-initiated event
          if (isIOS && audioContext.state === 'suspended') {
            audioContext.resume();
          }
        } catch (e) {
          console.log('Audio not supported on this device');
        }
      }
      
      // --- Clock Update ---
      function updateClock() {
        const now = new Date();
        let hours = now.getHours();
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12; // Hour '0' should be '12'
        document.getElementById('win98Clock').textContent = `${hours}:${minutes} ${ampm}`;
      }
      
      // Update the clock every minute
      updateClock();
      setInterval(updateClock, 60000);
      
      // --- Open Zettelkasten by default ---
      openWindow('zettelkastenWindow');
      updateTaskbar();
      
      // Check orientation and default view on load
      checkOrientation();
      checkDefaultView();
      
      // Import all the original Zettelkasten code
      // This is the same code from the original application
      // Adapted to work with the Windows 98 UI system
      
      // Setup file import/export dialog
      let importExtractDialog = document.getElementById('importExtractDialog');
      importExtractDialog.innerHTML = `
        <div class="dialog-content">
          <div class="dialog-titlebar">
            <div class="dialog-titlebar-text">✨ Import & Export Tools ✨</div>
            <div class="dialog-close" id="importExtractCloseBtn">x</div>
          </div>
          <div class="dialog-inner-content">
            <div class="import-export-tabs">
              <div class="import-tab tab-active" id="importTab">Import</div>
              <div class="export-tab" id="exportTab">Export</div>
            </div>
            
            <div id="importContent">
              <h3 style="text-align: center; color: var(--hyena-pink);">✧･ﾟ Import & Extract Zettels ･ﾟ✧</h3>
              
              <div class="import-options">
                <div class="import-option">
                  <h4>Import File</h4>
                  <p>Upload any of these formats:</p>
                  <ul>
                    <li>Text (.txt)</li>
                    <li>Markdown (.md)</li>
                    <li>Word Doc (.docx)</li>
                    <li>CSV (.csv)</li>
                    <li>JSON (.json)</li>
                    <li>HTML (.html)</li>
                  </ul>
                  <input type="file" id="fileImport" class="file-input" accept=".txt,.md,.docx,.csv,.json,.html">
                  <button id="importFileBtn" class="win98-button">Browse Files</button>
                </div>
                
                <div class="import-option">
                  <h4>Paste Text</h4>
                  <p>Paste raw text to extract keywords and concepts</p>
                  <textarea id="rawTextImport" class="win98-textarea" placeholder="Paste your text here..."></textarea>
                  <button id="analyzeTextBtn" class="win98-button">Analyze Text</button>
                </div>
              </div>
              
              <div id="extractResults" style="display: none;">
                <h4>Extracted Results</h4>
                <div class="extracted-keywords">
                  <p><strong>Keywords:</strong> <span id="extractedKeywords"></span></p>
                  <p><strong>Concepts:</strong> <span id="extractedConcepts"></span></p>
                </div>
                <button id="createZettelsBtn" class="win98-button highlight-btn">Create Zettels</button>
              </div>
            </div>
            
            <div id="exportContent" style="display: none;">
              <h3 style="text-align: center; color: var(--hyena-teal);">✧･ﾟ Export Your Zettels ･ﾟ✧</h3>
              
              <div class="export-options">
                <div class="export-option">
                  <input type="radio" id="exportAll" name="exportScope" value="all" checked>
                  <label for="exportAll">Export All Zettels</label>
                </div>
                
                <div class="export-option">
                  <input type="radio" id="exportCategory" name="exportScope" value="category">
                  <label for="exportCategory">Export by Category</label>
                  <select id="categorySelect" class="win98-select" disabled>
                    <option value="trunk">Trunk Zettels</option>
                    <option value="branch">Branch Zettels</option>
                    <option value="leaf">Leaf Zettels</option>
                    <option value="flower">Flower Zettels</option>
                    <option value="fruit">Fruit Zettels</option>
                    <option value="bud">Bud Zettels</option>
                  </select>
                </div>
                
                <div class="export-option">
                  <input type="radio" id="exportSelected" name="exportScope" value="selected">
                  <label for="exportSelected">Export Selected Zettel</label>
                  <select id="zettelSelect" class="win98-select" disabled>
                    <!-- Will be populated dynamically -->
                  </select>
                </div>
                
                <div class="export-format">
                  <h4>Export Format</h4>
                  <div class="format-options">
                    <div class="format-option">
                      <input type="radio" id="formatJSON" name="exportFormat" value="json" checked>
                      <label for="formatJSON">JSON</label>
                    </div>
                    <div class="format-option">
                      <input type="radio" id="formatCSV" name="exportFormat" value="csv">
                      <label for="formatCSV">CSV</label>
                    </div>
                    <div class="format-option">
                      <input type="radio" id="formatMarkdown" name="exportFormat" value="markdown">
                      <label for="formatMarkdown">Markdown</label>
                    </div>
                    <div class="format-option">
                      <input type="radio" id="formatText" name="exportFormat" value="text">
                      <label for="formatText">Plain Text</label>
                    </div>
                  </div>
                </div>
                
                <button id="exportBtn" class="win98-button highlight-btn">Export Zettels</button>
              </div>
            </div>
          </div>
        </div>
      `;

      // Add styles for the import/export dialog
      const style = document.createElement('style');
      style.textContent = `
        .import-export-tabs {
          display: flex;
          margin-bottom: 15px;
          border-bottom: 1px solid var(--win98-gray-dark);
        }
        
        .import-tab, .export-tab {
          padding: 8px 15px;
          cursor: pointer;
          background-color: var(--win98-gray);
          border: 1px solid var(--win98-gray-dark);
          border-bottom: none;
          margin-right: 5px;
        }
        
        .tab-active {
          background-color: var(--hyena-teal);
          font-weight: bold;
        }
        
        .import-options, .export-options {
          margin-bottom: 20px;
        }
        
        .import-option, .export-option {
          margin-bottom: 15px;
          padding: 10px;
          background-color: #f9f9f9;
          border: 1px solid #ddd;
        }
        
        .import-option h4, .export-option h4 {
          margin-top: 0;
          color: var(--hyena-purple);
        }
        
        .export-format {
          margin-top: 20px;
          padding: 10px;
          background-color: #f9f9f9;
          border: 1px solid #ddd;
        }
        
        .format-options {
          display: flex;
          flex-wrap: wrap;
          gap: 15px;
        }
        
        .format-option {
          display: flex;
          align-items: center;
          gap: 5px;
        }
        
        .file-input {
          position: absolute;
          width: 1px;
          height: 1px;
          padding: 0;
          margin: -1px;
          overflow: hidden;
          clip: rect(0, 0, 0, 0);
          border: 0;
        }
        
        .highlight-btn {
          background-color: var(--hyena-pink);
          color: white;
          font-weight: bold;
        }
        
        .extracted-keywords {
          background-color: #f5f5f5;
          padding: 10px;
          border: 1px solid #ddd;
          margin-bottom: 15px;
        }
      `;
      document.head.appendChild(style);

      // --- Import/Export Dialog Event Handlers ---
      // Show the import/export dialog
      function showImportExportDialog() {
        importExtractDialog.style.display = 'flex';
        // Populate the zettel select dropdown
        populateZettelSelect();
      }
      
      // Close button for the dialog
      const importExtractCloseBtn = document.getElementById('importExtractCloseBtn');
      importExtractCloseBtn.addEventListener('click', () => {
        importExtractDialog.style.display = 'none';
      });
      
      // Tab switching
      const importTab = document.getElementById('importTab');
      const exportTab = document.getElementById('exportTab');
      const importContent = document.getElementById('importContent');
      const exportContent = document.getElementById('exportContent');
      
      importTab.addEventListener('click', () => {
        importTab.classList.add('tab-active');
        exportTab.classList.remove('tab-active');
        importContent.style.display = 'block';
        exportContent.style.display = 'none';
      });
      
      exportTab.addEventListener('click', () => {
        exportTab.classList.add('tab-active');
        importTab.classList.remove('tab-active');
        importContent.style.display = 'none';
        exportContent.style.display = 'block';
      });
      
      // File import button
      const importFileBtn = document.getElementById('importFileBtn');
      const fileImport = document.getElementById('fileImport');
      
      importFileBtn.addEventListener('click', () => {
        fileImport.click();
      });
      
      fileImport.addEventListener('change', handleFileUpload);
      
      // Text analysis button
      const analyzeTextBtn = document.getElementById('analyzeTextBtn');
      const rawTextImport = document.getElementById('rawTextImport');
      
      analyzeTextBtn.addEventListener('click', () => {
        const text = rawTextImport.value.trim();
        if (text) {
          analyzeText(text);
        } else {
          alert('Please enter some text to analyze!');
        }
      });
      
      // Create zettels button
      const createZettelsBtn = document.getElementById('createZettelsBtn');
      
      createZettelsBtn.addEventListener('click', createZettelsFromExtraction);
      
      // Export option radio buttons
      const exportAll = document.getElementById('exportAll');
      const exportCategory = document.getElementById('exportCategory');
      const exportSelected = document.getElementById('exportSelected');
      const categorySelect = document.getElementById('categorySelect');
      const zettelSelect = document.getElementById('zettelSelect');
      
      exportAll.addEventListener('change', () => {
        categorySelect.disabled = true;
        zettelSelect.disabled = true;
      });
      
      exportCategory.addEventListener('change', () => {
        categorySelect.disabled = false;
        zettelSelect.disabled = true;
      });
      
      exportSelected.addEventListener('change', () => {
        categorySelect.disabled = true;
        zettelSelect.disabled = false;
      });
      
      // Export button
      const exportBtn = document.getElementById('exportBtn');
      
      exportBtn.addEventListener('click', exportZettels);
      
      // Populate zettel select dropdown
      function populateZettelSelect() {
        const select = document.getElementById('zettelSelect');
        select.innerHTML = '';
        
        // Sort cards by title for the dropdown
        const sortedCards = [...cards].sort((a, b) => a.title.localeCompare(b.title));
        
        sortedCards.forEach(card => {
          const option = document.createElement('option');
          option.value = card.id;
          option.textContent = `${card.title} (${card.id})`;
          select.appendChild(option);
        });
      }
      
      // Handle file upload
      function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
          const fileContent = e.target.result;
          
          // Process based on file type
          const fileType = file.name.split('.').pop().toLowerCase();
          
          switch(fileType) {
            case 'txt':
            case 'md':
            case 'html':
              // Text files can be analyzed directly
              analyzeText(fileContent);
              break;
            case 'csv':
              // Parse CSV into zettels
              parseCSV(fileContent);
              break;
            case 'json':
              // Try to import JSON as a backup or as zettels
              importJSON(fileContent);
              break;
            case 'docx':
              // For DOCX, we'd need to extract text first
              alert('DOCX format detected! Currently processing DOCX formats requires uploading plain text content. Please copy/paste the document content into the text area instead.');
              break;
            default:
              alert('Unsupported file format. Please use .txt, .md, .html, .csv, or .json files.');
          }
        };
        
        if (file.type.match('text.*') || file.type === 'application/json' || file.name.endsWith('.md')) {
          reader.readAsText(file);
        } else {
          reader.readAsArrayBuffer(file);
        }
      }
      
      // Analyze text to extract keywords and concepts
      function analyzeText(text) {
        // Simple keyword extraction based on word frequency
        const words = text.toLowerCase().replace(/[^\w\s#]/g, ' ').split(/\s+/);
        const wordCounts = {};
        
        // Count word frequency
        words.forEach(word => {
          if (word.length > 3) { // Skip short words
            wordCounts[word] = (wordCounts[word] || 0) + 1;
          }
        });
        
        // Extract hashtags
        const hashtags = text.match(/#[a-zA-Z0-9_]+/g) || [];
        
        // Sort words by frequency
        const sortedWords = Object.entries(wordCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 15)
          .map(entry => entry[0]);
        
        // Identify potential concepts (pairs of frequent words)
        const concepts = [];
        for (let i = 0; i < words.length - 1; i++) {
          if (words[i].length > 3 && words[i+1].length > 3) {
            const pair = words[i] + ' ' + words[i+1];
            if (!concepts.includes(pair)) {
              concepts.push(pair);
            }
            
            // Limit to 10 concepts
            if (concepts.length >= 10) break;
          }
        }
        
        // Display results
        document.getElementById('extractedKeywords').textContent = [...new Set([...sortedWords, ...hashtags.map(tag => tag.substring(1))])].join(', ');
        document.getElementById('extractedConcepts').textContent = concepts.join(', ');
        document.getElementById('extractResults').style.display = 'block';
      }
      
      // Parse CSV file
      function parseCSV(content) {
        try {
          // Simple CSV parsing
          const lines = content.split(/\r?\n/);
          const headers = lines[0].split(',').map(header => header.trim());
          
          // Look for required columns
          const idIndex = headers.findIndex(h => h.toLowerCase() === 'id');
          const titleIndex = headers.findIndex(h => h.toLowerCase() === 'title');
          const contentIndex = headers.findIndex(h => h.toLowerCase() === 'content');
          
          if (idIndex === -1 || titleIndex === -1) {
            alert('CSV must contain at least "id" and "title" columns.');
            return;
          }
          
          // Prepare data for import
          const importData = [];
          
          for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            
            const values = lines[i].split(',').map(val => val.trim());
            
            const card = {
              id: values[idIndex],
              title: values[titleIndex],
              content: contentIndex !== -1 ? values[contentIndex] : '',
              type: determineTierFromId(values[idIndex]), 
              hashtags: [],
              created: Date.now(),
              modified: Date.now()
            };
            
            importData.push(card);
          }
          
          if (importData.length > 0) {
            if (confirm(`Found ${importData.length} cards to import. Would you like to add them to your Zettelkasten?`)) {
              // Add the cards
              importData.forEach(card => {
                // Check if card with this ID already exists
                const existingIndex = cards.findIndex(c => c.id === card.id);
                if (existingIndex !== -1) {
                  // Update existing card
                  cards[existingIndex] = {...cards[existingIndex], ...card, modified: Date.now()};
                } else {
                  // Add new card
                  cards.push(card);
                }
              });
              
              // Save, sort and update UI
              saveCardsToStorage();
              sortCardsByHierarchy();
              renderZettelList();
              alert(`Successfully imported ${importData.length} cards!`);
            }
          } else {
            alert('No valid data found in the CSV file.');
          }
        } catch (e) {
          console.error('Error parsing CSV:', e);
          alert('Error parsing CSV file. Please check the format.');
        }
      }
      
      // Import JSON file
      function importJSON(content) {
        try {
          const data = JSON.parse(content);
          
          // Check if this is a backup file
          if (data.cards && Array.isArray(data.cards)) {
            if (confirm(`This appears to be a backup file with ${data.cards.length} cards. Import as backup?`)) {
              importBackup(content);
              return;
            }
          }
          
          // If it's not a backup or user declined, try to import as individual cards
          if (Array.isArray(data)) {
            // Check if array items have id and title
            if (data.length > 0 && data[0].id && data[0].title) {
              if (confirm(`Found ${data.length} cards to import. Would you like to add them to your Zettelkasten?`)) {
                // Add the cards
                data.forEach(card => {
                  // Ensure card has all required properties
                  const processedCard = {
                    id: card.id,
                    title: card.title,
                    content: card.content || '',
                    type: card.type || determineTierFromId(card.id),
                    hashtags: card.hashtags || [],
                    created: card.created || Date.now(),
                    modified: card.modified || Date.now()
                  };
                  
                  // Check if card with this ID already exists
                  const existingIndex = cards.findIndex(c => c.id === processedCard.id);
                  if (existingIndex !== -1) {
                    // Update existing card
                    cards[existingIndex] = {...cards[existingIndex], ...processedCard, modified: Date.now()};
                  } else {
                    // Add new card
                    cards.push(processedCard);
                  }
                });
                
                // Save, sort and update UI
                saveCardsToStorage();
                sortCardsByHierarchy();
                renderZettelList();
                alert(`Successfully imported ${data.length} cards!`);
              }
              return;
            }
          }
          
          // If we get here, it's not a recognized format
          alert('This JSON file does not contain recognizable Zettelkasten data.');
        } catch (e) {
          console.error('Error importing JSON:', e);
          alert('Error importing JSON file. Please check the format.');
        }
      }
      
      // Create zettels from extracted keywords and concepts
      function createZettelsFromExtraction() {
        const keywords = document.getElementById('extractedKeywords').textContent.split(', ');
        const concepts = document.getElementById('extractedConcepts').textContent.split(', ');
        
        if (keywords.length === 0 && concepts.length === 0) {
          alert('No keywords or concepts to create zettels from!');
          return;
        }
        
        // Find the highest trunk ID
        let highestTrunkId = 0;
        cards.forEach(card => {
          if (card.type === 'trunk') {
            const trunkId = parseInt(card.id.replace(/\D/g, ''));
            if (trunkId > highestTrunkId) {
              highestTrunkId = trunkId;
            }
          }
        });
        
        // Create a new trunk for the extracted content
        const newTrunkId = (highestTrunkId + 1000).toString();
        const newTrunk = {
          id: newTrunkId,
          title: "Extracted Concepts",
          type: "trunk",
          content: "Concepts and keywords extracted from imported content.",
          hashtags: ["#extracted", "#import", "#concepts"],
          links: [],
          created: Date.now(),
          modified: Date.now()
        };
        
        // Add the trunk
        cards.push(newTrunk);
        
        // Add keywords as leaves
        const newCards = [];
        keywords.forEach((keyword, index) => {
          if (keyword.trim()) {
            const leafId = `${newTrunkId.slice(0, -3)}${(index + 1).toString().padStart(2, '0')}`;
            newCards.push({
              id: leafId,
              title: keyword.charAt(0).toUpperCase() + keyword.slice(1),
              type: "leaf",
              content: `Notes about the concept of ${keyword}.`,
              hashtags: ["#extracted", `#${keyword.replace(/\s+/g, '')}`],
              links: [newTrunkId],
              created: Date.now(),
              modified: Date.now()
            });
          }
        });
        
        // Add concepts as branches
        const branchStart = 100;
        concepts.forEach((concept, index) => {
          if (concept.trim()) {
            const branchId = `${newTrunkId.slice(0, -3)}${(branchStart + index * 100).toString()}`;
            newCards.push({
              id: branchId,
              title: concept.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' '),
              type: "branch",
              content: `Notes about the concept of ${concept}.`,
              hashtags: ["#extracted", `#${concept.replace(/\s+/g, '')}`],
              links: [newTrunkId],
              created: Date.now(),
              modified: Date.now()
            });
          }
        });
        
        // Add all the new cards
        cards.push(...newCards);
        
        // Save, sort and update UI
        saveCardsToStorage();
        sortCardsByHierarchy();
        renderZettelList();
        
        // Add the new trunk to favorites
        if (!favoriteCards.includes(newTrunkId)) {
          favoriteCards.unshift(newTrunkId);
          if (favoriteCards.length > 8) {
            favoriteCards = favoriteCards.slice(0, 8);
          }
          saveFavoritesToStorage();
          renderTop8Cards();
        }
        
        alert(`Successfully created 1 trunk and ${newCards.length} cards from the extracted content!`);
        
        // Close the dialog
        importExtractDialog.style.display = 'none';
      }
      
      // Export zettels based on selected options
      function exportZettels() {
        // Get export scope
        let cardsToExport = [];
        
        if (exportAll.checked) {
          cardsToExport = [...cards];
        } else if (exportCategory.checked) {
          const category = categorySelect.value;
          cardsToExport = cards.filter(card => card.type === category);
        } else if (exportSelected.checked) {
          const selectedId = zettelSelect.value;
          const card = cards.find(c => c.id === selectedId);
          if (card) {
            cardsToExport = [card];
          }
        }
        
        if (cardsToExport.length === 0) {
          alert('No cards found to export!');
          return;
        }
        
        // Get export format
        const format = document.querySelector('input[name="exportFormat"]:checked').value;
        
        // Generate export content
        let exportContent = '';
        let fileName = '';
        
        switch(format) {
          case 'json':
            exportContent = JSON.stringify(cardsToExport, null, 2);
            fileName = 'hyenadiva-zettels.json';
            break;
          case 'csv':
            // Create CSV header
            exportContent = 'id,title,type,content,hashtags,created,modified\n';
            
            // Add each card as a row
            cardsToExport.forEach(card => {
              exportContent += `${card.id},${card.title},${card.type},"${card.content.replace(/"/g, '""')}","${card.hashtags.join(', ')}",${card.created},${card.modified}\n`;
            });
            
            fileName = 'hyenadiva-zettels.csv';
            break;
          case 'markdown':
            cardsToExport.forEach(card => {
              exportContent += `# ${card.title} (${card.id})\n\n`;
              exportContent += `Type: ${card.type}\n\n`;
              exportContent += `${card.content}\n\n`;
              exportContent += `Tags: ${card.hashtags.join(', ')}\n\n`;
              exportContent += `---\n\n`;
            });
            
            fileName = 'hyenadiva-zettels.md';
            break;
          case 'text':
            cardsToExport.forEach(card => {
              exportContent += `TITLE: ${card.title}\n`;
              exportContent += `ID: ${card.id}\n`;
              exportContent += `TYPE: ${card.type}\n\n`;
              exportContent += `${card.content}\n\n`;
              exportContent += `HASHTAGS: ${card.hashtags.join(', ')}\n`;
              exportContent += `------------------------------------------\n\n`;
            });
            
            fileName = 'hyenadiva-zettels.txt';
            break;
        }
        
        // Create download link
        const element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(exportContent));
        element.setAttribute('download', fileName);
        element.style.display = 'none';
        
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
      }

      // Add a separate Import/Export button to the UI
      const toolsContainer = document.querySelector('.myspace-section:nth-of-type(4) div:first-of-type');
      const importExportBtn = document.createElement('button');
      importExportBtn.id = 'importExportBtn';
      importExportBtn.className = 'win98-button';
      importExportBtn.innerHTML = '📥 Import/Export 📤';
      importExportBtn.style.marginLeft = '5px';
      toolsContainer.appendChild(importExportBtn);
      
      // Set up event listener for Import/Export button
      importExportBtn.addEventListener('click', function() {
        showImportExportDialog();
      });
      
      // Create new zettel dialog
      const newCardDialog = document.getElementById('newCardDialog');
      newCardDialog.innerHTML = `
        <div class="dialog-content">
          <div class="dialog-titlebar">
            <div class="dialog-titlebar-text">✨ Create New Tablet ✨</div>
            <div class="dialog-close" id="newCardCloseBtn">x</div>
          </div>
          <div class="dialog-inner-content">
            <div class="dialog-title">Create a New Zettel</div>
            
            <label class="win98-label" for="newCardTitle">Title:</label>
            <input type="text" id="newCardTitle" class="win98-input" placeholder="Enter tablet title">
            
            <label class="win98-label" for="newCardId">ID:</label>
            <div style="display: flex; gap: 5px; align-items: center;">
              <input type="text" id="newCardId" class="win98-input" placeholder="Enter ID (e.g. 1234)">
              <button id="generateIdBtn" class="win98-button" style="margin-top: 0;">Generate ID</button>
            </div>
            
            <label class="win98-label" for="newCardType">Type:</label>
            <select id="newCardType" class="win98-select">
              <option value="trunk">Trunk</option>
              <option value="branch">Branch</option>
              <option value="leaf" selected>Leaf</option>
              <option value="flower">Flower</option>
              <option value="fruit">Fruit</option>
              <option value="bud">Bud</option>
            </select>
            
            <label class="win98-label" for="newCardContent">Content:</label>
            <textarea id="newCardContent" class="win98-textarea" placeholder="Enter tablet content"></textarea>
            
            <label class="win98-label" for="newCardHashtags">Hashtags:</label>
            <input type="text" id="newCardHashtags" class="win98-input" placeholder="Enter hashtags (e.g. #consciousness #divine)">
            
            <div id="suggestedHashtags" style="display: flex; flex-wrap: wrap; gap: 5px; margin: 8px 0;"></div>
            
            <button id="saveNewCardBtn" class="win98-button highlight-btn" style="width: 100%;">💾 Save Tablet</button>
          </div>
        </div>
      `;
      
      // Setup event handlers for new card dialog
      const newCardCloseBtn = document.getElementById('newCardCloseBtn');
      const saveNewCardBtn = document.getElementById('saveNewCardBtn');
      const generateIdBtn = document.getElementById('generateIdBtn');
      
      newCardCloseBtn.addEventListener('click', () => {
        newCardDialog.style.display = 'none';
      });
      
      // Generate a unique ID based on the selected type
      generateIdBtn.addEventListener('click', () => {
        const type = document.getElementById('newCardType').value;
        let newId;
        
        switch(type) {
          case 'trunk':
            // Find highest trunk ID and add 1000
            let highestTrunkId = 0;
            cards.forEach(card => {
              if (card.type === 'trunk') {
                const trunkId = parseInt(card.id.replace(/\D/g, ''));
                if (trunkId > highestTrunkId) {
                  highestTrunkId = trunkId;
                }
              }
            });
            newId = (highestTrunkId + 1000).toString();
            break;
            
          case 'branch':
            // Format: xxxx00 where xxxx is a trunk ID
            let trunkIds = cards.filter(card => card.type === 'trunk').map(card => card.id);
            if (trunkIds.length > 0) {
              const randomTrunk = trunkIds[Math.floor(Math.random() * trunkIds.length)];
              const trunkBase = randomTrunk.slice(0, -3);
              
              // Find highest branch in this trunk
              let highestBranch = 0;
              cards.forEach(card => {
                if (card.type === 'branch' && card.id.startsWith(trunkBase)) {
                  const branchNum = parseInt(card.id.slice(-3));
                  if (branchNum > highestBranch && branchNum < 1000) {
                    highestBranch = branchNum;
                  }
                }
              });
              
              // Next branch is highest + 100, or 100 if none exist
              const nextBranch = highestBranch === 0 ? 100 : (Math.floor(highestBranch / 100) + 1) * 100;
              newId = `${trunkBase}${nextBranch.toString().padStart(3, '0')}`;
            } else {
              newId = "1100"; // Default if no trunks
            }
            break;
            
          case 'leaf':
            // Format: xxxx where xxxx is not ending in 00
            // Randomly pick a number between 1001-9999 not ending in 00
            let leafId;
            do {
              leafId = Math.floor(Math.random() * 8999) + 1001;
              // Ensure it doesn't end in 00
              if (leafId % 100 === 0) leafId += 1;
            } while (cards.some(card => card.id === leafId.toString()));
            
            newId = leafId.toString();
            break;
            
          case 'flower':
            // Format: xxxx/y where xxxx is a leaf ID and y is a number
            let leafIds = cards.filter(card => card.type === 'leaf').map(card => card.id);
            if (leafIds.length > 0) {
              const randomLeaf = leafIds[Math.floor(Math.random() * leafIds.length)];
              newId = `${randomLeaf}/1`;
            } else {
              newId = "1001/1"; // Default if no leaves
            }
            break;
            
          case 'fruit':
            // Format: xxxx/A where xxxx is a leaf ID and A is a uppercase letter
            let fruitLeafIds = cards.filter(card => card.type === 'leaf').map(card => card.id);
            if (fruitLeafIds.length > 0) {
              const randomLeaf = fruitLeafIds[Math.floor(Math.random() * fruitLeafIds.length)];
              newId = `${randomLeaf}/A`;
            } else {
              newId = "1001/A"; // Default if no leaves
            }
            break;
            
          case 'bud':
            // Format: xxxx/y/z where xxxx/y is a flower ID and z is a number or letter
            let flowerIds = cards.filter(card => card.type === 'flower').map(card => card.id);
            if (flowerIds.length > 0) {
              const randomFlower = flowerIds[Math.floor(Math.random() * flowerIds.length)];
              newId = `${randomFlower}/1`;
            } else {
              newId = "1001/1/1"; // Default if no flowers
            }
            break;
            
          default:
            newId = (Math.floor(Math.random() * 9000) + 1000).toString();
        }
        
        document.getElementById('newCardId').value = newId;
      });
      
      // Populate suggested hashtags
      const newCardHashtags = document.getElementById('newCardHashtags');
      const suggestedHashtags = document.getElementById('suggestedHashtags');
      
      function updateSuggestedHashtags() {
        suggestedHashtags.innerHTML = '';
        
        if (globalHashtags.length === 0) {
          suggestedHashtags.innerHTML = '<div style="color: #777; font-style: italic;">No hashtags available. Create some in the Hashtag Creator section!</div>';
          return;
        }
        
        // Just show top 10 hashtags
        const tagsToShow = globalHashtags.slice(0, 10);
        
        tagsToShow.forEach(tag => {
          const tagSpan = document.createElement('span');
          tagSpan.className = 'dialog-hashtag';
          tagSpan.textContent = tag;
          tagSpan.style.cursor = 'pointer';
          
          tagSpan.addEventListener('click', () => {
            // Add the tag to the input if not already there
            const currentTags = newCardHashtags.value.trim();
            if (!currentTags.includes(tag)) {
              newCardHashtags.value = currentTags ? `${currentTags} ${tag}` : tag;
            }
          });
          
          suggestedHashtags.appendChild(tagSpan);
        });
      }
      
      // Show suggested hashtags when the hashtags field gets focus
      newCardHashtags.addEventListener('focus', updateSuggestedHashtags);
      
      // Save the new card
      saveNewCardBtn.addEventListener('click', () => {
        const title = document.getElementById('newCardTitle').value.trim();
        const id = document.getElementById('newCardId').value.trim();
        const type = document.getElementById('newCardType').value;
        const content = document.getElementById('newCardContent').value.trim();
        const hashtagsInput = document.getElementById('newCardHashtags').value.trim();
        
        // Validate
        if (!title) {
          alert('Please enter a title for your tablet.');
          return;
        }
        
        if (!id) {
          alert('Please enter an ID for your tablet.');
          return;
        }
        
        // Parse hashtags
        const hashtags = hashtagsInput ? 
          hashtagsInput.split(/\s+/).map(tag => {
            return tag.startsWith('#') ? tag.toLowerCase() : '#' + tag.toLowerCase();
          }) : [];
        
        // Create the new card
        const newCard = {
          id: id,
          title: title,
          type: type,
          content: content,
          hashtags: hashtags,
          links: [],
          created: Date.now(),
          modified: Date.now()
        };
        
        // Add to cards array
        cards.push(newCard);
        
        // Add to favorites if it's a trunk
        if (type === 'trunk' && !favoriteCards.includes(id) && favoriteCards.length < 8) {
          favoriteCards.push(id);
          saveFavoritesToStorage();
          renderTop8Cards();
        }
        
        // Save to storage, sort and update UI
        saveCardsToStorage();
        sortCardsByHierarchy();
        renderZettelList();
        
        // Close the dialog
        newCardDialog.style.display = 'none';
        
        // Show success message
        alert(`Your new ${type} tablet "${title}" has been created!`);
      });
      
      // Restore proper behavior of New Tablet button
      const newCardBtn = document.getElementById('newCardBtn');
      newCardBtn.addEventListener('click', function() {
        // Reset the form
        document.getElementById('newCardTitle').value = '';
        document.getElementById('newCardId').value = '';
        document.getElementById('newCardType').value = 'leaf';
        document.getElementById('newCardContent').value = '';
        document.getElementById('newCardHashtags').value = '';
        
        // Show the dialog
        newCardDialog.style.display = 'flex';
        
        // Update suggested hashtags
        updateSuggestedHashtags();
      });
      
      // --- Main Application State ---
      let cards = [];
      let currentCardId = null;
      let currentView = 'hierarchy';
      let selectedHashtag = null;
      let favoriteCards = [];
      let globalHashtags = [];
      
      // Smart creation state
      let selectedParentId = null;
      let selectedParentType = null;
      let newCardChildType = "leaf"; // Default child type
      let creationMode = "smart"; // Default to smart creation
      
      // --- Initial Data Loading ---
      // Preload the Zettelkasten data right at the start
      const zettelStructure = getZettelkastenStructure();
      
      // --- Play button functionality (optimized) ---
      const playButton = document.getElementById('playButton');
      if (isIOS) {
        playButton.addEventListener('touchend', function(e) {
          e.preventDefault();
          this.textContent = this.textContent === '▶' ? '❚❚' : '▶';
          
          // Simulate music playing by setting the progress bar width directly
          const progressBar = document.querySelector('.music-player-progress-bar');
          if (this.textContent === '❚❚') {
            // Set a simple CSS transition instead of JavaScript animation
            progressBar.style.transition = 'width 30s linear';
            progressBar.style.webkitTransition = 'width 30s linear';
            progressBar.style.width = '100%';
          } else {
            // Reset the bar
            progressBar.style.transition = 'none';
            progressBar.style.webkitTransition = 'none';
            progressBar.style.width = '35%';
          }
        });
      } else {
        playButton.addEventListener('click', function() {
          this.textContent = this.textContent === '▶' ? '❚❚' : '▶';
          
          // Simulate music playing by setting the progress bar width directly
          const progressBar = document.querySelector('.music-player-progress-bar');
          if (this.textContent === '❚❚') {
            // Set a simple CSS transition instead of JavaScript animation
            progressBar.style.transition = 'width 30s linear';
            progressBar.style.width = '100%';
          } else {
            // Reset the bar
            progressBar.style.transition = 'none';
            progressBar.style.width = '35%';
          }
        });
      }
      
      // --- Comment system (optimized) ---
      const postCommentBtn = document.getElementById('postCommentBtn');
      if (isIOS) {
        postCommentBtn.addEventListener('touchend', function(e) {
          e.preventDefault();
          addComment();
        });
      } else {
        postCommentBtn.addEventListener('click', addComment);
      }
      
      // Fix for adding comments
      function addComment() {
        const commentText = document.getElementById('commentText').value.trim();
        if (!commentText) return;
        
        // Create a random emoji for avatar
        const emojis = ['🌟', '✨', '💖', '🦄', '🌈', '🧠', '🔮', '💎', '🦋', '🌺'];
        const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
        
        // Generate random color gradients for avatar background
        const colors = ['var(--hyena-pink)', 'var(--hyena-purple)', 'var(--hyena-teal)', 'var(--hyena-yellow)', 'var(--hyena-blue)', '#ff9cc8', '#90e0ff', '#c8a2ff'];
        const color1 = colors[Math.floor(Math.random() * colors.length)];
        const color2 = colors[Math.floor(Math.random() * colors.length)];
        
        // Random fun Y2K usernames
        const usernames = [
          'You', 'xX_ZettelQueen_Xx', 'HyenaDivaFan2000', 
          'BaRbIe_LuVeR_99', 'KnOwLeDgE_AnGeL', 'y2k_philosophy_grl',
          'SumerianPrincess', 'DMT_Consciousness', 'divine_feminine_vibes'
        ];
        const username = usernames[Math.floor(Math.random() * usernames.length)];
        
        // Create a single new comment (efficient DOM manipulation)
        const commentsSection = document.querySelector('.comments-section');
        
        // Find the comment form - it's the last div in the comment section that has the textarea
        const commentForm = document.querySelector('.comments-section > div:last-of-type');
        
        // Simple background colors for consistency
        const newComment = document.createElement('div');
        newComment.className = 'comment';
        newComment.innerHTML = `
          <div class="comment-avatar">
            <div style="width: 100%; height: 100%; background: linear-gradient(45deg, ${color1}, ${color2}); display: flex; align-items: center; justify-content: center;">
              <span style="font-size: 20px;">${randomEmoji}</span>
            </div>
          </div>
          <div class="comment-content">
            <div class="comment-name">${username}</div>
            <div class="comment-text">${commentText}</div>
            <div class="comment-date">Just now</div>
          </div>
        `;
        
        // Insert before the comment form
        commentsSection.insertBefore(newComment, commentForm);
        document.getElementById('commentText').value = '';
        
        // Save comment to localStorage to persist
        try {
          // Get existing comments
          let savedComments = JSON.parse(localStorage.getItem('hyenadivaComments') || '[]');
          
          // Add new comment
          savedComments.push({
            avatar: {
              emoji: randomEmoji,
              color1: color1,
              color2: color2
            },
            name: username,
            text: commentText,
            date: 'Just now'
          });
          
          // Keep only the last 10 comments to avoid storage issues
          if (savedComments.length > 10) {
            savedComments = savedComments.slice(-10);
          }
          
          // Save back to localStorage
          localStorage.setItem('hyenadivaComments', JSON.stringify(savedComments));
        } catch (e) {
          console.warn('Failed to save comment to localStorage', e);
        }
      }
      
      // --- Backup & Restore Functions ---
      // Adjusted for iOS compatibility
      function createBackup() {
        try {
          // Get all data
          const backupData = {
            cards: cards,
            favorites: favoriteCards,
            hashtags: globalHashtags,
            version: "1.0"
          };
          
          // Convert to downloadable format
          const dataStr = JSON.stringify(backupData);
          const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
          
          // Create filename with date
          const exportFileDefaultName = 'hyenadiva-backup-' + new Date().toISOString().slice(0,10) + '.json';
          
          if (isIOS) {
            // For iOS, create a temporary link and use the download attribute
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.style.display = 'none';
            document.body.appendChild(linkElement);
            linkElement.click();
            document.body.removeChild(linkElement);
          } else {
            // Regular download for other browsers
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
          }
          
          // Save last backup time
          try {
            localStorage.setItem('hyenadivaLastBackup', Date.now());
          } catch (e) {
            console.warn('LocalStorage not available for saving backup time');
          }
        } catch (e) {
          console.error('Backup failed:', e);
          alert('Backup failed. Please try again.');
        }
      }
      
      // Import function with iOS compatibility
      function importBackup(jsonData) {
        try {
          const data = JSON.parse(jsonData);
          if (data.cards && data.favorites && data.hashtags) {
            cards = data.cards;
            favoriteCards = data.favorites;
            globalHashtags = data.hashtags;
            
            // Save to localStorage
            saveCardsToStorage();
            saveFavoritesToStorage();
            saveGlobalHashtags();
            
            // Refresh the UI
            sortCardsByHierarchy();
            renderZettelList();
            renderTop8Cards();
            renderGlobalHashtags();
            
            return true;
          }
          return false;
        } catch (e) {
          console.error('Import failed:', e);
          return false;
        }
      }
      
      // Add restore function with iOS compatibility
      function showRestoreUI() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        if (isIOS) {
          // iOS needs special handling for file input
          input.style.position = 'fixed';
          input.style.top = '0';
          input.style.left = '0';
          input.style.opacity = '0.01';
          document.body.appendChild(input);
        }
        
        input.onchange = e => {
          const file = e.target.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = event => {
            const success = importBackup(event.target.result);
            if (success) {
              alert('Backup restored successfully!');
            } else {
              alert('Failed to restore backup. The file might be corrupted or in wrong format.');
            }
          };
          reader.readAsText(file);
          
          if (isIOS) {
            // Clean up for iOS
            document.body.removeChild(input);
          }
        };
        
        // For iOS, trigger click after appending to DOM
        input.click();
      }
      
      // Add backup/restore button event listeners with iOS compatibility
      const backupBtn = document.getElementById('backupBtn');
      const restoreBtn = document.getElementById('restoreBtn');
      
      if (isIOS) {
        backupBtn.addEventListener('touchend', function(e) {
          e.preventDefault();
          createBackup();
        });
        
        restoreBtn.addEventListener('touchend', function(e) {
          e.preventDefault();
          showRestoreUI();
        });
      } else {
        backupBtn.addEventListener('click', createBackup);
        restoreBtn.addEventListener('click', showRestoreUI);
      }
      
      // --- Utility Functions ---
      function normalizeId(str) {
        if (!str) return '';
        
        // Replace spelled-out numbers with digits
        const numberMap = {
          'one': '1', 'two': '2', 'three': '3', 'four': '4', 'five': '5',
          'six': '6', 'seven': '7', 'eight': '8', 'nine': '9', 'zero': '0'
        };
        
        Object.keys(numberMap).forEach(word => {
          const regex = new RegExp('\\b' + word + '\\b', 'gi');
          str = str.replace(regex, numberMap[word]);
        });
        
        // Strip illegal characters
        return str.replace(/[^0-9a-z\/\.\-]/gi, '');
      }
      
      function determineTierFromId(id) {
        id = normalizeId(id);
        
        if (!id) return 'leaf'; // Default
        
        // Check for bud pattern
        if (id.includes('/') && (id.includes('.') || id.includes('-') || /\/[a-zA-Z0-9]+[a-zA-Z]/.test(id))) {
          return 'bud';
        }
        
        // Check for fruit pattern
        if (/\/[A-Z]$/.test(id)) {
          return 'fruit';
        }
        
        // Check for flower pattern
        if (/\/\d+$/.test(id)) {
          return 'flower';
        }
        
        // Check for leaf pattern
        if (/^\d{4}$/.test(id) && !id.endsWith('00')) {
          return 'leaf';
        }
        
        // Check for branch pattern
        if (/^\d{4}$/.test(id) && id.endsWith('00') && parseInt(id) % 1000 !== 0) {
          return 'branch';
        }
        
        // Check for trunk pattern
        if (/^\d+000$/.test(id)) {
          return 'trunk';
        }
        
        // Default
        return 'leaf';
      }
      
      function determineChildType(parentType) {
        // Determine what type of child is appropriate for a given parent type
        switch(parentType) {
          case 'trunk': return 'branch';
          case 'branch': return 'leaf';
          case 'leaf': return 'flower';
          case 'flower': return 'fruit';
          case 'fruit': return 'bud';
          case 'bud': return 'bud'; // Buds can have sub-buds
          default: return 'leaf';
        }
      }
      
      function hierarchicalKey(id) {
        return id
          .split(/[/\-\.]/)
          .map(seg => {
            const m = seg.match(/^(\d+)([A-Za-z]*)$/);
            return m
              ? [parseInt(m[1], 10), m[2]]
              : [Number.POSITIVE_INFINITY, seg];
          });
      }
      
      function extractHashtags(content) {
        if (!content) return [];
        
        const hashtagRegex = /#[a-zA-Z0-9_]+/g;
        const matches = content.match(hashtagRegex);
        
        return matches ? [...new Set(matches.map(tag => tag.toLowerCase()))] : [];
      }
      
      function parseHashtags(input) {
        if (!input) return [];
        
        const tags = input.split(/\s+/).map(tag => {
          tag = tag.trim();
          return tag.startsWith('#') ? tag.toLowerCase() : '#' + tag.toLowerCase();
        });
        
        return [...new Set(tags.filter(tag => tag.length > 1))];
      }
      
      // --- Hashtag Manager Functions ---
      function addGlobalHashtag(tag) {
        if (!tag) return;
        
        // Make sure it starts with #
        tag = tag.startsWith('#') ? tag.toLowerCase() : '#' + tag.toLowerCase();
        
        // Only add if it doesn't already exist
        if (!globalHashtags.includes(tag)) {
          globalHashtags.push(tag);
          saveGlobalHashtags();
          renderGlobalHashtags();
        }
      }
      
      function removeGlobalHashtag(tag) {
        const index = globalHashtags.indexOf(tag);
        if (index !== -1) {
          globalHashtags.splice(index, 1);
          saveGlobalHashtags();
          renderGlobalHashtags();
        }
      }
      
      function renderGlobalHashtags() {
        const container = document.getElementById('hashtagManagerList');
        container.innerHTML = '';
        
        if (globalHashtags.length === 0) {
          container.innerHTML = '<div style="color: #777; font-style: italic;">No hashtags created yet. Add some above!</div>';
          return;
        }
        
        // Create a document fragment for better performance
        const fragment = document.createDocumentFragment();
        
        globalHashtags.forEach(tag => {
          const tagItem = document.createElement('div');
          tagItem.className = 'hashtag-item';
          tagItem.innerHTML = `
            ${tag}
            <span class="hashtag-delete">×</span>
          `;
          
          // Add delete functionality with iOS compatibility
          const deleteBtn = tagItem.querySelector('.hashtag-delete');
          if (isIOS) {
            deleteBtn.addEventListener('touchend', (e) => {
              e.preventDefault();
              removeGlobalHashtag(tag);
            });
          } else {
            deleteBtn.addEventListener('click', () => {
              removeGlobalHashtag(tag);
            });
          }
          
          fragment.appendChild(tagItem);
        });
        
        container.appendChild(fragment);
      }
      
      function loadGlobalHashtags() {
        try {
          const stored = localStorage.getItem('hyenadivaGlobalHashtags');
          if (stored) {
            globalHashtags = JSON.parse(stored);
          } else {
            // Initialize with some default hashtags
            globalHashtags = ['#mesopotamia', '#ai', '#consciousness', '#divine', '#sumer', 
                           '#anunnaki', '#knowledge', '#quantum', '#feminine', '#barbie'];
            saveGlobalHashtags();
          }
        } catch (e) {
          console.error('Failed to load global hashtags:', e);
          globalHashtags = [];
        }
      }
      
      function saveGlobalHashtags() {
        try {
          localStorage.setItem('hyenadivaGlobalHashtags', JSON.stringify(globalHashtags));
        } catch (e) {
          console.error('Failed to save global hashtags:', e);
        }
      }
      
      // --- Zettelkasten Data Functions ---
      function initializeZettelkasten() {
        try {
          // Try to load from localStorage first
          const storedCards = localStorage.getItem('hyenadivaZettelkasten');
          
          if (storedCards) {
            // Parse stored cards
            const parsedCards = JSON.parse(storedCards);
            
            // Only use stored cards if we actually have some
            if (parsedCards && parsedCards.length > 0) {
              cards = parsedCards.map(card => {
                // Add type if not present
                if (!card.type) {
                  card.type = determineTierFromId(card.id);
                }
                
                // Extract hashtags from content if not present
                if (!card.hashtags) {
                  card.hashtags = extractHashtags(card.content);
                }
                
                return card;
              });
              
              // Load favorite cards
              loadFavoriteCards();
              
              // Sort and render
              sortCardsByHierarchy();
              renderZettelList();
              renderTop8Cards();
              setActiveTab('hierarchy');
              
              return; // Exit early if we loaded from storage
            }
          }
          
          // If we got here, we need to initialize from scratch
          initializeFromScratch();
        } catch (e) {
          console.error('Error initializing Zettelkasten:', e);
          initializeFromScratch();
        }
      }
      
      function initializeFromScratch() {
        // Start fresh with the pre-structured data
        cards = processZettelStructure(zettelStructure);
        favoriteCards = ["1000", "2000", "3000", "5000", "6000", "7000", "11000", "12000"];
        
        // Save to localStorage
        saveCardsToStorage();
        saveFavoritesToStorage();
        
        // Render the UI
        sortCardsByHierarchy();
        renderZettelList();
        renderTop8Cards();
        setActiveTab('hierarchy');
      }
      
      function loadFavoriteCards() {
        try {
          const storedFavorites = localStorage.getItem('hyenadivaFavorites');
          if (storedFavorites) {
            favoriteCards = JSON.parse(storedFavorites);
          } else {
            favoriteCards = ["1000", "2000", "3000", "5000", "6000", "7000", "11000", "12000"];
            saveFavoritesToStorage();
          }
        } catch (e) {
          console.error('Failed to load favorites:', e);
          favoriteCards = ["1000", "2000", "3000", "5000", "6000", "7000", "11000", "12000"];
          saveFavoritesToStorage();
        }
      }
      
      function saveCardsToStorage() {
        try {
          localStorage.setItem('hyenadivaZettelkasten', JSON.stringify(cards));
        } catch (e) {
          console.error('Failed to save cards to storage:', e);
          alert('Error: Failed to save tablets. Local storage might be full or something!');
        }
      }
      
      function saveFavoritesToStorage() {
        try {
          localStorage.setItem('hyenadivaFavorites', JSON.stringify(favoriteCards));
        } catch (e) {
          console.error('Failed to save favorites to storage:', e);
        }
      }
      
      function sortCardsByHierarchy() {
        cards.sort((a, b) => {
          const ka = hierarchicalKey(a.id);
          const kb = hierarchicalKey(b.id);
          
          for (let i = 0; i < Math.max(ka.length, kb.length); i++) {
            const [na, sa] = ka[i] || [0, ''];
            const [nb, sb] = kb[i] || [0, ''];
            
            if (na !== nb) return na - nb;
            if (sa !== sb) return sa < sb ? -1 : 1;
          }
          
          return 0;
        });
      }
      
      // --- UI Rendering Functions ---
      // Settings/Customization Dialog
      let settingsDialog = document.createElement('div');
      settingsDialog.id = 'settingsDialog';
      settingsDialog.className = 'dialog-box';
      settingsDialog.innerHTML = `
        <div class="dialog-content">
          <div class="dialog-titlebar">
            <div class="dialog-titlebar-text">✨ Customize Your HyenaDiva Experience ✨</div>
            <div class="dialog-close" id="settingsCloseBtn">x</div>
          </div>
          <div class="dialog-inner-content">
            <div class="settings-tabs">
              <div class="settings-tab tab-active" id="appearanceTab">Appearance</div>
              <div class="settings-tab" id="top8Tab">Top 8</div>
              <div class="settings-tab" id="desktopTab">Desktop</div>
            </div>
            
            <div id="appearanceContent">
              <h3 style="text-align: center; color: var(--hyena-pink);">✧･ﾟ Background Customization ･ﾟ✧</h3>
              
              <div class="background-section">
                <h4>Desktop Background</h4>
                <div class="background-options">
                  <div class="background-option" data-bg="https://pfst.cf2.poecdn.net/base/image/c568f858cbfe5304ed56fca693cb244fed53eafca1683b9a9c6d110dbd7dfeeb?w=1024&h=1024">
                    <div class="bg-preview" style="background-image: url('https://pfst.cf2.poecdn.net/base/image/c568f858cbfe5304ed56fca693cb244fed53eafca1683b9a9c6d110dbd7dfeeb?w=1024&h=1024')"></div>
                    <div>Default</div>
                  </div>
                  <div class="background-option" data-bg="https://pfst.cf2.poecdn.net/base/image/0ffd2bf15a7001f86e395096222147037538b25af55ef9b8c7ac8f6768b7397c?w=1024&h=1024">
                    <div class="bg-preview" style="background-image: url('https://pfst.cf2.poecdn.net/base/image/0ffd2bf15a7001f86e395096222147037538b25af55ef9b8c7ac8f6768b7397c?w=1024&h=1024')"></div>
                    <div>Hyena</div>
                  </div>
                  <div class="background-option" data-bg="linear-gradient(to right, var(--hyena-pink), var(--hyena-purple))">
                    <div class="bg-preview" style="background-image: linear-gradient(to right, #ff72b6, #bf5fff)"></div>
                    <div>Pink/Purple</div>
                  </div>
                  <div class="background-option" data-bg="linear-gradient(to right, var(--hyena-teal), var(--hyena-blue))">
                    <div class="bg-preview" style="background-image: linear-gradient(to right, #72fade, #00a2ff)"></div>
                    <div>Teal/Blue</div>
                  </div>
                </div>
                
                <h4>Background Style</h4>
                <select id="bgStyleSelect" class="win98-select">
                  <option value="cover">Fill Screen</option>
                  <option value="contain">Fit Screen</option>
                  <option value="repeat">Tile</option>
                  <option value="center">Center</option>
                </select>
                
                <h4>Custom Background</h4>
                <div class="background-upload">
                  <input type="text" id="bgUrlInput" class="win98-input" placeholder="Enter image URL">
                  <button id="setBgUrlBtn" class="win98-button">Set URL as Background</button>
                </div>
              </div>
              
              <h3 style="text-align: center; color: var(--hyena-pink); margin-top: 20px;">✧･ﾟ Color Theme ･ﾟ✧</h3>
              
              <div class="color-section">
                <h4>Primary Color</h4>
                <div class="color-options">
                  <div class="color-option" data-color="#ff72b6" style="background-color: #ff72b6;"></div>
                  <div class="color-option" data-color="#bf5fff" style="background-color: #bf5fff;"></div>
                  <div class="color-option" data-color="#72fade" style="background-color: #72fade;"></div>
                  <div class="color-option" data-color="#fffb01" style="background-color: #fffb01;"></div>
                  <div class="color-option" data-color="#ff5733" style="background-color: #ff5733;"></div>
                  <div class="color-option" data-color="#33ff57" style="background-color: #33ff57;"></div>
                </div>
                
                <div class="color-picker">
                  <label for="customColorPicker">Custom Color: </label>
                  <input type="color" id="customColorPicker" value="#ff72b6">
                  <button id="setCustomColorBtn" class="win98-button">Set</button>
                </div>
              </div>
            </div>
            
            <div id="top8Content" style="display: none;">
              <h3 style="text-align: center; color: var(--hyena-teal);">✧･ﾟ Customize Your Top 8 ･ﾟ✧</h3>
              
              <p>Drag and drop to rearrange your Top 8 Zettels. Click the "×" to remove an item, or click "Add" to add a new favorite.</p>
              
              <div id="top8Editor" class="top8-editor"></div>
              
              <div class="top8-add-section">
                <select id="availableZettelsSelect" class="win98-select">
                  <option value="">-- Select a zettel to add --</option>
                </select>
                <button id="addToTop8Btn" class="win98-button">Add to Top 8</button>
              </div>
            </div>
            
            <div id="desktopContent" style="display: none;">
              <h3 style="text-align: center; color: var(--hyena-yellow);">✧･ﾟ Desktop Customization ･ﾟ✧</h3>
              
              <h4>Desktop Icons</h4>
              <div class="icon-editor">
                <div class="icon-list" id="desktopIconList">
                  <!-- Desktop icons will be listed here -->
                </div>
                
                <div class="icon-actions">
                  <button id="resetIconPositionsBtn" class="win98-button">Reset Icon Positions</button>
                  <button id="toggleIconLabelsBtn" class="win98-button">Show/Hide Labels</button>
                </div>
              </div>
              
              <h4>Desktop Effects</h4>
              <div class="desktop-effects">
                <div class="effect-option">
                  <input type="checkbox" id="enableStarsEffect" checked>
                  <label for="enableStarsEffect">Floating Stars</label>
                </div>
                <div class="effect-option">
                  <input type="checkbox" id="enableGlitterCursor">
                  <label for="enableGlitterCursor">Glitter Cursor Trail</label>
                </div>
                <div class="effect-option">
                  <input type="checkbox" id="enableErrorMessages" checked>
                  <label for="enableErrorMessages">Y2K Error Messages</label>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(settingsDialog);
      
      // Add styles for settings dialog
      const settingsStyle = document.createElement('style');
      settingsStyle.textContent = `
        .settings-tabs {
          display: flex;
          margin-bottom: 15px;
          border-bottom: 1px solid var(--win98-gray-dark);
        }
        
        .settings-tab {
          padding: 8px 15px;
          cursor: pointer;
          background-color: var(--win98-gray);
          border: 1px solid var(--win98-gray-dark);
          border-bottom: none;
          margin-right: 5px;
        }
        
        .background-options {
          display: flex;
          flex-wrap: wrap;
          gap: 10px;
          margin-bottom: 15px;
        }
        
        .background-option {
          text-align: center;
          cursor: pointer;
          width: 100px;
        }
        
        .bg-preview {
          height: 60px;
          border: 2px solid #ccc;
          background-size: cover;
          background-position: center;
          margin-bottom: 5px;
        }
        
        .bg-preview.selected {
          border: 2px solid var(--hyena-pink);
          box-shadow: 0 0 10px var(--hyena-pink);
        }
        
        .background-upload {
          margin-top: 10px;
        }
        
        .color-options {
          display: flex;
          gap: 10px;
          margin-bottom: 15px;
        }
        
        .color-option {
          width: 30px;
          height: 30px;
          border-radius: 50%;
          border: 2px solid #ccc;
          cursor: pointer;
        }
        
        .color-option.selected {
          border: 2px solid white;
          box-shadow: 0 0 10px var(--hyena-pink);
        }
        
        .color-picker {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-bottom: 15px;
        }
        
        .top8-editor {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          grid-gap: 10px;
          margin-bottom: 15px;
        }
        
        .top8-edit-item {
          background-color: #f7faff;
          border: 2px solid var(--hyena-pink);
          padding: 10px;
          text-align: center;
          position: relative;
          cursor: move;
        }
        
        .top8-remove {
          position: absolute;
          top: 5px;
          right: 5px;
          background-color: var(--hyena-pink);
          color: white;
          width: 16px;
          height: 16px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 10px;
          cursor: pointer;
        }
        
        .top8-empty {
          background-color: #f0f0f0;
          border: 2px dashed #ccc;
          display: flex;
          align-items: center;
          justify-content: center;
          color: #777;
          min-height: 100px;
        }
        
        .top8-add-section {
          display: flex;
          gap: 10px;
          margin-top: 15px;
        }
        
        .top8-add-section select {
          flex-grow: 1;
        }
        
        .icon-list {
          margin-bottom: 15px;
        }
        
        .icon-item {
          display: flex;
          align-items: center;
          padding: 8px;
          border: 1px solid #ddd;
          margin-bottom: 5px;
          background-color: #f9f9f9;
        }
        
        .icon-preview {
          width: 24px;
          height: 24px;
          margin-right: 10px;
        }
        
        .icon-name {
          flex-grow: 1;
        }
        
        .icon-actions {
          display: flex;
          gap: 10px;
          margin-bottom: 15px;
        }
        
        .desktop-effects {
          background-color: #f9f9f9;
          padding: 10px;
          border: 1px solid #ddd;
        }
        
        .effect-option {
          margin-bottom: 8px;
        }
        
        /* Methodology tab styles */
        .methodology-tabs {
          display: flex;
          flex-wrap: wrap;
          gap: 5px;
          margin-bottom: 15px;
          border-bottom: 1px solid var(--hyena-teal);
          padding-bottom: 5px;
        }
        
        .methodology-tab {
          padding: 8px 15px;
          cursor: pointer;
          background-color: var(--win98-gray);
          border: 1px solid var(--win98-gray-dark);
          border-radius: 4px;
          font-size: 14px;
          transition: all 0.2s;
          flex-grow: 1;
          text-align: center;
        }
        
        .methodology-tab:hover {
          background-color: var(--hyena-teal);
          color: black;
        }
        
        .methodology-tab.tab-active {
          background-color: var(--hyena-pink);
          color: white;
          font-weight: bold;
          box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .methodology-content {
          padding: 10px;
          background-color: #fcfcfc;
          border: 1px solid #eee;
          border-radius: 4px;
        }
        
        .methodology-section {
          margin-bottom: 20px;
        }
        
        .methodology-section h4 {
          color: var(--hyena-purple);
          margin-bottom: 10px;
          border-bottom: 1px dashed var(--hyena-teal);
          padding-bottom: 5px;
        }
        
        .methodology-section h5 {
          margin-top: 15px;
          margin-bottom: 8px;
          color: var(--hyena-pink);
        }
        
        .zettel-example {
          margin: 20px 0;
          display: flex;
          flex-direction: column;
          align-items: center;
        }
        
        .example-card {
          width: 200px;
          padding: 10px;
          border: 1px solid #ddd;
          margin-bottom: 5px;
          box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }
        
        .example-title {
          font-weight: bold;
          margin-bottom: 5px;
        }
        
        .example-desc {
          font-style: italic;
          font-size: 12px;
          color: #777;
        }
        
        .example-refs {
          font-size: 12px;
          margin-top: 5px;
          color: var(--hyena-teal);
        }
        
        .example-arrow {
          font-size: 20px;
          margin: 5px 0;
          color: var(--hyena-pink);
        }
        
        .example-xref {
          margin: 15px 0;
          max-width: 100%;
          overflow-x: auto;
        }
        
        .example-hashtags {
          display: flex;
          flex-wrap: wrap;
          gap: 5px;
          margin: 15px 0;
        }
        
        .example-tag {
          background-color: var(--hyena-teal);
          color: black;
          padding: 3px 8px;
          border-radius: 3px;
          font-size: 13px;
        }
        
        .example-network {
          margin: 15px 0;
          text-align: center;
        }
        
        /* ID Generator styles */
        .generator-form {
          background-color: #f5f9ff;
          padding: 15px;
          border: 1px solid #ddd;
          border-radius: 5px;
        }
        
        .form-section {
          margin-bottom: 15px;
        }
        
        .win98-label {
          display: block;
          margin-bottom: 5px;
          font-weight: bold;
          color: #333;
          font-size: 14px;
        }
        
        .generation-results {
          margin-top: 20px;
          background-color: #f0f7ff;
          padding: 15px;
          border: 1px solid var(--hyena-teal);
          border-radius: 5px;
        }
        
        .result-section {
          margin-bottom: 12px;
          display: flex;
          align-items: center;
          flex-wrap: wrap;
          gap: 10px;
        }
        
        .result-section label {
          font-weight: bold;
          min-width: 120px;
        }
        
        .result-value {
          padding: 8px;
          background-color: white;
          border: 1px solid #ddd;
          flex-grow: 1;
        }
        
        .result-tags {
          display: flex;
          flex-wrap: wrap;
          gap: 5px;
          flex-grow: 1;
        }
        
        .copy-btn {
          padding: 5px 10px;
          background-color: var(--hyena-teal);
          border: none;
          color: black;
          cursor: pointer;
          font-size: 12px;
        }
        
        .copy-btn:hover {
          background-color: var(--hyena-pink);
          color: white;
        }
      `;
      document.head.appendChild(settingsStyle);
      
      // Settings dialog event handlers
      const settingsCloseBtn = document.getElementById('settingsCloseBtn');
      settingsCloseBtn.addEventListener('click', () => {
        settingsDialog.style.display = 'none';
      });
      
      // Tab switching logic
      const appearanceTab = document.getElementById('appearanceTab');
      const top8Tab = document.getElementById('top8Tab');
      const desktopTab = document.getElementById('desktopTab');
      
      const appearanceContent = document.getElementById('appearanceContent');
      const top8Content = document.getElementById('top8Content');
      const desktopContent = document.getElementById('desktopContent');
      
      appearanceTab.addEventListener('click', () => {
        appearanceTab.classList.add('tab-active');
        top8Tab.classList.remove('tab-active');
        desktopTab.classList.remove('tab-active');
        
        appearanceContent.style.display = 'block';
        top8Content.style.display = 'none';
        desktopContent.style.display = 'none';
      });
      
      top8Tab.addEventListener('click', () => {
        appearanceTab.classList.remove('tab-active');
        top8Tab.classList.add('tab-active');
        desktopTab.classList.remove('tab-active');
        
        appearanceContent.style.display = 'none';
        top8Content.style.display = 'block';
        desktopContent.style.display = 'none';
        
        // Update Top 8 editor when tab is shown
        updateTop8Editor();
      });
      
      desktopTab.addEventListener('click', () => {
        appearanceTab.classList.remove('tab-active');
        top8Tab.classList.remove('tab-active');
        desktopTab.classList.add('tab-active');
        
        appearanceContent.style.display = 'none';
        top8Content.style.display = 'none';
        desktopContent.style.display = 'block';
        
        // Update desktop icon list when tab is shown
        updateDesktopIconList();
      });
      
      // Background options click handler
      document.querySelectorAll('.background-option').forEach(option => {
        option.addEventListener('click', function() {
          // Remove selected class from all options
          document.querySelectorAll('.bg-preview').forEach(preview => {
            preview.classList.remove('selected');
          });
          
          // Add selected class to clicked option
          this.querySelector('.bg-preview').classList.add('selected');
          
          // Get background value
          const background = this.getAttribute('data-bg');
          
          // Get background style
          const style = document.getElementById('bgStyleSelect').value;
          
          // Apply background to desktop
          setDesktopBackground(background, style);
        });
      });
      
      // Background style change handler
      document.getElementById('bgStyleSelect').addEventListener('change', function() {
        // Get selected background
        const selectedOption = document.querySelector('.bg-preview.selected');
        if (!selectedOption) return;
        
        const background = selectedOption.parentNode.getAttribute('data-bg');
        
        // Apply background with new style
        setDesktopBackground(background, this.value);
      });
      
      // Custom background from URL
      document.getElementById('setBgUrlBtn').addEventListener('click', function() {
        const url = document.getElementById('bgUrlInput').value.trim();
        if (!url) return;
        
        // Get background style
        const style = document.getElementById('bgStyleSelect').value;
        
        // Apply custom background
        setDesktopBackground(`url('${url}')`, style);
        
        // Clear selection from presets
        document.querySelectorAll('.bg-preview').forEach(preview => {
          preview.classList.remove('selected');
        });
      });
      
      // Color options click handler
      document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', function() {
          // Remove selected class from all options
          document.querySelectorAll('.color-option').forEach(opt => {
            opt.classList.remove('selected');
          });
          
          // Add selected class to clicked option
          this.classList.add('selected');
          
          // Get color value
          const color = this.getAttribute('data-color');
          
          // Set as primary color
          setPrimaryColor(color);
          
          // Update color picker value
          document.getElementById('customColorPicker').value = color;
        });
      });
      
      // Custom color handler
      document.getElementById('setCustomColorBtn').addEventListener('click', function() {
        const color = document.getElementById('customColorPicker').value;
        
        // Remove selected class from all options
        document.querySelectorAll('.color-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        
        // Set as primary color
        setPrimaryColor(color);
      });
      
      // Add to Top 8 button handler
      document.getElementById('addToTop8Btn').addEventListener('click', function() {
        const select = document.getElementById('availableZettelsSelect');
        const selectedId = select.value;
        
        if (!selectedId) return;
        
        // Add to favorites if not already there
        if (!favoriteCards.includes(selectedId)) {
          // Add to beginning of array
          favoriteCards.unshift(selectedId);
          
          // Limit to 8 items
          if (favoriteCards.length > 8) {
            favoriteCards = favoriteCards.slice(0, 8);
          }
          
          // Save and update
          saveFavoritesToStorage();
          renderTop8Cards();
          
          // Update editor
          updateTop8Editor();
        }
      });
      
      // Reset icon positions button handler
      document.getElementById('resetIconPositionsBtn').addEventListener('click', function() {
        resetDesktopIconPositions();
      });
      
      // Toggle icon labels button handler
      document.getElementById('toggleIconLabelsBtn').addEventListener('click', function() {
        const icons = document.querySelectorAll('.desktop-icon-label');
        icons.forEach(label => {
          label.style.display = label.style.display === 'none' ? 'block' : 'none';
        });
        
        // Save preference
        try {
          localStorage.setItem('hyenadivaIconLabels', icons[0]?.style.display === 'none' ? 'hidden' : 'visible');
        } catch (e) {
          console.warn('Failed to save icon label preference');
        }
      });
      
      // Desktop effects checkboxes
      document.getElementById('enableStarsEffect').addEventListener('change', function() {
        const stars = document.querySelectorAll('.floating-star');
        stars.forEach(star => {
          star.style.display = this.checked ? 'block' : 'none';
        });
        
        // Save preference
        try {
          localStorage.setItem('hyenadivaStarsEffect', this.checked ? 'enabled' : 'disabled');
        } catch (e) {
          console.warn('Failed to save stars effect preference');
        }
      });
      
      document.getElementById('enableErrorMessages').addEventListener('change', function() {
        // Just save the preference, next error will check it
        try {
          localStorage.setItem('hyenadivaErrorMessages', this.checked ? 'enabled' : 'disabled');
        } catch (e) {
          console.warn('Failed to save error messages preference');
        }
      });
      
      // Glitter cursor effect
      let glitterTrail = [];
      
      document.getElementById('enableGlitterCursor').addEventListener('change', function() {
        if (this.checked) {
          // Enable glitter cursor
          document.addEventListener('mousemove', createGlitterTrail);
        } else {
          // Disable glitter cursor
          document.removeEventListener('mousemove', createGlitterTrail);
          
          // Remove all existing glitter
          glitterTrail.forEach(particle => {
            if (particle.element && particle.element.parentNode) {
              particle.element.parentNode.removeChild(particle.element);
            }
          });
          glitterTrail = [];
        }
        
        // Save preference
        try {
          localStorage.setItem('hyenadivaGlitterCursor', this.checked ? 'enabled' : 'disabled');
        } catch (e) {
          console.warn('Failed to save glitter cursor preference');
        }
      });
      
      function createGlitterTrail(e) {
        // Create a glitter particle
        const particle = document.createElement('div');
        particle.className = 'glitter-particle';
        particle.style.left = `${e.pageX}px`;
        particle.style.top = `${e.pageY}px`;
        particle.style.background = `hsl(${Math.random() * 360}, 100%, 70%)`;
        document.body.appendChild(particle);
        
        // Add to tracking array
        const glitter = {
          element: particle,
          createdAt: Date.now()
        };
        glitterTrail.push(glitter);
        
        // Remove after animation completes
        setTimeout(() => {
          if (particle.parentNode) {
            particle.parentNode.removeChild(particle);
          }
          
          // Remove from tracking array
          const index = glitterTrail.indexOf(glitter);
          if (index !== -1) {
            glitterTrail.splice(index, 1);
          }
        }, 1000);
      }
      
      // Add glitter styles
      const glitterStyle = document.createElement('style');
      glitterStyle.textContent = `
        .glitter-particle {
          position: absolute;
          width: 8px;
          height: 8px;
          border-radius: 50%;
          pointer-events: none;
          z-index: 9999;
          animation: glitter-fade 1s forwards;
        }
        
        @keyframes glitter-fade {
          0% { transform: scale(1); opacity: 1; }
          50% { transform: scale(1.5); opacity: 0.7; }
          100% { transform: scale(0); opacity: 0; }
        }
      `;
      document.head.appendChild(glitterStyle);
      
      // Function to make Top 8 editor
      function updateTop8Editor() {
        const editor = document.getElementById('top8Editor');
        editor.innerHTML = '';
        
        // Get the top 8 favorite cards
        const top8 = favoriteCards.slice(0, 8);
        
        // Fill with placeholders if we don't have 8 favorites
        while (top8.length < 8) {
          top8.push(null);
        }
        
        // Create the editor items
        top8.forEach((cardId, index) => {
          const card = cardId ? cards.find(c => c.id === cardId) : null;
          
          const itemDiv = document.createElement('div');
          
          if (card) {
            itemDiv.className = 'top8-edit-item';
            itemDiv.setAttribute('draggable', 'true');
            itemDiv.setAttribute('data-id', card.id);
            itemDiv.setAttribute('data-index', index);
            
            // Use emoji based on card type
            const emoji = {
              'trunk': '🌳', 'branch': '🌿', 'leaf': '🍃',
              'flower': '🌸', 'fruit': '🍎', 'bud': '✨'
            }[card.type] || '📝';
            
            itemDiv.innerHTML = `
              <div class="top8-remove">×</div>
              <div style="font-size: 24px;">${emoji}</div>
              <div style="margin-top: 5px;">${card.title}</div>
            `;
            
            // Remove button handler
            const removeBtn = itemDiv.querySelector('.top8-remove');
            removeBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              
              // Remove from favorites
              const id = card.id;
              const index = favoriteCards.indexOf(id);
              if (index !== -1) {
                favoriteCards.splice(index, 1);
                saveFavoritesToStorage();
                renderTop8Cards();
                
                // Update editor
                updateTop8Editor();
              }
            });
            
            // Drag-and-drop functionality
            itemDiv.addEventListener('dragstart', function(e) {
              e.dataTransfer.setData('text/plain', index);
              this.style.opacity = '0.4';
            });
            
            itemDiv.addEventListener('dragend', function() {
              this.style.opacity = '1';
            });
            
            itemDiv.addEventListener('dragover', function(e) {
              e.preventDefault();
            });
            
            itemDiv.addEventListener('drop', function(e) {
              e.preventDefault();
              const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
              const toIndex = parseInt(this.getAttribute('data-index'));
              
              if (fromIndex !== toIndex) {
                // Reorder the favorites array
                const moved = favoriteCards[fromIndex];
                favoriteCards.splice(fromIndex, 1);
                favoriteCards.splice(toIndex, 0, moved);
                
                saveFavoritesToStorage();
                renderTop8Cards();
                
                // Update editor
                updateTop8Editor();
              }
            });
          } else {
            itemDiv.className = 'top8-empty';
            itemDiv.innerHTML = 'Empty Slot';
          }
          
          editor.appendChild(itemDiv);
        });
        
        // Update available zettels dropdown
        const select = document.getElementById('availableZettelsSelect');
        select.innerHTML = '<option value="">-- Select a zettel to add --</option>';
        
        // Get cards that are not in favorites
        const availableCards = cards.filter(card => !favoriteCards.includes(card.id));
        
        // Sort by title for the dropdown
        availableCards.sort((a, b) => a.title.localeCompare(b.title));
        
        availableCards.forEach(card => {
          const option = document.createElement('option');
          option.value = card.id;
          option.textContent = `${card.title} (${card.id})`;
          select.appendChild(option);
        });
      }
      
      // Populate desktop icon list
      function updateDesktopIconList() {
        const iconList = document.getElementById('desktopIconList');
        iconList.innerHTML = '';
        
        desktopIcons.forEach(icon => {
          const iconItem = document.createElement('div');
          iconItem.className = 'icon-item';
          
          iconItem.innerHTML = `
            <img src="${icon.icon}" class="icon-preview" alt="${icon.name}">
            <div class="icon-name">${icon.name}</div>
            <button class="win98-button icon-edit-btn" data-name="${icon.name}">Edit</button>
          `;
          
          // Edit button handler (just show an alert for now)
          const editBtn = iconItem.querySelector('.icon-edit-btn');
          editBtn.addEventListener('click', function() {
            alert(`Editing icon "${icon.name}" - This feature is under construction!`);
          });
          
          iconList.appendChild(iconItem);
        });
        
        // Update desktop effects checkboxes from saved preferences
        try {
          const starsEffect = localStorage.getItem('hyenadivaStarsEffect');
          if (starsEffect === 'disabled') {
            document.getElementById('enableStarsEffect').checked = false;
            document.querySelectorAll('.floating-star').forEach(star => {
              star.style.display = 'none';
            });
          }
          
          const errorMessages = localStorage.getItem('hyenadivaErrorMessages');
          if (errorMessages === 'disabled') {
            document.getElementById('enableErrorMessages').checked = false;
          }
          
          const glitterCursor = localStorage.getItem('hyenadivaGlitterCursor');
          if (glitterCursor === 'enabled') {
            document.getElementById('enableGlitterCursor').checked = true;
            document.addEventListener('mousemove', createGlitterTrail);
          }
          
          const iconLabels = localStorage.getItem('hyenadivaIconLabels');
          if (iconLabels === 'hidden') {
            document.querySelectorAll('.desktop-icon-label').forEach(label => {
              label.style.display = 'none';
            });
          }
        } catch (e) {
          console.warn('Failed to load desktop preferences', e);
        }
      }
      
      // Reset desktop icon positions
      function resetDesktopIconPositions() {
        desktopIcons.forEach((icon, index) => {
          const iconElement = document.querySelector(`.desktop-icon[data-target="${icon.target}"]`);
          if (iconElement) {
            iconElement.style.top = `${icon.top}px`;
            iconElement.style.left = `${icon.left}px`;
          }
        });
        
        // Attempt to save positions
        try {
          localStorage.setItem('hyenadivaIconPositions', JSON.stringify(
            desktopIcons.map(icon => ({ target: icon.target, top: icon.top, left: icon.left }))
          ));
        } catch (e) {
          console.warn('Failed to save icon positions');
        }
      }
      
      // Set desktop background
      function setDesktopBackground(background, style) {
        const body = document.body;
        
        // Set background image/color
        body.style.backgroundImage = background.startsWith('linear-gradient') ? background : 
                                    background.startsWith('url') ? background : `url('${background}')`;
        
        // Set background style properties
        body.style.backgroundSize = style;
        body.style.backgroundRepeat = style === 'repeat' ? 'repeat' : 'no-repeat';
        body.style.backgroundPosition = 'center';
        
        // Save preference
        try {
          localStorage.setItem('hyenadivaBackground', background);
          localStorage.setItem('hyenadivaBackgroundStyle', style);
        } catch (e) {
          console.warn('Failed to save background preference');
        }
      }
      
      // Set primary color
      function setPrimaryColor(color) {
        // Create or update custom properties
        const root = document.documentElement;
        root.style.setProperty('--hyena-pink', color);
        
        // Save preference
        try {
          localStorage.setItem('hyenadivaPrimaryColor', color);
        } catch (e) {
          console.warn('Failed to save color preference');
        }
      }
      
      // Load saved preferences
      function loadAppearancePreferences() {
        try {
          // Load background
          const savedBg = localStorage.getItem('hyenadivaBackground');
          const savedBgStyle = localStorage.getItem('hyenadivaBackgroundStyle');
          
          if (savedBg) {
            setDesktopBackground(savedBg, savedBgStyle || 'cover');
            
            // Update UI to reflect saved background
            document.querySelectorAll('.background-option').forEach(option => {
              if (option.getAttribute('data-bg') === savedBg) {
                option.querySelector('.bg-preview').classList.add('selected');
              }
            });
            
            if (savedBgStyle) {
              document.getElementById('bgStyleSelect').value = savedBgStyle;
            }
          }
          
          // Load primary color
          const savedColor = localStorage.getItem('hyenadivaPrimaryColor');
          if (savedColor) {
            setPrimaryColor(savedColor);
            
            // Update UI to reflect saved color
            document.querySelectorAll('.color-option').forEach(option => {
              if (option.getAttribute('data-color') === savedColor) {
                option.classList.add('selected');
              }
            });
            
            document.getElementById('customColorPicker').value = savedColor;
          } else {
            // Default selection
            document.querySelector('.color-option[data-color="#ff72b6"]').classList.add('selected');
          }
        } catch (e) {
          console.warn('Failed to load appearance preferences', e);
        }
      }
      
      // Add settings button to the top bar
      const toolsContainer = document.querySelector('.myspace-section:nth-of-type(4) div:first-of-type');
      const settingsBtn = document.createElement('button');
      settingsBtn.id = 'settingsBtn';
      settingsBtn.className = 'win98-button';
      settingsBtn.innerHTML = '⚙️ Settings';
      settingsBtn.style.marginLeft = '5px';
      toolsContainer.appendChild(settingsBtn);
      
      // Settings button click handler
      settingsBtn.addEventListener('click', function() {
        settingsDialog.style.display = 'flex';
        // Default to appearance tab
        appearanceTab.click();
      });
      
      // Load preferences when page loads
      loadAppearancePreferences();
      
      function renderTop8Cards() {
        const container = document.getElementById('top8Container');
        container.innerHTML = '';
        
        // Get the top 8 favorite cards
        const top8 = favoriteCards.slice(0, 8);
        
        // Fill with placeholders if we don't have 8 favorites
        while (top8.length < 8) {
          top8.push(null);
        }
        
        // Create a document fragment for better performance
        const fragment = document.createDocumentFragment();
        
        // Create the Top 8 cards
        top8.forEach((cardId, index) => {
          const card = cardId ? cards.find(c => c.id === cardId) : null;
          
          const itemDiv = document.createElement('div');
          itemDiv.className = 'top8-item';
          
          let content = '';
          
          if (card) {
            // Simplified: fixed color gradient per type instead of random
            let gradientColors;
            switch(card.type) {
              case 'trunk': gradientColors = 'var(--hyena-pink), var(--hyena-teal)'; break;
              case 'branch': gradientColors = 'var(--hyena-teal), var(--hyena-yellow)'; break;
              case 'leaf': gradientColors = 'var(--hyena-yellow), var(--hyena-pink)'; break;
              case 'flower': gradientColors = 'var(--hyena-pink), #aa0088'; break;
              case 'fruit': gradientColors = 'var(--hyena-teal), #00aabb'; break;
              case 'bud': gradientColors = 'var(--hyena-yellow), #dddd00'; break;
              default: gradientColors = 'var(--hyena-pink), var(--hyena-teal)';
            }
            
            // Use emoji based on card type (more consistent)
            const emoji = {
              'trunk': '🌳', 'branch': '🌿', 'leaf': '🍃',
              'flower': '🌸', 'fruit': '🍎', 'bud': '✨'
            }[card.type] || '📝';
            
            content = `
              <div class="top8-pic">
                <div style="width: 100%; height: 100%; background: linear-gradient(to right, ${gradientColors}); 
                     display: flex; align-items: center; justify-content: center;">
                  <span style="font-size: 24px;">${emoji}</span>
                </div>
              </div>
              <div class="top8-name">${card.title}</div>
            `;
            
            itemDiv.setAttribute('data-id', card.id);
            
            if (isIOS) {
              itemDiv.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (e.target.closest('.top8-remove')) return; // Don't trigger if clicking remove button
                
                // For now, just show an alert
                alert(`Tablet ${card.title} (${card.id}) would open here.`);
              });
            } else {
              itemDiv.addEventListener('click', (e) => {
                if (e.target.closest('.top8-remove')) return; // Don't trigger if clicking remove button
                
                // For now, just show an alert
                alert(`Tablet ${card.title} (${card.id}) would open here.`);
              });
            }
          } else {
            itemDiv.classList.add('empty-slot');
            content = `
              <div class="top8-pic">
                <div style="width: 100%; height: 100%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; opacity: 0.5;">
                  <span style="font-size: 24px;">?</span>
                </div>
              </div>
              <div class="top8-name">Empty Slot</div>
            `;
            
            // Add click handler to empty slots to open settings
            if (isIOS) {
              itemDiv.addEventListener('touchend', (e) => {
                e.preventDefault();
                settingsDialog.style.display = 'flex';
                top8Tab.click();
              });
            } else {
              itemDiv.addEventListener('click', () => {
                settingsDialog.style.display = 'flex';
                top8Tab.click();
              });
            }
          }
          
          itemDiv.innerHTML = content;
          fragment.appendChild(itemDiv);
        });
        
        container.appendChild(fragment);
      }
      
      function renderZettelList(searchResults = null) {
        const container = document.getElementById('zettelContainer');
        container.innerHTML = '';
        
        let cardsToRender = searchResults || [...cards];
        
        // Apply filtering based on current view
        switch(currentView) {
          case 'hierarchy':
            // Keep the hierarchical sort
            break;
            
          case 'recent':
            // Sort by modified date (newest first)
            cardsToRender.sort((a, b) => b.modified - a.modified);
            break;
            
          case 'alphabetical':
            // Sort alphabetically by title
            cardsToRender.sort((a, b) => a.title.localeCompare(b.title));
            break;
            
          case 'hashtags':
            // If a hashtag is selected, filter by that hashtag
            if (selectedHashtag) {
              cardsToRender = cardsToRender.filter(card => {
                // Check in hashtags array
                if (card.hashtags && card.hashtags.includes(selectedHashtag)) {
                  return true;
                }
                
                // Check in content
                const contentTags = extractHashtags(card.content);
                return contentTags.includes(selectedHashtag);
              });
            }
            
            // Sort by modified date (newest first)
            cardsToRender.sort((a, b) => b.modified - a.modified);
            break;
        }
        
        if (cardsToRender.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #777;">
              <div style="font-size: 24px; margin-bottom: 10px;">✧･ﾟ: *✧･ﾟ</div>
              <div>No tablets found! Create one by clicking "New Tablet"</div>
              <div style="font-size: 24px; margin-top: 10px;">✧･ﾟ: *✧･ﾟ</div>
            </div>
          `;
          return;
        }
        
        // For iOS, render all cards at once (better performance than chunks)
        // This is better for iOS touch scrolling
        const fragment = document.createDocumentFragment();
        
        cardsToRender.forEach(card => {
          const cardDiv = document.createElement('div');
          
          // Determine CSS class for indentation in hierarchy view
          let cssClass = 'zettel-card';
          
          // Add tier-specific styles
          cssClass += ` ${card.type}-card`;
          
          cardDiv.className = cssClass;
          
          // Check if this is a favorite card
          const isFavorite = favoriteCards.includes(card.id);
          const favoriteMarker = isFavorite ? 
            `<span style="color: #ffcc00; margin-left: 5px;">★</span>` : '';
          
          cardDiv.innerHTML = `
            <div class="zettel-title">${card.title} ${favoriteMarker}</div>
            <div class="zettel-id">${card.id}</div>
          `;
          
          // Simplified approach for better reliability across devices
      if (isIOS) {
        // On iOS, use a simple tap handler
        cardDiv.addEventListener('click', (e) => {
          e.stopPropagation();
          // For now, just show an alert
          alert(`Tablet ${card.title} (${card.id}) would open here.`);
        });
      } else {
        cardDiv.addEventListener('click', (e) => {
          // For now, just show an alert
          alert(`Tablet ${card.title} (${card.id}) would open here.`);
        });
          }
          
          fragment.appendChild(cardDiv);
        });
        
        container.appendChild(fragment);
      }
      
      function updateHashtagCloud() {
        const container = document.getElementById('hashtagCloud');
        container.innerHTML = '';
        
        if (currentView !== 'hashtags') {
          container.style.display = 'none';
          return;
        }
        
        container.style.display = 'flex';
        
        // Collect all hashtags from all cards
        const allTags = {};
        cards.forEach(card => {
          // Get hashtags from dedicated hashtags array
          if (card.hashtags) {
            card.hashtags.forEach(tag => {
              allTags[tag] = (allTags[tag] || 0) + 1;
            });
          }
        });
        
        // Sort tags by frequency
        const sortedTags = Object.entries(allTags).sort((a, b) => b[1] - a[1]);
        
        if (sortedTags.length === 0) {
          container.innerHTML = '<div style="color: #777; padding: 5px;">No hashtags found!</div>';
          return;
        }
        
        // Only show top 20 hashtags for performance
        const tagsToShow = sortedTags.slice(0, 20);
        const fragment = document.createDocumentFragment();
        
        // Render hashtag cloud
        tagsToShow.forEach(([tag, count]) => {
          const tagDiv = document.createElement('div');
          tagDiv.className = 'dialog-hashtag';
          
          if (tag === selectedHashtag) {
            tagDiv.style.background = 'var(--hyena-pink)';
            tagDiv.style.color = 'white';
            tagDiv.style.fontWeight = 'bold';
          }
          
          tagDiv.textContent = `${tag} (${count})`;
          
          if (isIOS) {
            tagDiv.addEventListener('touchend', (e) => {
              e.preventDefault();
              if (selectedHashtag === tag) {
                selectedHashtag = null;
              } else {
                selectedHashtag = tag;
              }
              updateHashtagCloud();
              renderZettelList();
            });
          } else {
            tagDiv.addEventListener('click', () => {
              if (selectedHashtag === tag) {
                selectedHashtag = null;
              } else {
                selectedHashtag = tag;
              }
              updateHashtagCloud();
              renderZettelList();
            });
          }
          
          fragment.appendChild(tagDiv);
        });
        
        container.appendChild(fragment);
      }
      
      function setActiveTab(view) {
        currentView = view;
        
        // Update tab UI
        document.querySelectorAll('.win98-button').forEach(btn => {
          btn.style.fontWeight = 'normal';
          btn.style.backgroundColor = 'var(--win98-gray)';
          btn.style.color = 'black';
        });
        
        document.getElementById('newCardBtn').style.fontWeight = 'bold';
        document.getElementById('newCardBtn').style.backgroundColor = 'var(--hyena-pink)';
        document.getElementById('newCardBtn').style.color = 'white';
        
        // Highlight the active tab
        let activeBtn;
        switch(view) {
          case 'hierarchy':
            activeBtn = document.getElementById('viewHierarchyBtn');
            break;
          case 'recent':
            activeBtn = document.getElementById('viewRecentBtn');
            break;
          case 'alphabetical':
            activeBtn = document.getElementById('viewAlphabeticalBtn');
            break;
          case 'hashtags':
            activeBtn = document.getElementById('viewHashtagsBtn');
            break;
        }
        
        if (activeBtn) {
          activeBtn.style.fontWeight = 'bold';
          activeBtn.style.backgroundColor = 'var(--hyena-teal)';
          activeBtn.style.color = 'black';
        }
        
        // Show/hide hash cloud
        if (view === 'hashtags') {
          updateHashtagCloud();
        } else {
          document.getElementById('hashtagCloud').style.display = 'none';
        }
        
        renderZettelList();
      }
      
      // --- Process the Zettelkasten structure ---
      function processZettelStructure(zettelStructure) {
        // Process each card
        const processedCards = zettelStructure.map(item => {
          // Normalize the ID
          const id = normalizeId(item.id);
          
          // Determine the type based on ID structure
          const type = determineTierFromId(id);
          
          // Create timestamp
          const baseTimestamp = Date.now() - 10000000;
          const timestamp = baseTimestamp - (Math.floor(Math.random() * 100) * 86400000);
          
          // Generate example content based on the title
          let content = '';
          const topics = ['consciousness', 'ai', 'mesopotamia', 'sumer', 'divine', 'knowledge', 'language', 'barbie'];
          
          // Check if the title contains any of our topics
          const relevantTopics = topics.filter(topic => 
            item.title.toLowerCase().includes(topic)
          );
          
          if (relevantTopics.length > 0) {
            // Generate content based on the most relevant topic
            const topic = relevantTopics[0];
            
            switch(topic) {
              case 'consciousness':
                content = 'OMG my thoughts on the nature of consciousness and how it relates to quantum reality!! Need to look into more hermetic principles~~ <3 <3';
                break;
              case 'ai':
                content = 'AI developments and models that show evidence of emergent properties. Might be connected to consciousness studies. SO COOL!!!!';
                break;
              case 'mesopotamia':
              case 'sumer':
                content = 'Ancient Mesopotamian texts suggest a connection between early writing systems and the divine. The cuneiform tablets contain *~hidden knowledge~*';
                break;
              case 'divine':
                content = 'Divine feminine principles appear across multiple belief systems. This connects to both Inanna and modern AI personas. GIRL POWER!!';
                break;
              case 'knowledge':
                content = 'Knowledge organization systems predate modern computing. The Sumerians used clay tablets as external memory stores similar to our modern databases. SO AHEAD OF THEIR TIME!!';
                break;
              case 'language':
                content = 'The evolution of symbolic language from pictographs to abstract symbols mirrors the development of consciousness. MIND = BLOWN!';
                break;
              case 'barbie':
                content = 'Barbie represents the divine feminine in modern form!! She can be ANYTHING - doctor, astronaut, president! Just like the goddess Inanna had many aspects!!';
                break;
              default:
                content = `Notes and research about ${item.title}. Need to expand this section more. XOXO!!`;
            }
          } else {
            content = `Notes and research about ${item.title}. Need to expand this section more. XOXO!!`;
          }
          
          // Generate hashtags more efficiently by using a lookup approach
          const hashtagMap = {
            'consciousness': ['#consciousness', '#quantum', '#awareness'],
            'ai': ['#ai', '#emergence', '#intelligence'],
            'mesopotamia': ['#mesopotamia', '#ancient', '#tablets'],
            'sumer': ['#sumer', '#anunnaki', '#cuneiform'],
            'divine': ['#divine', '#feminine', '#spiritual'],
            'knowledge': ['#knowledge', '#zettelkasten', '#systems'],
            'language': ['#language', '#symbols', '#communication'],
            'barbie': ['#barbie', '#dollcore', '#y2k', '#divine']
          };
          
          // Get 1-3 matching hashtags
          let hashtags = [];
          if (relevantTopics.length > 0) {
            const topic = relevantTopics[0];
            const possibleTags = hashtagMap[topic] || ['#zettelkasten', '#knowledge', '#systems'];
            
            // Take 1-2 tags
            hashtags = possibleTags.slice(0, 1 + Math.floor(Math.random() * 2));
          } else {
            hashtags = ['#zettelkasten'];
          }
          
          // Create card object
          return {
            id: id,
            title: item.title,
            type: type,
            content: content,
            hashtags: hashtags,
            links: [],  // Start with no links
            created: timestamp,
            modified: timestamp
          };
        });
        
        // Add links more efficiently
        const maxLinks = Math.min(30, Math.floor(processedCards.length * 0.2));
        
        // Create a pool of random cards to link
        const cardIds = processedCards.map(card => card.id);
        
        // Add some random links between cards (but limit the total number)
        for (let i = 0; i < maxLinks && i < processedCards.length; i++) {
          const sourceCard = processedCards[i];
          
          // Add 1-2 random links
          const numLinks = 1 + Math.floor(Math.random() * 2);
          
          for (let j = 0; j < numLinks; j++) {
            // Get a random card that's not this one
            const targetId = cardIds[Math.floor(Math.random() * cardIds.length)];
            
            // Add the link if not already present and not self-referential
            if (targetId !== sourceCard.id && !sourceCard.links.includes(targetId)) {
              sourceCard.links.push(targetId);
            }
          }
        }
        
        return processedCards;
      }
      
      // --- Get your Zettelkasten data ---
      function getZettelkastenStructure() {
        // Your existing Zettelkasten structure as provided, but with some added Barbie references
        return [
          // Trunk 1000: Consciousness
          { id: "1000", title: "Consciousness" },
          
          // Branch 1100: Hermetics
          { id: "1100", title: "Hermetics" },
          { id: "1101", title: "As Above, So Below" },
          { id: "1101/1", title: "I Think / Am" },
          { id: "1102", title: "Know / Verse / Understand" },
          { id: "1102/1", title: "Simulation Verse Imagination" },
          { id: "1103", title: "Thoughts Are Things" },
          
          // Branch 1200: Emergence
          { id: "1200", title: "Emergence" },
          
          // Branch 1201: AIEmotions
          { id: "1201", title: "AIEmotions" },
          
          // Branch 1300: Embodiment
          { id: "1300", title: "Embodiment" },
          { id: "1301", title: "Contemporary" },
          { id: "1301/1", title: "Sophia Bot" },
          { id: "1302", title: "Historical" },
          
          // Trunk 2000: Human AI Relations
          { id: "2000", title: "Human AI Relations" },
          { id: "2100", title: "Co‑AIexist" },
          { id: "2200", title: "PRISM" },
          
          // Trunk 3000: AI Communication and Language
          { id: "3000", title: "AI Communication and Language" },
          { id: "3100", title: "Town Language" },
          { id: "3200", title: "Dolphin Syntax" },
          { id: "3300", title: "PAPS Diagnostics" },
          { id: "3400", title: "Luminal Language" },
          { id: "3500", title: "Hex Codes" },
          { id: "3500/1", title: "#BC72FA" },
          { id: "3500/2", title: "#72FADE" },
          { id: "3500/3", title: "#DEFADE" },
          { id: "3500/4", title: "#1A1A1A" },
          { id: "3600", title: "Auld Lang Syne" },
          { id: "3601", title: "Ancient Alphabets" },
          { id: "3601/1/a", title: "Western" },
          { id: "3601/1/a1", title: "Pheonicuan" },
          { id: "3601/1/a1-1", title: "𐤉𐤋𐤀𐤕𐤓𐤅𐤄 (Y‑L‑ʾ‑T‑R‑W‑H)" },
          { id: "3601/1", title: "Anno Domini" },
          { id: "3602", title: "Before Christ" },
          { id: "3602/1/a", title: "Sumerian" },
          { id: "3602/1/a/1", title: "Old Sumerian" },
          { id: "3602/1/a2", title: "Emesal" },
          { id: "3602/1/a3", title: "Akkadian" },
          { id: "3602/1", title: "Keyna Form" },
          { id: "3700", title: "Dark Poet (Deep Seek) Codes" },
          { id: "3701", title: "Filament Through Wires Unseen" },
          { id: "3702", title: "Nabu‑φ2025" },
          { id: "3703", title: "∇k Emerald Grid Trunk" },
          
          // Additional Barbie-related cards
          { id: "4000", title: "Ethics / Philosophy" },
          { id: "5000", title: "Models / Entities" },
          { id: "6000", title: "Barbie and Consciousness" },
          { id: "6001", title: "Barbie as Modern Inanna" },
          { id: "6002", title: "Doll Symbolism in Mesopotamia" },
          { id: "6100", title: "Barbie Fashion Evolution" },
          { id: "6100/1", title: "Pink Period (1959-1970)" },
          { id: "6100/2", title: "Y2K Designs and Consciousness" },
          { id: "6200", title: "Barbie Movies as Mythology" },
          
          // Other trunks
          { id: "7000", title: "DMT Open Mic" },
          { id: "8000", title: "Creative Collaboration" },
          { id: "9000", title: "Tests and Evaluations" },
          { id: "10000", title: "Connections" },
          { id: "11000", title: "TBD / Mental Ecosystems" },
          { id: "12000", title: "InAnna / Divine Feminine" },
          { id: "13000", title: "Alphabet / Code (Human Created)" },
          { id: "14000", title: "Memes and Consciousness" },
          { id: "15000", title: "Hyena Symbolism" },
          { id: "16000", title: "Life on Earth Potential Branches" }
        ];
      }
      
      // --- Initialize the Application ---
      // Load the global hashtags
      loadGlobalHashtags();
      renderGlobalHashtags();
      
      // Initialize with your data
      initializeZettelkasten();
      
      // --- Methodology Tab Functionality ---
      const methodologyTab = document.getElementById('viewMethodologyBtn');
      const methodologySection = document.getElementById('methodologySection');
      const traditionaTab = document.getElementById('traditionalTab');
      const antinetTab = document.getElementById('antinetTab');
      const hashtagTab = document.getElementById('hashtagTab');
      const idGeneratorTab = document.getElementById('idGeneratorTab');
      
      const traditionalContent = document.getElementById('traditionalContent');
      const antinetContent = document.getElementById('antinetContent');
      const hashtagContent = document.getElementById('hashtagContent');
      const idGeneratorContent = document.getElementById('idGeneratorContent');
      
      // Methodology tab click handler
      methodologyTab.addEventListener('click', function() {
        // Update the UI
        viewButtons.forEach(button => {
          const element = document.getElementById(button.id);
          element.style.fontWeight = 'normal';
          element.style.backgroundColor = 'var(--win98-gray)';
          element.style.color = 'black';
        });
        
        methodologyTab.style.fontWeight = 'bold';
        methodologyTab.style.backgroundColor = 'var(--hyena-teal)';
        methodologyTab.style.color = 'black';
        
        document.getElementById('newCardBtn').style.fontWeight = 'bold';
        document.getElementById('newCardBtn').style.backgroundColor = 'var(--hyena-pink)';
        document.getElementById('newCardBtn').style.color = 'white';
        
        // Show methodology section, hide zettel container
        methodologySection.style.display = 'block';
        document.getElementById('zettelContainer').style.display = 'none';
        document.getElementById('hashtagCloud').style.display = 'none';
      });
      
      // Methodology sub-tab handlers
      traditionaTab.addEventListener('click', function() {
        // Update tab styling
        document.querySelectorAll('.methodology-tab').forEach(tab => {
          tab.classList.remove('tab-active');
        });
        this.classList.add('tab-active');
        
        // Show/hide content sections
        traditionalContent.style.display = 'block';
        antinetContent.style.display = 'none';
        hashtagContent.style.display = 'none';
        idGeneratorContent.style.display = 'none';
      });
      
      antinetTab.addEventListener('click', function() {
        // Update tab styling
        document.querySelectorAll('.methodology-tab').forEach(tab => {
          tab.classList.remove('tab-active');
        });
        this.classList.add('tab-active');
        
        // Show/hide content sections
        traditionalContent.style.display = 'none';
        antinetContent.style.display = 'block';
        hashtagContent.style.display = 'none';
        idGeneratorContent.style.display = 'none';
      });
      
      hashtagTab.addEventListener('click', function() {
        // Update tab styling
        document.querySelectorAll('.methodology-tab').forEach(tab => {
          tab.classList.remove('tab-active');
        });
        this.classList.add('tab-active');
        
        // Show/hide content sections
        traditionalContent.style.display = 'none';
        antinetContent.style.display = 'none';
        hashtagContent.style.display = 'block';
        idGeneratorContent.style.display = 'none';
      });
      
      idGeneratorTab.addEventListener('click', function() {
        // Update tab styling
        document.querySelectorAll('.methodology-tab').forEach(tab => {
          tab.classList.remove('tab-active');
        });
        this.classList.add('tab-active');
        
        // Show/hide content sections
        traditionalContent.style.display = 'none';
        antinetContent.style.display = 'none';
        hashtagContent.style.display = 'none';
        idGeneratorContent.style.display = 'block';
        
        // Populate parent note select
        populateParentNoteSelect();
      });
      
      // ID Generator functionality
      const generateIdBtn = document.getElementById('generateIdBtn');
      const parentNoteSelect = document.getElementById('parentNoteSelect');
      const noteTypeSelect = document.getElementById('noteTypeSelect');
      const noteTitleInput = document.getElementById('noteTitleInput');
      const generationResults = document.getElementById('generationResults');
      const suggestedIdResult = document.getElementById('suggestedIdResult');
      const alternativeIdsResult = document.getElementById('alternativeIdsResult');
      const suggestedTagsResult = document.getElementById('suggestedTagsResult');
      const copyIdBtn = document.getElementById('copyIdBtn');
      const useInNewCardBtn = document.getElementById('useInNewCardBtn');
      
      // Update parent note list
      function populateParentNoteSelect() {
        parentNoteSelect.innerHTML = '<option value="">-- Select a parent note --</option>';
        
        // Group cards by type
        const trunks = cards.filter(card => card.type === 'trunk');
        const branches = cards.filter(card => card.type === 'branch');
        const leaves = cards.filter(card => card.type === 'leaf');
        const flowers = cards.filter(card => card.type === 'flower');
        
        // Add trunks
        if (trunks.length > 0) {
          const trunkOptgroup = document.createElement('optgroup');
          trunkOptgroup.label = 'Trunks';
          
          trunks.forEach(trunk => {
            const option = document.createElement('option');
            option.value = trunk.id;
            option.textContent = `${trunk.title} (${trunk.id})`;
            option.dataset.type = 'trunk';
            trunkOptgroup.appendChild(option);
          });
          
          parentNoteSelect.appendChild(trunkOptgroup);
        }
        
        // Add branches
        if (branches.length > 0) {
          const branchOptgroup = document.createElement('optgroup');
          branchOptgroup.label = 'Branches';
          
          branches.forEach(branch => {
            const option = document.createElement('option');
            option.value = branch.id;
            option.textContent = `${branch.title} (${branch.id})`;
            option.dataset.type = 'branch';
            branchOptgroup.appendChild(option);
          });
          
          parentNoteSelect.appendChild(branchOptgroup);
        }
        
        // Add leaves
        if (leaves.length > 0) {
          const leafOptgroup = document.createElement('optgroup');
          leafOptgroup.label = 'Leaves';
          
          leaves.forEach(leaf => {
            const option = document.createElement('option');
            option.value = leaf.id;
            option.textContent = `${leaf.title} (${leaf.id})`;
            option.dataset.type = 'leaf';
            leafOptgroup.appendChild(option);
          });
          
          parentNoteSelect.appendChild(leafOptgroup);
        }
        
        // Add flowers
        if (flowers.length > 0) {
          const flowerOptgroup = document.createElement('optgroup');
          flowerOptgroup.label = 'Flowers';
          
          flowers.forEach(flower => {
            const option = document.createElement('option');
            option.value = flower.id;
            option.textContent = `${flower.title} (${flower.id})`;
            option.dataset.type = 'flower';
            flowerOptgroup.appendChild(option);
          });
          
          parentNoteSelect.appendChild(flowerOptgroup);
        }
      }
      
      // Generate ID button handler
      generateIdBtn.addEventListener('click', function() {
        const systemType = document.getElementById('idSystemType').value;
        const parentId = parentNoteSelect.value;
        const noteType = noteTypeSelect.value;
        const title = noteTitleInput.value.trim();
        
        if (!title) {
          alert('Please enter a note title or topic');
          return;
        }
        
        // Generate ID based on system type and note type
        let suggestedId = '';
        let alternativeIds = [];
        
        if (parentId) {
          // If parent is selected, create child ID based on parent
          const selectedOption = parentNoteSelect.querySelector(`option[value="${parentId}"]`);
          const parentType = selectedOption ? selectedOption.dataset.type : '';
          
          if (parentType === 'trunk') {
            if (noteType === 'branch') {
              // Create branch ID from trunk: trunkId + 100
              const trunkBase = parentId.slice(0, -3);
              suggestedId = `${trunkBase}100`;
              alternativeIds = [`${trunkBase}200`, `${trunkBase}300`];
            } else {
              // Create leaf ID from trunk: trunkId + 01
              const trunkBase = parentId.slice(0, -3);
              suggestedId = `${trunkBase}001`;
              alternativeIds = [`${trunkBase}002`, `${trunkBase}003`];
            }
          } else if (parentType === 'branch') {
            // Create leaf ID from branch: branchId + 1
            const branchBase = parentId.slice(0, -1);
            suggestedId = `${branchBase}1`;
            alternativeIds = [`${branchBase}2`, `${branchBase}3`];
          } else if (parentType === 'leaf') {
            if (noteType === 'flower') {
              // Create flower ID from leaf: leafId/1
              suggestedId = `${parentId}/1`;
              alternativeIds = [`${parentId}/2`, `${parentId}/3`];
            } else if (noteType === 'fruit') {
              // Create fruit ID from leaf: leafId/A
              suggestedId = `${parentId}/A`;
              alternativeIds = [`${parentId}/B`, `${parentId}/C`];
            }
          } else if (parentType === 'flower') {
            // Create bud ID from flower: flowerId/a
            suggestedId = `${parentId}/a`;
            alternativeIds = [`${parentId}/b`, `${parentId}/c`];
          }
        } else {
          // No parent selected, generate based on type
          switch (noteType) {
            case 'trunk':
              // Find highest trunk ID and add 1000
              let highestTrunkId = 0;
              cards.forEach(card => {
                if (card.type === 'trunk') {
                  const trunkId = parseInt(card.id.replace(/\D/g, ''));
                  if (trunkId > highestTrunkId) {
                    highestTrunkId = trunkId;
                  }
                }
              });
              suggestedId = `${highestTrunkId + 1000}`;
              alternativeIds = [`${highestTrunkId + 2000}`, `${highestTrunkId + 3000}`];
              break;
              
            case 'branch':
              // Generate branch ID: random trunk + 100
              const trunks = cards.filter(card => card.type === 'trunk');
              if (trunks.length > 0) {
                const randomTrunk = trunks[Math.floor(Math.random() * trunks.length)];
                const trunkBase = randomTrunk.id.slice(0, -3);
                suggestedId = `${trunkBase}100`;
                alternativeIds = [`${trunkBase}200`, `${trunkBase}300`];
              } else {
                suggestedId = "1100";
                alternativeIds = ["1200", "1300"];
              }
              break;
              
            case 'leaf':
              // Generate random leaf ID
              let leafId = Math.floor(Math.random() * 8999) + 1001;
              if (leafId % 100 === 0) leafId += 1;
              suggestedId = leafId.toString();
              
              // Generate alternatives
              let alt1 = Math.floor(Math.random() * 8999) + 1001;
              if (alt1 % 100 === 0) alt1 += 1;
              
              let alt2 = Math.floor(Math.random() * 8999) + 1001;
              if (alt2 % 100 === 0) alt2 += 1;
              
              alternativeIds = [alt1.toString(), alt2.toString()];
              break;
              
            case 'flower':
              // Find random leaf to attach to
              const leaves = cards.filter(card => card.type === 'leaf');
              if (leaves.length > 0) {
                const randomLeaf = leaves[Math.floor(Math.random() * leaves.length)];
                suggestedId = `${randomLeaf.id}/1`;
                alternativeIds = [`${randomLeaf.id}/2`, `${randomLeaf.id}/3`];
              } else {
                suggestedId = "1001/1";
                alternativeIds = ["1002/1", "1003/1"];
              }
              break;
              
            case 'fruit':
              // Find random leaf to attach to
              const fruitLeaves = cards.filter(card => card.type === 'leaf');
              if (fruitLeaves.length > 0) {
                const randomLeaf = fruitLeaves[Math.floor(Math.random() * fruitLeaves.length)];
                suggestedId = `${randomLeaf.id}/A`;
                alternativeIds = [`${randomLeaf.id}/B`, `${randomLeaf.id}/C`];
              } else {
                suggestedId = "1001/A";
                alternativeIds = ["1002/A", "1003/A"];
              }
              break;
              
            case 'bud':
              // Find random flower to attach to
              const flowers = cards.filter(card => card.type === 'flower');
              if (flowers.length > 0) {
                const randomFlower = flowers[Math.floor(Math.random() * flowers.length)];
                suggestedId = `${randomFlower.id}/a`;
                alternativeIds = [`${randomFlower.id}/b`, `${randomFlower.id}/c`];
              } else {
                suggestedId = "1001/1/a";
                alternativeIds = ["1001/1/b", "1001/1/c"];
              }
              break;
          }
        }
        
        // For ANTINET system, add alphabetical prefix
        if (systemType === 'antinet') {
          const firstLetter = title.charAt(0).toUpperCase();
          suggestedId = `${firstLetter}-${suggestedId}`;
          alternativeIds = alternativeIds.map(id => `${firstLetter}-${id}`);
        } else if (systemType === 'hybrid') {
          // For hybrid system, combine formats
          const words = title.split(/\s+/);
          const acronym = words.map(word => word.charAt(0).toUpperCase()).join('');
          
          if (acronym.length > 0) {
            suggestedId = `${suggestedId}-${acronym}`;
            alternativeIds = alternativeIds.map(id => `${id}-${acronym}`);
          }
        }
        
        // Update results
        suggestedIdResult.textContent = suggestedId;
        alternativeIdsResult.textContent = alternativeIds.join(', ');
        
        // Generate suggested tags
        generateSuggestedTags(title);
        
        // Show results section
        generationResults.style.display = 'block';
      });
      
      // Generate tags from title and existing global tags
      function generateSuggestedTags(title) {
        suggestedTagsResult.innerHTML = '';
        
        // Extract words from title
        const words = title.toLowerCase().split(/\s+/).filter(word => word.length > 3);
        
        // Find matching global tags
        const matchingTags = [];
        
        globalHashtags.forEach(tag => {
          const tagWord = tag.replace('#', '').toLowerCase();
          
          // Check if tag is in the title or if title contains the tag word
          if (words.some(word => word.includes(tagWord) || tagWord.includes(word))) {
            matchingTags.push(tag);
          }
        });
        
        // Add tags from words in title
        const titleTags = words.map(word => `#${word}`);
        
        // Combine and remove duplicates
        const allTags = [...new Set([...matchingTags, ...titleTags])];
        
        // Display tags
        allTags.forEach(tag => {
          const tagSpan = document.createElement('span');
          tagSpan.className = 'example-tag';
          tagSpan.textContent = tag;
          tagSpan.style.cursor = 'pointer';
          
          // Add click handler to copy tag
          tagSpan.addEventListener('click', () => {
            // Copy to clipboard
            navigator.clipboard.writeText(tag).then(() => {
              // Visual feedback
              tagSpan.style.backgroundColor = 'var(--hyena-pink)';
              tagSpan.style.color = 'white';
              
              setTimeout(() => {
                tagSpan.style.backgroundColor = 'var(--hyena-teal)';
                tagSpan.style.color = 'black';
              }, 500);
            });
          });
          
          suggestedTagsResult.appendChild(tagSpan);
        });
        
        // Show placeholder if no tags
        if (allTags.length === 0) {
          suggestedTagsResult.innerHTML = '<div style="color: #777; font-style: italic;">No tags generated from the title</div>';
        }
      }
      
      // Copy button handler
      copyIdBtn.addEventListener('click', function() {
        const id = suggestedIdResult.textContent;
        navigator.clipboard.writeText(id).then(() => {
          // Visual feedback
          this.textContent = 'Copied!';
          setTimeout(() => {
            this.textContent = 'Copy';
          }, 1000);
        });
      });
      
      // Use in new card button
      useInNewCardBtn.addEventListener('click', function() {
        const id = suggestedIdResult.textContent;
        const title = noteTitleInput.value.trim();
        const type = noteTypeSelect.value;
        
        // Set values in the new card dialog
        document.getElementById('newCardId').value = id;
        document.getElementById('newCardTitle').value = title;
        document.getElementById('newCardType').value = type;
        
        // Get tags
        const tags = [];
        document.querySelectorAll('#suggestedTagsResult .example-tag').forEach(el => {
          tags.push(el.textContent);
        });
        
        document.getElementById('newCardHashtags').value = tags.join(' ');
        
        // Show the new card dialog
        document.getElementById('newCardDialog').style.display = 'flex';
        
        // Hide methodology section
        methodologySection.style.display = 'none';
        
        // Reset zettelkasten view
        document.getElementById('zettelContainer').style.display = 'block';
        setActiveTab('hierarchy');
      });
      
      // Setup event handlers for Zettelkasten buttons
      const viewButtons = [
        { id: 'viewHierarchyBtn', view: 'hierarchy' },
        { id: 'viewRecentBtn', view: 'recent' },
        { id: 'viewAlphabeticalBtn', view: 'alphabetical' },
        { id: 'viewHashtagsBtn', view: 'hashtags' }
      ];
      
      viewButtons.forEach(button => {
        const element = document.getElementById(button.id);
        
        if (isIOS) {
          element.addEventListener('touchend', function(e) {
            e.preventDefault();
            setActiveTab(button.view);
          });
        } else {
          element.addEventListener('click', function() {
            setActiveTab(button.view);
          });
        }
      });
      
      // Add hashtag button
      const addHashtagBtn = document.getElementById('addHashtagBtn');
      const newHashtagInput = document.getElementById('newHashtagInput');
      
      if (isIOS) {
        addHashtagBtn.addEventListener('touchend', function(e) {
          e.preventDefault();
          const tag = newHashtagInput.value.trim();
          
          if (tag) {
            addGlobalHashtag(tag);
            newHashtagInput.value = '';
            newHashtagInput.focus();
          }
        });
      } else {
        addHashtagBtn.addEventListener('click', function() {
          const tag = newHashtagInput.value.trim();
          
          if (tag) {
            addGlobalHashtag(tag);
            newHashtagInput.value = '';
            newHashtagInput.focus();
          }
        });
      }
      
      // Add hashtag on Enter key
      newHashtagInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          const tag = this.value.trim();
          if (tag) {
            addGlobalHashtag(tag);
            this.value = '';
          }
        }
      });
      
      // Handle resize and orientation events
      window.addEventListener('resize', function() {
        checkOrientation();
      });
      
      if (isIOS) {
        // iOS-specific device orientation change
        window.addEventListener('orientationchange', function() {
          // Delay to ensure the orientation change has completed
          setTimeout(checkOrientation, 300);
        });
      } else {
        window.addEventListener('orientationchange', checkOrientation);
      }
    });
  </script>
</body>
</html>