<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ú® COAIEXIST Studio - Page Builder</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Inter:wght@400;700;900&family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sass.js/0.11.1/sass.sync.min.js"></script>
    <script type="importmap">
    {
        "imports": {
            "@google/genai": "https://esm.run/@google/genai"
        }
    }
    </script>
    <style>
        /* ============================================
           COAIEXIST STUDIO - MCBLING / FRUTIGER AERO REFRESH
           ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            scrollbar-width: thin;
            scrollbar-color: var(--magenta) var(--bg-dark);
        }

        :root {
            /* PALETTE */
            --magenta: #ff00cc;
            --cyan: #00f0ff;
            --lime: #ccff00;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.25);
            
            /* UI COLORS */
            --bg-dark: #0a0a12;
            --panel-bg: rgba(20, 20, 35, 0.65);
            --text-main: #ffffff;
            --text-dim: #8fa1b3;
            
            --spacing: 10px;
            --radius: 12px;
        }

        /* LIGHT MODE OVERRIDES */
        body.light-mode {
            --bg-dark: #e0e5ec;
            --panel-bg: rgba(255, 255, 255, 0.85);
            --text-main: #2d3436;
            --text-dim: #636e72;
            --glass-bg: rgba(255, 255, 255, 0.4);
            --glass-border: rgba(160, 160, 160, 0.3);
        }
        body.light-mode::after {
            background: linear-gradient(rgba(255, 255, 255, 0) 50%, rgba(0, 0, 0, 0.05) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
        }
        body.light-mode .canvas-area {
            background: #d1d8e0;
            background-image: 
                linear-gradient(rgba(255,255,255,0.4) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.4) 1px, transparent 1px);
        }
        body.light-mode .modal-content, body.light-mode .modal-box {
            background: #f5f6fa;
            color: #2d3436;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
        }
        body.light-mode .modal-title, body.light-mode .modal-header h2 { color: #2d3436; }
        body.light-mode .modal-close { color: #2d3436; }
        body.light-mode input, body.light-mode select, body.light-mode textarea {
            background: #ffffff; color: #2d3436; border-color: #b2bec3;
        }
        body.light-mode .tool-item { color: #2d3436; }
        body.light-mode .tool-label { color: #2d3436; }
        body.light-mode .prop-group summary { color: #2d3436; background: rgba(0,0,0,0.05); }
        body.light-mode .logo { text-shadow: 0 0 10px var(--magenta); }
        body.light-mode .btn { color: #2d3436; border-color: rgba(0,0,0,0.2); background: rgba(255,255,255,0.5); }
        body.light-mode .btn:hover { background: #fff; }
        
        /* Light Mode Specific Bar Fixes */
        body.light-mode .viewport-controls {
            background: rgba(255, 255, 255, 0.6);
            border-color: rgba(0,0,0,0.05);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        body.light-mode .rtf-toolbar {
            background: rgba(255, 255, 255, 0.95);
            border-color: #b2bec3;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        body.light-mode .rtf-btn { color: #2d3436; }
        body.light-mode .rtf-btn:hover { background: rgba(0,0,0,0.05); color: var(--magenta); }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-main);
            overflow: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 0, 204, 0.15) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(0, 240, 255, 0.15) 0%, transparent 20%);
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Scanlines */
        body::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        /* ============================================
           LAYOUT
           ============================================ */
        .editor-wrapper {
            display: grid;
            grid-template-columns: 260px 1fr 320px;
            grid-template-rows: 64px 1fr 36px;
            grid-template-areas:
                "toolbar toolbar toolbar"
                "toolbox canvas sidebar"
                "statusbar statusbar statusbar";
            height: 100vh;
            gap: 0;
            transition: all 0.3s ease;
        }

        /* Preview / Flow Mode Styles */
        body.preview-mode .editor-wrapper {
            grid-template-columns: 1fr;
            grid-template-rows: 1fr;
            grid-template-areas: "canvas";
        }
        
        body.preview-mode .toolbar,
        body.preview-mode .toolbox,
        body.preview-mode .sidebar,
        body.preview-mode .statusbar,
        body.preview-mode .viewport-controls,
        body.preview-mode .page-tabs-bar { /* Hide tabs in preview */
            display: none !important;
        }

        body.preview-mode .canvas-area {
            padding: 0;
            background: #000;
        }
        
        body.preview-mode #canvas-frame {
            width: 100% !important;
            height: 100% !important;
            min-height: 0 !important;
            border-radius: 0;
            box-shadow: none;
        }

        #exit-preview-btn {
            display: none;
            position: fixed;
            bottom: 20px; right: 20px;
            z-index: 9999;
            box-shadow: 0 0 20px var(--magenta);
        }
        
        body.preview-mode #exit-preview-btn { display: block; }

        /* Responsive Layout */
        @media (max-width: 900px) {
            .editor-wrapper {
                grid-template-columns: 1fr;
                grid-template-rows: 60px 1fr 100px 30px; /* Toolbar, Canvas, Toolbox, Status */
                grid-template-areas:
                    "toolbar"
                    "canvas"
                    "toolbox"
                    "statusbar";
            }
            
            .sidebar {
                display: none; /* Hide sidebar on mobile by default */
                position: fixed;
                top: 60px; bottom: 0; right: 0; width: 85%; max-width: 300px;
                z-index: 100;
                border-left: 1px solid var(--magenta);
                box-shadow: -5px 0 20px rgba(0,0,0,0.5);
            }
            .sidebar.active { display: flex; }
            
            .toolbox {
                flex-direction: row;
                overflow-x: auto;
                border-right: none;
                border-top: 1px solid var(--glass-border);
                padding: 10px;
                white-space: nowrap;
            }
            .tool-category { display: none; } /* Hide headers to save space */
            .tool-grid { 
                display: flex; 
                gap: 10px; 
                margin-right: 20px;
            }
            .tool-item { 
                min-width: 70px; 
                display: inline-flex;
            }
        }

        /* ============================================
           TOOLBAR (TOP)
           ============================================ */
        .toolbar {
            grid-area: toolbar;
            background: var(--panel-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 12px;
            z-index: 10;
            box-shadow: 0 4px 30px rgba(0,0,0,0.3);
            overflow-x: auto; /* Allow scrolling for buttons on mobile */
        }

        .logo {
            font-family: 'VT323', monospace;
            font-size: 32px;
            color: var(--magenta);
            text-shadow: 0 0 10px var(--magenta), 2px 2px 0px var(--cyan);
            margin-right: 20px;
            letter-spacing: 2px;
            white-space: nowrap;
        }

        /* Glossy Buttons */
        .btn, .big-button {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 8px 16px;
            color: var(--text-main);
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            white-space: nowrap;
        }
        
        .btn:hover, .big-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2), 0 0 15px rgba(255,255,255,0.1);
            border-color: var(--text-main);
        }
        
        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            background: rgba(0,0,0,0.2);
        }
        
        .btn.active {
             background: var(--magenta);
             color: white;
             box-shadow: inset 0 2px 5px rgba(0,0,0,0.5), 0 0 15px var(--magenta);
             border-color: white;
        }

        .btn-pink { border-color: var(--magenta); color: var(--magenta); }
        .btn-pink:hover { background: var(--magenta); color: white; box-shadow: 0 0 20px var(--magenta); }

        .btn-cyan { border-color: var(--cyan); color: var(--cyan); }
        .btn-cyan:hover { background: var(--cyan); color: black; box-shadow: 0 0 20px var(--cyan); }
        
        .btn-purple { border-color: #bf5fff; color: #bf5fff; }
        .btn-purple:hover { background: #bf5fff; color: white; box-shadow: 0 0 20px #bf5fff; }

        .btn-orange { border-color: #ff9900; color: #ff9900; }
        .btn-orange:hover { background: #ff9900; color: black; box-shadow: 0 0 20px #ff9900; }

        /* ============================================
           TOOLBOX (LEFT)
           ============================================ */
        .toolbox {
            grid-area: toolbox;
            background: var(--panel-bg);
            border-right: 1px solid var(--glass-border);
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            backdrop-filter: blur(10px);
        }

        .tool-category {
            color: var(--text-dim);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            font-weight: 900;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .tool-item {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 12px 5px;
            text-align: center;
            cursor: grab;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: var(--text-main);
        }
        
        .tool-item:hover {
            background: rgba(255,255,255,0.1);
            border-color: var(--cyan);
            box-shadow: 0 0 10px rgba(0, 240, 255, 0.2);
            cursor: pointer;
        }

        .tool-icon { font-size: 20px; margin-bottom: 2px; }
        .tool-label { font-size: 11px; }

        /* ============================================
           CANVAS (CENTER)
           ============================================ */
        .canvas-area {
            grid-area: canvas;
            background: #121218;
            position: relative;
            padding: 10px 40px 40px 40px; /* Reduced top padding for tabs */
            overflow: hidden; /* Changed from auto to hidden to manage scrolling in container */
            background-image: 
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 20px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: background 0.3s;
        }
        
        /* PAGE TABS BAR */
        .page-tabs-bar {
            width: 100%;
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            overflow-x: auto;
            padding-bottom: 2px;
            border-bottom: 1px solid var(--glass-border);
            min-height: 36px;
        }

        .page-tab {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            padding: 6px 12px;
            color: var(--text-dim);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            transition: 0.2s;
            min-width: 100px;
            justify-content: space-between;
        }

        .page-tab:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-main);
        }

        .page-tab.active {
            background: rgba(255, 0, 204, 0.1);
            border-color: var(--magenta);
            color: var(--text-main);
            box-shadow: 0 -2px 10px rgba(255, 0, 204, 0.2);
        }
        
        .page-tab-add {
            background: transparent;
            border: 1px dashed var(--glass-border);
            color: var(--cyan);
            font-size: 16px;
            padding: 0 10px;
            cursor: pointer;
            border-radius: 6px;
            transition: 0.2s;
            line-height: 30px;
        }
        .page-tab-add:hover {
            border-color: var(--cyan);
            background: rgba(0, 240, 255, 0.1);
        }
        
        /* VIEWPORT CONTROLS */
        .viewport-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            background: rgba(0,0,0,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(5px);
        }
        
        .vp-btn {
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
            border-radius: 5px;
            transition: 0.2s;
        }
        
        .vp-btn:hover, .vp-btn.active {
            color: var(--cyan);
            background: rgba(255,255,255,0.1);
        }
        
        @media (max-width: 600px) {
            .canvas-area { padding: 10px; }
            .viewport-controls { display: none; } /* Hide resizing on mobile since it's already mobile */
        }

        #canvas-container {
            flex: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            overflow: auto;
            padding-bottom: 40px;
        }

        #canvas-frame {
            width: 100%;
            height: 100%;
            min-height: 800px;
            background: white;
            border: none;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            transition: width 0.3s, height 0.3s;
        }

        #grid-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            display: none;
            background-image: linear-gradient(0deg, transparent 24%, rgba(0, 255, 204, .3) 25%, rgba(0, 255, 204, .3) 26%, transparent 27%, transparent 74%, rgba(0, 255, 204, .3) 75%, rgba(0, 255, 204, .3) 76%, transparent 77%, transparent), linear-gradient(90deg, transparent 24%, rgba(0, 255, 204, .3) 25%, rgba(0, 255, 204, .3) 26%, transparent 27%, transparent 74%, rgba(0, 255, 204, .3) 75%, rgba(0, 255, 204, .3) 76%, transparent 77%, transparent);
            background-size: 50px 50px;
        }

        /* RTF Toolbar - Now embedded in sidebar, styles updated for sidebar context */
        .rtf-group {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
        }

        .rtf-btn {
            background: transparent; border: 1px solid var(--glass-border); color: var(--text-main);
            padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 14px;
            transition: 0.2s;
            flex: 1;
            min-width: 30px;
            display: flex; align-items: center; justify-content: center;
        }
        .rtf-btn:hover { background: rgba(255,255,255,0.1); color: var(--cyan); }
        .rtf-btn.active { background: var(--magenta); color: white; border-color: var(--magenta); }
        .rtf-separator { width: 1px; background: var(--glass-border); margin: 0 2px; height: 20px; align-self: center; }


        /* ============================================
           INSPECTOR (RIGHT) - FRUTIGER AERO / MCBLING
           ============================================ */
        .sidebar {
            grid-area: sidebar;
            background: var(--panel-bg);
            border-left: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            display: flex;
            border-bottom: 1px solid var(--glass-border);
        }

        .tab-btn {
            flex: 1;
            background: transparent;
            border: none;
            padding: 10px 5px;
            color: var(--text-dim);
            font-weight: bold;
            cursor: pointer;
            font-size: 11px;
            text-transform: uppercase;
            transition: 0.2s;
            border-bottom: 2px solid transparent;
        }
        
        .tab-btn.active {
            color: var(--cyan);
            border-bottom: 2px solid var(--cyan);
            background: linear-gradient(to bottom, transparent, rgba(0, 240, 255, 0.05));
            text-shadow: 0 0 8px rgba(0, 240, 255, 0.5);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        /* Accordion Group */
        .prop-group {
            margin-bottom: 10px;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            background: var(--glass-bg);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .prop-group[open] {
            border-color: var(--glass-border);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .prop-group summary {
            padding: 10px 12px;
            cursor: pointer;
            list-style: none;
            font-weight: 700;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.2);
        }
        
        .prop-group[open] summary {
            color: var(--magenta);
            text-shadow: 0 0 5px rgba(255, 0, 204, 0.3);
            border-bottom: 1px solid var(--glass-border);
        }

        .prop-group summary::-webkit-details-marker { display: none; }
        .prop-group summary::after { content: '+'; font-size: 14px; }
        .prop-group[open] summary::after { content: '-'; }

        .prop-body {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Controls */
        .control-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        /* New Layout Grids for Sidebar */
        .control-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .control-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; }

        .label-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .prop-label {
            font-size: 10px;
            font-weight: 700;
            color: var(--cyan);
            text-transform: uppercase;
        }
        
        .prop-unit {
             font-size: 9px; 
             color: var(--text-dim); 
             margin-left: 5px;
        }

        .prop-val-display {
            font-size: 10px;
            color: var(--text-dim);
            font-family: monospace;
        }

        /* Pill Inputs - McBling Style */
        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            border-radius: 4px;
            padding: 4px 8px;
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            font-size: 11px;
            outline: none;
            transition: 0.2s;
        }

        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            border-color: var(--magenta);
            box-shadow: 0 0 10px rgba(255, 0, 204, 0.3), inset 0 2px 4px rgba(0,0,0,0.1);
            background: var(--glass-bg);
        }
        
        textarea.code-editor {
            font-family: 'VT323', monospace;
            font-size: 14px;
            background: #1a1a24;
            color: #00ffcc;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
        }

        /* Sliders */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            margin: 5px 0;
        }
        
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: var(--magenta);
            cursor: pointer;
            margin-top: -4px;
            box-shadow: 0 0 8px var(--magenta);
            border: 2px solid white;
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }

        /* Color Picker */
        .color-wrap {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--glass-bg);
            padding: 4px 8px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
        }
        input[type="color"] {
            -webkit-appearance: none;
            width: 20px; height: 20px;
            border: none; padding: 0;
            background: none;
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 1px solid white; border-radius: 50%; }

        /* Action Bar */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 1px solid var(--glass-border);
        }
        .act-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid transparent;
            color: var(--text-main);
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            font-size: 14px;
            text-align: center;
        }
        .act-btn:hover { background: rgba(255,255,255,0.15); transform: translateY(-2px); }
        .act-btn.del:hover { background: #ff3860; box-shadow: 0 0 10px #ff3860; }
        
        /* LAB UI ELEMENTS */
        .experiment-box {
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
        }
        .experiment-box h4 {
            color: var(--lime);
            margin-bottom: 10px;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
        }
        .preview-box {
            width: 80px; height: 80px;
            background: linear-gradient(45deg, var(--magenta), var(--cyan));
            margin: 15px auto;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
        }
        
        /* STYLE MATRIX (CSS LAB) */
        .css-library-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .css-tabs {
            display: flex;
            gap: 5px;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 10px;
            overflow-x: auto;
        }
        .css-tab-btn {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-dim);
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            border-radius: 4px;
            white-space: nowrap;
        }
        .css-tab-btn.active {
            background: rgba(255,255,255,0.1);
            color: var(--cyan);
            border-color: var(--glass-border);
        }
        .style-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .style-card {
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            padding: 10px;
            cursor: pointer;
            font-size: 11px;
            text-align: center;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            gap: 4px;
            color: var(--text-main);
        }
        .style-card:hover {
            border-color: var(--magenta);
            background: rgba(255,0,204,0.1);
        }
        .style-preview-mini {
            height: 30px;
            border-radius: 4px;
            margin-bottom: 4px;
            background: #333;
        }


        /* ============================================
           MODALS - FIXED FOR MOBILE RESPONSIVENESS
           ============================================ */
        .modal {
            display: none;
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            padding: 10px; /* Padding to prevent touching edges */
        }
        .modal.active { display: flex; }

        .modal-content, .modal-box {
            background: #1a1a24;
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            width: 100%; /* Full width of container */
            max-width: 800px; /* Max desktop width */
            height: auto;
            max-height: 90vh; /* Ensure it fits vertically */
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px rgba(0,0,0,0.6);
            overflow: hidden;
        }

        .modal-header {
            padding: 15px 20px;
            background: linear-gradient(90deg, rgba(255,255,255,0.05), transparent);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .modal-title, .modal-header h2 {
            font-family: 'Inter', sans-serif;
            font-weight: 900;
            font-size: 18px;
            color: white;
            text-transform: uppercase;
            margin: 0;
        }
        
        .modal-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto; /* Critical for small screens */
            flex: 1;
        }

        /* Asset/GitHub Browser Styles */
        .asset-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 10px;
            flex-wrap: wrap;
        }
        .asset-tab {
            background: transparent;
            border: none;
            color: var(--text-dim);
            font-weight: bold;
            cursor: pointer;
            padding: 5px 10px;
        }
        .asset-tab.active { color: var(--cyan); text-shadow: 0 0 10px var(--cyan); }

        .gh-inputs { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .gh-inputs input { flex: 1; min-width: 120px; }
        .gh-path { font-family: monospace; color: var(--magenta); margin-bottom: 15px; font-size: 12px; word-break: break-all; }
        .gh-crumb { cursor: pointer; text-decoration: underline; }
        
        .asset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
        }
        .asset-card {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; gap: 5px;
        }
        .asset-card:hover { background: rgba(255,255,255,0.1); border-color: var(--cyan); }
        .asset-thumb { width: 100%; height: 60px; object-fit: contain; border-radius: 4px; margin-bottom: 5px; }
        .asset-name { font-size: 10px; word-break: break-all; color: var(--text-dim); }
        
        /* Template Grid */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        /* Mobile Grid fix */
        @media(max-width: 600px) {
            .template-grid {
                grid-template-columns: 1fr; /* 1 col on small screens */
            }
            .modal-body {
                display: block !important; /* Fix for CSS modal grid */
                padding: 15px !important;
            }
            .css-library-panel {
                border-left: none !important;
                border-top: 1px solid var(--glass-border);
                padding-left: 0 !important;
                padding-top: 15px;
                margin-top: 15px;
            }
        }

        /* Status Bar */
        .statusbar {
            grid-area: statusbar;
            background: var(--bg-dark);
            border-top: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            font-size: 11px;
            color: var(--text-dim);
            font-family: monospace;
        }
        
        /* Context Menu */
        #context-menu {
            position: absolute;
            display: none;
            background: rgba(10, 10, 20, 0.95);
            border: 1px solid var(--cyan);
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.3);
            z-index: 10000;
            padding: 5px 0;
            backdrop-filter: blur(5px);
            min-width: 150px;
        }
        
        .ctx-item {
            padding: 8px 15px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            gap: 10px;
        }
        
        .ctx-item:hover {
            background: rgba(0, 240, 255, 0.2);
            color: var(--cyan);
        }

        /* Dragging Style for Layers */
        .layer-item {
            transition: all 0.1s ease;
        }
        .layer-item.dragging {
            opacity: 0.5;
            background: rgba(255,255,255,0.1);
            border: 1px dashed var(--cyan);
        }
        .layer-item.drag-over {
            border-bottom: 2px solid var(--magenta);
        }
    </style>
    
    <!-- Logic Scripts -->
    <script>
        window.PAGE_SOURCE_HTML = window.PAGE_SOURCE_HTML || {};
        window.elementTemplates = window.elementTemplates || {};
        
        // Global Helper stub for external scripts
        window.openModal = (id) => {
             const m = document.getElementById(id);
             if(m) { 
                 m.classList.add('active'); 
                 if(window.playSound) window.playSound('pop'); 
             }
        };
        window.closeModal = (id) => document.getElementById(id)?.classList.remove('active');
        window.updateStatus = (msg) => { 
            const el = document.getElementById('status-msg'); 
            if(el) el.innerText = msg; 
        };
        // Sound and stamp placeholders to be overwritten by module
        window.playSound = () => {};
        window.showStamp = () => {};
        window.saveState = () => {}; // Will be overwritten
        window.draggedLayer = null;
        window.clipboardEl = null; // for copy/paste
    </script>
    <script src="page-sources-embedded.js"></script>
    <script src="wysiwyg-enhancements.js"></script>
    <script src="neocities-deploy-pro.js"></script>
    <script src="page-loader-and-components.js"></script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <!-- EXIT PREVIEW BUTTON (FIXED POS) -->
    <button id="exit-preview-btn" class="big-button btn-pink" onclick="togglePreview()">‚ùå Exit Preview</button>

    <!-- CONTEXT MENU -->
    <div id="context-menu">
        <div class="ctx-item" onclick="window.ctxAction('copy')">üìã Copy (Ctrl+C)</div>
        <div class="ctx-item" onclick="window.ctxAction('paste')">üìã Paste (Ctrl+V)</div>
        <div class="ctx-item" onclick="window.ctxAction('cut')">‚úÇÔ∏è Cut (Ctrl+X)</div>
        <div style="height:1px; background:var(--glass-border); margin:4px 0;"></div>
        <div class="ctx-item" onclick="window.ctxAction('dup')">üìë Duplicate (Ctrl+D)</div>
        <div class="ctx-item" onclick="window.ctxAction('up')">‚¨ÜÔ∏è Move Up</div>
        <div class="ctx-item" onclick="window.ctxAction('down')">‚¨áÔ∏è Move Down</div>
        <div class="ctx-item" onclick="window.ctxAction('link')">üîó Link</div>
        <div style="height:1px; background:var(--glass-border); margin:4px 0;"></div>
        <div class="ctx-item" onclick="window.ctxAction('del')" style="color:#ff3860;">üóëÔ∏è Delete (Del)</div>
    </div>

    <div class="editor-wrapper">
        <!-- TOOLBAR -->
        <div class="toolbar">
            <div class="logo">‚ú®COAIEXIST</div>
            <button class="btn" id="new-btn">üìÑ Reset</button>
            <button class="btn" id="undo-btn" disabled>‚è™ Undo</button>
            <button class="btn" id="redo-btn" disabled>‚è© Redo</button>
            <button class="btn btn-pink" id="ai-gen-btn">‚ú® AI Manifest</button>
            
            <button class="btn" id="preview-btn" onclick="togglePreview()">üëÅÔ∏è Preview</button>
            <button class="btn" id="code-view-btn" onclick="openSourceModal()">Ôπ§/Ôπ• Source</button>

            <!-- Hardcoded onclick events to guarantee responsiveness -->
            <button class="btn" id="css-btn" onclick="openModal('css-modal')">üé® CSS Lab</button>
            <button class="btn btn-cyan" id="global-styles-btn" onclick="openModal('global-styles-modal')">üåç Theme</button>
            <button class="btn btn-orange" id="js-btn" onclick="openModal('js-modal')">‚ö° Scripts</button>
            
            <button class="btn" id="asset-btn">üñºÔ∏è Assets</button>
            <button class="btn" id="settings-btn" onclick="openSettingsModal()">‚öôÔ∏è Settings</button>
            <button class="btn" id="theme-toggle-btn" onclick="window.toggleTheme()">‚òÄÔ∏è Mode</button>
            <button class="btn btn-cyan" id="export-btn">üíæ Export</button>
            <button class="btn" id="grid-toggle-btn">Grid</button>
            <button class="btn" id="sound-toggle-btn" onclick="window.toggleSound()">üîä Sound: On</button>
            <button class="btn" id="toggle-sidebar-btn" style="display:none;">üçî</button> <!-- Mobile Sidebar Toggle -->
            <div style="flex:1;"></div>
        </div>

        <!-- TOOLBOX -->
        <div class="toolbox">
            <!-- Content populated by tools... -->
             <div class="tool-category">COAIEXIST.OS</div>
            <div class="tool-grid">
                 <div class="tool-item" draggable="true" data-type="coaiexist-winamp">
                    <div class="tool-icon">üéµ</div>
                    <div class="tool-label">Winamp</div>
                </div>
                <div class="tool-item" draggable="true" data-type="coaiexist-terminal">
                    <div class="tool-icon">üìü</div>
                    <div class="tool-label">Terminal</div>
                </div>
                <div class="tool-item" draggable="true" data-type="coaiexist-webring">
                    <div class="tool-icon">üï∏Ô∏è</div>
                    <div class="tool-label">Webring</div>
                </div>
                 <div class="tool-item" draggable="true" data-type="coaiexist-cyber-badge">
                    <div class="tool-icon">üè∑Ô∏è</div>
                    <div class="tool-label">Badges</div>
                </div>
                 <div class="tool-item" draggable="true" data-type="coaiexist-hit-counter">
                    <div class="tool-icon">1Ô∏è‚É£</div>
                    <div class="tool-label">Counter</div>
                </div>
                 <div class="tool-item" draggable="true" data-type="coaiexist-pip">
                    <div class="tool-icon">üê∏</div>
                    <div class="tool-label">Pip 3D</div>
                </div>
                 <div class="tool-item" draggable="true" data-type="coaiexist-mobile-frame">
                    <div class="tool-icon">üì±</div>
                    <div class="tool-label">Mobile Frame</div>
                </div>
            </div>

            <div class="tool-category">Fun & Chaos</div>
            <div class="tool-grid">
                <div class="tool-item" draggable="true" data-type="coaiexist-window">
                    <div class="tool-icon">ü™ü</div>
                    <div class="tool-label">Retro Window</div>
                </div>
                <div class="tool-item" draggable="true" data-type="coaiexist-sticker">
                    <div class="tool-icon">üåà</div>
                    <div class="tool-label">Sticker</div>
                </div>
                <div class="tool-item" draggable="true" data-type="coaiexist-pet">
                    <div class="tool-icon">üëæ</div>
                    <div class="tool-label">Pixel Pet</div>
                </div>
                <div class="tool-item" draggable="true" data-type="coaiexist-weather">
                    <div class="tool-icon">‚òÄÔ∏è</div>
                    <div class="tool-label">Weather</div>
                </div>
                <div class="tool-item" draggable="true" data-type="coaiexist-music-viz">
                    <div class="tool-icon">üìä</div>
                    <div class="tool-label">Visualizer</div>
                </div>
                 <div class="tool-item" draggable="true" data-type="coaiexist-crt">
                    <div class="tool-icon">üì∫</div>
                    <div class="tool-label">CRT Filter</div>
                </div>
                 <div class="tool-item" draggable="true" data-type="coaiexist-cursor-sparkles">
                    <div class="tool-icon">‚ú®</div>
                    <div class="tool-label">Sparkle Cursor</div>
                </div>
            </div>
            
            <div class="tool-category">Nostalgia Pack üìº</div>
            <div class="tool-grid">
                <div class="tool-item" draggable="true" data-type="coaiexist-cool-s">
                    <div class="tool-icon">‚ö°</div>
                    <div class="tool-label">Cool S</div>
                </div>
                <div class="tool-item" draggable="true" data-type="coaiexist-dvd-logo">
                    <div class="tool-icon">üìÄ</div>
                    <div class="tool-label">DVD Logo</div>
                </div>
                <div class="tool-item" draggable="true" data-type="coaiexist-glitter-text">
                    <div class="tool-icon">‚ú®</div>
                    <div class="tool-label">Glitter</div>
                </div>
                <div class="tool-item" draggable="true" data-type="coaiexist-hazard-tape">
                    <div class="tool-icon">üöß</div>
                    <div class="tool-label">Hazard</div>
                </div>
                <div class="tool-item" draggable="true" data-type="coaiexist-guestbook-btn">
                    <div class="tool-icon">üìñ</div>
                    <div class="tool-label">Guestbook</div>
                </div>
            </div>

            <div class="tool-category">Y2K & Chrome üëΩ</div>
            <div class="tool-grid">
                <div class="tool-item" draggable="true" data-type="coaiexist-y2k-blob">
                    <div class="tool-icon">üíß</div>
                    <div class="tool-label">Liquid Blob</div>
                </div>
                <div class="tool-item" draggable="true" data-type="coaiexist-alien-badge">
                    <div class="tool-icon">üëΩ</div>
                    <div class="tool-label">Alien Badge</div>
                </div>
                 <div class="tool-item" draggable="true" data-type="coaiexist-chrome-text">
                    <div class="tool-icon">üíø</div>
                    <div class="tool-label">Chrome Txt</div>
                </div>
                <div class="tool-item" draggable="true" data-type="coaiexist-tribal-mark">
                    <div class="tool-icon">üêâ</div>
                    <div class="tool-label">Tribal</div>
                </div>
            </div>
            
            <div class="tool-category">Dark & Ethereal ü¶á</div>
            <div class="tool-grid">
                <div class="tool-item" draggable="true" data-type="coaiexist-vampire-card">
                    <div class="tool-icon">‚ö∞Ô∏è</div>
                    <div class="tool-label">Vampire Box</div>
                </div>
                <div class="tool-item" draggable="true" data-type="coaiexist-angel-cloud">
                    <div class="tool-icon">‚òÅÔ∏è</div>
                    <div class="tool-label">Angel Cloud</div>
                </div>
                 <div class="tool-item" draggable="true" data-type="coaiexist-aura-text">
                    <div class="tool-icon">‚ú®</div>
                    <div class="tool-label">Aura Text</div>
                </div>
                <div class="tool-item" draggable="true" data-type="coaiexist-goth-quote">
                    <div class="tool-icon">ü•Ä</div>
                    <div class="tool-label">Goth Quote</div>
                </div>
            </div>
            
            <div class="tool-category">GeoCities / Clown ü§°</div>
            <div class="tool-grid">
                <div class="tool-item" draggable="true" data-type="coaiexist-construction">
                    <div class="tool-icon">üöß</div>
                    <div class="tool-label">Construction</div>
                </div>
                <div class="tool-item" draggable="true" data-type="coaiexist-clown-card">
                    <div class="tool-icon">ü§°</div>
                    <div class="tool-label">Clown Box</div>
                </div>
                <div class="tool-item" draggable="true" data-type="coaiexist-wordart">
                    <div class="tool-icon">üé®</div>
                    <div class="tool-label">WordArt</div>
                </div>
                <div class="tool-item" draggable="true" data-type="coaiexist-flames">
                    <div class="tool-icon">üî•</div>
                    <div class="tool-label">Fire Text</div>
                </div>
                <div class="tool-item" draggable="true" data-type="coaiexist-spin-new">
                    <div class="tool-icon">‚≠ê</div>
                    <div class="tool-label">Spin New</div>
                </div>
                <div class="tool-item" draggable="true" data-type="coaiexist-comic-btn">
                    <div class="tool-icon">ü§™</div>
                    <div class="tool-label">Clown Btn</div>
                </div>
                <div class="tool-item" draggable="true" data-type="coaiexist-blink-text">
                    <div class="tool-icon">üëÄ</div>
                    <div class="tool-label">Blink Text</div>
                </div>
                <div class="tool-item" draggable="true" data-type="coaiexist-rainbow-hr">
                    <div class="tool-icon">üåà</div>
                    <div class="tool-label">Rainbow Line</div>
                </div>
                <div class="tool-item" draggable="true" data-type="coaiexist-cursor-trail">
                    <div class="tool-icon">üêÅ</div>
                    <div class="tool-label">Mouse Trail</div>
                </div>
            </div>

            <div class="tool-category">Structure</div>
            <div class="tool-grid">
                <div class="tool-item" draggable="true" data-type="div">
                    <div class="tool-icon">‚¨ú</div>
                    <div class="tool-label">Container</div>
                </div>
                <div class="tool-item" draggable="true" data-type="card">
                    <div class="tool-icon">ü™ü</div>
                    <div class="tool-label">Glass Card</div>
                </div>
                <div class="tool-item" draggable="true" data-type="table">
                    <div class="tool-icon">‚ñ¶</div>
                    <div class="tool-label">Table</div>
                </div>
                <div class="tool-item" draggable="true" data-type="code">
                    <div class="tool-icon">‚å®Ô∏è</div>
                    <div class="tool-label">Code</div>
                </div>
                <div class="tool-item" draggable="true" data-type="embed">
                    <div class="tool-icon">üîó</div>
                    <div class="tool-label">Embed Site</div>
                </div>
            </div>

            <div class="tool-category">Typography</div>
            <div class="tool-grid">
                <div class="tool-item" draggable="true" data-type="h1">
                    <div class="tool-icon">H1</div>
                    <div class="tool-label">Header</div>
                </div>
                <div class="tool-item" draggable="true" data-type="p">
                    <div class="tool-icon">¬∂</div>
                    <div class="tool-label">Text</div>
                </div>
                 <div class="tool-item" draggable="true" data-type="gradient-text">
                    <div class="tool-icon">üåà</div>
                    <div class="tool-label">Gradient</div>
                </div>
                <div class="tool-item" draggable="true" data-type="typewriter">
                    <div class="tool-icon">‚å®Ô∏è</div>
                    <div class="tool-label">Typewriter</div>
                </div>
                <div class="tool-item" draggable="true" data-type="blockquote">
                    <div class="tool-icon">‚ùù</div>
                    <div class="tool-label">Quote</div>
                </div>
                <div class="tool-item" draggable="true" data-type="blink">
                    <div class="tool-icon">‚ú®</div>
                    <div class="tool-label">Blink</div>
                </div>
            </div>

            <div class="tool-category">Media</div>
            <div class="tool-grid">
                <div class="tool-item" draggable="true" data-type="img">
                    <div class="tool-icon">üñºÔ∏è</div>
                    <div class="tool-label">Image</div>
                </div>
                <div class="tool-item" draggable="true" data-type="video">
                    <div class="tool-icon">üì∫</div>
                    <div class="tool-label">Video</div>
                </div>
                <div class="tool-item" draggable="true" data-type="audio">
                    <div class="tool-icon">üîä</div>
                    <div class="tool-label">Audio</div>
                </div>
                <div class="tool-item" draggable="true" data-type="avatar">
                    <div class="tool-icon">üë§</div>
                    <div class="tool-label">Avatar</div>
                </div>
                <div class="tool-item" draggable="true" data-type="button">
                    <div class="tool-icon">üîò</div>
                    <div class="tool-label">Button</div>
                </div>
                <div class="tool-item" draggable="true" data-type="marquee">
                    <div class="tool-icon">‚ÜîÔ∏è</div>
                    <div class="tool-label">Marquee</div>
                </div>
            </div>
            
            <div class="tool-category">Components</div>
            <div class="tool-grid">
                <div class="tool-item" draggable="true" data-type="bulma-card">
                    <div class="tool-icon">üÉè</div>
                    <div class="tool-label">Bulma Card</div>
                </div>
                <div class="tool-item" draggable="true" data-type="bulma-hero">
                    <div class="tool-icon">ü¶∏</div>
                    <div class="tool-label">Hero</div>
                </div>
                <div class="tool-item" draggable="true" data-type="bulma-navbar">
                    <div class="tool-icon">üß≠</div>
                    <div class="tool-label">Nav</div>
                </div>
                 <div class="tool-item" draggable="true" data-type="bulma-message">
                    <div class="tool-icon">üí¨</div>
                    <div class="tool-label">Message</div>
                </div>
                 <div class="tool-item" draggable="true" data-type="accordion">
                    <div class="tool-icon">üìÇ</div>
                    <div class="tool-label">Accordion</div>
                </div>
                <div class="tool-item" draggable="true" data-type="badge">
                    <div class="tool-icon">üè∑Ô∏è</div>
                    <div class="tool-label">Badge</div>
                </div>
                 <div class="tool-item" draggable="true" data-type="alert">
                    <div class="tool-icon">‚ö†Ô∏è</div>
                    <div class="tool-label">Alert</div>
                </div>
                 <div class="tool-item" draggable="true" data-type="progress">
                    <div class="tool-icon">üìä</div>
                    <div class="tool-label">Progress</div>
                </div>
            </div>
        </div>

        <!-- CANVAS -->
        <div class="canvas-area" id="canvas-area">
            <!-- PAGE TABS -->
            <div class="page-tabs-bar" id="page-tabs-bar">
                <!-- Tabs generated here -->
                <button class="page-tab-add" onclick="createNewPage()" title="Create New Page">+</button>
            </div>

            <div class="viewport-controls">
                <button class="vp-btn" id="vp-mobile" title="Mobile (375px)">üì±</button>
                <button class="vp-btn" id="vp-tablet" title="Tablet (768px)">üì≤</button>
                <button class="vp-btn" id="vp-desktop" title="Laptop (1024px)">üíª</button>
                <button class="vp-btn active" id="vp-full" title="Full Width">üñ•Ô∏è</button>
            </div>
            
            <div id="canvas-container">
                <iframe id="canvas-frame" sandbox="allow-scripts allow-same-origin allow-modals allow-popups allow-forms"></iframe>
            </div>
            <div id="grid-overlay"></div>
        </div>

        <!-- INSPECTOR SIDEBAR -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="tab-btn active" id="tab-props">Pro CSS</button>
                <button class="tab-btn" id="tab-text">Text</button>
                <button class="tab-btn" id="tab-layers">Layers</button>
                <button class="tab-btn" onclick="document.getElementById('sidebar').classList.remove('active')">√ó</button>
            </div>
            
            <div id="panel-props" class="sidebar-content" id="properties-panel">
                <div style="text-align: center; margin-top: 50%; color: var(--text-dim); font-size: 12px;">
                    Select an object to<br>hack its matrix.
                </div>
            </div>
            
            <div id="panel-text" class="sidebar-content" style="display:none;">
                 <div class="prop-group" open>
                    <summary>Text Format</summary>
                    <div class="prop-body">
                         <div id="rtf-toolbar" class="rtf-group">
                            <button class="rtf-btn" data-rtf="bold" title="Bold"><b>B</b></button>
                            <button class="rtf-btn" data-rtf="italic" title="Italic"><i>I</i></button>
                            <button class="rtf-btn" data-rtf="underline" title="Underline"><u>U</u></button>
                            <div class="rtf-separator"></div>
                            <button class="rtf-btn" data-rtf="alignLeft" title="Left">‚á†</button>
                            <button class="rtf-btn" data-rtf="alignCenter" title="Center">‚Üî</button>
                            <button class="rtf-btn" data-rtf="alignRight" title="Right">‚á¢</button>
                            <div class="rtf-separator"></div>
                            <input type="color" id="rtf-text-color" title="Text Color" style="width:20px; height:20px; border:none; padding:0; background:none; cursor:pointer;">
                            <button class="rtf-btn" data-rtf="link" title="Link">üîó</button>
                            <button class="rtf-btn" data-rtf="clearFormat" title="Clear Formatting">üßπ</button>
                        </div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 10px; color: var(--text-dim); font-size: 10px;">
                    Select text to apply styles.
                </div>
            </div>
            
            <div id="panel-layers" class="sidebar-content" style="display:none;">
                <!-- Layer list populated via JS -->
            </div>
        </div>

        <!-- STATUS BAR -->
        <div class="statusbar">
            <span id="status-msg">System Ready</span>
            <span id="mouse-coords">0,0</span>
        </div>
    </div>

    <!-- PAGE SETTINGS MODAL -->
    <div class="modal" id="settings-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-title">‚öôÔ∏è Page Settings</div>
                <button class="modal-close" onclick="closeModal('settings-modal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="prop-group" open>
                    <summary>Metadata</summary>
                    <div class="prop-body">
                        <div class="control-row">
                            <span class="prop-label">Page Title</span>
                            <input type="text" id="page-title-input" placeholder="My Awesome Page">
                        </div>
                        <div class="control-row">
                            <span class="prop-label">Description</span>
                            <textarea id="page-desc-input" rows="3" placeholder="Brief description for search engines..."></textarea>
                        </div>
                         <div class="control-row">
                            <span class="prop-label">Keywords</span>
                            <input type="text" id="page-keywords-input" placeholder="retro, cool, website">
                        </div>
                        <div class="control-row">
                            <span class="prop-label">Favicon URL</span>
                            <input type="text" id="page-favicon-input" placeholder="https://...">
                        </div>
                    </div>
                </div>
                
                <button class="big-button btn-cyan" onclick="savePageSettings()" style="width:100%; margin-top:15px;">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- SOURCE VIEW MODAL -->
    <div class="modal" id="source-modal">
        <div class="modal-content" style="max-width: 900px; height: 85vh;">
             <div class="modal-header">
               <div class="modal-title">Ôπ§/Ôπ• Full Source Editor</div>
               <button class="modal-close" onclick="closeModal('source-modal')">√ó</button>
             </div>
             <div class="modal-body" style="display:flex; flex-direction:column; padding:0;">
                <div style="background:var(--panel-bg); border-bottom:1px solid var(--glass-border); display:flex; gap:10px; padding:10px 20px;">
                    <button class="tab-btn active" onclick="switchSourceTab('html')">HTML (Body)</button>
                    <button class="tab-btn" onclick="switchSourceTab('css')">CSS (Styles)</button>
                    <button class="tab-btn" onclick="switchSourceTab('js')">JS (Scripts)</button>
                </div>
                
                <div id="source-tab-html" style="flex:1; display:flex; flex-direction:column; padding:20px;">
                     <p style="font-size:12px; color:var(--text-dim); margin-bottom:5px;">Clean HTML structure (Internal classes removed).</p>
                     <textarea id="html-source-editor" class="code-editor" style="flex:1; margin-bottom:15px;"></textarea>
                </div>
                
                <div id="source-tab-css" style="flex:1; display:none; flex-direction:column; padding:20px;">
                     <p style="font-size:12px; color:var(--text-dim); margin-bottom:5px;">Page Styles & Theme.</p>
                     <textarea id="css-source-editor" class="code-editor" style="flex:1; margin-bottom:15px;"></textarea>
                </div>
                
                <div id="source-tab-js" style="flex:1; display:none; flex-direction:column; padding:20px;">
                     <p style="font-size:12px; color:var(--text-dim); margin-bottom:5px;">Custom Javascript.</p>
                     <textarea id="js-source-editor" class="code-editor" style="flex:1; margin-bottom:15px;"></textarea>
                </div>
               
               <div style="padding:15px 20px; border-top:1px solid var(--glass-border); display:flex; justify-content:space-between; background:var(--bg-dark);">
                   <label style="font-size:12px; color:var(--text-dim); display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none;">
                       <input type="checkbox" id="auto-layerize-check" checked style="width:16px; height:16px;"> 
                       <span><b>ü™Ñ Auto-Layerize</b> (Make elements draggable)</span>
                   </label>
                   <button id="update-source-btn" class="big-button btn-cyan" onclick="updateSourceFromModal()">Update All</button>
               </div>
             </div>
        </div>
    </div>

    <!-- AI IMAGE MODAL (Nano Banana) -->
    <div class="modal" id="ai-image-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title">üçå Nano Banana Studio</div>
                <button class="modal-close" onclick="closeModal('ai-image-modal')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="ai-image-workspace" style="display:flex; flex-direction:column; gap:15px; align-items:center;">
                    <div style="display:flex; gap:10px; width:100%; justify-content:center; flex-wrap: wrap;">
                        <div id="ai-img-original-container" style="text-align:center; display:none;">
                            <span class="prop-label">Original</span>
                            <img id="ai-img-original" style="max-width:200px; max-height:200px; border:1px solid var(--glass-border); display:block; margin-top:5px;">
                        </div>
                        <div id="ai-img-result-container" style="text-align:center; display:none;">
                            <span class="prop-label">Result</span>
                            <img id="ai-img-result" style="max-width:200px; max-height:200px; border:1px solid var(--magenta); display:block; margin-top:5px;">
                        </div>
                    </div>
                    
                    <textarea id="ai-image-prompt" class="code-editor" rows="3" placeholder="Describe edits (e.g., 'Add a retro filter') or a new image..."></textarea>
                    
                    <div style="display:flex; gap:10px; width:100%;">
                        <button id="ai-img-gen-btn" class="big-button btn-pink" style="flex:1;">‚ú® Generate</button>
                        <button id="ai-img-accept-btn" class="big-button btn-cyan" style="flex:1; display:none;">‚úÖ Accept</button>
                    </div>
                    <div id="ai-img-status" style="font-size:12px; color:var(--text-dim);"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI MANIFEST MODAL -->
    <div class="modal" id="ai-manifest-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title">‚ú® AI Manifest Engine</div>
                <button class="modal-close" onclick="closeModal('ai-manifest-modal')">√ó</button>
            </div>
            <div class="modal-body">
                <div style="display:flex; flex-direction:column; gap:15px;">
                    <p style="font-size:12px; color:var(--text-dim);">Describe the element or section you want to manifest (e.g. "A neon glowing hero section for a cyber cafe").</p>
                    <textarea id="ai-manifest-prompt" class="code-editor" rows="4" placeholder="Enter your vision..."></textarea>
                    <button id="ai-manifest-run-btn" class="big-button btn-pink">‚ú® Manifest Reality</button>
                    <div id="ai-manifest-status" style="font-size:12px; color:var(--cyan); min-height:20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ASSET MODAL -->
    <div id="asset-modal" class="modal">
        <div class="modal-box">
            <div class="modal-header">
                <div class="modal-title">Asset Manager</div>
                <button class="modal-close" onclick="document.getElementById('asset-modal').classList.remove('active')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="asset-nav">
                    <button class="asset-tab active" onclick="window.switchAssetTab('github')">GitHub Bridge</button>
                    <button class="asset-tab" onclick="window.switchAssetTab('neocities')">Neocities Cloud</button>
                    <button class="asset-tab" onclick="window.switchAssetTab('upload')">Direct Link / Upload</button>
                </div>

                <!-- GITHUB TAB -->
                <div id="tab-github">
                    <div class="gh-inputs">
                        <input id="gh-user" type="text" placeholder="User" value="TheNabu222">
                        <input id="gh-repo" type="text" placeholder="Repo" value="entropic-ai">
                        <button class="btn btn-cyan" onclick="window.fetchGithubAssets('')">‚ö° Connect</button>
                    </div>
                    <div class="gh-path" id="gh-breadcrumbs">root /</div>
                    <div class="asset-grid" id="gh-grid">
                        <div style="grid-column: 1/-1; text-align: center; color: var(--text-dim); padding: 20px;">
                            Enter a public repo to fetch assets. If you see an error, the repo may be private or you hit the rate limit.
                        </div>
                    </div>
                </div>
                
                <!-- NEOCITIES TAB -->
                <div id="tab-neocities" style="display:none;">
                    <div class="gh-inputs">
                        <button class="btn btn-cyan" onclick="window.fetchNeocitiesAssets()">‚ö° Refresh from Neocities</button>
                        <span style="font-size: 10px; color: var(--text-dim); align-self: center;">Uses API Key from Deploy settings</span>
                    </div>
                    <div class="asset-grid" id="neocities-asset-grid">
                        <div style="grid-column: 1/-1; text-align: center; color: var(--text-dim); padding: 20px;">
                            Click refresh to load your site assets.
                        </div>
                    </div>
                </div>

                <!-- URL TAB (Updated with File Upload) -->
                <div id="tab-upload" style="display:none; padding: 20px;">
                    <div style="margin-bottom: 20px;">
                         <label class="prop-label">Direct URL</label>
                         <div style="display:flex; gap:10px; flex-direction:column;">
                             <input type="text" id="asset-url-input" placeholder="https://example.com/image.gif" style="flex:1;">
                             <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                 <button class="btn btn-cyan" onclick="window.insertAssetFromUrl('img')">Image</button>
                                 <button class="btn" onclick="window.insertAssetFromUrl('audio')">Audio</button>
                                 <button class="btn" onclick="window.insertAssetFromUrl('video')">Video</button>
                                 <button class="btn" onclick="window.insertAssetFromUrl('iframe')">Embed Frame</button>
                                 <button class="btn" onclick="window.insertAssetFromUrl('html')">Inject Code</button>
                             </div>
                         </div>
                    </div>
                    
                    <div style="margin-top: 20px; border-top: 1px solid var(--glass-border); padding-top: 20px;">
                        <label class="prop-label">Upload Local File</label>
                        <input type="file" id="local-file-upload" onchange="window.handleFileUpload(this)" style="width:100%; margin-top:5px;">
                        <p style="font-size:10px; color:var(--text-dim); margin-top:5px;">Supports: Images, Audio, Video, HTML (injects code).</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- GLOBAL THEME MODAL -->
    <div class="modal" id="global-styles-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title">üåç Global Theme Studio</div>
                <button class="modal-close" onclick="closeModal('global-styles-modal')">√ó</button>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; gap: 20px;">
                <p style="font-size:12px; color:var(--text-dim);">Define defaults for the entire page. Updates apply immediately.</p>
                
                <!-- Google Fonts -->
                <div class="prop-group" open>
                    <summary>Font Manager</summary>
                    <div class="prop-body">
                        <div class="control-row">
                            <span class="prop-label">Import Google Font</span>
                            <div style="display:flex; gap:5px;">
                                <input type="text" id="gf-name" list="gf-suggestions" placeholder="Type or Select Font...">
                                <datalist id="gf-suggestions">
                                    <option value="Press Start 2P">Retro Pixel</option>
                                    <option value="Roboto">Clean Sans</option>
                                    <option value="Lobster">Cursive</option>
                                    <option value="Share Tech Mono">Cyber Tech</option>
                                    <option value="Bangers">Comic Book</option>
                                    <option value="Cinzel">Fantasy</option>
                                    <option value="Orbitron">Sci-Fi</option>
                                    <option value="Pacifico">Handwriting</option>
                                    <option value="VT323">Terminal</option>
                                </datalist>
                                <button class="btn btn-cyan" onclick="window.addGoogleFont()">Fetch</button>
                            </div>
                            <p style="font-size:10px; color:var(--text-dim); margin-top:5px;">Font will be added to dropdowns below.</p>
                        </div>
                    </div>
                </div>

                <!-- Page Base -->
                <div class="prop-group" open>
                    <summary>Base Page Style</summary>
                    <div class="prop-body">
                        <div class="control-row">
                            <div class="label-row"><span class="prop-label">Background Color</span></div>
                            <div class="color-wrap">
                                <input type="color" id="gs-body-bg" oninput="updateGlobalTheme()">
                                <input type="text" id="gs-body-bg-text" onchange="document.getElementById('gs-body-bg').value=this.value; updateGlobalTheme();" style="flex:1; border:none; background:transparent; color:white; font-size:10px;">
                            </div>
                        </div>
                        <div class="control-row">
                            <div class="label-row"><span class="prop-label">Text Color</span></div>
                            <div class="color-wrap">
                                <input type="color" id="gs-body-text" oninput="updateGlobalTheme()">
                                <input type="text" id="gs-body-text-text" onchange="document.getElementById('gs-body-text').value=this.value; updateGlobalTheme();" style="flex:1; border:none; background:transparent; color:white; font-size:10px;">
                            </div>
                        </div>
                        <div class="control-row">
                            <div class="label-row"><span class="prop-label">Font Family</span></div>
                            <select id="gs-body-font" onchange="updateGlobalTheme()">
                                <option value="'Inter', sans-serif">Inter (Modern)</option>
                                <option value="'VT323', monospace">VT323 (Retro)</option>
                                <option value="'Comic Neue', cursive">Comic Neue (Fun)</option>
                                <option value="'Comic Sans MS', 'Comic Neue', cursive">Comic Sans MS (Classic)</option>
                                <option value="'Papyrus', fantasy">Papyrus (Ancient)</option>
                                <option value="'Impact', sans-serif">Impact (Meme)</option>
                                <option value="'Chalkboard SE', sans-serif">Chalkboard</option>
                                <option value="'Courier New', monospace">Courier (Code)</option>
                                <option value="sans-serif">Sans-Serif</option>
                                <option value="serif">Serif</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Typography -->
                <div class="prop-group" open>
                    <summary>Headings (H1-H6)</summary>
                    <div class="prop-body">
                         <div class="control-row">
                            <div class="label-row"><span class="prop-label">Heading Color</span></div>
                            <div class="color-wrap"><input type="color" id="gs-h-color" oninput="updateGlobalTheme()"><span style="font-size:10px;">Choose...</span></div>
                        </div>
                        <div class="control-row">
                            <div class="label-row"><span class="prop-label">Heading Font</span></div>
                            <select id="gs-h-font" onchange="updateGlobalTheme()">
                                <option value="inherit">Same as Body</option>
                                <option value="'VT323', monospace">VT323 (Retro)</option>
                                <option value="'Inter', sans-serif">Inter (Modern)</option>
                                <option value="'Comic Neue', cursive">Comic Neue (Fun)</option>
                                <option value="'Papyrus', fantasy">Papyrus</option>
                                <option value="'Impact', sans-serif">Impact</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <div class="label-row"><span class="prop-label">Text Transform</span></div>
                            <select id="gs-h-transform" onchange="updateGlobalTheme()">
                                <option value="none">None</option>
                                <option value="uppercase">UPPERCASE</option>
                                <option value="lowercase">lowercase</option>
                                <option value="capitalize">Capitalize</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="prop-group" open>
                    <summary>Standard Buttons</summary>
                    <div class="prop-body">
                         <div class="control-row">
                            <div class="label-row"><span class="prop-label">Bg Color</span></div>
                            <div class="color-wrap"><input type="color" id="gs-btn-bg" oninput="updateGlobalTheme()"><span style="font-size:10px;">Choose...</span></div>
                        </div>
                         <div class="control-row">
                            <div class="label-row"><span class="prop-label">Text Color</span></div>
                            <div class="color-wrap"><input type="color" id="gs-btn-text" oninput="updateGlobalTheme()"><span style="font-size:10px;">Choose...</span></div>
                        </div>
                        <div class="control-row">
                            <div class="label-row"><span class="prop-label">Border Radius (px)</span><span class="prop-val-display" id="val-gs-btn-radius">4px</span></div>
                            <input type="range" id="gs-btn-radius" min="0" max="50" value="4" oninput="updateGlobalTheme()">
                        </div>
                    </div>
                </div>
                
                <!-- Links -->
                <div class="prop-group" open>
                    <summary>Links (Anchors)</summary>
                    <div class="prop-body">
                         <div class="control-row">
                            <div class="label-row"><span class="prop-label">Link Color</span></div>
                            <div class="color-wrap"><input type="color" id="gs-link-color" oninput="updateGlobalTheme()"><span style="font-size:10px;">Choose...</span></div>
                        </div>
                        <div class="control-row">
                            <div class="label-row"><span class="prop-label">Decoration</span></div>
                            <select id="gs-link-dec" onchange="updateGlobalTheme()">
                                <option value="underline">Underline</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CSS LAB MODAL (REFACTORED & ORGANIZED) -->
    <div class="modal" id="css-modal">
        <div class="modal-content" style="max-width: 1100px;">
            <div class="modal-header"><div class="modal-title">üé® CSS Style Matrix</div><button class="modal-close" onclick="closeModal('css-modal')">√ó</button></div>
            <div class="modal-body" style="display:grid; grid-template-columns: 1fr 320px; gap:20px; height: 100%;">
                
                <!-- LEFT: EDITOR & PREVIEW -->
                <div style="display:flex; flex-direction:column; gap:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <span class="prop-label">Syntax:</span>
                        <div style="display:flex; gap:10px;">
                            <label style="color:var(--text-dim); font-size:12px; cursor:pointer;"><input type="radio" name="css-mode" value="css" checked onchange="document.getElementById('css-editor').placeholder='/* Enter CSS here */'"> CSS</label>
                            <label style="color:var(--text-dim); font-size:12px; cursor:pointer;"><input type="radio" name="css-mode" value="scss" onchange="document.getElementById('css-editor').placeholder='/* Enter SCSS here (Variables, Nesting...) */'"> SCSS</label>
                        </div>
                    </div>
                    <textarea id="css-editor" class="code-editor" rows="20" placeholder="/* CSS Code Matrix */"></textarea>
                    <button id="apply-css-btn" class="big-button btn-cyan" style="width: 100%;">Apply Code to Reality</button>
                    
                    <!-- Quick Generators -->
                     <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div class="experiment-box" style="margin-top:0;">
                            <h4>‚ú® Gradient Forge</h4>
                             <div style="display:flex; gap:5px; align-items:center; flex-wrap:wrap;">
                                 <input type="color" id="grad-c1" value="#ff00cc">
                                 <input type="color" id="grad-c2" value="#00f0ff">
                                 <input type="range" id="grad-angle" min="0" max="360" value="90" style="width:60px">
                                 <button class="btn" onclick="insertGradient()">Generate</button>
                             </div>
                        </div>
                         <div class="experiment-box" style="margin-top:0;">
                            <h4>‚ú® Shadow Caster</h4>
                             <div style="display:flex; gap:5px; align-items:center; flex-wrap:wrap;">
                                 <input type="color" id="shadow-c" value="#000000">
                                 <input type="range" id="shadow-blur" min="0" max="50" value="10" style="width:60px">
                                 <button class="btn" onclick="insertShadow()">Generate</button>
                             </div>
                        </div>
                     </div>
                </div>

                <!-- RIGHT: STYLE LIBRARY (Better Organized) -->
                <div class="css-library-panel" style="overflow-y:auto; padding-left:15px; border-left:1px solid var(--glass-border);">
                    <div class="css-tabs">
                        <button class="css-tab-btn active" onclick="switchCssTab('presets')">Layouts</button>
                        <button class="css-tab-btn" onclick="switchCssTab('filters')">Filters</button>
                        <button class="css-tab-btn" onclick="switchCssTab('scroll')">Scrollbars</button>
                        <button class="css-tab-btn" onclick="switchCssTab('anim')">Anim</button>
                    </div>
                    <p style="font-size:10px; color:var(--text-dim); margin-bottom:10px;">Click a card to apply code.</p>

                    <!-- TAB: LAYOUTS / PRESETS -->
                    <div id="css-tab-presets" class="style-grid">
                        <!-- Populated by JS -->
                    </div>
                    
                    <!-- TAB: FILTERS -->
                    <div id="css-tab-filters" class="style-grid" style="display:none;">
                        <!-- Populated by JS -->
                    </div>
                    
                     <!-- TAB: SCROLLBARS -->
                    <div id="css-tab-scroll" class="style-grid" style="display:none;">
                        <!-- Populated by JS -->
                    </div>

                    <!-- TAB: ANIMATIONS -->
                    <div id="css-tab-anim" class="style-grid" style="display:none;">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JS SCRIPT ENGINE MODAL (UPGRADED) -->
    <div class="modal" id="js-modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header"><div class="modal-title">‚ö° Script Kiddie Stash</div><button class="modal-close" onclick="closeModal('js-modal')">√ó</button></div>
            <div class="modal-body" style="display: flex; flex-direction: column; height: 100%;">
                <div style="display: grid; grid-template-columns: 1fr 280px; gap: 20px; flex: 1;">
                    <!-- Left: Editor -->
                    <div style="display: flex; flex-direction: column;">
                        <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px;">
                            <span style="font-size: 12px; color: var(--text-dim);">Javascript Console</span>
                        </div>
                        <textarea id="js-editor" class="code-editor" style="flex: 1; margin-bottom: 10px;" placeholder="// Add your custom JavaScript here or select a preset from the right..."></textarea>
                        <button id="apply-js-btn" class="big-button btn-orange" style="width: 100%;">‚ö° Execute Script</button>
                    </div>

                    <!-- Right: Presets -->
                    <div class="css-library-panel" style="overflow-y:auto; padding-left:15px; border-left:1px solid var(--glass-border);">
                         <div class="css-tabs">
                            <button class="css-tab-btn active" onclick="switchJsTab('effects')">Effects</button>
                            <button class="css-tab-btn" onclick="switchJsTab('cursors')">Cursors</button>
                            <button class="css-tab-btn" onclick="switchJsTab('utils')">Utils</button>
                        </div>
                        <p style="font-size:10px; color:var(--text-dim); margin-bottom:10px;">One-Click Magic Injection</p>

                        <div id="js-tab-effects" class="style-grid"></div>
                        <div id="js-tab-cursors" class="style-grid" style="display:none;"></div>
                        <div id="js-tab-utils" class="style-grid" style="display:none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CORE APPLICATION LOGIC (Instant Load) -->
    <script>
        // --- GLOBAL STATE ---
        window.selectedEl = null;
        const iframe = document.getElementById('canvas-frame');
        let iframeDoc = null;
        window.activeImageElement = null;
        let matrixRainInterval = null;
        window.soundEnabled = true;
        window.clipboardEl = null;

        // Helper: RGB to Hex
        function rgbToHex(color) {
            if(!color) return '#000000';
            if(color.startsWith('#')) return color;
            const rgb = color.match(/\d+/g);
            if(!rgb) return '#000000';
            return "#" + ((1 << 24) + (parseInt(rgb[0]) << 16) + (parseInt(rgb[1]) << 8) + parseInt(rgb[2])).toString(16).slice(1);
        }
        
        // --- THEME SYSTEM ---
        window.toggleTheme = () => {
            document.body.classList.toggle('light-mode');
            const btn = document.getElementById('theme-toggle-btn');
            if(document.body.classList.contains('light-mode')) {
                btn.innerText = "üåô Mode";
            } else {
                btn.innerText = "‚òÄÔ∏è Mode";
            }
            window.playSound('pop');
        };

        // --- MULTI-PAGE SYSTEM ---
        window.pages = [{ id: 'p_' + Date.now(), name: 'index.html', content: '', history: [], historyIndex: -1 }];
        window.activePageIndex = 0;

        function getCurrentPage() {
            return window.pages[window.activePageIndex];
        }

        window.createNewPage = () => {
            const newId = 'p_' + Date.now();
            const newPage = { 
                id: newId, 
                name: `page-${window.pages.length}.html`, 
                content: '', 
                history: [], 
                historyIndex: -1 
            };
            window.pages.push(newPage);
            window.switchPage(window.pages.length - 1);
        };

        window.switchPage = (index) => {
            // Save current page state before switching
            if (iframeDoc && iframeDoc.documentElement) {
                window.pages[window.activePageIndex].content = iframeDoc.documentElement.outerHTML;
            }

            window.activePageIndex = index;
            const page = window.pages[index];
            
            // Re-init canvas with page content
            // If content is empty, initCanvas will use default
            window.initCanvas(page.content || null);
            
            renderPageTabs();
            window.playSound('pop');
        };

        window.duplicatePage = (index) => {
            const original = window.pages[index];
            // Save current state if duplicating active page
            let currentContent = original.content;
            if (index === window.activePageIndex && iframeDoc) {
                currentContent = iframeDoc.documentElement.outerHTML;
            }

            const newPage = {
                id: 'p_' + Date.now(),
                name: original.name.replace('.html', '-copy.html'),
                content: currentContent, // "Duplicate Stylesheets" implied by copying full HTML
                history: [], // Start fresh history for clone
                historyIndex: -1
            };
            window.pages.push(newPage);
            window.switchPage(window.pages.length - 1);
            window.updateStatus(`Duplicated ${original.name}`);
        };
        
        window.deletePage = (index) => {
            if (window.pages.length <= 1) {
                alert("Cannot delete the last page!");
                return;
            }
            if (!confirm(`Delete ${window.pages[index].name}?`)) return;
            
            window.pages.splice(index, 1);
            if (index <= window.activePageIndex) {
                window.activePageIndex = Math.max(0, window.activePageIndex - 1);
            }
            window.switchPage(window.activePageIndex);
        };

        window.renamePage = (index) => {
            const newName = prompt("Enter new page name:", window.pages[index].name);
            if (newName) {
                window.pages[index].name = newName;
                renderPageTabs();
            }
        };

        function renderPageTabs() {
            const bar = document.getElementById('page-tabs-bar');
            const addBtn = bar.querySelector('.page-tab-add');
            bar.innerHTML = '';
            
            window.pages.forEach((page, idx) => {
                const tab = document.createElement('div');
                tab.className = `page-tab ${idx === window.activePageIndex ? 'active' : ''}`;
                tab.innerHTML = `
                    <span onclick="switchPage(${idx})">${page.name}</span>
                    <span style="font-size:10px; opacity:0.5; cursor:pointer;" onclick="deletePage(${idx})">‚úï</span>
                `;
                tab.ondblclick = () => renamePage(idx);
                tab.oncontextmenu = (e) => {
                    e.preventDefault();
                    if(confirm(`Duplicate ${page.name}?`)) duplicatePage(idx);
                };
                bar.appendChild(tab);
            });
            
            bar.appendChild(addBtn);
        }

        // --- ASSET MANAGER LOGIC ---
        window.switchAssetTab = (tabId) => {
            document.querySelectorAll('.asset-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll(`.asset-tab[onclick*="${tabId}"]`).forEach(t => t.classList.add('active'));
            
            document.getElementById('tab-github').style.display = tabId === 'github' ? 'block' : 'none';
            document.getElementById('tab-neocities').style.display = tabId === 'neocities' ? 'block' : 'none';
            document.getElementById('tab-upload').style.display = tabId === 'upload' ? 'block' : 'none';
        };

        window.insertAssetFromUrl = async (type) => {
             const url = document.getElementById('asset-url-input').value;
             if(!url) return;
             
             if(type === 'img') window.addElementHTML(`<img src="${url}" class="canvas-el" style="max-width:300px;">`);
             else if(type === 'audio') window.addElementHTML(`<audio controls src="${url}" class="canvas-el"></audio>`);
             else if(type === 'video') window.addElementHTML(`<video controls src="${url}" class="canvas-el" style="max-width:300px;"></video>`);
             else if(type === 'iframe') window.addElementHTML(`<iframe src="${url}" class="canvas-el" style="width:400px; height:300px; border:none;"></iframe>`);
             else if(type === 'html') {
                 await window.fetchAndInjectText(url, 'URL Resource');
                 return; // fetchAndInjectText handles modal close
             }
             
             window.closeModal('asset-modal');
             window.playSound('success');
        };

        window.handleFileUpload = (input) => {
            const file = input.files[0];
            if(!file) return;
            
            const name = file.name.toLowerCase();
            
            if(name.endsWith('.html') || name.endsWith('.txt') || name.endsWith('.md') || name.endsWith('.svg')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    window.addElementHTML(e.target.result);
                    window.closeModal('asset-modal');
                    window.playSound('success');
                };
                reader.readAsText(file);
            } else {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const res = e.target.result;
                    if(file.type.startsWith('image/')) window.addElementHTML(`<img src="${res}" class="canvas-el" style="max-width:300px;">`);
                    else if(file.type.startsWith('audio/')) window.addElementHTML(`<audio controls src="${res}" class="canvas-el"></audio>`);
                    else if(file.type.startsWith('video/')) window.addElementHTML(`<video controls src="${res}" class="canvas-el" style="max-width:300px;"></video>`);
                    else alert('Unknown file type. Upload HTML, Text, Image, Audio, or Video.');
                    
                    window.closeModal('asset-modal');
                    window.playSound('success');
                };
                reader.readAsDataURL(file);
            }
        };

        // --- GITHUB ASSET LOGIC (FIXED) ---
        window.fetchAndInjectText = async (url, name) => {
             window.updateStatus(`Fetching ${name}...`);
             try {
                let text = '';
                // Attempt 1: Direct
                try {
                    const r = await fetch(url);
                    if(r.ok) text = await r.text();
                    else throw new Error('Direct fetch failed');
                } catch(e) {
                    console.warn('Direct load failed, trying proxy...');
                    // Attempt 2: CORS Proxy
                    const r2 = await fetch('https://corsproxy.io/?' + encodeURIComponent(url));
                    if(r2.ok) text = await r2.text();
                    else throw new Error('Proxy failed');
                }
                
                if(text) {
                    window.addElementHTML(text);
                    window.closeModal('asset-modal');
                    window.updateStatus(`Injected ${name}`);
                    window.playSound('success');
                }
            } catch(err) {
                console.error(err);
                alert(`Could not load file. It might be too large or blocked.\nError: ${err.message}`);
            }
        };

        window.handleGithubAssetClick = async (type, url, name) => {
            console.log('Clicked asset:', name, type, url);
            if (!url) { alert('Error: No download URL for this file.'); return; }

            const ext = name.split('.').pop().toLowerCase();
            let htmlToInject = '';

            // 1. Images
            if (['jpg', 'jpeg', 'png', 'gif', 'svg', 'webp', 'ico', 'bmp', 'tiff'].includes(ext)) {
                htmlToInject = `<img src="${url}" class="canvas-el" style="max-width:300px;">`;
            }
            // 2. Audio
            else if (['mp3', 'wav', 'ogg', 'm4a', 'aac', 'flac'].includes(ext)) {
                htmlToInject = `<audio controls src="${url}" class="canvas-el"></audio>`;
            }
            // 3. Video
            else if (['mp4', 'webm', 'ogv', 'mov', 'avi', 'mkv'].includes(ext)) {
                htmlToInject = `<video controls src="${url}" class="canvas-el" style="max-width:300px;"></video>`;
            }
            // 4. 3D Models (using model-viewer)
            else if (['glb', 'gltf'].includes(ext)) {
                htmlToInject = `<model-viewer src="${url}" auto-rotate camera-controls class="canvas-el" style="width: 300px; height: 300px; background-color: transparent;"></model-viewer>`;
            }
            // 5. PDF (Fixed: Use gitHack CDN to force correct Content-Type for rendering, and iframe for better compatibility)
            else if (['pdf'].includes(ext)) {
                // If it's a raw github url, switch to githack CDN to ensure correct MIME type application/pdf
                let pdfUrl = url;
                if (url.includes('raw.githubusercontent.com')) {
                    pdfUrl = url.replace('raw.githubusercontent.com', 'raw.githack.com');
                }
                // Use iframe instead of object for better PDF viewer compat in sandboxed environments
                htmlToInject = `<iframe src="${pdfUrl}" class="canvas-el pdf-viewer" style="width:100%; height:600px; border:1px solid #ccc;"></iframe>`;
            }
            // 6. CSS (Link or Inject)
            else if (['css'].includes(ext)) {
                 // Use githack for CSS too to ensure correct MIME type if linking
                 let cssUrl = url;
                 if (url.includes('raw.githubusercontent.com')) {
                    cssUrl = url.replace('raw.githubusercontent.com', 'raw.githack.com');
                 }

                 if(confirm(`Inject CSS file "${name}"?\n\nOK = Link tag (recommended)\nCancel = Raw text`)) {
                    const link = iframeDoc.createElement('link');
                    link.rel = 'stylesheet';
                    link.href = cssUrl;
                    iframeDoc.head.appendChild(link);
                    window.closeModal('asset-modal');
                    window.playSound('success');
                    window.updateStatus(`Linked CSS: ${name}`);
                    return;
                 } else {
                     await window.fetchAndInjectText(url, name);
                     return;
                 }
            }
            // 7. JS (Script or Text)
            else if (['js'].includes(ext)) {
                 let jsUrl = url;
                 if (url.includes('raw.githubusercontent.com')) {
                    jsUrl = url.replace('raw.githubusercontent.com', 'raw.githack.com');
                 }

                 if(confirm(`Inject Script file "${name}"?\n\nOK = Script tag (execute)\nCancel = Raw text`)) {
                    const script = iframeDoc.createElement('script');
                    script.src = jsUrl;
                    iframeDoc.body.appendChild(script);
                    window.closeModal('asset-modal');
                    window.playSound('success');
                    window.updateStatus(`Linked JS: ${name}`);
                    return;
                 } else {
                     await window.fetchAndInjectText(url, name);
                     return;
                 }
            }
            // 8. Fonts
            else if (['ttf', 'otf', 'woff', 'woff2'].includes(ext)) {
                 const fontName = name.split('.')[0];
                 // Fonts also need correct MIME
                 let fontUrl = url;
                 if (url.includes('raw.githubusercontent.com')) {
                    fontUrl = url.replace('raw.githubusercontent.com', 'raw.githack.com');
                 }
                 const css = `
                    @font-face {
                        font-family: '${fontName}';
                        src: url('${fontUrl}');
                    }
                 `;
                 const style = iframeDoc.createElement('style');
                 style.textContent = css;
                 iframeDoc.head.appendChild(style);
                 window.closeModal('asset-modal');
                 window.playSound('success');
                 alert(`Font '${fontName}' added! Use it in CSS as font-family: '${fontName}';`);
                 return;
            }
            // 9. Text Content
            else if (['html', 'txt', 'md', 'json', 'xml', 'csv', 'py', 'java', 'c', 'cpp', 'h'].includes(ext)) {
                 await window.fetchAndInjectText(url, name);
                 return;
            }
            // 10. Generic Fallback
            else {
                 if(confirm(`Unknown file type: ${ext}. Try to inject as text?`)) {
                     await window.fetchAndInjectText(url, name);
                     return;
                 }
                 const action = prompt(`Manual Override for .${ext}\n\nType 'img', 'video', 'audio', 'link', '3d' to force handling.`, 'link');
                 if(action === 'img') htmlToInject = `<img src="${url}" class="canvas-el" style="max-width:300px;">`;
                 else if(action === 'video') htmlToInject = `<video controls src="${url}" class="canvas-el" style="max-width:300px;"></video>`;
                 else if(action === 'audio') htmlToInject = `<audio controls src="${url}" class="canvas-el"></audio>`;
                 else if(action === '3d') htmlToInject = `<model-viewer src="${url}" auto-rotate camera-controls class="canvas-el" style="width: 300px; height: 300px;"></model-viewer>`;
                 else if(action === 'link') htmlToInject = `<a href="${url}" class="canvas-el" target="_blank">Download ${name}</a>`;
                 else return;
            }

            if (htmlToInject) {
                window.addElementHTML(htmlToInject);
                window.closeModal('asset-modal');
                window.playSound('success');
            }
        };
        
        window.fetchNeocitiesAssets = async () => {
            const grid = document.getElementById('neocities-asset-grid');
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">Contacting Neocities...</div>';
            
            // Get Config from localStorage set by deployment script
            const saved = localStorage.getItem('neocities-config');
            if(!saved) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:red;">No API Key found. Please set it in "Deploy" menu first.</div>';
                return;
            }
            let apiKey = "";
            try {
                const config = JSON.parse(saved);
                apiKey = config.apiKey;
            } catch(e) {
                 grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:red;">Config Error. Reset Deploy settings.</div>';
                 return;
            }

            if(!apiKey) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:red;">No API Key configured. Go to Deploy > Settings.</div>';
                return;
            }

            try {
                // 1. Get Info for URL (Use Safe Fetch for Proxy)
                const infoRes = await window.safeFetch('https://neocities.org/api/info', { headers: { 'Authorization': `Bearer ${apiKey}` } });
                if(!infoRes || infoRes.result !== 'success') throw new Error('Auth Failed');
                const siteUrl = `https://${infoRes.info.sitename}.neocities.org`;

                // 2. Get Files (Use Safe Fetch for Proxy)
                const listRes = await window.safeFetch('https://neocities.org/api/list', { headers: { 'Authorization': `Bearer ${apiKey}` } });
                
                grid.innerHTML = '';

                // Filter images
                const images = listRes.files.filter(f => f.path.match(/\.(jpg|jpeg|png|gif|svg|webp)$/i));

                images.forEach(img => {
                    const fullUrl = `${siteUrl}/${img.path}`;
                    const card = document.createElement('div');
                    card.className = 'asset-card';
                    card.innerHTML = `
                        <img src="${fullUrl}" class="asset-thumb" loading="lazy">
                        <div class="asset-name">${img.path}</div>
                    `;
                    card.onclick = () => {
                        window.addElementHTML(`<img src="${fullUrl}" class="canvas-el" style="max-width:300px;">`);
                        window.closeModal('asset-modal');
                        window.playSound('success');
                    };
                    grid.appendChild(card);
                });

                if(images.length === 0) {
                     grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">No images found on site.</div>';
                }

            } catch(e) {
                 grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:red;">Error: ${e.message}. <br>(If this is a CORS error, you need a browser extension to allow CORS for neocities.org)</div>`;
            }
        };

        window.fetchGithubAssets = async (path = '') => {
            const user = document.getElementById('gh-user').value;
            const repo = document.getElementById('gh-repo').value;
            const grid = document.getElementById('gh-grid');
            const breadcrumbs = document.getElementById('gh-breadcrumbs');
            
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">Loading...</div>';
            
            try {
                const response = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${path}`);
                if(!response.ok) throw new Error('Repo not found, private, or rate limited');
                const data = await response.json();
                
                grid.innerHTML = '';
                breadcrumbs.innerText = `root / ${path}`;
                
                if(path.length > 0) {
                    const upPath = path.split('/').slice(0,-1).join('/');
                    const backCard = document.createElement('div');
                    backCard.className = 'asset-card';
                    backCard.innerHTML = `<div style="font-size:30px;">üìÅ</div><div class="asset-name">..</div>`;
                    backCard.onclick = () => window.fetchGithubAssets(upPath);
                    grid.appendChild(backCard);
                }

                data.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'asset-card';
                    
                    if(item.type === 'dir') {
                        card.innerHTML = `<div style="font-size:30px;">üìÅ</div><div class="asset-name">${item.name}</div>`;
                        card.onclick = () => window.fetchGithubAssets(item.path);
                    } else {
                         // Determine preview icon based on extension
                        const ext = item.name.split('.').pop().toLowerCase();
                        let icon = 'üìÑ';
                        let isImg = false;
                        
                        if (['jpg', 'jpeg', 'png', 'gif', 'svg', 'webp', 'ico', 'bmp'].includes(ext)) { icon = 'üñºÔ∏è'; isImg = true; }
                        else if (['mp3', 'wav', 'ogg', 'm4a'].includes(ext)) icon = 'üéµ';
                        else if (['mp4', 'webm', 'mov', 'avi', 'mkv'].includes(ext)) icon = 'üé¨';
                        else if (['glb', 'gltf', 'obj'].includes(ext)) icon = 'üßä';
                        else if (['css', 'scss', 'sass', 'less'].includes(ext)) icon = 'üé®';
                        else if (['js', 'ts', 'jsx', 'tsx', 'json'].includes(ext)) icon = '‚ö°';
                        else if (['html', 'xml', 'md', 'txt'].includes(ext)) icon = 'üìù';
                        else if (['pdf'].includes(ext)) icon = 'üìï';
                        else if (['zip', 'rar', '7z', 'tar', 'gz'].includes(ext)) icon = 'üì¶';

                        const preview = isImg ? `<img src="${item.download_url}" class="asset-thumb">` : `<div style="font-size:30px;">${icon}</div>`;
                        card.innerHTML = `${preview}<div class="asset-name">${item.name}</div>`;
                        
                        // Robust Click Handler Call
                        const downloadUrl = item.download_url;
                        const itemName = item.name;
                        const itemType = item.type;
                        card.onclick = () => window.handleGithubAssetClick(itemType, downloadUrl, itemName);
                    }
                    grid.appendChild(card);
                });
            } catch(e) {
                grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:red;">Error: ${e.message}.<br>Check if repo is public.</div>`;
            }
        };

        // --- INLINE COAIEXIST TEMPLATES ---
        const COAIEXIST_TEMPLATES = {
            'coaiexist-mobile-frame': `<div style="width: 375px; height: 667px; border: 10px solid #333; border-radius: 20px; background: white; overflow: hidden; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); display: flex; flex-direction: column;"><div style="height: 20px; background: #333; width: 100%; display: flex; justify-content: center; align-items: center; flex-shrink: 0;"><div style="width: 50px; height: 4px; background: #555; border-radius: 2px;"></div></div><div class="mobile-content" style="padding: 20px; flex: 1; overflow-y: auto;"><h3>Mobile View</h3><p>Content goes here...</p></div></div>`,
            'coaiexist-pip': `<model-viewer src="https://coaiexist.wtf/assets/pollywog/pip.glb" alt="A 3D Pip" auto-rotate camera-controls style="width: 200px; height: 200px; background-color: transparent;"></model-viewer>`,
            'coaiexist-update-card': `<div class="update-card-container" style="width: 100%; max-width: 600px; box-sizing: border-box; margin: 0 auto;"><div class="update-card" style="background: linear-gradient(135deg, #0000FF 0%, #000000 100%); border: 3px dotted #FFFF00; color: #FFFFFF; padding: 20px; margin-bottom: 25px; border-radius: 10px; font-family: 'VT323', monospace; box-shadow: 0 0 20px #FF00FF; transform: rotate(-1deg); transition: all 0.2s; overflow-wrap: break-word;"><div class="update-header" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px dashed #FFFF00; margin-bottom: 15px; padding-bottom: 10px; flex-wrap: wrap; gap: 10px;"><h3 style="color: #00FF00; text-shadow: 2px 2px #FF00FF; margin: 0; font-size: 24px;">‚ú® New Update!</h3><span style="background-color: #800080; color: #FFFF00; padding: 3px 8px; border-radius: 5px; font-weight: bold; border: 1px outset #FFFFFF; font-size: 14px;">${new Date().toLocaleDateString()}</span></div><div class="update-body" style="font-size: 18px; line-height: 1.4;"><p><strong>SYSTEM MSG:</strong> Write your update here. The void is listening.</p><p style="color:#00ffcc;">> End of line.</p></div></div></div>`,
            'coaiexist-glitch': `<div style="position: relative; display: inline-block;"><h1 class="glitch-text" style="font-size: 4rem; font-weight: bold; text-transform: uppercase; position: relative; color: white; mix-blend-mode: lighten;">CYBERPUNK</h1><style>.glitch-text::before, .glitch-text::after {content: "CYBERPUNK";position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.8;}.glitch-text::before { color: #0ff; z-index: -1; animation: glitch-anim-1 0.4s infinite; clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%); transform: translate(-2px, -2px); }.glitch-text::after { color: #f0f; z-index: -2; animation: glitch-anim-2 0.4s infinite; clip-path: polygon(0 60%, 100% 60%, 100% 100%, 0 100%); transform: translate(2px, 2px); }@keyframes glitch-anim-1 { 0% { clip-path: inset(20% 0 80% 0); } 20% { clip-path: inset(60% 0 10% 0); } 40% { clip-path: inset(40% 0 50% 0); } 60% { clip-path: inset(80% 0 5% 0); } 80% { clip-path: inset(10% 0 70% 0); } 100% { clip-path: inset(30% 0 20% 0); } }@keyframes glitch-anim-2 { 0% { clip-path: inset(10% 0 60% 0); } 20% { clip-path: inset(30% 0 20% 0); } 40% { clip-path: inset(70% 0 10% 0); } 60% { clip-path: inset(20% 0 50% 0); } 80% { clip-path: inset(60% 0 30% 0); } 100% { clip-path: inset(40% 0 80% 0); } }</style><script>document.currentScript.parentElement.querySelector('.glitch-text').addEventListener('input', function(e) {this.setAttribute('data-text', this.innerText);});<\/script></div>`,
            'coaiexist-buddy-list': `<div style="width: 200px; background: #c0c0c0; border: 2px outset #fff; font-family: 'MS Sans Serif', sans-serif; font-size: 11px; color: black;"><div style="background: navy; color: white; padding: 2px 4px; font-weight: bold; display: flex; justify-content: space-between;"><span>Buddy List</span><span>_ ‚ñ° X</span></div><div style="background: white; border: 2px inset #fff; margin: 4px; height: 250px; overflow-y: scroll; padding: 2px;"><div style="font-weight: bold; margin-bottom: 2px;">‚ñº Buddies (3/12)</div><div style="padding-left: 10px; cursor: pointer;">üòä xX_DarkSoul_Xx</div><div style="padding-left: 10px; cursor: pointer; color: red;">üò° glitter_gurl</div><div style="padding-left: 10px; cursor: pointer; color: blue;">üí§ matrix_neo</div><div style="font-weight: bold; margin-top: 5px;">‚ñº Family (0/4)</div></div><div style="padding: 4px; text-align: center;"><button style="border: 1px outset white;">IM</button><button style="border: 1px outset white;">Info</button><button style="border: 1px outset white;">Setup</button></div></div>`,
            'coaiexist-winamp': `<div style="width: 300px; background: #222; color: #0f0; font-family: 'VT323', monospace; border: 2px solid #555; border-radius: 4px; padding: 5px; position: relative;"><div style="background: linear-gradient(to right, #000033, #000066); padding: 2px 5px; display: flex; justify-content: space-between; margin-bottom: 5px; cursor: move;"><span>WINAMP</span><span>_ ‚ñ° X</span></div><div style="background: black; border: 1px inset #555; height: 40px; margin-bottom: 5px; display: flex; align-items: center; justify-content: center;"><span style="color: #0f0; font-size: 20px;">01:23 *** DEMO TRACK ***</span></div><div style="display: flex; gap: 2px;"><div style="flex: 1; height: 40px; background: #333; display: flex; align-items: flex-end; padding: 2px; gap: 1px;">${Array(15).fill(0).map(() => `<div style="width: 5px; background: linear-gradient(to top, green, yellow, red); height: ${Math.random()*100}%;"></div>`).join('')}</div><div style="width: 80px; display: grid; grid-template-columns: 1fr 1fr; gap: 2px;"><button style="background:#ccc; border:1px outset #fff; font-size:10px;">PREV</button><button style="background:#ccc; border:1px outset #fff; font-size:10px;">PLAY</button><button style="background:#ccc; border:1px outset #fff; font-size:10px;">PAUSE</button><button style="background:#ccc; border:1px outset #fff; font-size:10px;">NEXT</button></div></div><div style="margin-top: 5px; display: flex; justify-content: space-between; font-size: 10px;"><span>KBPS: 128</span><span>KHZ: 44</span></div></div>`,
            'coaiexist-terminal': `<div style="width: 400px; height: 250px; background: black; border: 2px solid #333; color: #0f0; font-family: monospace; padding: 5px; overflow: hidden;"><div>Microsoft(R) Windows DOS</div><div>(C) Copyright Microsoft Corp 1990-2001.</div><br><div id="term-output">C:\\USERS\\ADMIN> <span class="blink">_</span></div><style>.blink { animation: blinker 1s linear infinite; } @keyframes blinker { 50% { opacity: 0; } }</style></div>`,
            'coaiexist-webring': `<div style="background: black; border: 2px solid #00ff00; padding: 10px; width: 100%; max-width: 400px; text-align: center; font-family: 'Courier New', monospace; color: #00ff00;"><div>=== THE COAIEXIST WEBRING ===</div><div style="margin: 10px 0; font-size: 24px;">üï∏Ô∏è</div><div style="display: flex; justify-content: space-around;"><a href="#" style="color: #00ff00;">[ Prev ]</a><a href="#" style="color: #00ff00;">[ Random ]</a><a href="#" style="color: #00ff00;">[ Next ]</a></div></div>`,
            'coaiexist-cyber-badge': `<div style="display: flex; gap: 5px; flex-wrap: wrap;"><img src="https://anlucas.neocities.org/88x31/notepad.gif" style="image-rendering: pixelated;"><img src="https://anlucas.neocities.org/88x31/ie_logo.gif" style="image-rendering: pixelated;"><img src="https://anlucas.neocities.org/88x31/netscape.gif" style="image-rendering: pixelated;"><img src="https://anlucas.neocities.org/88x31/now.gif" style="image-rendering: pixelated;"></div>`,
            'coaiexist-hit-counter': `<div style="display: inline-block; background: black; border: 2px inset #555; padding: 2px 5px; color: red; font-family: 'Courier New', monospace; font-weight: bold; letter-spacing: 3px; font-size: 14px;">0 3 4 8 2 1</div>`,
            'coaiexist-pet': `<div style="width: 100px; text-align: center; position: relative;"><div style="background: #e0f0ff; border: 4px solid #333; border-radius: 50% 50% 10px 10px; padding: 10px;"><img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExa244a2o1Ynd5Ymx5a2w1Ynd5Ymx5a2w1Ynd5Ymx5YSZlcD12MV9zdGlja2Vyc19zZWFyY2gmY3Q9cw/3o7TKMt1VVNkHVyPaE/giphy.gif" style="width: 50px; image-rendering: pixelated;"></div><div style="background: #333; color: white; font-size: 10px; padding: 2px; margin-top: 2px;">TAMAGOTCHI</div></div>`,
            'coaiexist-weather': `<div style="width: 150px; background: linear-gradient(to bottom, #87CEFA, #4682B4); border: 2px solid white; border-radius: 8px; padding: 10px; color: white; font-family: sans-serif; text-align: center; box-shadow: 2px 2px 5px rgba(0,0,0,0.3);"><div style="font-size: 12px; text-transform: uppercase; margin-bottom: 5px;">Tokyo</div><div style="font-size: 32px;">‚òÄÔ∏è</div><div style="font-size: 24px; font-weight: bold;">24¬∞C</div><div style="font-size: 10px; margin-top: 5px;">Feels like 26¬∞C</div></div>`,
            'coaiexist-music-viz': `<div style="display: flex; align-items: flex-end; gap: 2px; height: 50px; padding: 10px; background: rgba(0,0,0,0.5); border-radius: 8px;">${[1,2,3,4,5,6,7,8].map(i => `<div style="width: 8px; background: #00f0ff; animation: viz${i} 0.5s infinite alternate ease-in-out; height: 20%;"></div><style>@keyframes viz${i} { 0% { height: 20%; } 100% { height: ${Math.floor(Math.random()*80+20)}%; } }</style>`).join('')}</div>`,
            
            // --- NOSTALGIA PACK ---
            'coaiexist-cool-s': `<div style="width: 60px; height: 120px; margin: 10px auto;"><svg viewBox="0 0 100 200" style="width:100%; height:100%; stroke:#00f0ff; stroke-width:8; stroke-linecap:round; stroke-linejoin:round; fill:none; filter:drop-shadow(0 0 5px cyan);"><path d="M 20,60 V 20 L 50,0 L 80,20 V 60" /><path d="M 20,140 V 180 L 50,200 L 80,180 V 140" /><path d="M 20,60 L 50,100 L 80,60" /><path d="M 20,140 L 50,100 L 80,140" /><line x1="20" y1="60" x2="20" y2="140" /><line x1="80" y1="60" x2="80" y2="140" /></svg></div>`,
            'coaiexist-dvd-logo': `<div style="width: 100%; height: 200px; background: #000; position: relative; overflow: hidden; border: 2px solid #333;"><div style="width: 60px; height: 30px; position: absolute; animation: dvd-x 4s linear infinite alternate, dvd-y 6.3s linear infinite alternate; top: 0; left: 0;"><div style="width: 100%; height: 100%; background: blue; color: white; display: flex; justify-content: center; align-items: center; font-weight: bold; border-radius: 4px; box-shadow: 0 0 10px blue;">DVD</div></div><style>@keyframes dvd-x { 0% { left: 0; } 100% { left: calc(100% - 60px); } } @keyframes dvd-y { 0% { top: 0; } 100% { top: calc(100% - 30px); } }</style></div>`,
            'coaiexist-glitter-text': `<h1 style="font-size: 48px; font-weight: bold; color: gold; background-image: url('https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExMzc1ZWY5ZjIyM2ExZjU4Y2YwODU4YzQ4ZDM5ZjA5YzYwYzcwYjQxZSZlcD12MV9pbnRlcm5hbF9naWZzX2dpZklkJmN0PXM/3o7TKMt1VVNkHVyPaE/giphy.gif'); -webkit-background-clip: text; color: transparent; filter: drop-shadow(0 0 2px gold);">GLITTER</h1>`,
            'coaiexist-hazard-tape': `<div style="height: 40px; width: 100%; background: repeating-linear-gradient(-45deg, #ffd700, #ffd700 20px, #000 20px, #000 40px); border: 2px solid black;"></div>`,
            'coaiexist-guestbook-btn': `<button style="background: #c0c0c0; border: 2px outset white; padding: 4px 8px; display: flex; align-items: center; gap: 6px; cursor: pointer; font-family: sans-serif; font-size: 12px;"><span style="font-size: 16px;">üìñ</span> Sign My Guestbook!</button>`,
            
            // --- BASIC TYPES ---
            'typewriter': `<h2 style="font-family: monospace; overflow: hidden; border-right: .15em solid orange; white-space: nowrap; margin: 0 auto; letter-spacing: .15em; animation: typing 3.5s steps(30, end), blink-caret .5s step-end infinite;">Hello World</h2><style>@keyframes typing { from { width: 0 } to { width: 100% } } @keyframes blink-caret { from, to { border-color: transparent } 50% { border-color: orange } }</style>`,
            'blockquote': `<blockquote style="border-left: 4px solid #ccc; margin: 1.5em 10px; padding: 0.5em 10px; quotes: '\\201C''\\201D''\\2018''\\2019';"><p style="display: inline;">The web is what you make of it.</p><footer style="color: #666; margin-top: 5px;">‚Äî Internet User</footer></blockquote>`,
            'blink': `<span style="animation: blinker 1s linear infinite;">BLINKING TEXT</span><style>@keyframes blinker { 50% { opacity: 0; } }</style>`,
            'avatar': `<img src="https://i.pravatar.cc/150?img=12" style="border-radius: 50%; width: 64px; height: 64px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">`,
            'marquee': `<marquee scrollamount="5" style="background:#000; color:#0f0; font-family:monospace; padding:5px;">*** WELCOME TO THE ZONE ***</marquee>`,
            'accordion': `<details style="border:1px solid #aaa; border-radius:4px; padding:5px;"><summary style="cursor:pointer; font-weight:bold;">Click to expand</summary><p style="margin-top:5px;">Hidden content revealed!</p></details>`,
            'badge': `<span style="background:#00d1b2; color:white; padding:2px 8px; border-radius:10px; font-size:10px; font-weight:bold; text-transform:uppercase;">New</span>`,
            'alert': `<div style="background:#fee; color:#c00; border:1px solid #fcc; padding:10px; border-radius:4px;"><strong>Alert:</strong> Something happened!</div>`,
            'progress': `<div style="width:100%; background:#eee; border-radius:10px; height:20px; overflow:hidden;"><div style="width:60%; background:#3273dc; height:100%;"></div></div>`,
            'bulma-hero': `<section style="background-color: #00d1b2; padding: 3rem 1.5rem; text-align: center; color: white;"><h1 style="font-size: 2rem; font-weight: bold;">Hero Title</h1><p style="font-size: 1.25rem;">Hero subtitle goes here.</p></section>`,
            'bulma-navbar': `<nav style="background: white; display: flex; justify-content: space-between; padding: 10px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); align-items: center;"><div style="font-weight: bold; font-size: 18px;">Logo</div><div style="display: flex; gap: 15px;"><a href="#" style="color: #4a4a4a; text-decoration: none;">Home</a><a href="#" style="color: #4a4a4a; text-decoration: none;">About</a><a href="#" style="color: #4a4a4a; text-decoration: none;">Contact</a></div></nav>`,
            'bulma-message': `<article style="background-color: #f5f5f5; border-radius: 4px; font-size: 1rem;"><div style="background-color: #4a4a4a; color: #fff; padding: 0.5em 0.75em; border-radius: 4px 4px 0 0; font-weight: 700;">Message Header</div><div style="padding: 1em; border: 1px solid #dbdbdb; border-top: none; border-radius: 0 0 4px 4px; color: #4a4a4a;">Message body text here.</div></article>`,
            'table': `<table style="width:100%; border-collapse: collapse; margin: 10px 0;"><thead><tr style="background: #eee;"><th style="border: 1px solid #ccc; padding: 8px;">Header 1</th><th style="border: 1px solid #ccc; padding: 8px;">Header 2</th></tr></thead><tbody><tr><td style="border: 1px solid #ccc; padding: 8px;">Row 1 Col 1</td><td style="border: 1px solid #ccc; padding: 8px;">Row 1 Col 2</td></tr><tr><td style="border: 1px solid #ccc; padding: 8px;">Row 2 Col 1</td><td style="border: 1px solid #ccc; padding: 8px;">Row 2 Col 2</td></tr></tbody></table>`,
            'code': `<pre style="background: #2d2d2d; color: #ccc; padding: 10px; border-radius: 4px; overflow-x: auto;"><code>console.log('Hello World');</code></pre>`,
            
            // All other existing templates...
            'coaiexist-construction': `
            <div style="width: 100%; background: repeating-linear-gradient(45deg, #ffee00, #ffee00 10px, #000000 10px, #000000 20px); padding: 10px; text-align: center; border: 2px solid black;">
                <div style="background: black; color: yellow; display: inline-block; padding: 5px 15px; font-family: 'Arial Black', sans-serif; font-weight: bold; border: 2px solid white;">
                    üöß UNDER CONSTRUCTION üöß
                </div>
            </div>`,

            'coaiexist-clown-card': `
            <div style="background-color: #FFFF00; background-image: radial-gradient(circle, #FF0000 20%, transparent 20%), radial-gradient(circle, #0000FF 20%, transparent 20%); background-size: 30px 30px; background-position: 0 0, 15px 15px; border: 5px ridge #00FF00; padding: 20px; font-family: 'Comic Sans MS', 'Comic Neue', cursive; text-align: center; color: #0000FF; box-shadow: 5px 5px 0px #FF00FF;">
                <h2 style="background: white; display: inline-block; padding: 5px; border: 2px dashed red; transform: rotate(-3deg);">Welcome 2 My Page!!</h2>
                <p style="background: white; padding: 5px; margin-top: 10px; font-weight: bold;">Don't forget to sign the guestbook!</p>
                <marquee style="background: white; border: 1px solid black; margin-top: 10px; color: red;">Thanks for visiting!!! You are visitor number 1000000</marquee>
            </div>`,

            'coaiexist-wordart': `
            <div style="font-family: 'Arial Black', sans-serif; font-size: 40px; font-weight: bold; color: #00F0FF; -webkit-text-stroke: 1px #0000CC; transform: skewY(-10deg) scaleY(1.5); text-shadow: 4px 4px 0px #CCC; display: inline-block; margin: 20px;">
                WORD ART
            </div>`,

            'coaiexist-rainbow-hr': `
            <div style="height: 8px; background: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet); border-radius: 4px; margin: 10px 0;"></div>`,

            'coaiexist-flames': `
            <div style="font-family: Impact, sans-serif; font-size: 50px; font-weight: bold; color: #FF0000; text-shadow: 0px -2px 4px #FFFF00, 2px -4px 6px #FF6600; letter-spacing: 2px; display: inline-block;">
                üî• HOT STUFF üî•
            </div>`,
            
            'coaiexist-spin-new': `
            <div style="display: inline-block; position: relative; width: 100px; height: 100px; animation: spin-star 4s linear infinite;">
                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: yellow; clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); border: 2px solid orange;"></div>
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: 'Comic Sans MS', cursive; font-weight: bold; color: red; font-size: 20px;">NEW!</div>
            </div>
            <style>@keyframes spin-star { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>`,

            'coaiexist-comic-btn': `
            <button style="background: #FF00FF; border: 5px ridge #00FF00; color: #FFFF00; padding: 15px 30px; font-family: 'Comic Sans MS', cursive; font-size: 24px; font-weight: bold; cursor: pointer; box-shadow: 5px 5px 0px #000000; transition: transform 0.1s;" onmousedown="this.style.transform='scale(0.95)'" onmouseup="this.style.transform='scale(1)'">
                CLICK HERE!!!
            </button>`,

            'coaiexist-blink-text': `
            <div style="font-family: 'Courier New', monospace; font-size: 24px; color: #00FF00; background: black; padding: 5px; display: inline-block;">
                <span style="animation: blinker 0.5s linear infinite;">‚ö†Ô∏è WARNING: COOL CONTENT ‚ö†Ô∏è</span>
            </div>
            <style>@keyframes blinker { 50% { opacity: 0; } }</style>`,

            'coaiexist-cursor-trail': `
            <script>
                (function(){
                    const trail = [];
                    const maxTrail = 20;
                    document.addEventListener('mousemove', (e) => {
                        const el = document.createElement('div');
                        el.innerText = '‚òÖ';
                        el.style.position = 'fixed';
                        el.style.left = e.clientX + 'px';
                        el.style.top = e.clientY + 'px';
                        el.style.color = 'hsl(' + (Date.now() % 360) + ', 100%, 50%)';
                        el.style.pointerEvents = 'none';
                        el.style.zIndex = '999999';
                        el.style.fontSize = '12px';
                        document.body.appendChild(el);
                        trail.push({el, created: Date.now()});
                        
                        setTimeout(() => {
                            el.remove();
                        }, 500);
                    });
                })();
            <\/script>
            <div style="border: 1px dashed #ccc; padding: 5px; font-size: 10px; color: #666; display: inline-block;">[ Mouse Trail Script Active ]</div>
            `,
            
            'coaiexist-y2k-blob': `
            <div style="width: 150px; height: 120px; background: linear-gradient(135deg, #e0e0e0 0%, #ffffff 50%, #a0a0a0 100%); border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; box-shadow: inset 5px 5px 10px rgba(255,255,255,1), inset -5px -5px 10px rgba(0,0,0,0.2), 5px 5px 15px rgba(0,0,0,0.2); display:flex; align-items:center; justify-content:center; color:#666; font-weight:bold; font-family:sans-serif;">
                LIQUID
            </div>`,
            'coaiexist-alien-badge': `
            <div style="background: #000; border: 2px solid #0f0; border-radius: 50%; width: 80px; height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 10px #0f0;">
                <div style="font-size: 30px;">üëΩ</div>
                <div style="font-size: 10px; color: #0f0; font-family: monospace;">BELIEVE</div>
            </div>`,
            'coaiexist-chrome-text': `
            <h2 style="font-family: sans-serif; font-size: 40px; font-weight: 900; font-style: italic; text-transform: uppercase; color: #ccc; background: linear-gradient(to bottom, #fff 0%, #ccc 50%, #000 51%, #666 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; -webkit-text-stroke: 1px silver; filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.5));">
                CHROME
            </h2>`,
            'coaiexist-tribal-mark': `
            <div style="width: 200px; height: 50px; background: black; clip-path: polygon(0% 40%, 10% 20%, 20% 40%, 30% 10%, 40% 40%, 50% 0%, 60% 40%, 70% 10%, 80% 40%, 90% 20%, 100% 40%, 100% 60%, 90% 80%, 80% 60%, 70% 90%, 60% 60%, 50% 100%, 40% 60%, 30% 90%, 20% 60%, 10% 80%, 0% 60%);"></div>`,

            'coaiexist-vampire-card': `
            <div style="background: #0a0a0a; border: 3px double #800000; color: #800000; padding: 20px; font-family: 'Times New Roman', serif; text-align: center; max-width: 300px; box-shadow: 0 0 20px rgba(128,0,0,0.3);">
                <h3 style="border-bottom: 1px solid #800000; margin-bottom: 10px; padding-bottom: 5px;">The Void</h3>
                <p style="font-style: italic; color: #666;">"Eternal night awaits..."</p>
                <div style="font-size: 24px; margin-top: 10px;">ü¶á üï∏Ô∏è ‚ö∞Ô∏è</div>
            </div>`,
            'coaiexist-angel-cloud': `
            <div style="background: rgba(255,255,255,0.8); backdrop-filter: blur(5px); border-radius: 50px; padding: 20px 40px; color: #5ca6ff; font-family: 'Comic Neue', cursive; font-weight: bold; box-shadow: 0 0 20px rgba(255,255,255,0.8), 0 0 40px rgba(100,200,255,0.4); border: 2px solid white; text-shadow: 0 0 5px white;">
                ‚òÅÔ∏è dreamscape ‚òÅÔ∏è
            </div>`,
            'coaiexist-aura-text': `
            <h1 style="color: white; text-shadow: 0 0 10px #ff00cc, 0 0 20px #ff00cc, 0 0 30px #00f0ff, 0 0 40px #00f0ff; font-family: sans-serif; font-weight: 100; letter-spacing: 5px;">
                A U R A
            </h1>`,
            'coaiexist-goth-quote': `
            <blockquote style="background: black; color: white; border-left: 4px solid #666; padding: 10px; font-family: monospace; font-size: 12px;">
                <span style="color: #ff0000;">root@darkweb:~$</span> echo "Reality is a glitch."
            </blockquote>`,

            'coaiexist-window': `
            <div class="draggable-window" style="position: absolute; top: 50px; left: 50px; width: 300px; background: #c0c0c0; border: 2px outset #fff; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); z-index: 100;">
                <div class="window-header" style="background: navy; color: white; padding: 2px 5px; cursor: move; font-weight: bold; font-family: sans-serif; display: flex; justify-content: space-between; font-size: 12px;">
                    <span>My Window.exe</span>
                    <div style="display:flex; gap:2px;">
                       <button style="background:#c0c0c0; border:1px outset #fff; width:14px; height:14px; font-size:9px;">_</button>
                       <button style="background:#c0c0c0; border:1px outset #fff; width:14px; height:14px; font-size:9px;">X</button>
                    </div>
                </div>
                <div class="window-content" style="padding: 10px; color: black; font-family: 'MS Sans Serif', sans-serif; font-size: 13px;">
                    <p>Welcome to the future!</p>
                    <p>Drag this window around.</p>
                    <button style="margin-top:5px; padding:2px 10px;">OK</button>
                </div>
            </div>
            <script>
                (function() {
                    const wins = document.getElementsByClassName('draggable-window');
                    const win = wins[wins.length - 1]; // Get last added
                    const header = win.querySelector('.window-header');
                    let isDragging = false;
                    let offsetX, offsetY;

                    header.addEventListener('mousedown', (e) => {
                        isDragging = true;
                        offsetX = e.clientX - win.getBoundingClientRect().left;
                        offsetY = e.clientY - win.getBoundingClientRect().top;
                        win.style.zIndex = 1000; // Bring to front
                    });

                    document.addEventListener('mousemove', (e) => {
                        if (isDragging) {
                            win.style.left = (e.clientX - offsetX) + 'px';
                            win.style.top = (e.clientY - offsetY) + 'px';
                        }
                    });

                    document.addEventListener('mouseup', () => {
                        isDragging = false;
                    });
                })();
            <\/script>`,
            
            'coaiexist-sticker': `
            <img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExMzc1ZWY5ZjIyM2ExZjU4Y2YwODU4YzQ4ZDM5ZjA5YzYwYzcwYjQxZSZlcD12MV9pbnRlcm5hbF9naWZzX2dpZklkJmN0PXM/l4FGr3nzq5u0m02vm/giphy.gif" style="position: absolute; top: 100px; left: 100px; width: 80px; transform: rotate(-15deg); cursor: grab; filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.2)); z-index:50;">
            `,

            'coaiexist-crt': `
            <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%); background-size: 100% 4px; box-shadow: inset 0 0 100px rgba(0,0,0,0.5);"></div>
            `,

            'coaiexist-cursor-sparkles': `
            <script>
                (function() {
                    const colors = ["#ff00cc", "#00f0ff", "#ccff00", "#ffffff"];
                    document.addEventListener('mousemove', function(e) {
                        if(Math.random() > 0.5) return; // Throttle
                        const particle = document.createElement('div');
                        particle.style.position = 'fixed';
                        particle.style.left = e.clientX + 'px';
                        particle.style.top = e.clientY + 'px';
                        particle.style.width = '4px';
                        particle.style.height = '4px';
                        particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                        particle.style.pointerEvents = 'none';
                        particle.style.borderRadius = '50%';
                        particle.style.zIndex = '99999';
                        document.body.appendChild(particle);

                        // Animate
                        let opacity = 1;
                        let top = e.clientY;
                        const interval = setInterval(() => {
                            opacity -= 0.05;
                            top += 1;
                            particle.style.opacity = opacity;
                            particle.style.top = top + 'px';
                            if(opacity <= 0) {
                                clearInterval(interval);
                                particle.remove();
                            }
                        }, 20);
                    });
                })();
            <\/script>`
        };
        const BULMA_TEMPLATES = { 'bulma-card': `<div style="border:1px solid #dbdbdb;border-radius:6px;background:white;max-width:300px;"><div style="padding:20px;"><h3>Title</h3><p>Content</p></div></div>` };
        Object.assign(window.elementTemplates, COAIEXIST_TEMPLATES, BULMA_TEMPLATES);

        // --- HISTORY SYSTEM ---
        // History is now managed per-page in the pages object.
        const MAX_HISTORY = 50;
        let isUndoRedoAction = false;

        // --- SOUND SYSTEM ---
        const sounds = {};
        let soundsInitialized = false;
        let soundInitPromise = null;

        function initializeSounds() {
            if (soundsInitialized) return;
            if (typeof Tone === 'undefined') return;
            try {
                sounds.pop = new Tone.PolySynth(Tone.Synth).toDestination();
                sounds.boop = new Tone.PolySynth(Tone.Synth).toDestination();
                sounds.success = new Tone.PolySynth(Tone.Synth).toDestination();
                sounds.error = new Tone.PolySynth(Tone.Synth).toDestination();
                soundsInitialized = true;
            } catch(e) { console.error(e); }
        }

        async function ensureSoundInitialized() {
            if (soundsInitialized) return;
            if (!soundInitPromise && typeof Tone !== 'undefined') {
                soundInitPromise = Tone.start().then(() => initializeSounds());
            }
            return soundInitPromise;
        }

        window.toggleSound = async () => {
            window.soundEnabled = !window.soundEnabled;
            const btn = document.getElementById('sound-toggle-btn');
            if(btn) {
                btn.innerText = window.soundEnabled ? "üîä Sound: On" : "üîá Sound: Off";
                btn.classList.toggle('btn-pink', !window.soundEnabled);
            }
            
            try {
                if (window.soundEnabled) {
                    await Tone.start();
                    if (Tone.context.state !== 'running') {
                        await Tone.context.resume();
                    }
                } else {
                    // Fix for Tone.context.suspend error
                    const ctx = Tone.context.rawContext || Tone.context;
                    if (ctx && typeof ctx.suspend === 'function') {
                        await ctx.suspend();
                    }
                }
            } catch (e) {
                console.warn("Audio context state change failed:", e);
            }
        };

        window.playSound = (type, note = 'C5') => {
            if(!window.soundEnabled) return;
            ensureSoundInitialized().then(() => {
                if(sounds[type]) sounds[type].triggerAttackRelease(note, '16n');
            });
        };
        
        window.showStamp = (emoji) => {
            const stamp = document.createElement('div');
            stamp.innerText = emoji;
            stamp.style.cssText = `position:fixed; left:${Math.random()*80+10}%; top:${Math.random()*80+10}%; font-size:48px; pointer-events:none; z-index:9999; animation: floatUp 1s ease-out forwards; opacity: 0;`;
            const style = document.createElement('style');
            style.innerHTML = `@keyframes floatUp { 0% { opacity: 1; transform: scale(0.5); } 100% { opacity: 0; transform: scale(1.5) translateY(-50px); } }`;
            document.head.appendChild(style);
            document.body.appendChild(stamp);
            setTimeout(() => stamp.remove(), 1000);
        };

        // --- HISTORY FUNCTIONS (Updated for Multi-Page) ---
        window.saveState = () => {
            if (isUndoRedoAction) return;
            if (!iframeDoc || !iframeDoc.body) return;
            
            const page = getCurrentPage();
            const currentHtml = iframeDoc.documentElement.innerHTML;
            
            if (page.historyIndex >= 0 && page.history[page.historyIndex] === currentHtml) return;
            
            if (page.historyIndex < page.history.length - 1) {
                page.history = page.history.slice(0, page.historyIndex + 1);
            }
            
            page.history.push(currentHtml);
            if (page.history.length > MAX_HISTORY) {
                page.history.shift();
            } else {
                page.historyIndex++;
            }
            
            page.content = currentHtml; // Update current content ref
            updateUndoButtons();
            renderLayers();
        };

        function updateUndoButtons() {
            const page = getCurrentPage();
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');
            
            if(undoBtn) {
                undoBtn.disabled = page.historyIndex <= 0;
                undoBtn.classList.toggle('active', page.historyIndex > 0);
            }
            
            if(redoBtn) {
                redoBtn.disabled = page.historyIndex >= page.history.length - 1;
                redoBtn.classList.toggle('active', page.historyIndex < page.history.length - 1);
            }
        }

        window.undo = () => {
            const page = getCurrentPage();
            if (page.historyIndex > 0) {
                isUndoRedoAction = true;
                page.historyIndex--;
                restoreState(page.history[page.historyIndex]);
                isUndoRedoAction = false;
                window.playSound('pop', 'D5');
            }
        };

        window.redo = () => {
            const page = getCurrentPage();
            if (page.historyIndex < page.history.length - 1) {
                isUndoRedoAction = true;
                page.historyIndex++;
                restoreState(page.history[page.historyIndex]);
                isUndoRedoAction = false;
                window.playSound('pop', 'E5');
            }
        };

        function restoreState(html) {
            if (!iframeDoc) return;
            iframeDoc.open();
            iframeDoc.write(html);
            iframeDoc.close();
            
            const page = getCurrentPage();
            page.content = html;

            setTimeout(() => {
                 setupIframeInteractions();
                 window.ensureAnimationStyles();
                 deselect();
            }, 10);
            
            updateUndoButtons();
            renderLayers();
        }
        
        // --- INTERACTION HANDLER ---
        function setupIframeInteractions() {
            if(!iframeDoc || !iframeDoc.body) return;
            
            // 0. CAPTURE PHASE LINK INTERCEPTOR (Crucial for preventing navigation)
            iframeDoc.addEventListener('click', (e) => {
                const link = e.target.closest('a') || e.target.closest('button');
                // Check if we are in text-editing mode for this element
                const isEditing = link && link.isContentEditable;
                
                if(link) {
                    if(!document.body.classList.contains('preview-mode')) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation(); // Force stop all other handlers
                        
                        if(!isEditing) {
                            window.selectElement(link);
                            window.updateStatus(`Link intercepted: ${link.href || 'button'}`);
                        }
                        return false;
                    }
                }
            }, true); // True = Capture phase (happens before bubble)

            // 1. Click Selection & Global Dismiss
            iframeDoc.body.addEventListener('click', (e) => {
                // If it was a drag, do nothing here (mouseup handled it)
                if(window.wasDragging) { window.wasDragging = false; return; }
                
                // Context menu close
                closeContextMenu();

                // Selection logic
                if(e.target !== iframeDoc.body) {
                     // Check if clicking inside already selected text element (editing)
                     if(window.selectedEl === e.target && e.target.isContentEditable) {
                         return; 
                     }
                     selectElement(e.target);
                }
                else deselect();
            });
            
            // Global key handler is attached in initCanvas via window.handleGlobalKeys
            // But we ensure it here too just in case
            iframeDoc.removeEventListener('keydown', window.handleGlobalKeys);
            iframeDoc.addEventListener('keydown', window.handleGlobalKeys);

            // 2. Context Menu (Improved for deep elements)
            iframeDoc.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                // Find deepest element under cursor (including inside navbars)
                const target = e.target.closest('.canvas-el') || e.target;
                
                if(target && target !== iframeDoc.body) {
                    selectElement(target);
                
                    const menu = document.getElementById('context-menu');
                    const iframeRect = document.getElementById('canvas-frame').getBoundingClientRect();
                    
                    menu.style.display = 'block';
                    // Positioning relative to viewport
                    menu.style.left = (iframeRect.left + e.clientX) + 'px';
                    menu.style.top = (iframeRect.top + e.clientY) + 'px';
                }
            });

            // 3. Double Click Text Edit
            iframeDoc.body.addEventListener('dblclick', (e) => {
                const el = e.target.closest('.canvas-el') || e.target;
                if(el && el !== iframeDoc.body) {
                    e.preventDefault(); // Stop default (like selecting word)
                    tryEditText(el);
                }
            });
            
            // Track mouse coordinates for Status Bar
            iframeDoc.body.addEventListener('mousemove', (e) => {
                const status = document.getElementById('mouse-coords');
                if(status) status.innerText = `${Math.round(e.clientX)},${Math.round(e.clientY)}`;
            });

            function tryEditText(el) {
                 if(el !== iframeDoc.body && !el.isContentEditable) {
                     // Check if it's text-like
                     // Expanded list to include more block types
                     if(['DIV','P','H1','H2','H3','H4','H5','H6','SPAN','A','LI','BUTTON','LABEL','TD','TH','B','I','STRONG','EM','SMALL','BIG'].includes(el.tagName)) {
                         el.contentEditable = true;
                         el.focus();
                         el.style.outline = "2px dashed #ff00cc";
                         
                         // Temporarily disable pointer events on children to prevent clicking links inside while editing
                         Array.from(el.children).forEach(c => c.style.pointerEvents = 'none');
                         
                         // Open Sidebar Text Tab automatically
                         document.getElementById('sidebar').classList.add('active');
                         document.getElementById('tab-text').click();
                         
                         // Enhanced Enter Key Handling
                         const onKeydown = (e) => {
                             e.stopPropagation(); // Prevent global shortcuts while typing
                             
                             if (e.key === 'Enter') {
                                 // Shift+Enter allowed for line break
                                 if (e.shiftKey) return;

                                 // For single-line elements, Enter = Commit (Blur)
                                 if (['H1','H2','H3','H4','H5','H6','BUTTON','SPAN','A','LABEL','TH'].includes(el.tagName)) {
                                     e.preventDefault();
                                     el.blur(); 
                                 } 
                             }
                         };
                         el.addEventListener('keydown', onKeydown);

                         const onBlur = (e) => {
                             // Check if focus moved to sidebar toolbar, if so keep editing?
                             // Actually, simple blur commit is safer for now.
                             el.contentEditable = false;
                             el.style.outline = "";
                             // Re-enable pointer events
                             Array.from(el.children).forEach(c => c.style.pointerEvents = '');
                             
                             window.saveState();
                             el.removeEventListener('blur', onBlur);
                             el.removeEventListener('keydown', onKeydown);
                         };
                         el.addEventListener('blur', onBlur);
                     }
                }
            }

            // 4. Drag & Drop
            iframeDoc.body.addEventListener('dragover', e => e.preventDefault());
            iframeDoc.body.addEventListener('drop', e => {
                e.preventDefault();
                const type = e.dataTransfer.getData('type');
                if(type) addElement(type, e.clientX, e.clientY);
            });

            // 5. DEFAULT FREE DRAG MODE (With Threshold)
            let activeDragEl = null;
            let dragOffsetX = 0;
            let dragOffsetY = 0;
            let startX = 0;
            let startY = 0;
            let isDragStarted = false;

            iframeDoc.body.addEventListener('mousedown', (e) => {
                const target = e.target.closest('.canvas-el');
                // Only start drag if NOT editing text
                if (target && target !== iframeDoc.body && !target.isContentEditable) {
                    activeDragEl = target;
                    startX = e.clientX;
                    startY = e.clientY;
                    isDragStarted = false;
                    
                    const rect = activeDragEl.getBoundingClientRect();
                    dragOffsetX = e.clientX - rect.left;
                    dragOffsetY = e.clientY - rect.top;
                }
            });

            iframeDoc.addEventListener('mousemove', (e) => {
                if (activeDragEl) {
                    // Check threshold (5px) before starting drag
                    if (!isDragStarted) {
                        const dist = Math.sqrt(Math.pow(e.clientX - startX, 2) + Math.pow(e.clientY - startY, 2));
                        if (dist > 5) {
                            isDragStarted = true;
                            // Now we are definitely dragging
                            window.selectElement(activeDragEl);
                            activeDragEl.style.zIndex = '9999';
                            activeDragEl.style.cursor = 'grabbing';
                            
                            // Ensure absolute positioning if not already
                            const cs = window.getComputedStyle(activeDragEl);
                            if (cs.position === 'static' || cs.position === 'relative') {
                                const rect = activeDragEl.getBoundingClientRect();
                                const bodyRect = iframeDoc.body.getBoundingClientRect();
                                activeDragEl.style.position = 'absolute';
                                activeDragEl.style.left = (rect.left - bodyRect.left) + 'px';
                                activeDragEl.style.top = (rect.top - bodyRect.top) + 'px';
                                activeDragEl.style.width = rect.width + 'px';
                                activeDragEl.style.margin = '0';
                                activeDragEl.style.transform = 'none';
                            }
                        }
                    }

                    if (isDragStarted) {
                        e.preventDefault();
                        const bodyRect = iframeDoc.body.getBoundingClientRect();
                        let x = e.clientX - bodyRect.left - dragOffsetX;
                        let y = e.clientY - bodyRect.top - dragOffsetY;
                        
                        // Subtle Snap (10px grid)
                        // x = Math.round(x / 5) * 5;
                        // y = Math.round(y / 5) * 5;
                        
                        activeDragEl.style.left = x + 'px';
                        activeDragEl.style.top = y + 'px';
                        
                        if(window.selectedEl === activeDragEl) window.renderProperties();
                    }
                }
            });

            iframeDoc.addEventListener('mouseup', () => {
                if (activeDragEl) {
                    activeDragEl.style.cursor = '';
                    activeDragEl.style.zIndex = '';
                    if (isDragStarted) {
                        window.wasDragging = true;
                        window.saveState();
                    }
                    activeDragEl = null;
                    isDragStarted = false;
                }
            });
        }
        
        window.closeContextMenu = () => {
            const menu = document.getElementById('context-menu');
            if(menu) menu.style.display = 'none';
        };

        window.ctxAction = (action) => {
            // Check active element in iframe first, then main window selection
            let el = window.selectedEl;
            
            if(!el && action !== 'paste') return;
            
            if(action === 'del') { el.remove(); window.deselect(); window.saveState(); }
            else if(action === 'dup') { const clone = el.cloneNode(true); el.parentNode.insertBefore(clone, el.nextSibling); window.saveState(); }
            else if(action === 'up') { if(el.previousElementSibling) { el.parentNode.insertBefore(el, el.previousElementSibling); window.saveState(); } }
            else if(action === 'down') { if(el.nextElementSibling) { el.parentNode.insertBefore(el.nextElementSibling, el); window.saveState(); } }
            else if(action === 'copy') {
                 window.clipboardEl = el.cloneNode(true);
                 window.updateStatus('Element Copied');
            }
            else if(action === 'cut') {
                 window.clipboardEl = el.cloneNode(true);
                 el.remove();
                 window.deselect();
                 window.saveState();
                 window.updateStatus('Element Cut');
            }
            else if(action === 'paste') {
                 if(window.clipboardEl) {
                      const clone = window.clipboardEl.cloneNode(true);
                      window.processLayerization(clone);
                      // Paste after current selection or at body end
                      if(el && el.parentNode) el.parentNode.insertBefore(clone, el.nextSibling);
                      else if (iframeDoc) iframeDoc.body.appendChild(clone);
                      
                      window.selectElement(clone);
                      window.saveState();
                      window.updateStatus('Element Pasted');
                 }
            }
            else if(action === 'link') {
                const url = prompt('Enter URL:', 'https://');
                if(url) {
                    if(el.tagName === 'A') {
                        el.href = url;
                    } else if (window.getSelection && window.getSelection().rangeCount > 0) {
                         const doc = iframeDoc;
                         doc.execCommand('createLink', false, url);
                    } else {
                       const a = document.createElement('a');
                       a.href = url;
                       el.parentNode.insertBefore(a, el);
                       a.appendChild(el);
                       window.selectElement(a);
                    }
                   window.saveState();
                }
            }
            closeContextMenu();
        };
        
        // Removed toggleDragMode as it's now default behavior

        // --- EXPORTED FUNCTIONS ---
        window.initCanvas = function(content = null, resetHistory = false) {
            iframeDoc = iframe.contentWindow.document;
            iframeDoc.open();
            
            if(content) {
                // Auto-layerize imported content immediately
                const parser = new DOMParser();
                const tempDoc = parser.parseFromString(content, 'text/html');
                window.processLayerization(tempDoc.body);
                // Also ensure styles exist
                if(!tempDoc.head.innerHTML.includes('global-theme-style')) {
                     const s = tempDoc.createElement('style'); s.id='global-theme-style'; tempDoc.head.appendChild(s);
                }
                iframeDoc.write(tempDoc.documentElement.outerHTML);
            } else {
                // Default blank canvas
                iframeDoc.write(`<!DOCTYPE html>
                    <html>
                    <head>
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <style>
                            body { font-family: 'Inter', sans-serif; padding: 20px; margin: 0; min-height: 100vh; color: #333; overflow-x: hidden; }
                            .canvas-el { cursor: pointer; position: relative; transition: outline 0.2s; }
                            .canvas-el:hover { outline: 1px dashed #00f0ff; }
                            /* Native Resize Handle for Selected Elements - STABILIZED */
                            .selected { 
                                outline: 2px solid #ff00cc !important; 
                                box-shadow: 0 0 15px rgba(255, 0, 204, 0.5); 
                                resize: both; 
                                overflow: auto; /* Changed from hidden to auto to force resize handle availability */
                                z-index: 1000;
                            }
                            /* Special resizing rules for images/video to preserve ratios and handles */
                            img.selected, video.selected, iframe.selected, embed.selected, object.selected {
                                object-fit: fill; 
                                resize: both;
                                overflow: hidden; /* Hide scrollbars inside images */
                                display: inline-block;
                            }

                            .selected:hover {
                                overflow: auto; /* Show handle on hover */
                            }
                            /* Hide the actual bars, keep the handle */
                            .selected::-webkit-scrollbar { width: 8px; height: 8px; }
                            .selected::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 4px; }
                            .selected::-webkit-scrollbar-track { background: transparent; }
                            .selected::-webkit-corner { background: rgba(0,0,0,0.1); }
                            
                            .hover-highlight {
                                outline: 2px dotted #00f0ff !important;
                                z-index: 999;
                            }
                            @keyframes pulse { 0% { box-shadow: 0 0 5px #ff00cc; } 50% { box-shadow: 0 0 20px #ff00cc; } 100% { box-shadow: 0 0 5px #ff00cc; } }
                        </style>
                        <style id="global-theme-style"></style>
                        <style id="custom-styles"></style>
                        <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"><\/script>
                        <link href="https://fonts.googleapis.com/css2?family=VT323&family=Inter:wght@400;700&family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
                    </head>
                    <body>
                        <h1 class="canvas-el">COAIEXIST</h1>
                        <p class="canvas-el">Welcome to the digital frontier.</p>
                    <script type="module" src="/index.tsx"></script>
</body>
                    </html>
                `);
            }
            iframeDoc.close();
            
            // Reset Logic
            const page = getCurrentPage();
            if (resetHistory) {
                page.history = [];
                page.historyIndex = -1;
                page.content = iframeDoc.documentElement.outerHTML;
                window.updateUndoButtons();
            }

            // Sync history to current page state
            if (page.history.length === 0) {
                setTimeout(() => { 
                    window.ensureAnimationStyles(); 
                    setupIframeInteractions(); 
                    window.saveState(); 
                }, 100);
            } else {
                // Just bind interactions, history is already there
                setTimeout(() => { 
                    window.ensureAnimationStyles(); 
                    setupIframeInteractions(); 
                }, 100);
            }
            
            if(iframeDoc.body) {
                 iframeDoc.body.addEventListener('blur', () => window.saveState(), true);
                 // Bind global keys to iframe doc
                 iframeDoc.addEventListener('keydown', window.handleGlobalKeys);

                 // Mutation Observer to auto-layerize dynamically added elements (like from JS navbars)
                 const observer = new MutationObserver((mutations) => {
                    let hasNewElements = false;
                    mutations.forEach((mutation) => {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === 1) { // Element
                                if(node.classList.contains('canvas-el')) return;
                                // Basic check if it's relevant
                                const tagName = node.tagName;
                                if(['DIV','NAV','A','BUTTON','UL','LI','HEADER','FOOTER'].includes(tagName)) {
                                     window.processLayerization(node);
                                     hasNewElements = true;
                                }
                            }
                        });
                    });
                    if(hasNewElements) {
                        // Debounced layer render if needed, or just let it be
                        // We don't want to re-render layers panel too often
                    }
                 });
                 observer.observe(iframeDoc.body, { childList: true, subtree: true });
            }
        }
        
        window.exportHTML = () => {
            const doc = document.getElementById('canvas-frame').contentWindow.document;
            if (!doc) return;
            const html = `<!DOCTYPE html>\n${window.getCleanHTML(doc)}`;
            const blob = new Blob([html], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = window.pages[window.activePageIndex].name || 'coaiexist-page.html';
            a.click();
            URL.revokeObjectURL(url);
            window.playSound('success');
        };

        window.getCanvasDoc = () => iframeDoc;
        
        window.getCleanHTML = (doc) => {
             // Clone root to avoid messing up live canvas
             const clone = doc.documentElement.cloneNode(true);
             // Remove internal classes/styles
             const els = clone.querySelectorAll('.canvas-el, .selected, .hover-highlight');
             els.forEach(el => {
                 el.classList.remove('canvas-el', 'selected', 'hover-highlight');
                 el.removeAttribute('contenteditable');
                 el.style.cursor = '';
                 el.style.outline = '';
                 el.style.zIndex = '';
                 if(el.getAttribute('class') === '') el.removeAttribute('class');
                 if(el.getAttribute('style') === '') el.removeAttribute('style');
             });
             // Remove editor-specific scripts if any
             return clone.outerHTML;
        };
        
        window.ensureAnimationStyles = () => {
            if(!iframeDoc) return;
            let style = iframeDoc.getElementById('coai-animations');
            if(!style) {
                style = iframeDoc.createElement('style');
                style.id = 'coai-animations';
                style.textContent = `
                    @keyframes anim-fadeIn { from { opacity:0; } to { opacity:1; } }
                    @keyframes anim-slideUp { from { transform:translateY(50px); opacity:0; } to { transform:translateY(0); opacity:1; } }
                    @keyframes anim-zoomIn { from { transform:scale(0); opacity:0; } to { transform:scale(1); opacity:1; } }
                    @keyframes anim-bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-30px);} 60% {transform: translateY(-15px);} }
                    @keyframes anim-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
                    @keyframes anim-shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
                    @keyframes anim-glow { 0% { box-shadow: 0 0 5px #fff; } 50% { box-shadow: 0 0 20px #ff00cc; } 100% { box-shadow: 0 0 5px #fff; } }
                    .anim-fadeIn { animation: anim-fadeIn 0.8s ease forwards; }
                    .anim-slideUp { animation: anim-slideUp 0.8s ease forwards; }
                    .anim-zoomIn { animation: anim-zoomIn 0.5s ease forwards; }
                    .anim-bounce { animation: anim-bounce 2s infinite; }
                    .hover-pulse:hover { animation: anim-pulse 1s infinite; }
                    .hover-shake:hover { animation: anim-shake 0.5s; }
                    .hover-glow:hover { animation: anim-glow 1.5s infinite; }
                    .hover-scale:hover { transform: scale(1.1); transition: transform 0.3s; }
                `;
                iframeDoc.head.appendChild(style);
            }
        };
        
        window.addElementHTML = (html) => {
            const div = document.createElement('div');
            div.innerHTML = html;
            window.processLayerization(div); 
            
            const nodes = Array.from(div.childNodes);
            let contentAdded = false;

            nodes.forEach(child => {
                // TYPE 1: ELEMENT
                if (child.nodeType === 1) { 
                     // IMPORTANT: Handle Scripts separately to ensure execution
                     if (child.tagName === 'SCRIPT') {
                         const newScript = iframeDoc.createElement('script');
                         Array.from(child.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                         newScript.textContent = child.textContent;
                         iframeDoc.body.appendChild(newScript);
                         contentAdded = true;
                     } 
                     else if (child.tagName === 'STYLE' || child.tagName === 'LINK') {
                         iframeDoc.head.appendChild(child.cloneNode(true));
                         contentAdded = true;
                     }
                     else {
                         iframeDoc.body.appendChild(child);
                         selectElement(child);
                         contentAdded = true;
                         
                         // Check for nested scripts
                         child.querySelectorAll('script').forEach(oldScript => {
                             const newScript = iframeDoc.createElement('script');
                             Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                             newScript.textContent = oldScript.textContent;
                             oldScript.parentNode.replaceChild(newScript, oldScript);
                         });
                     }
                } 
                // TYPE 3: TEXT (Non-empty)
                else if (child.nodeType === 3 && child.textContent.trim().length > 0) {
                     const span = iframeDoc.createElement('span');
                     span.className = 'canvas-el';
                     span.style.display = 'inline-block'; // make it clickable/visible
                     span.textContent = child.textContent;
                     iframeDoc.body.appendChild(span);
                     selectElement(span);
                     contentAdded = true;
                }
            });
            
            if(contentAdded) {
                window.saveState();
                window.playSound('success');
            }
        };

        window.applyCustomCSS = () => {
            if(!iframeDoc) return;
            const code = document.getElementById('css-editor').value;
            const mode = document.querySelector('input[name="css-mode"]:checked').value;
            const btn = document.getElementById('apply-css-btn');

            const injectCSS = (css) => {
                let styleTag = iframeDoc.getElementById('custom-styles');
                if(!styleTag) {
                    styleTag = iframeDoc.createElement('style');
                    styleTag.id = 'custom-styles';
                    iframeDoc.head.appendChild(styleTag);
                }
                styleTag.textContent = css;
                window.saveState();
                window.closeModal('css-modal');
                window.playSound('success');
            };

            if (mode === 'scss') {
                const originalText = btn.innerText;
                btn.innerText = "Compiling...";
                if(window.Sass) {
                    Sass.compile(code, (result) => {
                        btn.innerText = originalText;
                        if (result.status === 0) {
                            injectCSS(result.text);
                        } else {
                            alert("SCSS Error:\n" + result.formatted);
                        }
                    });
                } else {
                    alert("Sass compiler not loaded yet.");
                    btn.innerText = originalText;
                }
            } else {
                injectCSS(code);
            }
        };
        
        window.addGoogleFont = () => {
            const fontName = document.getElementById('gf-name').value.trim();
            if(!fontName) return;
            
            const link = iframeDoc.createElement('link');
            link.rel = 'stylesheet';
            link.href = `https://fonts.googleapis.com/css2?family=${fontName.replace(/ /g, '+')}&display=swap`;
            iframeDoc.head.appendChild(link);
            
            const options = `<option value="'${fontName}', sans-serif">${fontName}</option>`;
            document.getElementById('gs-body-font').insertAdjacentHTML('afterbegin', options);
            document.getElementById('gs-h-font').insertAdjacentHTML('afterbegin', options);
            
            alert(`Font '${fontName}' imported! It is now available in the theme dropdowns.`);
        };

        window.updateGlobalTheme = () => {
            if (!iframeDoc) return;
            let themeTag = iframeDoc.getElementById('global-theme-style');
            if (!themeTag) {
                themeTag = iframeDoc.createElement('style');
                themeTag.id = 'global-theme-style';
                iframeDoc.head.appendChild(themeTag);
            }
            const bodyBg = document.getElementById('gs-body-bg').value;
            const bodyText = document.getElementById('gs-body-text').value;
            const bodyFont = document.getElementById('gs-body-font').value;
            const hColor = document.getElementById('gs-h-color').value;
            const hFont = document.getElementById('gs-h-font').value;
            const hTrans = document.getElementById('gs-h-transform').value;
            const btnBg = document.getElementById('gs-btn-bg').value;
            const btnText = document.getElementById('gs-btn-text').value;
            const btnRadius = document.getElementById('gs-btn-radius').value;
            const linkColor = document.getElementById('gs-link-color').value;
            const linkDec = document.getElementById('gs-link-dec').value;
            
            const css = `
                body { background-color: ${bodyBg} !important; color: ${bodyText} !important; font-family: ${bodyFont} !important; }
                h1, h2, h3, h4, h5, h6 { color: ${hColor} !important; font-family: ${hFont === 'inherit' ? bodyFont : hFont} !important; text-transform: ${hTrans} !important; }
                button, .btn-cta { border-radius: ${btnRadius}px; background-color: ${btnBg}; color: ${btnText}; }
                a { color: ${linkColor}; text-decoration: ${linkDec}; }
            `;
            themeTag.textContent = css;
            window.saveState();
        };

        window.applyCustomJS = () => {
            if(!iframeDoc) return;
            const code = document.getElementById('js-editor').value;
            const script = iframeDoc.createElement('script');
            script.textContent = code;
            iframeDoc.body.appendChild(script);
            window.saveState();
            window.closeModal('js-modal');
            window.playSound('success');
        };
        
        window.openSettingsModal = () => {
            if(!iframeDoc) return;
            const titleTag = iframeDoc.querySelector('title');
            document.getElementById('page-title-input').value = titleTag ? titleTag.innerText : '';
            const descTag = iframeDoc.querySelector('meta[name="description"]');
            document.getElementById('page-desc-input').value = descTag ? descTag.getAttribute('content') : '';
            const keyTag = iframeDoc.querySelector('meta[name="keywords"]');
            document.getElementById('page-keywords-input').value = keyTag ? keyTag.getAttribute('content') : '';
            const favTag = iframeDoc.querySelector('link[rel="icon"]') || iframeDoc.querySelector('link[rel="shortcut icon"]');
            document.getElementById('page-favicon-input').value = favTag ? favTag.href : '';
            window.openModal('settings-modal');
        };

        window.savePageSettings = () => {
            if(!iframeDoc) return;
            const title = document.getElementById('page-title-input').value;
            const desc = document.getElementById('page-desc-input').value;
            const keywords = document.getElementById('page-keywords-input').value;
            const favicon = document.getElementById('page-favicon-input').value;
            
            let titleTag = iframeDoc.querySelector('title');
            if(!titleTag) { titleTag = iframeDoc.createElement('title'); iframeDoc.head.appendChild(titleTag); }
            titleTag.innerText = title;
            
            let descTag = iframeDoc.querySelector('meta[name="description"]');
            if(!descTag && desc) { descTag = iframeDoc.createElement('meta'); descTag.name = "description"; iframeDoc.head.appendChild(descTag); }
            if(descTag) descTag.setAttribute('content', desc);
            
            let keyTag = iframeDoc.querySelector('meta[name="keywords"]');
            if(!keyTag && keywords) { keyTag = iframeDoc.createElement('meta'); keyTag.name = "keywords"; iframeDoc.head.appendChild(keyTag); }
            if(keyTag) keyTag.setAttribute('content', keywords);

            if(favicon) {
                let favTag = iframeDoc.querySelector('link[rel="icon"]') || iframeDoc.querySelector('link[rel="shortcut icon"]');
                if(!favTag) { favTag = iframeDoc.createElement('link'); favTag.rel = 'icon'; iframeDoc.head.appendChild(favTag); }
                favTag.href = favicon;
                favTag.type = 'image/x-icon';
            }
            
            window.pages[window.activePageIndex].name = title || window.pages[window.activePageIndex].name;
            window.renderPageTabs(); 
            
            window.saveState();
            window.closeModal('settings-modal');
            window.playSound('success');
            window.updateStatus('Settings Saved');
        };

        // --- CSS LAB FUNCTIONS ---
        window.switchCssTab = (tab) => {
            document.querySelectorAll('.css-tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll(`.css-tab-btn[onclick*="${tab}"]`).forEach(b => b.classList.add('active'));
            document.getElementById('css-tab-presets').style.display = tab === 'presets' ? 'grid' : 'none';
            document.getElementById('css-tab-filters').style.display = tab === 'filters' ? 'grid' : 'none';
            document.getElementById('css-tab-scroll').style.display = tab === 'scroll' ? 'grid' : 'none';
            document.getElementById('css-tab-anim').style.display = tab === 'anim' ? 'grid' : 'none';
        };

        window.insertCssAtCursor = (css) => {
            const editor = document.getElementById('css-editor');
            if(!editor) return;
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const text = editor.value;
            editor.value = text.substring(0, start) + css + text.substring(end);
            editor.focus();
        };
        
        window.applyCssPreset = (css) => {
            if(window.selectedEl) {
                const rules = css.split(';');
                rules.forEach(rule => {
                    const [prop, val] = rule.split(':');
                    if(prop && val) {
                        window.selectedEl.style[prop.trim()] = val.trim();
                    }
                });
                window.saveState();
                window.renderProperties();
                window.playSound('pop');
            } else {
                window.insertCssAtCursor(css);
            }
        };

        window.insertGradient = () => {
            const c1 = document.getElementById('grad-c1').value;
            const c2 = document.getElementById('grad-c2').value;
            const ang = document.getElementById('grad-angle').value;
            const css = `background: linear-gradient(${ang}deg, ${c1}, ${c2});\n`;
            window.applyCssPreset(css);
        };

        window.insertShadow = () => {
            const c = document.getElementById('shadow-c').value;
            const b = document.getElementById('shadow-blur').value;
            const css = `box-shadow: 0 10px ${b}px ${c};\n`;
            window.applyCssPreset(css);
        };
        
        // --- JS SCRIPT ENGINE UPGRADES ---
        window.switchJsTab = (tab) => {
             document.querySelectorAll('.css-tab-btn').forEach(b => b.classList.remove('active'));
             document.querySelectorAll(`.css-tab-btn[onclick*="${tab}"]`).forEach(b => b.classList.add('active'));
             document.getElementById('js-tab-effects').style.display = tab === 'effects' ? 'grid' : 'none';
             document.getElementById('js-tab-cursors').style.display = tab === 'cursors' ? 'grid' : 'none';
             document.getElementById('js-tab-utils').style.display = tab === 'utils' ? 'grid' : 'none';
        };

        window.applyJsPreset = (code) => {
            const editor = document.getElementById('js-editor');
            editor.value = code + "\n\n" + editor.value;
            window.playSound('boop');
        };

        window.renderJsLibrary = () => {
            // EFFECTS
            const effects = [
                { name: '‚ùÑÔ∏è Falling Snow', code: `/* Simple Snow Effect */\n(function(){\n  var style = document.createElement('style');\n  style.innerHTML = '@keyframes snowfall { 0% { transform: translateY(-10px); } 100% { transform: translateY(100vh); } } .snowflake { position: fixed; color: white; animation: snowfall linear infinite; z-index: 9999; pointer-events: none; }';\n  document.head.appendChild(style);\n  setInterval(() => {\n    var f = document.createElement('div'); f.className = 'snowflake'; f.innerText = '‚ùÑ'; f.style.left = Math.random() * 100 + 'vw'; f.style.animationDuration = Math.random() * 3 + 2 + 's'; f.style.fontSize = Math.random() * 20 + 10 + 'px';\n    document.body.appendChild(f);\n    setTimeout(() => f.remove(), 5000);\n  }, 200);\n})();` },
                { name: 'üéâ Confetti Rain', code: `/* Confetti Rain */\n(function(){\n  const colors = ['#ff0', '#f00', '#0f0', '#00f', '#f0f', '#0ff'];\n  setInterval(() => {\n    const c = document.createElement('div');\n    c.style.position = 'fixed';\n    c.style.left = Math.random() * 100 + 'vw';\n    c.style.top = '-10px';\n    c.style.width = '10px'; c.style.height = '10px';\n    c.style.background = colors[Math.floor(Math.random() * colors.length)];\n    c.style.zIndex = '9999';\n    c.style.transform = 'rotate(' + Math.random() * 360 + 'deg)';\n    document.body.appendChild(c);\n    let top = -10;\n    const interval = setInterval(() => {\n      top += 5;\n      c.style.top = top + 'px';\n      if(top > window.innerHeight) { clearInterval(interval); c.remove(); }\n    }, 20);\n  }, 100);\n})();` },
                { name: 'üì∫ Matrix Rain', code: `/* Matrix Rain Background */\n(function(){\n  var c = document.createElement('canvas');\n  c.style.position = 'fixed'; c.style.top = 0; c.style.left = 0; c.style.width = '100%'; c.style.height = '100%'; c.style.zIndex = -1; c.style.pointerEvents = 'none';\n  document.body.appendChild(c);\n  var ctx = c.getContext('2d');\n  c.width = window.innerWidth; c.height = window.innerHeight;\n  var letters = '01';\n  letters = letters.split('');\n  var fontSize = 10, columns = c.width / fontSize;\n  var drops = []; for(var x = 0; x < columns; x++) drops[x] = 1;\n  function draw() { ctx.fillStyle = 'rgba(0, 0, 0, 0.05)'; ctx.fillRect(0, 0, c.width, c.height); ctx.fillStyle = '#0F0'; ctx.font = fontSize + 'px monospace'; for(var i = 0; i < drops.length; i++) { var text = letters[Math.floor(Math.random() * letters.length)]; ctx.fillText(text, i * fontSize, drops[i] * fontSize); if(drops[i] * fontSize > c.height && Math.random() > 0.975) drops[i] = 0; drops[i]++; } }\n  setInterval(draw, 33);\n})();` },
                { name: 'üíø Bouncing DVD', code: `/* Bouncing Logo */\n(function(){\n  var d = document.createElement('div'); d.innerText = 'DVD'; d.style.position = 'fixed'; d.style.fontWeight = 'bold'; d.style.fontSize = '20px'; d.style.color = 'white'; d.style.zIndex = 9999; d.style.pointerEvents = 'none'; document.body.appendChild(d);\n  var x = 0, y = 0, dx = 2, dy = 2;\n  setInterval(() => {\n    x += dx; y += dy;\n    if(x + d.offsetWidth > window.innerWidth || x < 0) dx = -dx; \n    if(y + d.offsetHeight > window.innerHeight || y < 0) dy = -dy;\n    d.style.left = x + 'px'; d.style.top = y + 'px';\n  }, 10);\n})();` }
            ];
            
            // CURSORS
            const cursors = [
                { name: '‚ú® Sparkle Trail', code: `/* Sparkle Cursor */\n(function(){\n  const colors = ["#ff00cc", "#00f0ff", "#ccff00", "#ffffff"];\n  document.addEventListener('mousemove', function(e) {\n    if(Math.random() > 0.5) return;\n    const p = document.createElement('div');\n    p.style.position = 'fixed'; p.style.left = e.clientX + 'px'; p.style.top = e.clientY + 'px';\n    p.style.width = '4px'; p.style.height = '4px'; p.style.background = colors[Math.floor(Math.random() * colors.length)];\n    p.style.borderRadius = '50%'; p.style.pointerEvents = 'none'; p.style.zIndex = '99999';\n    document.body.appendChild(p);\n    let op = 1; let top = e.clientY;\n    const int = setInterval(() => { op -= 0.1; top += 2; p.style.opacity = op; p.style.top = top + 'px'; if(op <= 0) { clearInterval(int); p.remove(); } }, 50);\n  });\n})();` },
                { name: 'üëª Ghost Trail', code: `/* Ghost Trail Cursor */\n(function(){\n  document.addEventListener('mousemove', function(e) {\n    const p = document.createElement('div');\n    p.innerText = 'üëª'; p.style.position = 'fixed'; p.style.left = e.clientX + 'px'; p.style.top = e.clientY + 'px'; p.style.pointerEvents = 'none'; p.style.zIndex = '99999';\n    document.body.appendChild(p);\n    setTimeout(() => p.remove(), 500);\n  });\n})();` },
                { name: 'üñ±Ô∏è Custom Emoji', code: `/* Emoji Cursor */\ndocument.body.style.cursor = "url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2232%22 height=%2232%22 style=%22font-size: 24px%22><text y=%2224%22>üëΩ</text></svg>'), auto";` },
                { name: '‚úùÔ∏è Crosshair', code: `document.body.style.cursor = "crosshair";` },
                { name: '‚ùì Help', code: `document.body.style.cursor = "help";` }
            ];
            
            // UTILS
            const utils = [
                { name: 'üï∞Ô∏è Digital Clock', code: `/* Fixed Digital Clock */\n(function(){\n  const d = document.createElement('div'); \n  d.style.position = 'fixed'; d.style.bottom = '10px'; d.style.right = '10px'; d.style.background = 'black'; d.style.color = '#0f0'; d.style.fontFamily = 'monospace'; d.style.padding = '5px'; d.style.border = '1px solid #0f0'; d.style.zIndex = 9999;\n  document.body.appendChild(d);\n  setInterval(() => { d.innerText = new Date().toLocaleTimeString(); }, 1000);\n})();` },
                { name: 'üéÆ Konami Code', code: `/* Konami Code Secret */\n(function(){\n  const code = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];\n  let cur = 0;\n  document.addEventListener('keydown', (e) => {\n    if(e.key === code[cur]) { cur++; if(cur === code.length) { alert('CHEAT CODE ACTIVATED!'); cur = 0; } }\n    else { cur = 0; }\n  });\n})();` },
                { name: 'üåà Title Marquee', code: `/* Marquee Title */\n(function(){\n  var msg = " Welcome to my cool site! ";\n  var pos = 0;\n  setInterval(function() { \n    document.title = msg.substring(pos, msg.length) + msg.substring(0, pos); \n    pos++; \n    if (pos > msg.length) pos = 0;\n  }, 200);\n})();` },
                { name: 'üö´ No Right Click', code: `document.addEventListener('contextmenu', event => event.preventDefault());` }
            ];

            const renderGrid = (items, id) => {
                const el = document.getElementById(id);
                el.innerHTML = items.map(item => `
                    <div class="style-card" onclick="window.applyJsPreset(\`${item.code.replace(/`/g, '\\`').replace(/"/g, '&quot;')}\`)">
                        <div style="font-size:20px; margin-bottom:5px;">‚ö°</div>
                        <div>${item.name}</div>
                    </div>
                `).join('');
            };

            renderGrid(effects, 'js-tab-effects');
            renderGrid(cursors, 'js-tab-cursors');
            renderGrid(utils, 'js-tab-utils');
        };

        window.renderCssLibrary = () => {
             const presets = [
                { name: 'ü™ü Windows 95', code: `background: #c0c0c0; border: 2px solid white; border-right-color: #404040; border-bottom-color: #404040; color: black; font-family: 'MS Sans Serif', sans-serif; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); padding: 5px;` },
                { name: 'üîÆ Glassmorphism', code: `background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); border-radius: 16px; color: white;` },
                { name: 'üü¶ Neumorphism', code: `border-radius: 20px; background: #e0e0e0; box-shadow: 20px 20px 60px #bebebe, -20px -20px 60px #ffffff; border: none; color: #555;` },
                { name: 'ü§ñ Cyberpunk', code: `border: 2px solid #f0f; box-shadow: 0 0 10px #f0f, inset 0 0 10px #f0f; background: rgba(20,0,30,0.9); color: #0ff; font-family: 'Orbitron', sans-serif; text-transform: uppercase;` },
                { name: 'üìù Paper Note', code: `background: #fff9c4; color: #333; box-shadow: 5px 5px 15px rgba(0,0,0,0.2); transform: rotate(-2deg); border-radius: 2px; padding: 20px; font-family: 'Comic Sans MS', cursive;` },
                { name: 'üìü Retro Terminal', code: `background: #000; color: #0f0; font-family: monospace; border: 2px solid #0f0; padding: 10px; box-shadow: inset 0 0 20px rgba(0, 255, 0, 0.2);` }
            ];

            const filters = [
                { name: 'üì∫ CRT Scanline', code: `position: relative; overflow: hidden; } .selected::before { content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); z-index: 2; background-size: 100% 2px, 3px 100%; pointer-events: none;` },
                { name: 'üìº VHS Glitch', code: `filter: contrast(1.5) brightness(1.2) hue-rotate(-10deg) blur(0.5px);` },
                { name: 'üéûÔ∏è Sepia Vintage', code: `filter: sepia(100%) contrast(1.2) brightness(0.9);` },
                { name: 'üëª X-Ray', code: `filter: invert(100%);` },
                { name: 'üå´Ô∏è Blur Privacy', code: `filter: blur(5px);` },
                { name: 'üåë Grayscale', code: `filter: grayscale(100%);` },
                { name: 'üåà Hue Spin', code: `animation: hue-rotate 3s infinite linear; } @keyframes hue-rotate { from { filter: hue-rotate(0deg); } to { filter: hue-rotate(360deg); }` }
            ];

            const scrollbars = [
                { name: 'üü¢ Neon Green', code: `::-webkit-scrollbar { width: 10px; } ::-webkit-scrollbar-track { background: #000; } ::-webkit-scrollbar-thumb { background: #0f0; border-radius: 5px; }` },
                { name: 'üü£ Cyber Pink', code: `::-webkit-scrollbar { width: 10px; } ::-webkit-scrollbar-track { background: #220022; } ::-webkit-scrollbar-thumb { background: #ff00cc; border: 1px solid white; }` },
                { name: 'üåà Rainbow', code: `::-webkit-scrollbar { width: 12px; } ::-webkit-scrollbar-thumb { background: linear-gradient(to bottom, red, orange, yellow, green, blue, indigo, violet); border-radius: 10px; }` },
                { name: 'üëª Invisible', code: `::-webkit-scrollbar { width: 0px; background: transparent; }` },
                { name: 'üíª Win 95', code: `::-webkit-scrollbar { width: 16px; background: #c0c0c0; } ::-webkit-scrollbar-thumb { background: #c0c0c0; border: 2px outset #fff; } ::-webkit-scrollbar-button { background: #c0c0c0; border: 2px outset #fff; height: 16px; }` }
            ];

            const anim = [
                { name: 'üéà Float', code: `animation: float 3s ease-in-out infinite; } @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); }` },
                { name: 'üíì Pulse', code: `animation: pulse 1s infinite; } @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); }` },
                { name: 'üîÑ Spin', code: `animation: spin 2s linear infinite; } @keyframes spin { 100% { transform: rotate(360deg); }` },
                { name: '‚ö° Shake', code: `animation: shake 0.5s; } @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); }` },
                { name: 'üì∫ Glitch Text', code: `position: relative; animation: glitch-skew 1s cubic-bezier(0.25, 0.46, 0.45, 0.94) both infinite; } @keyframes glitch-skew { 0% { transform: skew(0deg); } 20% { transform: skew(-2deg); } 40% { transform: skew(2deg); } 60% { transform: skew(-1deg); } 80% { transform: skew(1deg); } 100% { transform: skew(0deg); }` }
            ];

            const renderGrid = (items, id) => {
                const el = document.getElementById(id);
                el.innerHTML = items.map(item => `
                    <div class="style-card" onclick="window.applyCssPreset(\`${item.code.replace(/`/g, '\\`').replace(/"/g, '&quot;')}\`)">
                        <div class="style-preview-mini"></div>
                        <div>${item.name}</div>
                    </div>
                `).join('');
            };

            renderGrid(presets, 'css-tab-presets');
            renderGrid(filters, 'css-tab-filters');
            renderGrid(scrollbars, 'css-tab-scroll');
            renderGrid(anim, 'css-tab-anim');
        };

        // --- AI IMAGE STUDIO ---
        window.openImageAiModal = (imgEl = null) => {
            window.activeImageElement = imgEl;
            const modal = document.getElementById('ai-image-modal');
            const originalContainer = document.getElementById('ai-img-original-container');
            const resultContainer = document.getElementById('ai-img-result-container');
            const originalImg = document.getElementById('ai-img-original');
            const prompt = document.getElementById('ai-image-prompt');
            const acceptBtn = document.getElementById('ai-img-accept-btn');
            
            resultContainer.style.display = 'none';
            acceptBtn.style.display = 'none';
            document.getElementById('ai-img-result').src = '';
            document.getElementById('ai-img-status').innerText = '';
            
            if (imgEl) {
                originalContainer.style.display = 'block';
                originalImg.src = imgEl.src;
                prompt.placeholder = "Describe edits (e.g., 'Make it cyberpunk')...";
            } else {
                originalContainer.style.display = 'none';
                prompt.placeholder = "Describe a new image...";
            }
            window.openModal('ai-image-modal');
        };
        
        window.acceptAiImage = () => {
            const resultSrc = document.getElementById('ai-img-result').src;
            if (!resultSrc) return;
            if (window.activeImageElement) {
                window.activeImageElement.src = resultSrc;
                window.selectElement(window.activeImageElement);
            } else {
                const newImg = document.createElement('img');
                newImg.src = resultSrc;
                newImg.className = 'canvas-el';
                newImg.style.maxWidth = '300px';
                iframeDoc.body.appendChild(newImg);
                window.selectElement(newImg);
            }
            window.saveState();
            window.closeModal('ai-image-modal');
        };
        
        window.togglePreview = () => {
             document.body.classList.toggle('preview-mode');
             const isPreview = document.body.classList.contains('preview-mode');
             
             if(isPreview) {
                 deselect();
                 document.getElementById('canvas-frame').style.width = '100%';
                 document.getElementById('canvas-frame').style.height = '100%';
                 // if(window.dragModeEnabled) window.toggleDragMode(); // No longer needed
             } else {
                 window.setViewport('100%', 'vp-full');
             }
        };
        
        window.switchSourceTab = (tab) => {
            // Hide all tabs
            document.getElementById('source-tab-html').style.display = 'none';
            document.getElementById('source-tab-css').style.display = 'none';
            document.getElementById('source-tab-js').style.display = 'none';
            
            // Deactivate buttons
            document.querySelectorAll('.modal-body .tab-btn').forEach(b => b.classList.remove('active'));
            
            // Activate selected
            document.getElementById('source-tab-' + tab).style.display = 'flex';
            document.querySelectorAll(`.modal-body .tab-btn[onclick*="'${tab}'"]`).forEach(b => b.classList.add('active'));
        };

        window.openSourceModal = () => {
            if(!iframeDoc) return;

            // HTML: Clean Body
            const clone = iframeDoc.cloneNode(true);
            const body = clone.body;
            // Clean specific editor artifacts
            body.querySelectorAll('*').forEach(el => {
                el.classList.remove('canvas-el', 'selected', 'hover-highlight');
                el.removeAttribute('contenteditable');
                el.style.cursor = '';
                el.style.outline = '';
                if(el.getAttribute('class')==='') el.removeAttribute('class');
                if(el.getAttribute('style')==='') el.removeAttribute('style');
            });
            // Remove Scripts from Body view (they go to JS tab)
            body.querySelectorAll('script').forEach(s => s.remove());
            
            document.getElementById('html-source-editor').value = body.innerHTML.trim();

            // CSS: Custom Styles + Theme
            let css = '';
            const themeStyle = iframeDoc.getElementById('global-theme-style');
            const customStyle = iframeDoc.getElementById('custom-styles');
            // Check for injected link stylesheets
            iframeDoc.querySelectorAll('link[rel="stylesheet"]').forEach(l => {
                if(!l.href.includes('googleapis')) css += `/* Linked Stylesheet: ${l.href} */\n`;
            });

            if(themeStyle) css += `/* Global Theme */\n${themeStyle.innerHTML}\n\n`;
            if(customStyle) css += `/* Custom CSS */\n${customStyle.innerHTML}`;
            document.getElementById('css-source-editor').value = css.trim();

            // JS: Inline scripts from body
            let js = '';
            // Also check script src tags
            iframeDoc.body.querySelectorAll('script').forEach(s => {
                if(s.src) js += `/* Script Source */\n// <script src="${s.src}"><\/script>\n\n`;
                if(s.innerHTML.trim()) js += s.innerHTML.trim() + '\n\n';
            });
            document.getElementById('js-source-editor').value = js.trim();
            
            // Default to HTML tab
            window.switchSourceTab('html');
            window.openModal('source-modal');
        };
        
        window.updateSourceFromModal = () => {
             if(!iframeDoc) return;
             
             const html = document.getElementById('html-source-editor').value;
             const css = document.getElementById('css-source-editor').value;
             const js = document.getElementById('js-source-editor').value;
             const shouldLayerize = document.getElementById('auto-layerize-check').checked;
             
             // 1. Update HTML
             const temp = document.createElement('div');
             temp.innerHTML = html;
             if(shouldLayerize) window.processLayerization(temp);
             
             // Preserve existing scripts in body before wiping? No, we replace with JS editor content.
             iframeDoc.body.innerHTML = temp.innerHTML;

             // 2. Update CSS
             let customStyle = iframeDoc.getElementById('custom-styles');
             if(!customStyle) { customStyle = iframeDoc.createElement('style'); customStyle.id='custom-styles'; iframeDoc.head.appendChild(customStyle); }
             customStyle.textContent = css; // This overwrites theme if not careful, but user sees all CSS in one box now.

             // 3. Update JS
             // Remove old inline scripts that we track
             // (Simple approach: we just append new script at end of body)
             const newScript = iframeDoc.createElement('script');
             newScript.textContent = js;
             iframeDoc.body.appendChild(newScript);
             
             window.saveState();
             window.closeModal('source-modal');
             window.renderLayers();
             window.updateStatus('Source Updated');
        };

        window.processLayerization = (container) => {
             const tags = ['DIV','SECTION','ARTICLE','NAV','HEADER','FOOTER','ASIDE','MAIN',
                           'H1','H2','H3','H4','H5','H6','P','A','BUTTON','IMG','VIDEO','AUDIO',
                           'UL','OL','LI','TABLE','BLOCKQUOTE','INPUT','TEXTAREA', 'SPAN', 'LABEL', 'DETAILS', 'SUMMARY', 'MARQUEE', 'PRE', 'CODE', 'MODEL-VIEWER', 'IFRAME', 'EMBED', 'OBJECT'];
             
             // Recursively add canvas-el class
             const processNode = (node) => {
                 if (node.nodeType === 1) { // Element node
                     if (tags.includes(node.tagName)) {
                         node.classList.add('canvas-el');
                     }
                     Array.from(node.children).forEach(processNode);
                 }
             };
             
             container.querySelectorAll('*').forEach(node => {
                 if(tags.includes(node.tagName)) {
                     node.classList.add('canvas-el');
                 }
             });
             // Also process top level children of container if container is a wrapper
             Array.from(container.children).forEach(processNode);
        };
        
        window.setViewport = (width, btnId) => {
             const iframe = document.getElementById('canvas-frame');
             iframe.style.width = width;
             document.querySelectorAll('.vp-btn').forEach(b => b.classList.remove('active'));
             document.getElementById(btnId).classList.add('active');
        };

        // --- MISSING FUNCTIONS IMPLEMENTATION ---

        window.setupEventListeners = () => {
            document.getElementById('new-btn').onclick = () => { if(confirm('Reset Page?')) window.location.reload(); };
            document.getElementById('undo-btn').onclick = window.undo;
            document.getElementById('redo-btn').onclick = window.redo;
            document.getElementById('export-btn').onclick = window.exportHTML;
            document.getElementById('asset-btn').onclick = () => window.openModal('asset-modal');
            document.getElementById('ai-gen-btn').onclick = () => window.openModal('ai-manifest-modal');

            // Sidebar Tabs
            document.getElementById('tab-props').onclick = (e) => {
                document.querySelectorAll('.sidebar-header .tab-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById('panel-props').style.display = 'block';
                document.getElementById('panel-text').style.display = 'none';
                document.getElementById('panel-layers').style.display = 'none';
            };
            document.getElementById('tab-text').onclick = (e) => {
                document.querySelectorAll('.sidebar-header .tab-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById('panel-props').style.display = 'none';
                document.getElementById('panel-text').style.display = 'block';
                document.getElementById('panel-layers').style.display = 'none';
            };
            document.getElementById('tab-layers').onclick = (e) => {
                document.querySelectorAll('.sidebar-header .tab-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById('panel-props').style.display = 'none';
                document.getElementById('panel-text').style.display = 'none';
                document.getElementById('panel-layers').style.display = 'block';
                window.renderLayers();
            };

            // Viewport
            document.getElementById('vp-mobile').onclick = () => window.setViewport('375px', 'vp-mobile');
            document.getElementById('vp-tablet').onclick = () => window.setViewport('768px', 'vp-tablet');
            document.getElementById('vp-desktop').onclick = () => window.setViewport('1024px', 'vp-desktop');
            document.getElementById('vp-full').onclick = () => window.setViewport('100%', 'vp-full');

            // Grid
            document.getElementById('grid-toggle-btn').onclick = () => {
                const grid = document.getElementById('grid-overlay');
                grid.style.display = grid.style.display === 'block' ? 'none' : 'block';
            };

            // AI Manifest Button (Dummy for now)
            document.getElementById('ai-manifest-run-btn').onclick = () => {
                 const prompt = document.getElementById('ai-manifest-prompt').value;
                 const status = document.getElementById('ai-manifest-status');
                 status.innerText = "Manifesting... (Simulation)";
                 setTimeout(() => {
                     status.innerText = "";
                     // Basic placeholder action
                     window.addElementHTML(`<div style="padding:20px; background:linear-gradient(45deg, #000, #222); border:1px solid cyan; color:cyan;"><h3>${prompt}</h3><p>Manifested Content Placeholder</p></div>`);
                     window.closeModal('ai-manifest-modal');
                 }, 1000);
            };
        };

        window.setupToolbox = () => {
            document.querySelectorAll('.tool-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('type', item.dataset.type);
                });
                // Click to add
                item.addEventListener('click', (e) => {
                    window.addElement(item.dataset.type);
                });
            });
        };

        window.addElement = (type, x = null, y = null) => {
            let html = '';
            
            // Check templates first
            if (window.elementTemplates[type]) {
                html = window.elementTemplates[type];
            } else {
                // Basic types
                switch(type) {
                    case 'h1': html = '<h1>Heading 1</h1>'; break;
                    case 'p': html = '<p>Lorem ipsum dolor sit amet.</p>'; break;
                    case 'div': html = '<div style="padding:20px; background:rgba(0,0,0,0.1); border:1px dashed #ccc;">Container</div>'; break;
                    case 'card': html = '<div style="padding:20px; background:white; border-radius:8px; box-shadow:0 4px 6px rgba(0,0,0,0.1);"><h3>Card Title</h3><p>Content goes here</p></div>'; break;
                    case 'button': html = '<button class="btn">Click Me</button>'; break;
                    case 'img': html = '<img src="https://via.placeholder.com/150" style="max-width:100%;">'; break;
                    case 'video': html = '<video src="" controls style="max-width:300px; background:#000;"></video>'; break;
                    case 'audio': html = '<audio src="" controls></audio>'; break;
                    case 'embed': html = '<iframe src="https://example.com" style="width:100%; height:300px; border:none;"></iframe>'; break;
                    case 'gradient-text': html = '<h1 style="background:linear-gradient(to right, #ff00cc, #333399); -webkit-background-clip:text; color:transparent; font-weight:900;">GRADIENT TEXT</h1>'; break;
                    default: html = `<div>${type}</div>`;
                }
            }

            // Create temporary container to process styles if x/y provided
            if (x !== null && y !== null) {
                const temp = document.createElement('div');
                temp.innerHTML = html;
                const el = temp.firstElementChild;
                if(el) {
                     const scrollX = iframeDoc.defaultView.scrollX;
                     const scrollY = iframeDoc.defaultView.scrollY;
                     
                     el.style.position = 'absolute';
                     el.style.left = (x + scrollX) + 'px';
                     el.style.top = (y + scrollY) + 'px';
                     html = el.outerHTML;
                }
            }

            window.addElementHTML(html);
        };

        window.selectElement = (el) => {
            if(window.selectedEl) window.selectedEl.classList.remove('selected');
            window.selectedEl = el;
            el.classList.add('selected');
            window.renderProperties();
            window.renderLayers(); // Highlight in layer list
            
            // Switch to props tab
            document.getElementById('tab-props').click();
        };

        window.deselect = () => {
            if(window.selectedEl) window.selectedEl.classList.remove('selected');
            window.selectedEl = null;
            document.getElementById('panel-props').innerHTML = `
                <div style="text-align: center; margin-top: 50%; color: var(--text-dim); font-size: 12px;">
                    Select an object to<br>hack its matrix.
                </div>
            `;
            window.renderLayers();
        };

        window.renderProperties = () => {
            const el = window.selectedEl;
            if(!el) return;
            
            const p = document.getElementById('panel-props');
            const cs = window.getComputedStyle(el);
            const s = el.style;
            
            // Helper to create input row
            const mkInput = (label, prop, type='text', opts=[], unit='') => {
                let val = s[prop] || cs[prop];
                
                // Special handling for some props
                if(prop === 'content') val = el.innerText;
                else if(prop === 'src') val = el.src || '';
                else if(prop === 'href') val = el.href || '';
                else if(prop === 'id') val = el.id || '';
                else if(prop === 'classes') val = Array.from(el.classList).filter(c=>c!=='selected'&&c!=='canvas-el').join(' ');
                
                // Color hex conversion
                if((type === 'color' || prop.toLowerCase().includes('color')) && val.startsWith('rgb')) {
                    val = rgbToHex(val);
                }
                
                // Remove 'px' for number inputs if present
                if(type === 'number' && typeof val === 'string' && val.endsWith('px')) {
                    val = val.replace('px','');
                }

                let control = '';
                if(type === 'select') {
                    control = `<select onchange="window.updateProp('${prop}', this.value)">
                        ${opts.map(o => `<option value="${o}" ${val===o ? 'selected' : ''}>${o}</option>`).join('')}
                    </select>`;
                } else if (type === 'color') {
                    control = `<div class="color-wrap">
                        <input type="color" value="${val}" oninput="window.updateProp('${prop}', this.value)">
                        <input type="text" value="${val}" onchange="window.updateProp('${prop}', this.value)" style="border:none;background:transparent;color:var(--text-dim);font-size:10px;width:60px;">
                    </div>`;
                } else if (type === 'range') {
                     control = `<div style="display:flex;align-items:center;gap:5px;">
                        <input type="range" min="0" max="100" value="${val.replace(/[^0-9.]/g, '') || 100}" oninput="window.updateProp('${prop}', this.value + '${unit}')">
                     </div>`;
                } else {
                    const step = type==='number' ? 'step="1"' : '';
                    control = `<div style="position:relative; width:100%;">
                        <input type="${type}" ${step} value="${String(val).replace(/"/g, '&quot;')}" onchange="window.updateProp('${prop}', this.value + '${unit}')">
                        ${unit ? `<span class="prop-unit" style="position:absolute;right:5px;top:50%;transform:translateY(-50%);pointer-events:none;">${unit}</span>` : ''}
                    </div>`;
                }

                return `
                <div class="control-row">
                    <div class="label-row"><span class="prop-label">${label}</span><span class="prop-unit" style="margin:0;">${unit?'auto':''}</span></div>
                    ${control}
                </div>`;
            };
            
            let html = `<div style="padding-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:bold; color:var(--magenta); text-transform:uppercase;">${el.tagName}</span>
                <span style="font-size:10px; color:var(--text-dim); font-family:monospace;">${Math.round(el.getBoundingClientRect().width)}x${Math.round(el.getBoundingClientRect().height)}</span>
            </div>`;
            
            // 1. IDENTITY
            html += `<div class="prop-group">
                <summary>ID & Classes</summary>
                <div class="prop-body">
                    ${mkInput('ID', 'id')}
                    ${mkInput('Classes', 'classes')}
                    ${(el.tagName === 'IMG' || el.tagName === 'VIDEO' || el.tagName === 'AUDIO' || el.tagName === 'IFRAME') ? mkInput('Source URL', 'src') : ''}
                    ${(el.tagName === 'A') ? mkInput('Link HREF', 'href') : ''}
                </div>
            </div>`;

            // 2. LAYOUT ENGINE
            html += `<div class="prop-group" open>
                <summary>Layout Engine</summary>
                <div class="prop-body">
                    ${mkInput('Display', 'display', 'select', ['block','inline-block','flex','grid','none','inline'])}
                    ${mkInput('Position', 'position', 'select', ['static','relative','absolute','fixed','sticky'])}
                    <div class="control-grid-2">
                        ${mkInput('Z-Index', 'zIndex', 'number')}
                        ${mkInput('Float', 'float', 'select', ['none','left','right'])}
                    </div>
                    ${mkInput('Overflow', 'overflow', 'select', ['visible','hidden','scroll','auto'])}
                    ${mkInput('Box Sizing', 'boxSizing', 'select', ['content-box','border-box'])}
                </div>
            </div>`;

            // 3. FLEXBOX CONTROLS (Conditional)
            if (cs.display === 'flex' || cs.display === 'inline-flex') {
                html += `<div class="prop-group" open>
                    <summary>Flexbox Smart Controls</summary>
                    <div class="prop-body">
                        ${mkInput('Direction', 'flexDirection', 'select', ['row','column','row-reverse','column-reverse'])}
                        ${mkInput('Wrap', 'flexWrap', 'select', ['nowrap','wrap','wrap-reverse'])}
                        ${mkInput('Justify', 'justifyContent', 'select', ['flex-start','flex-end','center','space-between','space-around','space-evenly'])}
                        ${mkInput('Align Items', 'alignItems', 'select', ['stretch','flex-start','flex-end','center','baseline'])}
                        ${mkInput('Align Content', 'alignContent', 'select', ['stretch','flex-start','flex-end','center','space-between'])}
                        <div class="control-grid-3">
                            ${mkInput('Gap', 'gap', 'number', [], 'px')}
                            ${mkInput('Grow', 'flexGrow', 'number')}
                            ${mkInput('Shrink', 'flexShrink', 'number')}
                        </div>
                    </div>
                </div>`;
            }

            // 4. DIMENSIONS & SPACING
            html += `<div class="prop-group" open>
                <summary>Dimensions & Spacing</summary>
                <div class="prop-body">
                    <div class="control-grid-2">
                         ${mkInput('Width', 'width')}
                         ${mkInput('Height', 'height')}
                    </div>
                    ${(s.position === 'absolute' || s.position === 'fixed') ? 
                      `<div class="control-grid-2">${mkInput('Top', 'top')}${mkInput('Left', 'left')}</div>
                       <div class="control-grid-2">${mkInput('Right', 'right')}${mkInput('Bottom', 'bottom')}</div>` : ''}
                    <div class="control-grid-2">
                        ${mkInput('Margin', 'margin', 'text', [], 'px')}
                        ${mkInput('Padding', 'padding', 'text', [], 'px')}
                    </div>
                     <div class="control-grid-2">
                        ${mkInput('Min-W', 'minWidth')}
                        ${mkInput('Max-W', 'maxWidth')}
                    </div>
                </div>
            </div>`;

            // 5. SASSY TEXT & DECO
            html += `<div class="prop-group" open>
                <summary>Sassy Text & Deco</summary>
                <div class="prop-body">
                    ${mkInput('Content', 'content')}
                    ${mkInput('Font Family', 'fontFamily', 'select', ['Inter, sans-serif','VT323, monospace','Comic Neue, cursive','Arial, sans-serif','Times New Roman, serif','Courier New, monospace'])}
                    <div class="control-grid-2">
                        ${mkInput('Size', 'fontSize', 'number', [], 'px')}
                        ${mkInput('Color', 'color', 'color')}
                    </div>
                    <div class="control-grid-2">
                        ${mkInput('Align', 'textAlign', 'select', ['left','center','right','justify'])}
                        ${mkInput('Weight', 'fontWeight', 'select', ['400','700','900','bold','normal'])}
                    </div>
                    <div class="control-grid-2">
                        ${mkInput('Line Height', 'lineHeight', 'number', [], 'px')}
                        ${mkInput('Letter Spacing', 'letterSpacing', 'number', [], 'px')}
                    </div>
                    <div class="control-grid-3">
                        ${mkInput('Deco Line', 'textDecorationLine', 'select', ['none','underline','overline','line-through'])}
                        ${mkInput('Deco Style', 'textDecorationStyle', 'select', ['solid','double','dotted','dashed','wavy'])}
                        ${mkInput('Deco Color', 'textDecorationColor', 'color')}
                    </div>
                    ${mkInput('Deco Thick', 'textDecorationThickness', 'number', [], 'px')}
                </div>
            </div>`;

            // 6. BACKGROUNDS
            html += `<div class="prop-group">
                <summary>Backgrounds</summary>
                <div class="prop-body">
                    ${mkInput('Color', 'backgroundColor', 'color')}
                    ${mkInput('Image URL', 'backgroundImage')}
                    <div class="control-grid-2">
                        ${mkInput('Size', 'backgroundSize', 'select', ['auto','cover','contain','100%'])}
                        ${mkInput('Repeat', 'backgroundRepeat', 'select', ['repeat','no-repeat','repeat-x','repeat-y'])}
                    </div>
                    ${mkInput('Position', 'backgroundPosition', 'select', ['center','top','bottom','left','right'])}
                </div>
            </div>`;

            // 7. BORDERS & EFFECTS
            html += `<div class="prop-group">
                <summary>Borders & Effects</summary>
                <div class="prop-body">
                    <div class="control-grid-2">
                        ${mkInput('Border Width', 'borderWidth', 'number', [], 'px')}
                        ${mkInput('Border Style', 'borderStyle', 'select', ['none','solid','dashed','dotted','double','groove','ridge','inset','outset'])}
                    </div>
                    ${mkInput('Border Color', 'borderColor', 'color')}
                    ${mkInput('Radius', 'borderRadius', 'number', [], 'px')}
                    ${mkInput('Shadow', 'boxShadow')}
                    ${mkInput('Opacity', 'opacity', 'range')}
                    ${mkInput('Blend Mode', 'mixBlendMode', 'select', ['normal','multiply','screen','overlay','darken','lighten','color-dodge','color-burn','difference','exclusion','hue','saturation','color','luminosity'])}
                </div>
            </div>`;
            
            // Actions
            html += `<div class="action-grid">
                <div class="act-btn" onclick="window.ctxAction('up')" title="Move Up">‚¨ÜÔ∏è</div>
                <div class="act-btn" onclick="window.ctxAction('down')" title="Move Down">‚¨áÔ∏è</div>
                <div class="act-btn" onclick="window.ctxAction('dup')" title="Duplicate">üìë</div>
                <div class="act-btn del" onclick="window.ctxAction('del')" title="Delete">üóëÔ∏è</div>
            </div>`;
            
             // Image Actions
            if(el.tagName === 'IMG') {
                html += `<button class="big-button btn-pink" style="width:100%; margin-top:10px;" onclick="window.openImageAiModal(window.selectedEl)">üçå AI Edit Image</button>`;
            }

            p.innerHTML = html;
        };

        window.updateProp = (prop, val) => {
            const el = window.selectedEl;
            if(!el) return;
            
            if(prop === 'content') el.innerText = val;
            else if(prop === 'src') el.src = val;
            else if(prop === 'href') el.href = val;
            else if(prop === 'classes') {
                el.className = 'canvas-el selected ' + val;
            }
            else if(prop === 'id') el.id = val;
            else {
                // Ensure correct camelCase for style object
                // Usually prop comes in as camelCase from mkInput args, but let's be safe
                el.style[prop] = val;
            }
            
            window.saveState();
        };

        window.renderLayers = () => {
             const list = document.getElementById('panel-layers');
             if(!iframeDoc) return;
             
             let html = '';
             window._layerLookup = []; // Reset global lookup
             
             const walk = (node, depth) => {
                  if(node.nodeType === 1 && node.classList.contains('canvas-el')) {
                       window._layerLookup.push(node);
                       const idx = window._layerLookup.length - 1;
                       const isSel = node === window.selectedEl ? 'background:rgba(0, 240, 255, 0.1); color:var(--cyan); border-left: 2px solid var(--cyan);' : '';
                       const pad = depth * 15 + 10;
                       let label = node.tagName.toLowerCase();
                       if(node.id) label += `<span style="opacity:0.6">#${node.id}</span>`;
                       if(node.classList.length > 2) label += `<span style="opacity:0.6">.${node.classList[1]}</span>`; // 0 is canvas-el
                       
                       html += `<div class="layer-item" draggable="true" ondragstart="window.dragLayerStart(event, ${idx})" ondragover="window.dragLayerOver(event, ${idx})" ondrop="window.dropLayer(event, ${idx})" onclick="window.selectElement(window._layerLookup[${idx}])" style="${isSel} padding:6px 10px 6px ${pad}px; cursor:pointer; font-size:11px; border-bottom:1px solid rgba(255,255,255,0.05); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; transition:0.2s;">
                           ${label}
                       </div>`;
                  }
                  Array.from(node.children).forEach(c => walk(c, depth+1));
             };
             
             walk(iframeDoc.body, 0);
             list.innerHTML = html || '<div style="padding:20px; text-align:center; color:gray;">No layers</div>';
        };
        
        // --- LAYER DRAG AND DROP ---
        window.dragLayerStart = (e, index) => {
            e.dataTransfer.setData('text/plain', index);
            e.target.classList.add('dragging');
        };
        
        window.dragLayerOver = (e, index) => {
             e.preventDefault(); // Allow drop
             document.querySelectorAll('.layer-item').forEach(el => el.classList.remove('drag-over'));
             e.currentTarget.classList.add('drag-over');
        };
        
        window.dropLayer = (e, targetIndex) => {
             e.preventDefault();
             document.querySelectorAll('.layer-item').forEach(el => el.classList.remove('dragging', 'drag-over'));
             
             const sourceIndex = parseInt(e.dataTransfer.getData('text/plain'));
             const sourceEl = window._layerLookup[sourceIndex];
             const targetEl = window._layerLookup[targetIndex];
             
             if(sourceEl && targetEl && sourceEl !== targetEl) {
                 // Logic: insert source before target in DOM
                 if(targetEl.parentNode) {
                     // Check if dropping before or after based on mouse Y? 
                     // Simple default: Insert Before
                     targetEl.parentNode.insertBefore(sourceEl, targetEl);
                     window.saveState();
                     window.renderLayers();
                     window.selectElement(sourceEl);
                 }
             }
        };

        // --- INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', () => {
            initCanvas();
            setupEventListeners();
            setupToolbox();
            renderPageTabs();
            // Setup Global Shortcuts
            document.addEventListener('keydown', window.handleGlobalKeys);
            // Click away from ctx menu
            document.addEventListener('click', (e) => {
                if(!e.target.closest('#context-menu')) closeContextMenu();
            });

            if(typeof renderCssLibrary === 'function') renderCssLibrary();
            // IMPORTANT: Render the restored JS library
            if(typeof renderJsLibrary === 'function') renderJsLibrary();
            
            document.addEventListener('click', () => ensureSoundInitialized(), {once:true});
            document.getElementById('ai-img-accept-btn').onclick = window.acceptAiImage;
             const toggleBtn = document.getElementById('toggle-sidebar-btn');
            if (toggleBtn) {
                toggleBtn.style.display = 'inline-flex';
                toggleBtn.onclick = () => { document.getElementById('sidebar').classList.toggle('active'); };
            }
        });
        
        window.handleGlobalKeys = (e) => {
            const activeEl = document.activeElement;
            const iframeActiveEl = iframeDoc ? iframeDoc.activeElement : null;
            
            // Check if user is typing text
            const isInput = (activeEl && (['INPUT','TEXTAREA'].includes(activeEl.tagName) || activeEl.isContentEditable)) ||
                            (iframeActiveEl && (['INPUT','TEXTAREA'].includes(iframeActiveEl.tagName) || iframeActiveEl.isContentEditable));
            
            // Delete Key
            if (e.key === 'Delete' || e.key === 'Backspace') {
                if(window.selectedEl && !isInput) {
                    window.ctxAction('del');
                } else {
                    // CRITICAL: If typing text, do NOT trigger delete element
                    return; 
                }
            }
            
            if (e.key === 'Escape') {
                window.deselect();
                closeContextMenu();
            }
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'z') { e.preventDefault(); if (e.shiftKey) window.redo(); else window.undo(); }
                else if (e.key === 'y') { e.preventDefault(); window.redo(); }
                else if (e.key === 'c') {
                    // Copy
                    if(!isInput && window.selectedEl) {
                        e.preventDefault();
                        window.ctxAction('copy');
                    }
                }
                else if (e.key === 'v') {
                    // Paste
                    if(!isInput) {
                        e.preventDefault();
                        window.ctxAction('paste');
                    }
                }
                else if (e.key === 'x') {
                    // Cut
                    if(!isInput && window.selectedEl) {
                        e.preventDefault();
                        window.ctxAction('cut');
                    }
                }
                else if (e.key === 'd') {
                    // Duplicate
                    if(!isInput && window.selectedEl) {
                        e.preventDefault();
                        window.ctxAction('dup');
                    }
                }
                else if (e.key === 's') {
                    // Save (Local/Export)
                    e.preventDefault();
                    window.exportHTML();
                }
            }
        };
    </script>
</body>
</html>