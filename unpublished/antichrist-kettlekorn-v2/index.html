<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AntiChrist KettleKorn v2.0 - Ultimate Antinet Zettelkasten</title>
    <style>
        :root {
            /* Primitive Color Tokens */
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-teal-800: rgba(41, 150, 161, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);

            /* RGB versions for opacity control */
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-red-400-rgb: 255, 84, 89;
            --color-orange-500-rgb: 168, 75, 47;
            --color-orange-400-rgb: 230, 129, 97;

            /* Dark theme overrides for AK aesthetic */
            --ak-bg-primary: #0a0a0b;
            --ak-bg-secondary: #1a1a1c;
            --ak-bg-tertiary: #2a2a2e;
            --ak-text-primary: #e8e3d3;
            --ak-text-secondary: #b8b0a0;
            --ak-accent-red: #8b1538;
            --ak-accent-gold: #d4af37;
            --ak-accent-crimson: #dc143c;
            --ak-border: rgba(212, 175, 55, 0.3);
            --ak-shadow: rgba(0, 0, 0, 0.8);

            /* Typography */
            --font-family-base: "Georgia", "Times New Roman", serif;
            --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-md: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --font-size-4xl: 30px;

            /* Spacing */
            --space-1: 1px;
            --space-2: 2px;
            --space-4: 4px;
            --space-6: 6px;
            --space-8: 8px;
            --space-10: 10px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;

            /* Border Radius */
            --radius-sm: 4px;
            --radius-base: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-full: 9999px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family-base);
            background: var(--ak-bg-primary);
            color: var(--ak-text-primary);
            font-size: var(--font-size-base);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: var(--ak-bg-secondary);
            border-bottom: 2px solid var(--ak-border);
            padding: var(--space-12) var(--space-20);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px var(--ak-shadow);
        }

        .header-actions {
            display: flex;
            gap: var(--space-8);
            align-items: center;
        }

        .header h1 {
            margin: 0;
            font-size: var(--font-size-xl);
            color: var(--ak-accent-gold);
            text-shadow: 1px 1px 2px var(--ak-shadow);
            font-weight: normal;
            letter-spacing: 1px;
        }

        .view-tabs {
            display: flex;
            gap: var(--space-4);
        }

        .tab {
            padding: var(--space-8) var(--space-16);
            background: transparent;
            border: 1px solid var(--ak-border);
            color: var(--ak-text-secondary);
            cursor: pointer;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            transition: all 0.2s ease;
        }

        .tab:hover {
            background: var(--ak-bg-tertiary);
            color: var(--ak-text-primary);
        }

        .tab.active {
            background: var(--ak-accent-red);
            color: var(--ak-text-primary);
            border-color: var(--ak-accent-red);
            box-shadow: 0 0 10px rgba(139, 21, 56, 0.5);
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            background: var(--ak-bg-secondary);
            border-right: 1px solid var(--ak-border);
            overflow-y: auto;
            padding: var(--space-16);
        }

        .content-area {
            flex: 1;
            background: var(--ak-bg-primary);
            overflow: hidden;
            position: relative;
        }

        /* Zettel Editor */
        .zettel-editor {
            height: 100%;
            padding: var(--space-20);
            display: flex;
            flex-direction: column;
            gap: var(--space-16);
        }

        .zettel-header {
            display: flex;
            gap: var(--space-16);
            align-items: center;
            margin-bottom: var(--space-16);
        }

        .zettel-id {
            background: var(--ak-accent-gold);
            color: var(--ak-bg-primary);
            padding: var(--space-6) var(--space-12);
            border-radius: var(--radius-full);
            font-weight: bold;
            font-size: var(--font-size-sm);
            font-family: var(--font-family-mono);
        }

        .zettel-title {
            flex: 1;
            background: var(--ak-bg-secondary);
            border: 1px solid var(--ak-border);
            padding: var(--space-8) var(--space-12);
            border-radius: var(--radius-sm);
            color: var(--ak-text-primary);
            font-size: var(--font-size-lg);
        }

        .zettel-content {
            flex: 1;
            background: var(--ak-bg-secondary);
            border: 1px solid var(--ak-border);
            padding: var(--space-16);
            border-radius: var(--radius-sm);
            color: var(--ak-text-primary);
            font-family: var(--font-family-base);
            font-size: var(--font-size-base);
            line-height: 1.8;
            resize: none;
            outline: none;
        }

        .zettel-meta {
            background: var(--ak-bg-tertiary);
            border: 1px solid var(--ak-border);
            padding: var(--space-12);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
        }

        /* Tree View */
        .tree-view {
            padding: var(--space-20);
            height: 100%;
            overflow-y: auto;
        }

        .tree-node {
            margin-left: var(--space-20);
            margin-bottom: var(--space-8);
            position: relative;
        }

        .tree-node::before {
            content: '';
            position: absolute;
            left: -12px;
            top: 12px;
            width: 8px;
            height: 1px;
            background: var(--ak-border);
        }

        .tree-item {
            padding: var(--space-6) var(--space-12);
            background: var(--ak-bg-secondary);
            border: 1px solid var(--ak-border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: var(--space-8);
        }

        .tree-item:hover {
            background: var(--ak-bg-tertiary);
            border-color: var(--ak-accent-gold);
        }

        .tree-item-id {
            font-family: var(--font-family-mono);
            color: var(--ak-accent-gold);
            font-weight: bold;
            font-size: var(--font-size-sm);
        }

        /* Conspiracy Board */
        .conspiracy-board {
            width: 100%;
            height: 100%;
            position: relative;
            background: 
                radial-gradient(circle at 25px 25px, rgba(212, 175, 55, 0.1) 2px, transparent 0),
                radial-gradient(circle at 75px 75px, rgba(139, 21, 56, 0.1) 2px, transparent 0);
            background-size: 100px 100px;
            background-color: #0f0a0a;
            overflow: hidden;
            cursor: grab;
        }

        .conspiracy-board.dragging {
            cursor: grabbing;
        }

        .conspiracy-card {
            position: absolute;
            width: 200px;
            min-height: 150px;
            background: #f4f1e8;
            color: #2c2c2c;
            padding: var(--space-12);
            border-radius: var(--radius-sm);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.6), inset 0 0 0 1px rgba(139, 21, 56, 0.3);
            cursor: move;
            transform: rotate(-2deg);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            font-size: var(--font-size-sm);
            line-height: 1.4;
        }

        .conspiracy-card:nth-child(2n) {
            transform: rotate(1deg);
        }

        .conspiracy-card:nth-child(3n) {
            transform: rotate(-1deg);
        }

        .conspiracy-card:hover {
            transform: rotate(0deg) scale(1.05);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.8);
            z-index: 10;
        }

        .conspiracy-card-id {
            background: var(--ak-accent-red);
            color: white;
            padding: var(--space-2) var(--space-6);
            border-radius: var(--radius-sm);
            font-family: var(--font-family-mono);
            font-size: var(--font-size-xs);
            font-weight: bold;
            display: inline-block;
            margin-bottom: var(--space-6);
        }

        .conspiracy-card-title {
            font-weight: bold;
            margin-bottom: var(--space-6);
            color: #1a1a1a;
        }

        .conspiracy-card-content {
            color: #4a4a4a;
            font-size: var(--font-size-xs);
        }

        .connection-line {
            position: absolute;
            height: 2px;
            background: var(--ak-accent-crimson);
            transform-origin: left center;
            opacity: 0.8;
            pointer-events: none;
            z-index: 1;
        }

        /* Graph View */
        .graph-view {
            width: 100%;
            height: 100%;
            background: var(--ak-bg-primary);
        }

        #graph-canvas {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #1a1a1c 0%, #0a0a0b 100%);
        }

        /* Index View */
        .index-view {
            padding: var(--space-20);
            height: 100%;
            overflow-y: auto;
        }

        .index-entry {
            background: var(--ak-bg-secondary);
            border: 1px solid var(--ak-border);
            padding: var(--space-16);
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-12);
        }

        .index-keyword {
            font-size: var(--font-size-lg);
            font-weight: bold;
            color: var(--ak-accent-gold);
            margin-bottom: var(--space-8);
        }

        .index-description {
            color: var(--ak-text-secondary);
            margin-bottom: var(--space-8);
        }

        .index-zettel-list {
            display: flex;
            gap: var(--space-6);
            flex-wrap: wrap;
        }

        .index-zettel-link {
            background: var(--ak-accent-red);
            color: var(--ak-text-primary);
            padding: var(--space-4) var(--space-8);
            border-radius: var(--radius-sm);
            font-family: var(--font-family-mono);
            font-size: var(--font-size-xs);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .index-zettel-link:hover {
            background: var(--ak-accent-crimson);
        }

        /* AI Ingestion */
        .ai-ingestion {
            padding: var(--space-20);
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: var(--space-16);
        }

        .ai-input {
            flex: 1;
            background: var(--ak-bg-secondary);
            border: 1px solid var(--ak-border);
            padding: var(--space-16);
            border-radius: var(--radius-sm);
            color: var(--ak-text-primary);
            font-family: var(--font-family-base);
            resize: none;
            outline: none;
        }

        .ai-controls {
            display: flex;
            gap: var(--space-12);
            align-items: center;
        }

        .btn {
            padding: var(--space-8) var(--space-16);
            background: var(--ak-accent-red);
            color: var(--ak-text-primary);
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: var(--font-size-sm);
            transition: background 0.2s ease;
        }

        .btn:hover {
            background: var(--ak-accent-crimson);
        }

        .btn-secondary {
            background: var(--ak-bg-tertiary);
            border: 1px solid var(--ak-border);
        }

        .btn-secondary:hover {
            background: var(--ak-bg-secondary);
        }

        /* Sidebar Components */
        .sidebar-section {
            margin-bottom: var(--space-24);
        }

        .sidebar-title {
            font-size: var(--font-size-sm);
            font-weight: bold;
            color: var(--ak-accent-gold);
            margin-bottom: var(--space-8);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .zettel-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .zettel-list li {
            padding: var(--space-6) var(--space-8);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: var(--font-size-sm);
            display: flex;
            align-items: center;
            gap: var(--space-6);
        }

        .zettel-list li:hover {
            background: var(--ak-bg-tertiary);
        }

        .zettel-list-id {
            font-family: var(--font-family-mono);
            color: var(--ak-accent-gold);
            font-size: var(--font-size-xs);
            font-weight: bold;
            min-width: 40px;
        }

        .search-input {
            width: 100%;
            background: var(--ak-bg-tertiary);
            border: 1px solid var(--ak-border);
            padding: var(--space-8);
            border-radius: var(--radius-sm);
            color: var(--ak-text-primary);
            font-size: var(--font-size-sm);
            outline: none;
        }

        .search-input:focus {
            border-color: var(--ak-accent-gold);
        }

        /* Hidden views */
        .view {
            display: none;
            height: 100%;
        }

        .view.active {
            display: block;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header {
                padding: var(--space-8) var(--space-12);
                flex-direction: column;
                gap: var(--space-12);
            }
            
            .header h1 {
                font-size: var(--font-size-lg);
            }
            
            .view-tabs {
                flex-wrap: wrap;
                justify-content: center;
                gap: var(--space-4);
            }
            
            .tab {
                padding: var(--space-6) var(--space-8);
                font-size: var(--font-size-xs);
                min-width: 44px;
                text-align: center;
            }
            
            .header-actions {
                order: -1;
            }
            
            .sidebar {
                position: fixed;
                top: 0;
                left: -280px;
                height: 100vh;
                z-index: 999;
                transition: left 0.3s ease;
                box-shadow: 2px 0 10px var(--ak-shadow);
            }
            
            .sidebar.mobile-open {
                left: 0;
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: var(--space-16);
            }
            
            .conspiracy-card {
                width: 160px;
                min-height: 120px;
                font-size: 11px;
            }
            
            .zettel-header {
                flex-direction: column;
                gap: var(--space-8);
            }
            
            .zettel-header > div {
                order: -1;
                align-self: flex-end;
            }
        }
        
        /* Mobile sidebar toggle */
        .mobile-sidebar-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: var(--ak-accent-red);
            color: white;
            border: none;
            border-radius: var(--radius-full);
            width: 44px;
            height: 44px;
            cursor: pointer;
            font-size: 18px;
        }
        
        @media (max-width: 768px) {
            .mobile-sidebar-toggle {
                display: block;
            }
        }
        
        /* Sidebar overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
        }
        
        .sidebar-overlay.active {
            display: block;
        }

        /* Status Bar */
        .status-bar {
            background: var(--ak-bg-secondary);
            border-top: 1px solid var(--ak-border);
            padding: var(--space-6) var(--space-16);
            font-size: var(--font-size-xs);
            color: var(--ak-text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Special effects */
        .glow {
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { box-shadow: 0 0 5px var(--ak-accent-gold); }
            to { box-shadow: 0 0 20px var(--ak-accent-gold), 0 0 30px var(--ak-accent-gold); }
        }

        .pulse {
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            background-color: var(--ak-bg-secondary);
            margin: 5% auto;
            padding: var(--space-24);
            border: 2px solid var(--ak-border);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 600px;
            position: relative;
            animation: slideIn 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-20);
            border-bottom: 1px solid var(--ak-border);
            padding-bottom: var(--space-12);
        }

        .modal-title {
            color: var(--ak-accent-gold);
            font-size: var(--font-size-xl);
            margin: 0;
        }

        .close {
            color: var(--ak-text-secondary);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .close:hover {
            color: var(--ak-accent-crimson);
        }

        .form-group {
            margin-bottom: var(--space-16);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-6);
            color: var(--ak-text-primary);
            font-weight: bold;
        }

        .form-input {
            width: 100%;
            padding: var(--space-8) var(--space-12);
            background: var(--ak-bg-tertiary);
            border: 1px solid var(--ak-border);
            border-radius: var(--radius-sm);
            color: var(--ak-text-primary);
            font-size: var(--font-size-base);
            outline: none;
        }

        .form-input:focus {
            border-color: var(--ak-accent-gold);
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.3);
        }

        .api-key-status {
            padding: var(--space-8);
            border-radius: var(--radius-sm);
            margin-top: var(--space-8);
            font-size: var(--font-size-sm);
        }

        .api-key-status.success {
            background: rgba(33, 128, 141, 0.2);
            color: var(--color-teal-300);
            border: 1px solid var(--color-teal-500);
        }

        .api-key-status.error {
            background: rgba(220, 20, 60, 0.2);
            color: var(--ak-accent-crimson);
            border: 1px solid var(--ak-accent-crimson);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--ak-bg-secondary);
            color: var(--ak-text-primary);
            padding: var(--space-12) var(--space-16);
            border-radius: var(--radius-lg);
            border: 1px solid var(--ak-border);
            box-shadow: 0 4px 12px var(--ak-shadow);
            z-index: 1001;
            animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s;
            min-width: 250px;
        }

        .toast.success {
            border-color: var(--color-teal-500);
        }

        .toast.error {
            border-color: var(--ak-accent-crimson);
        }

        .ai-suggestion {
            background: var(--ak-bg-tertiary);
            border: 1px solid var(--ak-border);
            border-radius: var(--radius-sm);
            padding: var(--space-16);
            margin-bottom: var(--space-12);
        }

        .ai-suggestion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-12);
        }

        .ai-suggestion-id {
            background: var(--ak-accent-gold);
            color: var(--ak-bg-primary);
            padding: var(--space-4) var(--space-8);
            border-radius: var(--radius-sm);
            font-family: var(--font-family-mono);
            font-size: var(--font-size-xs);
            font-weight: bold;
        }

        .ai-suggestion-actions {
            display: flex;
            gap: var(--space-8);
        }

        .btn-sm {
            padding: var(--space-4) var(--space-8);
            font-size: var(--font-size-xs);
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--ak-border);
            border-radius: 50%;
            border-top-color: var(--ak-accent-gold);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Mobile Sidebar Toggle -->
        <button class="mobile-sidebar-toggle" onclick="toggleMobileSidebar()">‚ò∞</button>
        
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" onclick="closeMobileSidebar()"></div>
        
        <!-- Header -->
        <header class="header">
            <h1>‚∏∏ AntiChrist KettleKorn v2.0 ‚∏∏</h1>
            <div class="view-tabs">
                <button class="tab active" data-view="editor">‚úçÔ∏è Zettel</button>
                <button class="tab" data-view="tree">üå≥ Tree</button>
                <button class="tab" data-view="conspiracy">üï∏Ô∏è Board</button>
                <button class="tab" data-view="graph">üìä Graph</button>
                <button class="tab" data-view="index">üìö Index</button>
                <button class="tab" data-view="ai">ü§ñ AI</button>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="openSearchModal()">üîç</button>
                <button class="btn btn-secondary" onclick="exportData()">üíæ Export</button>
                <button class="btn btn-secondary" onclick="openSettingsModal()">‚öôÔ∏è Settings</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Search</h3>
                    <input type="text" class="search-input" placeholder="Search zettels..." id="search-input">
                </div>

                <div class="sidebar-section">
                    <h3 class="sidebar-title">Recent</h3>
                    <ul class="zettel-list" id="recent-list">
                        <!-- Populated by JS -->
                    </ul>
                </div>

                <div class="sidebar-section">
                    <h3 class="sidebar-title">Current Zettel</h3>
                    <div id="current-zettel-meta">
                        <p><strong>ID:</strong> <span id="current-id">1</span></p>
                        <p><strong>Created:</strong> <span id="current-created"></span></p>
                        <p><strong>Modified:</strong> <span id="current-modified"></span></p>
                        <p><strong>Links:</strong> <span id="current-links"></span></p>
                        <p><strong>Backlinks:</strong> <span id="current-backlinks"></span></p>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3 class="sidebar-title">Quick Actions</h3>
                    <button class="btn btn-secondary" onclick="createNewZettel()" style="width: 100%; margin-bottom: 8px;">üÜï New Zettel</button>
                    <button class="btn btn-secondary" onclick="exportData()" style="width: 100%; margin-bottom: 8px;">üíæ Export JSON</button>
                    <button class="btn btn-secondary" onclick="exportMarkdown()" style="width: 100%; margin-bottom: 8px;">üìù Export MD</button>
                    <button class="btn btn-secondary" onclick="importData()" style="width: 100%; margin-bottom: 8px;">üìÅ Import</button>
                    <button class="btn btn-secondary" onclick="exportConspiracyBoard()" style="width: 100%;">üï∏Ô∏è Export Board</button>
                </div>
            </aside>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Zettel Editor -->
                <div class="view active" id="editor-view">
                    <div class="zettel-editor">
                        <div class="zettel-header">
                            <span class="zettel-id" id="editor-id">1</span>
                            <input type="text" class="zettel-title" id="editor-title" placeholder="Zettel title...">
                            <div>
                                <button class="btn" onclick="saveCurrentZettel()">Save</button>
                                <button class="btn btn-secondary" onclick="deleteCurrentZettel()">Delete</button>
                            </div>
                        </div>
                        <textarea class="zettel-content" id="editor-content" placeholder="Write your atomic thought here... Use [[id]] or [[title]] to link to other zettels."></textarea>
                        <div class="zettel-meta">
                            <label>Tags (comma-separated): </label>
                            <input type="text" id="editor-tags" style="background: var(--ak-bg-primary); border: 1px solid var(--ak-border); color: var(--ak-text-primary); padding: 4px; border-radius: 4px; width: 100%; margin-top: 4px;">
                        </div>
                    </div>
                </div>

                <!-- Tree View -->
                <div class="view" id="tree-view">
                    <div class="tree-view">
                        <h2 style="color: var(--ak-accent-gold); margin-bottom: var(--space-20);">Zettelkasten Structure</h2>
                        <div id="tree-container">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Conspiracy Board -->
                <div class="view" id="conspiracy-view">
                    <div class="conspiracy-board" id="conspiracy-board">
                        <!-- Cards and connections populated by JS -->
                    </div>
                </div>

                <!-- Graph View -->
                <div class="view" id="graph-view">
                    <canvas id="graph-canvas"></canvas>
                </div>

                <!-- Index View -->
                <div class="view" id="index-view">
                    <div class="index-view">
                        <h2 style="color: var(--ak-accent-gold); margin-bottom: var(--space-20);">Manual Index</h2>
                        <button class="btn" onclick="addIndexEntry()" style="margin-bottom: var(--space-16);">Add Index Entry</button>
                        <div id="index-container">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- AI Ingestion -->
                <div class="view" id="ai-view">
                    <div class="ai-ingestion">
                        <h2 style="color: var(--ak-accent-gold); margin-bottom: var(--space-16);">AI-Assisted Ingestion</h2>
                        <textarea class="ai-input" placeholder="Paste article, notes, or ideas here for AI processing into atomic zettels..." id="ai-input"></textarea>
                        <div class="ai-controls">
                            <input type="text" placeholder="Or paste URL here..." style="flex: 1; background: var(--ak-bg-secondary); border: 1px solid var(--ak-border); padding: var(--space-8); border-radius: var(--radius-sm); color: var(--ak-text-primary);" id="ai-url">
                            <button class="btn" onclick="processWithAI()">Process with AI</button>
                        </div>
                        <div id="ai-suggestions" style="margin-top: var(--space-16);"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Status Bar -->
        <footer class="status-bar">
            <span>AntiChrist KettleKorn v2.0 | Total Zettels: <span id="zettel-count">0</span> | <span id="api-status">No API Key Set</span></span>
            <span id="last-saved">Ready</span>
        </footer>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚öôÔ∏è Settings</h2>
                <span class="close" onclick="closeModal('settings-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="api-key-input">Gemini API Key:</label>
                    <input type="password" id="api-key-input" class="form-input" placeholder="Enter your Gemini API key...">
                    <div id="api-key-status" class="api-key-status" style="display: none;"></div>
                    <small style="color: var(--ak-text-secondary); display: block; margin-top: var(--space-4);">Your API key is stored securely in your browser and never sent to any server except Google's Gemini API.</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Auto-save:</label>
                    <label style="display: flex; align-items: center; gap: var(--space-8); cursor: pointer;">
                        <input type="checkbox" id="auto-save-checkbox" checked>
                        <span>Automatically save changes after 2 seconds</span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-label">Theme:</label>
                    <select id="theme-select" class="form-input">
                        <option value="dark">Dark Mode</option>
                        <option value="light">Light Mode</option>
                    </select>
                </div>
                <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                    <button class="btn btn-secondary" onclick="clearApiKey()">Clear API Key</button>
                    <button class="btn" onclick="testApiConnection()">Test Connection</button>
                    <button class="btn" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div id="search-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üîç Advanced Search</h2>
                <span class="close" onclick="closeModal('search-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Search Query:</label>
                    <input type="text" id="advanced-search-input" class="form-input" placeholder="Enter search terms...">
                </div>
                <div class="form-group">
                    <label class="form-label">Search In:</label>
                    <div style="display: flex; gap: var(--space-16); flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: var(--space-4); cursor: pointer;">
                            <input type="checkbox" id="search-title" checked> Title
                        </label>
                        <label style="display: flex; align-items: center; gap: var(--space-4); cursor: pointer;">
                            <input type="checkbox" id="search-content" checked> Content
                        </label>
                        <label style="display: flex; align-items: center; gap: var(--space-4); cursor: pointer;">
                            <input type="checkbox" id="search-tags" checked> Tags
                        </label>
                        <label style="display: flex; align-items: center; gap: var(--space-4); cursor: pointer;">
                            <input type="checkbox" id="search-id"> ID
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Filter by Tags:</label>
                    <input type="text" id="tag-filter" class="form-input" placeholder="Enter tags (comma-separated)...">
                </div>
                <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                    <button class="btn btn-secondary" onclick="closeModal('search-modal')">Cancel</button>
                    <button class="btn" onclick="performAdvancedSearch()">Search</button>
                </div>
                <div id="search-results" style="margin-top: var(--space-20);"></div>
            </div>
        </div>
    </div>

    <!-- Welcome Modal -->
    <div id="welcome-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚ú® Welcome to AntiChrist KettleKorn v2.0</h2>
            </div>
            <div class="modal-body">
                <p>Welcome to the ultimate digital Antinet Zettelkasten system! This tool helps you build a second mind through interconnected atomic notes.</p>
                <h3 style="color: var(--ak-accent-gold); margin-bottom: var(--space-12);">Get Started:</h3>
                <div style="display: flex; flex-direction: column; gap: var(--space-12); margin-bottom: var(--space-20);">
                    <button class="btn" onclick="loadSampleData()">üìö Load Sample Zettels (Recommended)</button>
                    <button class="btn btn-secondary" onclick="startFresh()">üÜï Start Fresh</button>
                </div>
                <p style="color: var(--ak-text-secondary); font-size: var(--font-size-sm);">Tip: Use Ctrl+K to search, Ctrl+N for new zettel, and explore different views with the tabs above!</p>
            </div>
        </div>
    </div>

    <!-- File Input for Import -->
    <input type="file" id="import-file-input" accept=".json" style="display: none;">

    <script>
        // Core Data Structures
        let zettels = new Map();
        let indexEntries = [];
        let boards = new Map();
        let currentZettelId = '1';
        let currentView = 'editor';
        let settings = {
            apiKey: '',
            theme: 'dark',
            autoSave: true,
            lastBackup: 0
        };
        let isFirstTime = true;

        // Sample data from provided JSON
        const sampleZettels = [
            {
                id: "1",
                title: "Antinet Zettelkasten Principles",
                content: "The **Antinet Zettelkasten** (coined by Scott Scheper) embodies four core principles:\n\n- **A**nalog (or adapted for digital)\n- **N**umeric-alpha addressing\n- **T**ree structure\n- **I**ndex\n\nThese principles create a thinking system that develops personality over time.\n\nSee: [[1a]] for addressing details, [[1b]] for tree structure",
                tags: ["zettelkasten", "core-concepts", "antinet"],
                links: ["1a", "1b"],
                created: 1729458000000,
                modified: 1729458000000
            },
            {
                id: "1a",
                title: "Alphanumeric Addressing System",
                content: "The alphanumeric address (like 1a2b3c) provides **permanent IDs** while allowing infinite branching.\n\nRules:\n- Letters = parallel thoughts (1a, 1b, 1c)\n- Numbers = sequential development (1a1, 1a2, 1a3)\n- Continue alternating (1a1a, 1a1b)\n\nThis creates geographic coordinates in your knowledge space.\n\nRelated: [[1]] [[1a1]]",
                tags: ["addressing", "system-design", "antinet"],
                links: ["1", "1a1"],
                created: 1729458300000,
                modified: 1729458300000
            },
            {
                id: "1a1",
                title: "When to Branch vs Sequence",
                content: "**Use letters** when ideas are parallel or alternative perspectives on the same concept.\n\n**Use numbers** when ideas build sequentially or develop the previous thought.\n\nExample:\n- 1a: Main concept\n- 1a1: Development of 1a\n- 1a2: Further development\n- 1a1a: Alternative angle on 1a1\n\nRelated: [[1a]]",
                tags: ["addressing", "methodology"],
                links: ["1a"],
                created: 1729458600000,
                modified: 1729458600000
            },
            {
                id: "1b",
                title: "Tree Structure (Non-Hierarchical)",
                content: "Unlike traditional hierarchies, the tree structure is about **proximity and location**, not categories.\n\nNotes branch infinitely without rigid categorization. The structure emerges from content, not predefined folders.\n\nThis allows ideas to connect organically across traditional boundaries.\n\nRelated: [[1]]",
                tags: ["structure", "core-concepts", "emergence"],
                links: ["1"],
                created: 1729458900000,
                modified: 1729458900000
            },
            {
                id: "2",
                title: "Digital vs Analog Tradeoffs",
                content: "**Digital advantages:**\n- Instant search\n- Automatic backlinks\n- Multiple visualizations\n- AI assistance\n- Unlimited space\n\n**Analog advantages:**\n- Tactile memory\n- Slower = deeper processing\n- No digital distraction\n\nThe key is preserving the **principles** while leveraging digital superpowers.\n\nRelated: [[1]] [[2a]]",
                tags: ["digital", "analog", "philosophy"],
                links: ["1", "2a"],
                created: 1729459200000,
                modified: 1729459200000
            },
            {
                id: "2a",
                title: "Conspiracy Board as Thinking Tool",
                content: "Spatial arrangement of notes mimics physical cork boards with string connections.\n\n**Why this works:**\n- Visual patterns reveal hidden connections\n- Spatial memory enhances recall\n- Non-linear arrangement encourages lateral thinking\n- Red string aesthetic adds playfulness\n\nThis is thinking made visible.\n\nRelated: [[2]]",
                tags: ["visualization", "conspiracy-board", "spatial-thinking"],
                links: ["2"],
                created: 1729459500000,
                modified: 1729459500000
            }
        ];

        const sampleIndex = [
            {
                keyword: "Zettelkasten Core Principles",
                description: "Fundamental concepts of Antinet methodology",
                zettelIds: ["1", "1a", "1b"]
            },
            {
                keyword: "Alphanumeric Addressing",
                description: "How to assign IDs and branch notes",
                zettelIds: ["1a", "1a1"]
            },
            {
                keyword: "Digital Tools & Visualization",
                description: "Digital-specific features and advantages",
                zettelIds: ["2", "2a"]
            }
        ];

        const sampleBoard = {
            id: "main",
            name: "Main Board",
            zettels: [
                { zettelId: "1", x: 150, y: 150, connections: ["1a", "1b", "2"] },
                { zettelId: "1a", x: 400, y: 100, connections: ["1", "1a1"] },
                { zettelId: "1a1", x: 650, y: 100, connections: ["1a"] },
                { zettelId: "1b", x: 400, y: 200, connections: ["1"] },
                { zettelId: "2", x: 150, y: 350, connections: ["1", "2a"] },
                { zettelId: "2a", x: 400, y: 350, connections: ["2"] }
            ]
        };

        // IndexedDB functions
        let db;

        function initDB() {
            const request = indexedDB.open('AntinetZettelkasten', 1);
            
            request.onerror = function(event) {
                console.error('Database error:', event.target.error);
            };
            
            request.onsuccess = function(event) {
                db = event.target.result;
                loadData();
            };
            
            request.onupgradeneeded = function(event) {
                db = event.target.result;
                
                // Create object stores
                if (!db.objectStoreNames.contains('zettels')) {
                    db.createObjectStore('zettels', { keyPath: 'id' });
                }
                if (!db.objectStoreNames.contains('index')) {
                    db.createObjectStore('index', { keyPath: 'keyword' });
                }
                if (!db.objectStoreNames.contains('boards')) {
                    db.createObjectStore('boards', { keyPath: 'id' });
                }
                if (!db.objectStoreNames.contains('settings')) {
                    db.createObjectStore('settings', { keyPath: 'key' });
                }
            };
        }

        function saveToDB(storeName, data) {
            if (!db) return;
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            store.put(data);
        }

        function loadFromDB(storeName, callback) {
            if (!db) return;
            const transaction = db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const request = store.getAll();
            
            request.onsuccess = function(event) {
                callback(event.target.result);
            };
        }

        function loadData() {
            // Load settings first
            loadFromDB('settings', function(settingsData) {
                if (settingsData.length > 0) {
                    settingsData.forEach(s => {
                        if (s.key === 'main') {
                            settings = { ...settings, ...s.data };
                        }
                    });
                }
                updateApiStatus();
            });

            // Load zettels
            loadFromDB('zettels', function(data) {
                if (data.length === 0) {
                    // Show welcome modal on first run
                    isFirstTime = true;
                    setTimeout(() => openModal('welcome-modal'), 500);
                } else {
                    isFirstTime = false;
                    data.forEach(z => zettels.set(z.id, z));
                    loadZettel(currentZettelId);
                    updateUI();
                }
            });

            // Load index
            loadFromDB('index', function(data) {
                if (data.length > 0) {
                    indexEntries = data;
                }
                renderIndex();
            });

            // Load boards
            loadFromDB('boards', function(data) {
                if (data.length > 0) {
                    data.forEach(b => boards.set(b.id, b));
                } else if (boards.size === 0 && !isFirstTime) {
                    boards.set('main', sampleBoard);
                    saveToDB('boards', sampleBoard);
                }
                renderConspiracyBoard();
            });
        }

        // Core Functions
        function generateNextId(baseId = '') {
            if (!baseId) {
                // Find highest numeric root
                let maxNum = 0;
                zettels.forEach((_, id) => {
                    if (/^\d+$/.test(id)) {
                        maxNum = Math.max(maxNum, parseInt(id));
                    }
                });
                return String(maxNum + 1);
            }

            // Generate branch ID
            const lastChar = baseId.slice(-1);
            if (/\d$/.test(baseId)) {
                // Last char is number, add letter
                return baseId + 'a';
            } else {
                // Last char is letter, increment it
                const nextChar = String.fromCharCode(lastChar.charCodeAt(0) + 1);
                return baseId.slice(0, -1) + nextChar;
            }
        }

        function extractLinks(content) {
            const linkRegex = /\[\[([^\]]+)\]\]/g;
            const links = [];
            let match;
            while ((match = linkRegex.exec(content)) !== null) {
                links.push(match[1]);
            }
            return links;
        }

        function calculateBacklinks(zettelId) {
            const backlinks = [];
            zettels.forEach((zettel, id) => {
                if (id !== zettelId) {
                    const links = extractLinks(zettel.content);
                    if (links.some(link => link === zettelId || link === zettel.title)) {
                        backlinks.push(id);
                    }
                }
            });
            return backlinks;
        }

        function saveCurrentZettel() {
            const id = document.getElementById('editor-id').textContent;
            const title = document.getElementById('editor-title').value;
            const content = document.getElementById('editor-content').value;
            const tags = document.getElementById('editor-tags').value.split(',').map(t => t.trim()).filter(t => t);

            const now = new Date().toISOString();
            const existing = zettels.get(id);
            
            const zettel = {
                id,
                title,
                content,
                created: existing ? existing.created : now,
                modified: now,
                tags
            };

            zettels.set(id, zettel);
            saveToDB('zettels', zettel);
            updateUI();
            updateStatus('Zettel saved successfully');
        }

        function loadZettel(id) {
            const zettel = zettels.get(id);
            if (!zettel) return;

            currentZettelId = id;
            
            document.getElementById('editor-id').textContent = zettel.id;
            document.getElementById('editor-title').value = zettel.title || '';
            document.getElementById('editor-content').value = zettel.content || '';
            document.getElementById('editor-tags').value = (zettel.tags || []).join(', ');

            updateCurrentZettelMeta(zettel);
        }

        function updateCurrentZettelMeta(zettel) {
            document.getElementById('current-id').textContent = zettel.id;
            document.getElementById('current-created').textContent = new Date(zettel.created).toLocaleDateString();
            document.getElementById('current-modified').textContent = new Date(zettel.modified).toLocaleDateString();
            
            const links = extractLinks(zettel.content);
            document.getElementById('current-links').textContent = links.join(', ') || 'None';
            
            const backlinks = calculateBacklinks(zettel.id);
            document.getElementById('current-backlinks').textContent = backlinks.join(', ') || 'None';
        }

        function createNewZettel() {
            const newId = generateNextId(currentZettelId);
            const now = new Date().toISOString();
            
            const newZettel = {
                id: newId,
                title: '',
                content: '',
                created: now,
                modified: now,
                tags: []
            };

            zettels.set(newId, newZettel);
            saveToDB('zettels', newZettel);
            loadZettel(newId);
            updateUI();
            
            // Focus title input
            document.getElementById('editor-title').focus();
        }

        function deleteCurrentZettel() {
            if (!confirm(`Delete zettel ${currentZettelId}?`)) return;
            
            zettels.delete(currentZettelId);
            
            // Remove from IndexedDB
            if (db) {
                const transaction = db.transaction(['zettels'], 'readwrite');
                const store = transaction.objectStore('zettels');
                store.delete(currentZettelId);
            }

            // Load first available zettel
            const firstId = zettels.keys().next().value || '1';
            if (zettels.has(firstId)) {
                loadZettel(firstId);
            } else {
                createNewZettel();
            }
            
            updateUI();
        }

        function updateUI() {
            // Update zettel count
            document.getElementById('zettel-count').textContent = zettels.size;
            
            // Update recent list
            const recentList = document.getElementById('recent-list');
            recentList.innerHTML = '';
            
            const sortedZettels = Array.from(zettels.values())
                .sort((a, b) => new Date(b.modified) - new Date(a.modified))
                .slice(0, 10);

            sortedZettels.forEach(zettel => {
                const li = document.createElement('li');
                li.innerHTML = `<span class="zettel-list-id">${zettel.id}</span>${zettel.title || 'Untitled'}`;
                li.onclick = () => loadZettel(zettel.id);
                recentList.appendChild(li);
            });

            renderTreeView();
            renderConspiracyBoard();
            renderGraph();
        }

        function renderTreeView() {
            const container = document.getElementById('tree-container');
            container.innerHTML = '';

            // Sort zettels by ID for tree display
            const sortedIds = Array.from(zettels.keys()).sort((a, b) => {
                // Custom sort for alphanumeric IDs
                const aParts = a.match(/(\d+|[a-z]+)/g) || [];
                const bParts = b.match(/(\d+|[a-z]+)/g) || [];
                
                for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
                    const aPart = aParts[i] || '';
                    const bPart = bParts[i] || '';
                    
                    if (aPart !== bPart) {
                        // If both are numbers, compare numerically
                        if (/^\d+$/.test(aPart) && /^\d+$/.test(bPart)) {
                            return parseInt(aPart) - parseInt(bPart);
                        }
                        // Otherwise compare lexicographically
                        return aPart.localeCompare(bPart);
                    }
                }
                return 0;
            });

            sortedIds.forEach(id => {
                const zettel = zettels.get(id);
                const depth = (id.length - 1); // Rough depth calculation
                
                const node = document.createElement('div');
                node.className = 'tree-node';
                node.style.marginLeft = `${depth * 20}px`;
                
                const item = document.createElement('div');
                item.className = 'tree-item';
                item.innerHTML = `
                    <span class="tree-item-id">${id}</span>
                    <span>${zettel.title || 'Untitled'}</span>
                `;
                item.onclick = () => {
                    loadZettel(id);
                    switchView('editor');
                };
                
                node.appendChild(item);
                container.appendChild(node);
            });
        }

        function renderConspiracyBoard() {
            const board = boards.get('board-1');
            if (!board) return;

            const container = document.getElementById('conspiracy-board');
            container.innerHTML = '';

            // Create cards
            board.zettels.forEach(boardZettel => {
                const zettel = zettels.get(boardZettel.zettelId);
                if (!zettel) return;

                const card = document.createElement('div');
                card.className = 'conspiracy-card';
                card.style.left = boardZettel.x + 'px';
                card.style.top = boardZettel.y + 'px';
                card.innerHTML = `
                    <div class="conspiracy-card-id">${zettel.id}</div>
                    <div class="conspiracy-card-title">${zettel.title || 'Untitled'}</div>
                    <div class="conspiracy-card-content">${zettel.content.substring(0, 100)}...</div>
                `;
                
                // Make draggable
                makeDraggable(card, boardZettel);
                
                card.onclick = (e) => {
                    if (!e.target.closest('.drag-handle')) {
                        loadZettel(zettel.id);
                        switchView('editor');
                    }
                };
                
                container.appendChild(card);
            });

            // Draw connections
            board.zettels.forEach(boardZettel => {
                if (!boardZettel.connections) return;
                
                boardZettel.connections.forEach(connectedId => {
                    const connectedBoardZettel = board.zettels.find(z => z.zettelId === connectedId);
                    if (!connectedBoardZettel) return;
                    
                    drawConnection(
                        boardZettel.x + 100, boardZettel.y + 75,
                        connectedBoardZettel.x + 100, connectedBoardZettel.y + 75
                    );
                });
            });
        }

        function makeDraggable(element, boardZettel) {
            let isDragging = false;
            let startX, startY, initialX, initialY;

            element.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                initialX = boardZettel.x;
                initialY = boardZettel.y;
                
                document.body.style.cursor = 'grabbing';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                boardZettel.x = initialX + dx;
                boardZettel.y = initialY + dy;
                
                element.style.left = boardZettel.x + 'px';
                element.style.top = boardZettel.y + 'px';
                
                // Redraw connections
                renderConspiracyBoard();
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    document.body.style.cursor = 'default';
                    
                    // Save board state
                    const board = boards.get('board-1');
                    saveToDB('boards', board);
                }
            });
        }

        function drawConnection(x1, y1, x2, y2) {
            const line = document.createElement('div');
            line.className = 'connection-line';
            
            const length = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
            const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
            
            line.style.width = length + 'px';
            line.style.left = x1 + 'px';
            line.style.top = y1 + 'px';
            line.style.transform = `rotate(${angle}deg)`;
            
            document.getElementById('conspiracy-board').appendChild(line);
        }

        function renderGraph() {
            const canvas = document.getElementById('graph-canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // Clear canvas
            ctx.fillStyle = '#0a0a0b';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (zettels.size === 0) return;
            
            // Simple force-directed layout
            const nodes = Array.from(zettels.values()).map(zettel => ({
                id: zettel.id,
                title: zettel.title,
                x: Math.random() * (canvas.width - 100) + 50,
                y: Math.random() * (canvas.height - 100) + 50,
                links: extractLinks(zettel.content)
            }));
            
            // Draw connections
            ctx.strokeStyle = '#dc143c';
            ctx.lineWidth = 1;
            ctx.globalAlpha = 0.6;
            
            nodes.forEach(node => {
                node.links.forEach(linkId => {
                    const targetNode = nodes.find(n => n.id === linkId);
                    if (targetNode) {
                        ctx.beginPath();
                        ctx.moveTo(node.x, node.y);
                        ctx.lineTo(targetNode.x, targetNode.y);
                        ctx.stroke();
                    }
                });
            });
            
            // Draw nodes
            ctx.globalAlpha = 1;
            nodes.forEach(node => {
                // Node circle
                ctx.fillStyle = '#d4af37';
                ctx.beginPath();
                ctx.arc(node.x, node.y, 8, 0, 2 * Math.PI);
                ctx.fill();
                
                // Node label
                ctx.fillStyle = '#e8e3d3';
                ctx.font = '10px monospace';
                ctx.textAlign = 'center';
                ctx.fillText(node.id, node.x, node.y - 12);
            });
        }

        function renderIndex() {
            const container = document.getElementById('index-container');
            container.innerHTML = '';
            
            indexEntries.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'index-entry';
                
                entryDiv.innerHTML = `
                    <div class="index-keyword">${entry.keyword}</div>
                    <div class="index-description">${entry.description}</div>
                    <div class="index-zettel-list">
                        ${entry.zettelIds.map(id => 
                            `<span class="index-zettel-link" onclick="loadZettel('${id}'); switchView('editor');">${id}</span>`
                        ).join('')}
                    </div>
                `;
                
                container.appendChild(entryDiv);
            });
        }

        function addIndexEntry() {
            const keyword = prompt('Index keyword:');
            const description = prompt('Description:');
            const zettelIds = prompt('Zettel IDs (comma-separated):');
            
            if (keyword && description && zettelIds) {
                const entry = {
                    keyword,
                    description,
                    zettelIds: zettelIds.split(',').map(id => id.trim())
                };
                
                indexEntries.push(entry);
                saveToDB('index', entry);
                renderIndex();
            }
        }

        // Real AI Integration Framework
        async function processWithAI() {
            const input = document.getElementById('ai-input').value.trim();
            const url = document.getElementById('ai-url').value.trim();
            
            if (!input && !url) {
                showToast('Please provide text or URL to process', 'error');
                return;
            }
            
            if (!settings.apiKey) {
                showToast('Please set your API key in Settings first', 'error');
                openSettingsModal();
                return;
            }
            
            const suggestions = document.getElementById('ai-suggestions');
            suggestions.innerHTML = `
                <div style="background: var(--ak-bg-secondary); border: 1px solid var(--ak-border); padding: var(--space-16); border-radius: var(--radius-sm); margin-top: var(--space-16);">
                    <h3 style="color: var(--ak-accent-gold); margin-top: 0; display: flex; align-items: center; gap: 8px;">
                        <span class="loading"></span>
                        Processing with AI...
                    </h3>
                    <p style="color: var(--ak-text-secondary);">Analyzing content and generating atomic note suggestions...</p>
                </div>
            `;
            
            try {
                const content = input || `Please analyze this URL: ${url}`;
                const prompt = createAIPrompt(content);
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${settings.apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }]
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (aiResponse) {
                    parseAndDisplayAISuggestions(aiResponse);
                } else {
                    throw new Error('No response from AI');
                }
                
            } catch (error) {
                console.error('AI processing error:', error);
                suggestions.innerHTML = `
                    <div style="background: var(--ak-bg-secondary); border: 1px solid var(--ak-accent-crimson); padding: var(--space-16); border-radius: var(--radius-sm); margin-top: var(--space-16);">
                        <h3 style="color: var(--ak-accent-crimson); margin-top: 0;">‚ö†Ô∏è AI Processing Failed</h3>
                        <p style="color: var(--ak-text-secondary);">Error: ${error.message}</p>
                        <p style="color: var(--ak-text-secondary); font-size: var(--font-size-sm);">Please check your API key in Settings and try again.</p>
                        <button class="btn btn-secondary" onclick="openSettingsModal()">Check Settings</button>
                    </div>
                `;
            }
        }
        
        function createAIPrompt(content) {
            const existingIds = Array.from(zettels.keys()).sort();
            const existingTags = [...new Set(Array.from(zettels.values()).flatMap(z => z.tags || []))];
            
            return `You are an expert at creating atomic notes for a Zettelkasten system. Analyze the following content and break it down into atomic thoughts following these guidelines:

**EXISTING SYSTEM CONTEXT:**
- Existing note IDs: ${existingIds.join(', ')}
- Existing tags: ${existingTags.join(', ')}
- Use alphanumeric addressing (1, 1a, 1b, 1a1, 1a2, etc.)
- Letters for parallel thoughts, numbers for sequential development

**CONTENT TO ANALYZE:**
${content}

**OUTPUT FORMAT (respond with valid JSON only):**
{
  "suggestions": [
    {
      "id": "suggested_id_based_on_existing_structure",
      "title": "Clear, specific title",
      "content": "Atomic thought content with [[links]] to existing notes where relevant",
      "tags": ["relevant", "tags"],
      "reasoning": "Why this ID and structure was chosen"
    }
  ]
}

**REQUIREMENTS:**
1. Each note should contain ONE atomic idea
2. Suggest IDs that branch logically from existing structure
3. Include [[id]] links where connections exist
4. Use existing tags where appropriate, suggest new ones sparingly
5. Keep content concise but complete
6. Ensure each note can stand alone

Provide 2-5 atomic note suggestions.`;
        }
        
        function parseAndDisplayAISuggestions(aiResponse) {
            try {
                // Clean up the response to extract JSON
                let jsonStr = aiResponse.trim();
                if (jsonStr.includes('```json')) {
                    jsonStr = jsonStr.split('```json')[1].split('```')[0].trim();
                } else if (jsonStr.includes('```')) {
                    jsonStr = jsonStr.split('```')[1].split('```')[0].trim();
                }
                
                const data = JSON.parse(jsonStr);
                const suggestions = data.suggestions || [];
                
                if (suggestions.length === 0) {
                    throw new Error('No suggestions generated');
                }
                
                displayAISuggestions(suggestions);
                
            } catch (error) {
                console.error('Error parsing AI response:', error);
                document.getElementById('ai-suggestions').innerHTML = `
                    <div style="background: var(--ak-bg-secondary); border: 1px solid var(--ak-accent-crimson); padding: var(--space-16); border-radius: var(--radius-sm); margin-top: var(--space-16);">
                        <h3 style="color: var(--ak-accent-crimson); margin-top: 0;">‚ö†Ô∏è Could not parse AI response</h3>
                        <p style="color: var(--ak-text-secondary);">The AI response couldn't be processed. Raw response:</p>
                        <pre style="background: var(--ak-bg-tertiary); padding: 8px; border-radius: 4px; overflow: auto; font-size: 11px;">${aiResponse}</pre>
                    </div>
                `;
            }
        }
        
        function displayAISuggestions(suggestions) {
            const container = document.getElementById('ai-suggestions');
            
            container.innerHTML = `
                <div style="background: var(--ak-bg-secondary); border: 1px solid var(--ak-border); padding: var(--space-16); border-radius: var(--radius-sm); margin-top: var(--space-16);">
                    <h3 style="color: var(--ak-accent-gold); margin-top: 0;">‚ú® AI Suggestions (${suggestions.length})</h3>
                    ${suggestions.map((suggestion, index) => `
                        <div class="ai-suggestion">
                            <div class="ai-suggestion-header">
                                <span class="ai-suggestion-id">${suggestion.id}</span>
                                <div class="ai-suggestion-actions">
                                    <button class="btn btn-sm" onclick="acceptAISuggestion(${index})">Accept</button>
                                    <button class="btn btn-secondary btn-sm" onclick="editAISuggestion(${index})">Edit</button>
                                    <button class="btn btn-secondary btn-sm" onclick="rejectAISuggestion(${index})">Reject</button>
                                </div>
                            </div>
                            <h4 style="margin: var(--space-8) 0; color: var(--ak-text-primary);">${suggestion.title}</h4>
                            <div style="color: var(--ak-text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--space-8);">${suggestion.content}</div>
                            <div style="margin-bottom: var(--space-8);">
                                ${(suggestion.tags || []).map(tag => `<span style="background: var(--ak-accent-red); color: white; padding: 2px 6px; border-radius: var(--radius-sm); font-size: 10px; margin-right: 4px;">${tag}</span>`).join('')}
                            </div>
                            <div style="font-size: var(--font-size-xs); color: var(--ak-text-secondary); font-style: italic;">${suggestion.reasoning}</div>
                        </div>
                    `).join('')}
                    <div style="margin-top: var(--space-16); display: flex; gap: var(--space-12);">
                        <button class="btn" onclick="acceptAllSuggestions()">Accept All</button>
                        <button class="btn btn-secondary" onclick="clearAISuggestions()">Clear All</button>
                    </div>
                </div>
            `;
            
            // Store suggestions globally for button handlers
            window.currentAISuggestions = suggestions;
        }
        
        function acceptAISuggestion(index) {
            const suggestion = window.currentAISuggestions[index];
            createZettelFromSuggestion(suggestion);
            showToast(`Created zettel ${suggestion.id}! ‚ú®`, 'success');
            removeSuggestionElement(index);
        }
        
        function editAISuggestion(index) {
            const suggestion = window.currentAISuggestions[index];
            createZettelFromSuggestion(suggestion);
            loadZettel(suggestion.id);
            switchView('editor');
            showToast('Zettel created for editing! ‚úçÔ∏è', 'success');
        }
        
        function rejectAISuggestion(index) {
            removeSuggestionElement(index);
            showToast('Suggestion rejected', 'success');
        }
        
        function acceptAllSuggestions() {
            window.currentAISuggestions.forEach(suggestion => {
                createZettelFromSuggestion(suggestion);
            });
            showToast(`Created ${window.currentAISuggestions.length} zettels! üéâ`, 'success');
            clearAISuggestions();
        }
        
        function clearAISuggestions() {
            document.getElementById('ai-suggestions').innerHTML = '';
            window.currentAISuggestions = [];
        }
        
        function removeSuggestionElement(index) {
            const suggestions = document.querySelectorAll('.ai-suggestion');
            if (suggestions[index]) {
                suggestions[index].style.opacity = '0.5';
                suggestions[index].style.pointerEvents = 'none';
            }
        }
        
        function createZettelFromSuggestion(suggestion) {
            const now = Date.now();
            const newZettel = {
                id: suggestion.id,
                title: suggestion.title,
                content: suggestion.content,
                tags: suggestion.tags || [],
                created: now,
                modified: now
            };
            
            zettels.set(newZettel.id, newZettel);
            saveToDB('zettels', newZettel);
            updateUI();
        }

        // View Management
        function switchView(viewName) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.view === viewName) {
                    tab.classList.add('active');
                }
            });
            
            // Update views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewName + '-view').classList.add('active');
            
            currentView = viewName;
            
            // Refresh view-specific content
            if (viewName === 'graph') {
                setTimeout(renderGraph, 100); // Allow canvas to resize
            } else if (viewName === 'conspiracy') {
                renderConspiracyBoard();
            }
        }

        // Search functionality
        function setupSearch() {
            const searchInput = document.getElementById('search-input');
            let searchTimeout;
            
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const query = e.target.value.toLowerCase();
                    if (!query) {
                        updateUI(); // Show all
                        return;
                    }
                    
                    // Search through zettels
                    const results = Array.from(zettels.values()).filter(zettel => 
                        zettel.id.toLowerCase().includes(query) ||
                        (zettel.title || '').toLowerCase().includes(query) ||
                        zettel.content.toLowerCase().includes(query) ||
                        (zettel.tags || []).some(tag => tag.toLowerCase().includes(query))
                    );
                    
                    // Update recent list with search results
                    const recentList = document.getElementById('recent-list');
                    recentList.innerHTML = '';
                    
                    results.forEach(zettel => {
                        const li = document.createElement('li');
                        li.innerHTML = `<span class="zettel-list-id">${zettel.id}</span>${zettel.title || 'Untitled'}`;
                        li.onclick = () => loadZettel(zettel.id);
                        recentList.appendChild(li);
                    });
                }, 300);
            });
        }

        // Real Import/Export Functions
        function exportData() {
            const data = {
                zettels: Array.from(zettels.values()),
                index: indexEntries,
                boards: Array.from(boards.values()),
                settings: settings,
                exportDate: new Date().toISOString(),
                version: '2.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `antinet-kettlekorn-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
            showToast(`Exported ${zettels.size} zettels successfully! üíæ`, 'success');
        }

        function exportMarkdown() {
            let markdown = '# AntiChrist KettleKorn Export\n\n';
            markdown += `Exported on ${new Date().toLocaleDateString()}\n\n`;
            
            const sortedZettels = Array.from(zettels.values()).sort((a, b) => a.id.localeCompare(b.id));
            
            sortedZettels.forEach(zettel => {
                markdown += `## ${zettel.id} - ${zettel.title || 'Untitled'}\n\n`;
                markdown += zettel.content + '\n\n';
                if (zettel.tags && zettel.tags.length > 0) {
                    markdown += `**Tags:** ${zettel.tags.join(', ')}\n\n`;
                }
                markdown += '---\n\n';
            });
            
            const blob = new Blob([markdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `antinet-kettlekorn-${new Date().toISOString().split('T')[0]}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
            showToast('Exported as Markdown successfully! üìù', 'success');
        }

        function exportConspiracyBoard() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 1200;
            canvas.height = 800;
            
            // Background
            ctx.fillStyle = '#0f0a0a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Cork board texture pattern
            const gradient = ctx.createRadialGradient(600, 400, 0, 600, 400, 600);
            gradient.addColorStop(0, 'rgba(212, 175, 55, 0.1)');
            gradient.addColorStop(1, 'rgba(139, 21, 56, 0.1)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const board = boards.get('main');
            if (board) {
                // Draw connections first
                ctx.strokeStyle = '#dc143c';
                ctx.lineWidth = 2;
                ctx.globalAlpha = 0.8;
                
                board.zettels.forEach(boardZettel => {
                    if (boardZettel.connections) {
                        boardZettel.connections.forEach(connectedId => {
                            const connectedBoardZettel = board.zettels.find(z => z.zettelId === connectedId);
                            if (connectedBoardZettel) {
                                ctx.beginPath();
                                ctx.moveTo(boardZettel.x + 100, boardZettel.y + 75);
                                ctx.lineTo(connectedBoardZettel.x + 100, connectedBoardZettel.y + 75);
                                ctx.stroke();
                            }
                        });
                    }
                });
                
                // Draw cards
                ctx.globalAlpha = 1;
                board.zettels.forEach(boardZettel => {
                    const zettel = zettels.get(boardZettel.zettelId);
                    if (zettel) {
                        // Card background
                        ctx.fillStyle = '#f4f1e8';
                        ctx.fillRect(boardZettel.x, boardZettel.y, 200, 150);
                        
                        // Card border
                        ctx.strokeStyle = 'rgba(139, 21, 56, 0.3)';
                        ctx.lineWidth = 1;
                        ctx.strokeRect(boardZettel.x, boardZettel.y, 200, 150);
                        
                        // ID badge
                        ctx.fillStyle = '#8b1538';
                        ctx.fillRect(boardZettel.x + 10, boardZettel.y + 10, 40, 20);
                        
                        // ID text
                        ctx.fillStyle = 'white';
                        ctx.font = 'bold 12px monospace';
                        ctx.fillText(zettel.id, boardZettel.x + 15, boardZettel.y + 23);
                        
                        // Title
                        ctx.fillStyle = '#1a1a1a';
                        ctx.font = 'bold 14px serif';
                        const title = (zettel.title || 'Untitled').substring(0, 25);
                        ctx.fillText(title, boardZettel.x + 10, boardZettel.y + 45);
                        
                        // Content preview
                        ctx.fillStyle = '#4a4a4a';
                        ctx.font = '11px serif';
                        const content = zettel.content.substring(0, 80) + '...';
                        const lines = content.match(/.{1,28}/g) || [content];
                        lines.slice(0, 4).forEach((line, i) => {
                            ctx.fillText(line, boardZettel.x + 10, boardZettel.y + 65 + (i * 15));
                        });
                    }
                });
            }
            
            // Convert to blob and download
            canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `conspiracy-board-${new Date().toISOString().split('T')[0]}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('Conspiracy board exported as image! üï∏Ô∏è', 'success');
            });
        }

        function setupImportExport() {
            const fileInput = document.getElementById('import-file-input');
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        let importedCount = 0;
                        
                        // Import zettels
                        if (data.zettels) {
                            data.zettels.forEach(zettel => {
                                // Convert old format if needed
                                if (typeof zettel.created === 'string') {
                                    zettel.created = new Date(zettel.created).getTime();
                                }
                                if (typeof zettel.modified === 'string') {
                                    zettel.modified = new Date(zettel.modified).getTime();
                                }
                                
                                zettels.set(zettel.id, zettel);
                                saveToDB('zettels', zettel);
                                importedCount++;
                            });
                        }
                        
                        // Import index
                        if (data.index) {
                            indexEntries = [...indexEntries, ...data.index];
                            data.index.forEach(entry => saveToDB('index', entry));
                        }
                        
                        // Import boards
                        if (data.boards) {
                            data.boards.forEach(board => {
                                boards.set(board.id || 'imported-board', board);
                                saveToDB('boards', board);
                            });
                        }
                        
                        updateUI();
                        renderIndex();
                        renderConspiracyBoard();
                        showToast(`Successfully imported ${importedCount} zettels! üéâ`, 'success');
                        
                    } catch (error) {
                        showToast('Error importing data: ' + error.message, 'error');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
            });
        }

        function importData() {
            document.getElementById('import-file-input').click();
        }

        function updateStatus(message) {
            document.getElementById('last-saved').textContent = message;
            setTimeout(() => {
                document.getElementById('last-saved').textContent = 'Ready';
            }, 3000);
        }
        
        // Mobile sidebar functions
        function toggleMobileSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        }
        
        function closeMobileSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
        }

        // Enhanced Keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Don't interfere with modal inputs
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    // Allow Escape to close modals even from inputs
                    if (e.key === 'Escape') {
                        const activeModal = document.querySelector('.modal.active');
                        if (activeModal) {
                            activeModal.classList.remove('active');
                        }
                    }
                    return;
                }
                
                // Escape to close modals
                if (e.key === 'Escape') {
                    const activeModal = document.querySelector('.modal.active');
                    if (activeModal) {
                        activeModal.classList.remove('active');
                        return;
                    }
                }
                
                // Ctrl/Cmd + S to save
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    saveCurrentZettel();
                    showToast('Zettel saved! ‚ú®', 'success');
                }
                
                // Ctrl/Cmd + N for new zettel
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    createNewZettel();
                }
                
                // Ctrl/Cmd + K for search
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    openSearchModal();
                }
                
                // Ctrl/Cmd + , for settings
                if ((e.ctrlKey || e.metaKey) && e.key === ',') {
                    e.preventDefault();
                    openSettingsModal();
                }
                
                // Ctrl/Cmd + E for export
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    exportData();
                }
                
                // Ctrl/Cmd + I for import
                if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
                    e.preventDefault();
                    importData();
                }
                
                // Number keys to switch views (1-6)
                if (e.key >= '1' && e.key <= '6' && !e.ctrlKey && !e.metaKey && !e.altKey) {
                    const views = ['editor', 'tree', 'conspiracy', 'graph', 'index', 'ai'];
                    const viewIndex = parseInt(e.key) - 1;
                    if (viewIndex < views.length) {
                        switchView(views[viewIndex]);
                    }
                }
            });
        }

        // Auto-save functionality
        function setupAutoSave() {
            const titleInput = document.getElementById('editor-title');
            const contentInput = document.getElementById('editor-content');
            const tagsInput = document.getElementById('editor-tags');
            
            let saveTimeout;
            
            function scheduleAutoSave() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    saveCurrentZettel();
                }, 2000); // Auto-save after 2 seconds of inactivity
            }
            
            [titleInput, contentInput, tagsInput].forEach(input => {
                input.addEventListener('input', scheduleAutoSave);
            });
        }

        // Modal Functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('active');
            
            // Focus first input if exists
            const firstInput = modal.querySelector('input[type="text"], input[type="password"], textarea');
            if (firstInput) {
                setTimeout(() => firstInput.focus(), 100);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function openSettingsModal() {
            document.getElementById('api-key-input').value = settings.apiKey || '';
            document.getElementById('auto-save-checkbox').checked = settings.autoSave !== false;
            document.getElementById('theme-select').value = settings.theme || 'dark';
            openModal('settings-modal');
        }

        function openSearchModal() {
            openModal('search-modal');
        }

        // Settings Functions
        function saveSettings() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            const autoSave = document.getElementById('auto-save-checkbox').checked;
            const theme = document.getElementById('theme-select').value;
            
            settings = {
                ...settings,
                apiKey,
                autoSave,
                theme
            };
            
            saveToDB('settings', { key: 'main', data: settings });
            updateApiStatus();
            closeModal('settings-modal');
            showToast('Settings saved successfully! ‚ú®', 'success');
        }

        function clearApiKey() {
            if (confirm('Are you sure you want to clear the API key?')) {
                settings.apiKey = '';
                document.getElementById('api-key-input').value = '';
                saveToDB('settings', { key: 'main', data: settings });
                updateApiStatus();
                showToast('API key cleared', 'success');
            }
        }

        function updateApiStatus() {
            const statusEl = document.getElementById('api-status');
            if (settings.apiKey) {
                statusEl.textContent = 'API Key Set ‚úì';
                statusEl.style.color = 'var(--color-teal-300)';
            } else {
                statusEl.textContent = 'No API Key Set';
                statusEl.style.color = 'var(--ak-text-secondary)';
            }
        }

        async function testApiConnection() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            if (!apiKey) {
                showApiKeyStatus('Please enter an API key first', 'error');
                return;
            }
            
            showApiKeyStatus('Testing connection...', 'loading');
            
            try {
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models?key=' + apiKey);
                if (response.ok) {
                    showApiKeyStatus('Connection successful! ‚úì', 'success');
                } else {
                    showApiKeyStatus('Invalid API key or connection failed', 'error');
                }
            } catch (error) {
                showApiKeyStatus('Connection failed: ' + error.message, 'error');
            }
        }

        function showApiKeyStatus(message, type) {
            const statusEl = document.getElementById('api-key-status');
            statusEl.textContent = message;
            statusEl.className = `api-key-status ${type}`;
            statusEl.style.display = 'block';
            
            if (type !== 'loading') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }

        // Toast Notifications
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 3000);
        }

        // Welcome Modal Functions
        function loadSampleData() {
            // Load sample zettels
            sampleZettels.forEach(z => {
                zettels.set(z.id, z);
                saveToDB('zettels', z);
            });
            
            // Load sample index
            sampleIndex.forEach(i => {
                indexEntries.push(i);
                saveToDB('index', i);
            });
            
            // Load sample board
            boards.set('main', sampleBoard);
            saveToDB('boards', sampleBoard);
            
            closeModal('welcome-modal');
            loadZettel('1');
            updateUI();
            renderIndex();
            showToast('Sample data loaded! Start exploring! üéâ', 'success');
        }

        function startFresh() {
            closeModal('welcome-modal');
            createNewZettel();
            showToast('Welcome to your new Zettelkasten! ‚ú®', 'success');
        }

        // Advanced Search Functions
        function performAdvancedSearch() {
            const query = document.getElementById('advanced-search-input').value.toLowerCase().trim();
            const searchTitle = document.getElementById('search-title').checked;
            const searchContent = document.getElementById('search-content').checked;
            const searchTags = document.getElementById('search-tags').checked;
            const searchId = document.getElementById('search-id').checked;
            const tagFilter = document.getElementById('tag-filter').value.toLowerCase().trim();
            
            if (!query && !tagFilter) {
                showToast('Please enter search terms or tags', 'error');
                return;
            }
            
            const results = Array.from(zettels.values()).filter(zettel => {
                let matches = false;
                
                if (query) {
                    if (searchId && zettel.id.toLowerCase().includes(query)) matches = true;
                    if (searchTitle && (zettel.title || '').toLowerCase().includes(query)) matches = true;
                    if (searchContent && zettel.content.toLowerCase().includes(query)) matches = true;
                    if (searchTags && (zettel.tags || []).some(tag => tag.toLowerCase().includes(query))) matches = true;
                }
                
                if (tagFilter && !matches) {
                    const filterTags = tagFilter.split(',').map(t => t.trim());
                    matches = filterTags.some(filterTag => 
                        (zettel.tags || []).some(tag => tag.toLowerCase().includes(filterTag))
                    );
                }
                
                return query ? matches : (tagFilter ? matches : true);
            });
            
            displaySearchResults(results);
        }

        function displaySearchResults(results) {
            const resultsContainer = document.getElementById('search-results');
            
            if (results.length === 0) {
                resultsContainer.innerHTML = '<p style="color: var(--ak-text-secondary);">No results found.</p>';
                return;
            }
            
            resultsContainer.innerHTML = `
                <h3 style="color: var(--ak-accent-gold); margin-bottom: var(--space-12);">Found ${results.length} result(s):</h3>
                ${results.map(zettel => `
                    <div class="search-result" style="background: var(--ak-bg-tertiary); padding: var(--space-12); border-radius: var(--radius-sm); margin-bottom: var(--space-8); cursor: pointer;" onclick="openZettelFromSearch('${zettel.id}')">
                        <div style="display: flex; align-items: center; gap: var(--space-8); margin-bottom: var(--space-6);">
                            <span style="background: var(--ak-accent-gold); color: var(--ak-bg-primary); padding: 2px 6px; border-radius: var(--radius-sm); font-family: var(--font-family-mono); font-size: var(--font-size-xs);">${zettel.id}</span>
                            <strong>${zettel.title || 'Untitled'}</strong>
                        </div>
                        <p style="color: var(--ak-text-secondary); font-size: var(--font-size-sm); margin: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${zettel.content.substring(0, 100)}${zettel.content.length > 100 ? '...' : ''}</p>
                        <div style="margin-top: var(--space-6);">
                            ${(zettel.tags || []).map(tag => `<span style="background: var(--ak-accent-red); color: white; padding: 2px 6px; border-radius: var(--radius-sm); font-size: 10px; margin-right: 4px;">${tag}</span>`).join('')}
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function openZettelFromSearch(zettelId) {
            closeModal('search-modal');
            loadZettel(zettelId);
            switchView('editor');
        }

        // Initialize the application
        function init() {
            initDB();
            
            // Set up event listeners
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchView(tab.dataset.view));
            });
            
            // Click outside modal to close
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('active');
                }
            });
            
            setupSearch();
            setupKeyboardShortcuts();
            setupAutoSave();
            setupImportExport();
            
            // Add mobile sidebar close on navigation
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', closeMobileSidebar);
            });
            
            // Add mobile sidebar close on zettel selection
            document.addEventListener('click', (e) => {
                if (e.target.closest('.zettel-list li')) {
                    closeMobileSidebar();
                }
            });
        }

        // Start the application
        init();
    </script>
</body>
</html>