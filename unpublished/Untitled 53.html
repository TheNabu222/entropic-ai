<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entropic Nexus (Classic)</title>
    <!-- The YouTube API script needs to be loaded externally -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <script type="importmap">
        { "imports": { "https://cdn.jsdelivr.net/npm/chart.js": "https://esm.sh/chart.js@4.4.2" } }
    </script>
    
    <!-- ======== START OF SIMPLIFIED W95 CSS ======== -->
    <style>
        @font-face {
            font-family: 'W95FA';
            src: url('https://w95fa-to-angelfire.s3.amazonaws.com/w95fa.woff2') format('woff2');
        }

        body {
            background-color: #008080; /* Classic Teal */
            margin: 0;
            overflow: hidden;
            font-family: 'W95FA', 'MS Sans Serif', 'Arial', sans-serif;
            font-smooth: never;
            -webkit-font-smoothing: none;
        }

        .w95-button {
            background-color: #c0c0c0;
            border: 2px outset #fff;
            box-shadow: 1px 1px 0 1px #000;
            padding: 2px 6px;
            font-size: 11px;
            cursor: pointer;
        }
        .w95-button:active { border-style: inset; }

        #desktop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 30px);
            padding: 10px;
            box-sizing: border-box;
        }

        .icon {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            width: 85px;
            padding: 5px;
            margin: 5px;
            cursor: pointer;
            text-align: center;
            background: transparent;
            border: none;
            color: inherit;
            font-family: inherit;
        }

        .icon img {
            width: 48px;
            height: 48px;
            margin-bottom: 5px;
        }

        .icon span {
            color: white;
            font-size: 11px;
            padding: 1px 3px;
            text-shadow: 1px 1px #000;
            word-wrap: break-word;
        }

        .icon:hover span {
            background-color: #000080;
            border: 1px dotted #fff;
            padding: 0 2px;
        }
        
        a { text-decoration: none; }

        #taskbar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 30px;
            background-color: #c0c0c0;
            border-top: 2px solid #fff;
            display: flex;
            align-items: center;
            padding: 2px;
            box-sizing: border-box;
            z-index: 10000;
        }
        
        #start-button { font-weight: bold; }
        #taskbar-apps { flex-grow: 1; height: 100%; display: flex; margin-left: 5px; }
        .taskbar-app { border: 2px outset #fff; background: #c0c0c0; margin: 0 2px; padding: 0 10px; height: 24px; max-width: 150px; display: flex; align-items: center; font-size: 11px; cursor: pointer; }
        .taskbar-app img { width: 16px; height: 16px; margin-right: 4px; }
        .taskbar-app.active { border-style: inset; background-color: #aaa; }
        #taskbar-clock { border: 2px inset #fff; padding: 0 10px; margin-right: 5px; height: 24px; line-height: 24px; font-size: 11px; }

        .window {
            position: absolute;
            background-color: #c0c0c0;
            border: 2px outset #fff;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            display: none; /* Changed from none to flex to show */
            flex-direction: column;
            min-width: 250px;
            min-height: 150px;
        }
        .window.active .window-titlebar { background: linear-gradient(to right, #000080, #1084d0); }
        .window.active .window-titlebar span { color: white; }

        .window-titlebar {
            background: linear-gradient(to right, #808080, #c0c0c0);
            padding: 3px 5px;
            display: flex;
            align-items: center;
            font-weight: bold;
            font-size: 11px;
            cursor: grab;
            height: 18px;
        }
        .window-titlebar span { color: #c0c0c0; flex-grow: 1; }
        .window-titlebar:active { cursor: grabbing; }

        .window-controls { display: flex; }
        .window-controls button { width: 16px; height: 14px; margin-left: 2px; font-size: 10px; font-weight: bold; padding: 0; }
        
        .window-content {
            flex-grow: 1;
            padding: 10px;
            margin: 2px;
            border: 2px inset #fff;
            background-color: white;
            overflow: auto;
            display: flex;
            flex-direction: column;
            color: black;
        }

        /* --- Zettelkasten Classic Theme --- */
        #hyenaDivaZettelkasten .window-content { background-color: #c0c0c0; }
        .tabs-container { border-bottom: 2px inset #fff; padding-bottom: 5px; margin-bottom: 5px; }
        .zettel-container { background-color: white; border: 2px inset #fff; padding: 5px; flex-grow: 1; overflow-y: auto; }
        .zettel-card { background: #fff; border: 1px solid #808080; padding: 5px; margin-bottom: 3px; cursor: pointer; display: flex; justify-content: space-between; }
        .zettel-card:hover { background: #e0e0e0; }
        .zettel-title { font-weight: bold; }
        .trunk-card { border-left: 3px solid #000080; }
        .branch-card { border-left: 3px solid #008080; margin-left: 15px; }
        .leaf-card { border-left: 3px solid #008000; margin-left: 30px; }
        .flower-card { border-left: 3px solid #808000; margin-left: 45px; }

        /* Dialog Box Classic Theme */
        .dialog-box { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 101; justify-content: center; align-items: center; }
        .dialog-content { background-color: #c0c0c0; border: 2px outset #fff; padding: 3px; width: 500px; }
        .dialog-titlebar { background: linear-gradient(to right, #000080, #1084d0); color: white; padding: 3px 5px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .dialog-close { background: #c0c0c0; border: 1px outset #fff; }
        .dialog-inner-content { background: #c0c0c0; padding: 15px; }
        .win98-label { font-size: 11px; margin-top: 5px; display: block; }
        .win98-input, .win98-textarea, .win98-select { border: 2px inset #fff; padding: 2px; width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>
    <div id="desktop">
        <!-- Desktop Icons -->
        <button type="button" class="icon" data-app="entropicNexus">
            <img src="https://storage.googleapis.com/gemini-95-icons/mycomputer.png" alt="Entropic Nexus"/>
            <span>Entropic Nexus</span>
        </button>
        <button type="button" class="icon" data-app="hyenaDivaZettelkasten">
             <img src="https://pfst.cf2.poecdn.net/base/image/0ffd2bf15a7001f86e395096222147037538b25af55ef9b8c7ac8f6768b7397c?w=48&h=48" alt="Knowledge Vault" />
            <span>Knowledge Vault</span>
        </button>
         <button type="button" class="icon" data-app="bloomSimulator">
            <img src="https://win98icons.alexmeub.com/icons/png/chart_pie_down-0.png" alt="Bloom Simulator" />
            <span>Bloom Simulator</span>
        </button>
        <a href="https://entropic-ai.angelfire.com/dolphin.html" target="_blank">
            <div class="icon">
                <img src="https://win98icons.alexmeub.com/icons/png/msagent_dolphins-0.png" alt="Dolphin Link" />
                <span>Dolphin Link</span>
            </div>
        </a>
        <!-- Add your other icons here using the same <button> or <a> format -->
    </div>

    <!-- Windows -->
    <div class="window" id="entropicNexus">
        <div class="window-titlebar"><span>Entropic Nexus</span><div class="window-controls"><button class="window-minimize">_</button><button class="window-close">X</button></div></div>
        <div class="window-content">
            <p>Welcome to the Entropic Nexus.</p>
            <p>This is the central hub. Other applications can be launched from the desktop.</p>
        </div>
    </div>
    
    <div class="window resizable" id="hyenaDivaZettelkasten" style="width: 600px; height: 450px;">
        <div class="window-titlebar"><span>Knowledge Vault</span><div class="window-controls"><button class="window-minimize">_</button><button class="window-close">X</button></div></div>
        <div class="window-content" id="hyenaDivaZettelkasten-content">
            <!-- Zettelkasten UI will be rendered here by JS -->
        </div>
    </div>
    
     <div class="window resizable" id="bloomSimulator" style="width: 400px; height: 400px;">
        <div class="window-titlebar"><span>Bloom Simulator</span><div class="window-controls"><button class="window-minimize">_</button><button class="window-close">X</button></div></div>
        <div class="window-content" id="bloom-chart-container">
            <!-- Chart will be rendered here by JS -->
        </div>
    </div>
    <!-- Add your other <div class="window"> elements here -->

    <!-- Zettelkasten Dialog Box -->
    <div id="zettelkasten-dialog" class="dialog-box">
        <div class="dialog-content">
            <div class="dialog-titlebar">
                <span id="dialog-title">View/Edit</span>
                <button id="dialog-close-button" class="dialog-close w95-button">X</button>
            </div>
            <div id="dialog-inner-content" class="dialog-inner-content"></div>
        </div>
    </div>

    <div id="taskbar">
        <button id="start-button" class="w95-button">Start</button>
        <div id="taskbar-apps"></div>
        <div id="taskbar-clock"></div>
    </div>
    
    <script type="module">
        import { Chart, registerables } from 'https://cdn.jsdelivr.net/npm/chart.js';
        Chart.register(...registerables);
        
        // --- Core OS State & DOM References ---
        const icons = document.querySelectorAll('.icon');
        const windows = document.querySelectorAll('.window');
        const taskbarAppsContainer = document.getElementById('taskbar-apps');
        let activeWindow = null;
        let highestZIndex = 20;
        const openApps = new Map();
        let bloomChart = null;

        // --- Zettelkasten Card Class ---
        class Card {
             constructor({ id, parentId = null, title, content, type, timestamp = Date.now(), tags = [], links = [], isPinned = false, pinX = 0, pinY = 0 }) {
                this.id = id; this.parentId = parentId; this.title = title; this.content = content; this.type = type; this.timestamp = timestamp; this.tags = tags; this.links = links; this.isPinned = isPinned; this.pinX = pinX; this.pinY = pinY;
            }
        }
        const HIERARCHY_TYPES = ["Trunk", "Branch", "Leaf", "Flower", "Fruit", "Bud"];

        // --- Core OS Functions ---
        function bringToFront(windowElement) {
            if (activeWindow) activeWindow.classList.remove('active');
            highestZIndex++;
            windowElement.style.zIndex = highestZIndex;
            windowElement.classList.add('active');
            activeWindow = windowElement;
            const taskbarButton = openApps.get(windowElement.id)?.taskbarButton;
            document.querySelectorAll('.taskbar-app').forEach(b => b.classList.remove('active'));
            if(taskbarButton) taskbarButton.classList.add('active');
        }

        function openApp(appName) {
            const windowElement = document.getElementById(appName);
            if (!windowElement) return;

            windowElement.style.display = 'flex';
            bringToFront(windowElement);

            if (openApps.has(appName)) return;

            const taskbarButton = document.createElement('div');
            taskbarButton.className = 'taskbar-app active';
            taskbarButton.textContent = windowElement.querySelector('.window-titlebar span').textContent;
            taskbarButton.addEventListener('click', () => {
                if (activeWindow === windowElement && windowElement.style.display !== 'none') {
                    minimizeApp(appName);
                } else {
                    windowElement.style.display = 'flex';
                    bringToFront(windowElement);
                }
            });
            taskbarAppsContainer.appendChild(taskbarButton);
            openApps.set(appName, { windowEl: windowElement, taskbarButton });
            
            // Initialize app content
            initializeApp(appName, windowElement);
        }

        function closeApp(appName) {
            const appData = openApps.get(appName);
            if (!appData) return;
            appData.windowEl.style.display = 'none';
            appData.taskbarButton.remove();
            openApps.delete(appName);
        }
        
        function minimizeApp(appName) {
            const appData = openApps.get(appName);
            if (!appData) return;
            appData.windowEl.style.display = 'none';
            appData.taskbarButton.classList.remove('active');
            if (activeWindow === appData.windowEl) activeWindow = null;
        }

        // --- App Initializer Switchboard ---
        function initializeApp(appName, windowElement) {
            if (windowElement.dataset.initialized) return;

            if (appName === 'hyenaDivaZettelkasten') {
                initHyenaDivaApp(windowElement.querySelector('#hyenaDivaZettelkasten-content'));
            } else if (appName === 'bloomSimulator') {
                initBloomSimulator(windowElement.querySelector('#bloom-chart-container'));
            }
            windowElement.dataset.initialized = 'true';
        }

        // --- Zettelkasten App Logic ---
        function initHyenaDivaApp(container) {
            let cards = []; let currentTab = 'All';
            const saveCards = () => { localStorage.setItem('multiZettelkasten', JSON.stringify(cards)); window.dispatchEvent(new CustomEvent('zettelkastenUpdated')); };
            const loadCards = () => { cards = JSON.parse(localStorage.getItem('multiZettelkasten') || '[]').map(c => new Card(c)); if (cards.length === 0) { cards = loadZettelkastenData(); saveCards(); }};
            const renderCardList = () => { /* Renders the list of cards based on currentTab */
                const zettelContainer = container.querySelector('#zettel-container');
                zettelContainer.innerHTML = '';
                loadCards();
                const filtered = (currentTab === 'All') ? cards : cards.filter(c => c.type === currentTab);
                filtered.forEach(card => {
                    const el = document.createElement('div');
                    el.className = `zettel-card ${card.type.toLowerCase()}-card`;
                    el.innerHTML = `<span class="zettel-title">${card.title}</span><span class="zettel-id">${card.id}</span>`;
                    el.onclick = () => showZettelDialog(card.id);
                    zettelContainer.appendChild(el);
                });
            };
            const render = () => { /* Renders the main UI of the app */
                container.innerHTML = `<div class="tabs-container"></div><div class="zettel-container"></div>`;
                const tabsContainer = container.querySelector('.tabs-container');
                ['All', ...HIERARCHY_TYPES].forEach(tabName => {
                    const btn = document.createElement('button');
                    btn.className = 'w95-button';
                    btn.textContent = tabName === 'All' ? 'All' : `${tabName}s`;
                    btn.onclick = () => { currentTab = tabName; renderCardList(); };
                    tabsContainer.appendChild(btn);
                });
                renderCardList();
            };
            window.addEventListener('zettelkastenUpdated', renderCardList);
            render();
        }

        function showZettelDialog(cardId) { /* Logic to show the edit/view dialog */ 
             let cards = JSON.parse(localStorage.getItem('multiZettelkasten') || '[]').map(c => new Card(c));
             const card = cards.find(c => c.id === cardId);
             if (!card) return;

             const dialog = document.getElementById('zettelkasten-dialog');
             const dialogContent = document.getElementById('dialog-inner-content');
             document.getElementById('dialog-title').textContent = `View/Edit: ${card.title}`;
             dialogContent.innerHTML = `
                <label class="win98-label">Title:</label><input type="text" id="edit-title" class="win98-input" value="${card.title}">
                <label class="win98-label">Content:</label><textarea id="edit-content" class="win98-textarea" rows="5">${card.content}</textarea>
                <div style="margin-top:10px;"><button id="save-card-btn" class="w95-button">Save</button></div>`;
             dialog.style.display = 'flex';

             dialog.querySelector('#save-card-btn').addEventListener('click', () => {
                 const cardIndex = cards.findIndex(c => c.id === cardId);
                 cards[cardIndex].title = dialog.querySelector('#edit-title').value;
                 cards[cardIndex].content = dialog.querySelector('#edit-content').value;
                 localStorage.setItem('multiZettelkasten', JSON.stringify(cards));
                 window.dispatchEvent(new CustomEvent('zettelkastenUpdated'));
                 dialog.style.display = 'none';
             });
        }
        function loadZettelkastenData() { return [ new Card({id: "1000", type: "Trunk", title: "Consciousness, Hermetics & Emergence"}), new Card({id: "1000/1", parentId: "1000", type: "Branch", title: "1100 :: Hermetics"}) ]; }

        // --- Bloom Simulator App Logic ---
        function initBloomSimulator(container) {
            container.innerHTML = '<canvas id="bloom-chart-canvas"></canvas>';
            const ctx = container.querySelector('#bloom-chart-canvas').getContext('2d');
            const renderChart = () => {
                if(bloomChart) bloomChart.destroy();
                const cards = JSON.parse(localStorage.getItem('multiZettelkasten') || '[]');
                const typeCounts = HIERARCHY_TYPES.reduce((acc, type) => ({...acc, [type]: 0}), {});
                cards.forEach(card => { if(typeCounts[card.type] !== undefined) typeCounts[card.type]++; });
                bloomChart = new Chart(ctx, {
                    type: 'polarArea',
                    data: {
                        labels: HIERARCHY_TYPES,
                        datasets: [{ label: 'Tablet Types', data: HIERARCHY_TYPES.map(t => typeCounts[t]) }]
                    }
                });
            };
            window.addEventListener('zettelkastenUpdated', renderChart);
            renderChart();
        }

        // --- Global Event Listeners & Final Setup ---
        icons.forEach(icon => {
            icon.addEventListener('dblclick', () => openApp(icon.dataset.app));
        });

        windows.forEach(windowElement => {
            const titleBar = windowElement.querySelector('.window-titlebar');
            windowElement.querySelector('.window-close').addEventListener('click', (e) => { e.stopPropagation(); closeApp(windowElement.id); });
            windowElement.querySelector('.window-minimize').addEventListener('click', (e) => { e.stopPropagation(); minimizeApp(windowElement.id); });
            windowElement.addEventListener('mousedown', () => bringToFront(windowElement), true);

            // Dragging Logic
            if(titleBar){
                let isDragging = false, offsetX, offsetY;
                titleBar.addEventListener('mousedown', e => {
                    isDragging = true;
                    offsetX = e.clientX - windowElement.offsetLeft;
                    offsetY = e.clientY - windowElement.offsetTop;
                });
                document.addEventListener('mousemove', e => {
                    if (!isDragging) return;
                    windowElement.style.left = `${e.clientX - offsetX}px`;
                    windowElement.style.top = `${e.clientY - offsetY}px`;
                });
                document.addEventListener('mouseup', () => isDragging = false);
            }
        });
        
        document.getElementById('dialog-close-button').onclick = () => document.getElementById('zettelkasten-dialog').style.display = 'none';

        // Clock
        const clock = document.getElementById('taskbar-clock');
        const updateClock = () => clock.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        updateClock();
        setInterval(updateClock, 1000);
    </script>
</body>
</html>