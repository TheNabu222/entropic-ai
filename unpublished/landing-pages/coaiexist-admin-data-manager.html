<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COAIEXIST Admin - Data Manager</title>
    <link rel="stylesheet" href="/css/counter-guestbook.css">
    <style>
        :root {
            --magenta: #f312af;
            --cyan: #00ffcc;
            --purple: #bf5fff;
        }

        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: var(--cyan);
            font-family: 'Courier New', monospace;
            padding: 2rem;
            min-height: 100vh;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: var(--magenta);
            text-align: center;
            font-size: 2.5rem;
            text-shadow: 0 0 20px rgba(243, 18, 175, 0.6);
            margin-bottom: 2rem;
        }

        .section {
            background: rgba(15, 15, 30, 0.9);
            border: 3px solid var(--purple);
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 0 20px rgba(191, 95, 255, 0.4);
        }

        .section h2 {
            color: var(--cyan);
            border-bottom: 2px solid var(--purple);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(0, 255, 204, 0.1);
            border: 2px solid var(--cyan);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            color: var(--magenta);
            font-weight: bold;
            text-shadow: 0 0 10px rgba(243, 18, 175, 0.5);
        }

        .stat-label {
            color: var(--cyan);
            margin-top: 0.5rem;
            font-size: 1.1rem;
        }

        .pending-item {
            background: rgba(15, 15, 30, 0.7);
            border: 2px solid var(--purple);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .pending-item.approved {
            border-color: #00ff00;
            background: rgba(0, 255, 0, 0.1);
        }

        .pending-item.rejected {
            border-color: #ff0000;
            background: rgba(255, 0, 0, 0.1);
            opacity: 0.5;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .item-actions button {
            margin-left: 0.5rem;
            padding: 0.5rem 1rem;
            border: 2px solid;
            border-radius: 4px;
            background: transparent;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .approve-btn {
            border-color: #00ff00;
            color: #00ff00;
        }

        .approve-btn:hover {
            background: #00ff00;
            color: #000;
        }

        .reject-btn {
            border-color: #ff0000;
            color: #ff0000;
        }

        .reject-btn:hover {
            background: #ff0000;
            color: #fff;
        }

        .export-section {
            margin-top: 2rem;
        }

        .code-box {
            background: #000;
            border: 2px solid var(--cyan);
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        .code-box pre {
            margin: 0;
            color: var(--cyan);
            font-size: 0.9rem;
        }

        .action-button {
            background: linear-gradient(135deg, var(--magenta) 0%, var(--purple) 100%);
            border: 2px solid var(--magenta);
            color: white;
            padding: 1rem 2rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0.5rem;
        }

        .action-button:hover {
            box-shadow: 0 0 20px rgba(243, 18, 175, 0.8);
            transform: translateY(-2px);
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--purple);
            font-style: italic;
        }

        .view-stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .view-stats-table th,
        .view-stats-table td {
            padding: 0.75rem;
            border: 1px solid var(--purple);
            text-align: left;
        }

        .view-stats-table th {
            background: rgba(191, 95, 255, 0.3);
            color: var(--magenta);
            font-weight: bold;
        }

        .view-stats-table tr:hover {
            background: rgba(0, 255, 204, 0.1);
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <h1>üîÆ COAIEXIST Admin Portal</h1>

        <!-- Statistics -->
        <div class="section">
            <h2>üìä Statistics</h2>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-views">0</div>
                    <div class="stat-label">Total Page Views</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pending-views">0</div>
                    <div class="stat-label">Pending Views</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-guestbook">0</div>
                    <div class="stat-label">Guestbook Entries</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pending-guestbook">0</div>
                    <div class="stat-label">Pending Entries</div>
                </div>
            </div>
        </div>

        <!-- Page Views Management -->
        <div class="section">
            <h2>üëÅÔ∏è Page Views</h2>
            <div id="views-content">
                <table class="view-stats-table">
                    <thead>
                        <tr>
                            <th>Page</th>
                            <th>Current Views</th>
                            <th>Pending</th>
                            <th>New Total</th>
                        </tr>
                    </thead>
                    <tbody id="views-table-body"></tbody>
                </table>
            </div>
            <div class="export-section">
                <button class="action-button" onclick="exportPageViews()">üì§ Export Updated pageviews.json</button>
                <button class="action-button" onclick="clearPendingViews()">üóëÔ∏è Clear Pending Views</button>
                <div id="pageviews-export" class="code-box" style="display: none;">
                    <pre id="pageviews-json"></pre>
                </div>
            </div>
        </div>

        <!-- Guestbook Management -->
        <div class="section">
            <h2>üìù Guestbook Entries</h2>
            <div id="guestbook-pending-list"></div>
            <div class="export-section">
                <button class="action-button" onclick="exportGuestbook()">üì§ Export Updated guestbook.json</button>
                <button class="action-button" onclick="clearProcessedEntries()">üóëÔ∏è Clear Processed Entries</button>
                <div id="guestbook-export" class="code-box" style="display: none;">
                    <pre id="guestbook-json"></pre>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="section">
            <h2>üìñ Instructions</h2>
            <ol style="line-height: 2;">
                <li>Review pending guestbook entries and approve/reject them</li>
                <li>Click "Export" buttons to generate updated JSON files</li>
                <li>Copy the JSON content and update the files in <code>/data/</code></li>
                <li>Commit changes to GitHub</li>
                <li>GitHub Actions will automatically deploy to Neocities</li>
            </ol>
        </div>
    </div>

    <script>
        let currentPageViews = {};
        let currentGuestbookEntries = [];
        let approvedEntries = new Set();
        let rejectedEntries = new Set();

        // Load current data
        async function loadCurrentData() {
            try {
                const [viewsRes, guestbookRes] = await Promise.all([
                    fetch('/data/pageviews.json?t=' + Date.now()),
                    fetch('/data/guestbook.json?t=' + Date.now())
                ]);

                currentPageViews = await viewsRes.json();
                const guestbookData = await guestbookRes.json();
                currentGuestbookEntries = guestbookData.entries || [];

                updateStats();
                renderPageViews();
                renderGuestbookEntries();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Update statistics
        function updateStats() {
            const totalViews = Object.values(currentPageViews).reduce((a, b) => a + b, 0);
            const pendingViews = getPendingViews().length;
            const totalGuestbook = currentGuestbookEntries.length;
            const pendingGuestbook = getPendingGuestbook().length;

            document.getElementById('total-views').textContent = totalViews.toLocaleString();
            document.getElementById('pending-views').textContent = pendingViews;
            document.getElementById('total-guestbook').textContent = totalGuestbook;
            document.getElementById('pending-guestbook').textContent = pendingGuestbook;
        }

        // Get pending views from localStorage
        function getPendingViews() {
            try {
                return JSON.parse(localStorage.getItem('coaiexist_pending_views') || '[]');
            } catch (e) {
                return [];
            }
        }

        // Get pending guestbook entries
        function getPendingGuestbook() {
            try {
                return JSON.parse(localStorage.getItem('coaiexist_pending_guestbook') || '[]');
            } catch (e) {
                return [];
            }
        }

        // Render page views table
        function renderPageViews() {
            const pendingViews = getPendingViews();
            const viewCounts = {};

            // Count pending views per page
            pendingViews.forEach(view => {
                viewCounts[view.page] = (viewCounts[view.page] || 0) + 1;
            });

            const tbody = document.getElementById('views-table-body');
            const pages = Object.keys(currentPageViews).sort();

            tbody.innerHTML = pages.map(page => {
                const current = currentPageViews[page] || 0;
                const pending = viewCounts[page] || 0;
                const newTotal = current + pending;

                return `
                    <tr>
                        <td>${page}</td>
                        <td>${current}</td>
                        <td style="color: ${pending > 0 ? 'var(--magenta)' : 'var(--cyan)'}">
                            ${pending > 0 ? '+' + pending : '-'}
                        </td>
                        <td style="font-weight: bold; color: var(--cyan)">${newTotal}</td>
                    </tr>
                `;
            }).join('');
        }

        // Render guestbook entries
        function renderGuestbookEntries() {
            const pending = getPendingGuestbook();
            const container = document.getElementById('guestbook-pending-list');

            if (pending.length === 0) {
                container.innerHTML = '<div class="empty-state">No pending guestbook entries</div>';
                return;
            }

            container.innerHTML = pending.map(entry => {
                const isApproved = approvedEntries.has(entry.id);
                const isRejected = rejectedEntries.has(entry.id);
                const status = isApproved ? 'approved' : isRejected ? 'rejected' : '';

                return `
                    <div class="pending-item ${status}" data-id="${entry.id}">
                        <div class="item-header">
                            <div>
                                <strong style="color: var(--magenta)">${escapeHtml(entry.name)}</strong>
                                ${entry.website ? `<a href="${escapeHtml(entry.website)}" target="_blank" style="color: var(--cyan)">üîó</a>` : ''}
                                <br>
                                <small style="color: var(--purple)">${new Date(entry.timestamp).toLocaleString()}</small>
                            </div>
                            <div class="item-actions">
                                <button class="approve-btn" onclick="approveEntry('${entry.id}')" ${isApproved ? 'disabled' : ''}>
                                    ‚úì Approve
                                </button>
                                <button class="reject-btn" onclick="rejectEntry('${entry.id}')" ${isRejected ? 'disabled' : ''}>
                                    ‚úó Reject
                                </button>
                            </div>
                        </div>
                        <div style="color: var(--cyan); margin-top: 0.5rem;">
                            ${escapeHtml(entry.message)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Approve entry
        function approveEntry(id) {
            approvedEntries.add(id);
            rejectedEntries.delete(id);
            renderGuestbookEntries();
            updateStats();
        }

        // Reject entry
        function rejectEntry(id) {
            rejectedEntries.add(id);
            approvedEntries.delete(id);
            renderGuestbookEntries();
            updateStats();
        }

        // Export updated page views
        function exportPageViews() {
            const pendingViews = getPendingViews();
            const updated = { ...currentPageViews };

            pendingViews.forEach(view => {
                updated[view.page] = (updated[view.page] || 0) + 1;
            });

            const json = JSON.stringify(updated, null, 2);
            document.getElementById('pageviews-json').textContent = json;
            document.getElementById('pageviews-export').style.display = 'block';
        }

        // Export updated guestbook
        function exportGuestbook() {
            const pending = getPendingGuestbook();
            const approved = pending.filter(entry => approvedEntries.has(entry.id));

            const updated = {
                entries: [...currentGuestbookEntries, ...approved]
            };

            const json = JSON.stringify(updated, null, 2);
            document.getElementById('guestbook-json').textContent = json;
            document.getElementById('guestbook-export').style.display = 'block';
        }

        // Clear pending views
        function clearPendingViews() {
            if (confirm('Clear all pending page views? This cannot be undone.')) {
                localStorage.removeItem('coaiexist_pending_views');
                loadCurrentData();
            }
        }

        // Clear processed entries
        function clearProcessedEntries() {
            if (confirm('Clear all processed guestbook entries? Make sure you\'ve exported and saved the data first!')) {
                const pending = getPendingGuestbook();
                const remaining = pending.filter(entry => !approvedEntries.has(entry.id) && !rejectedEntries.has(entry.id));

                localStorage.setItem('coaiexist_pending_guestbook', JSON.stringify(remaining));
                approvedEntries.clear();
                rejectedEntries.clear();
                loadCurrentData();
            }
        }

        // Utility function
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        loadCurrentData();
    </script>
</body>
</html>
